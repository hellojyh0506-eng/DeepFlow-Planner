<!DOCTYPE html>
<html lang="zh-CN" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DeepFlow | AI æ™ºèƒ½æ„å»º </title>
    <!-- å¼•å…¥æ ¸å¿ƒåº“ -->
    <script src="https://deepflow-hellojyh-audio.oss-cn-hangzhou.aliyuncs.com/libs/lucide.min.js"></script>
    <script src="https://deepflow-hellojyh-audio.oss-cn-hangzhou.aliyuncs.com/libs/tailwind.js"></script>
    <script src="https://deepflow-hellojyh-audio.oss-cn-hangzhou.aliyuncs.com/libs/xlsx.full.min.js"></script>
    <script src="templates/rules_db.js"></script> 
    <script>
        // è¿™é‡Œå®šä¹‰æ ¸å¿ƒåŒ¹é…é€»è¾‘ï¼Œç›´æ¥è¦†ç›–å¯èƒ½å­˜åœ¨çš„æ—§é€»è¾‘
        window.autoDetectTag = function(text) {
            // 1. å¦‚æœæ²¡æœ‰è¾“å…¥ï¼Œè¿”å›é»˜è®¤å€¼
            if (!text) return { category: "æ—¥å¸¸", label: "Task", emoji: "ğŸ“", color: "#8E8E93" };

            // 2. å°è¯•è·å–è§„åˆ™åº“æ•°æ®
            const db = (typeof SCENARIO_DATABASE !== 'undefined') ? SCENARIO_DATABASE : [];

            // 3. éå†è§„åˆ™åº“
            for (const group of db) {
                if (!group.scenarios) continue;

                for (const scenario of group.scenarios) {
                    // æ£€æŸ¥å…³é”®å­—æ˜¯å¦åŒ¹é… (ä¸åŒºåˆ†å¤§å°å†™)
                    const isMatch = scenario.keywords.some(k => text.toLowerCase().includes(k.toLowerCase()));

                    if (isMatch) {
                        // ======================================================
                        // ğŸ‘‡ éšæœº Emoji æ ¸å¿ƒé€»è¾‘ (ç»ˆæä¿®å¤ç‰ˆ) ğŸ‘‡
                        // ======================================================
                        
                        const emojiString = scenario.emoji || "ğŸ“";
                        
                        // ã€æ ¸å¿ƒä¿®å¤ã€‘ä½¿ç”¨ Intl.Segmenter æŒ‰â€œè§†è§‰å•å…ƒâ€æ‹†åˆ†
                        // å®ƒå¯ä»¥å®Œç¾å¤„ç† ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ (å®¶åº­)ã€â¤ï¸ (çº¢å¿ƒ) ç­‰å¤æ‚ç»„åˆ Emojiï¼Œä¸ä¼šäº§ç”Ÿç©ºç™½å­—ç¬¦
                        const segmenter = new Intl.Segmenter('en', { granularity: 'grapheme' });
                        let emojiList = Array.from(segmenter.segment(emojiString)).map(item => item.segment);

                        // è¿‡æ»¤æ‰é€—å·ã€ç©ºæ ¼ç­‰æ— ç”¨å­—ç¬¦
                        emojiList = emojiList.filter(char => {
                            const c = char.trim();
                            return c.length > 0 && c !== ',' && c !== 'ï¼Œ';
                        });

                        // åŒé‡ä¿é™©
                        if (emojiList.length === 0) {
                            emojiList = ["ğŸ“"];
                        }
                        
                        // éšæœºå–å‡ºä¸€ä¸ªç´¢å¼•
                        const randomIndex = Math.floor(Math.random() * emojiList.length);
                        const finalEmoji = emojiList[randomIndex];

                        // è¿”å›ç»“æœ
                        return {
                            category: group.category,
                            label: scenario.label,
                            emoji: finalEmoji,
                            color: group.color
                        };
                    }
                }
            }

            // 4. å¦‚æœæ²¡åŒ¹é…åˆ°ä»»ä½•è§„åˆ™ï¼Œè¿”å›é»˜è®¤å€¼
            return { category: "æ—¥å¸¸", label: "Task", emoji: "ğŸ“", color: "#8E8E93" };
        };
    </script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', '"Noto Sans SC"', 'sans-serif'] },
                    animation: { 
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 3s ease-in-out infinite',
                        'slide-in': 'slideIn 0.3s ease-out forwards',
                        'fadeIn': 'fadeIn 0.5s ease-out forwards',
                        'slideUp': 'slideUp 0.3s ease-out forwards',
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-4px)' } },
                        slideIn: { '0%': { opacity: '0', transform: 'translateX(-10px)' }, '100%': { opacity: '1', transform: 'translateX(0)' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>
    <style>
        /* ==========================================================================
           1. æ ¸å¿ƒè§†è§‰æ ·å¼
           ========================================================================== */
        html, body {
            background-color: #020617; 
            color: white; 
            overflow-x: hidden; 
            width: 100%;
            max-width: 100%;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-nav { background: rgba(2, 6, 23, 0.7); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255,255,255,0.05); }

        .deep-space-bg {
            position: fixed; inset: 0; z-index: -2;
            background: 
                radial-gradient(circle at 15% 50%, rgba(30, 58, 138, 0.4) 0%, transparent 50%), 
                radial-gradient(circle at 85% 30%, rgba(88, 28, 135, 0.25) 0%, transparent 50%);
            background-size: 100% 100%;
        }
        .grid-overlay {
            position: fixed; inset: 0; z-index: -1;
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
            pointer-events: none;
        }

        .glass-panel { 
            background: rgba(255,255,255,0.02); 
            border: 1px solid rgba(255,255,255,0.05); 
            backdrop-filter: blur(10px);
            transition: all 0.3s; 
            overflow: visible; 
            position: relative;
            z-index: 1;
        }
        .glass-panel:hover { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); }

        /* ==========================================================================
           2. æ‰‹æœºç«¯ä¸“å±ä¼˜åŒ– (Mobile First)
           ========================================================================== */
        @media (max-width: 768px) {
            /* 1. æ›´åŠ ç´§å‡‘çš„é¡µé¢é—´è· */
            section { padding-top: 85px !important; padding-bottom: 100px !important; } 
            
            /* 2. æ™ºèƒ½æŠ˜å è¾“å…¥æ¡†ï¼šé»˜è®¤åªæ˜¾ç¤ºä¸€è¡Œï¼Œèšç„¦æ—¶å˜é«˜ */
            /* === 1. ä¿®å¤è¾“å…¥æ¡†å’Œè¯­éŸ³æŒ‰é’® === */
            /* === æ›¿æ¢ä»£ç ï¼šä¿®å¤è¯­éŸ³æŒ‰é’®æ— æ³•ç‚¹å‡» (Z-Index + ç§»é™¤ç¦æ­¢ç‚¹å‡») === */
            
            /* æ™ºèƒ½æŠ˜å è¾“å…¥æ¡† */
            .ai-textarea {
                height: 52px !important; 
                min-height: 52px !important;
                font-size: 14px !important; 
                padding: 14px 45px 14px 16px !important; /* å³ä¾§ç»™è¯­éŸ³æŒ‰é’®ç•™ä½ç½® */
                background: rgba(30, 41, 59, 0.9) !important;
                border-color: rgba(255,255,255,0.15) !important;
                transition: all 0.25s ease !important;
                overflow: hidden;
                line-height: 1.5 !important;
                border-radius: 20px !important;
            }
            .ai-textarea:focus {
                height: 180px !important; 
                border-radius: 16px !important;
                background: rgba(15, 23, 42, 0.98) !important;
                padding-right: 16px !important;
                z-index: 50 !important; /* ä¿æŒå±‚çº§ */
                position: relative; 
            }

            /* è¯­éŸ³æŒ‰é’®ï¼šå¼ºåˆ¶ç¼©å°ï¼Œç²¾è‡´åŒ–ï¼Œå¹¶æå‡å±‚çº§ */
            #voice-btn {
                width: 32px !important;   
                height: 32px !important;
                padding: 0 !important;    
                bottom: 11px !important;  
                right: 10px !important;
                display: flex !important;
                align-items: center;
                justify-content: center;
                background-color: #3b82f6 !important; 
                border: 1px solid rgba(255,255,255,0.2) !important;
                box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3) !important;
                
                /* å…³é”®ä¿®å¤ 1ï¼šå±‚çº§å¿…é¡»æ¯”å±•å¼€åçš„è¾“å…¥æ¡†(50)æ›´é«˜ */
                z-index: 60 !important; 
                pointer-events: auto !important; /* ç¡®ä¿ä»»ä½•æ—¶å€™éƒ½èƒ½æ¥å—ç‚¹å‡» */
                cursor: pointer !important;
            }

            /* å½“è¾“å…¥æ¡†å±•å¼€æ—¶ï¼šä¿æŒæŒ‰é’®å¯è§ä¸”å¯ç‚¹å‡» */
            .ai-textarea:focus + #voice-btn {
                opacity: 1 !important; /* ä¿æŒå®Œå…¨å¯è§ï¼Œä¸å˜æ·¡ */
                pointer-events: auto !important; /* å…è®¸ç‚¹å‡» */
                transform: scale(1.05); /* ç¨å¾®æ”¾å¤§ä¸€ç‚¹ç‚¹ */
            }

            .desktop-nav-text { display: none !important; }
            .desktop-btn { display: none !important; }
            
            .mobile-scroll-container {
                display: flex; gap: 10px; overflow-x: auto; padding: 4px 4px 12px 4px;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }
            .mobile-scroll-container::-webkit-scrollbar { display: none; }

            .mobile-action-bar {
                display: flex !important;
                position: fixed; bottom: 0; left: 0; right: 0; z-index: 999;
                background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px);
                border-top: 1px solid rgba(255,255,255,0.1);
                padding: 12px 16px; gap: 12px;
                box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
                animation: slideUp 0.3s ease-out;
            }

            .glass-panel { padding: 1.25rem !important; border-radius: 20px !important; }
            h1 { font-size: 2rem !important; line-height: 1.2 !important; }
            .voice-btn-mobile { display: flex !important; }
            
            /* 4. é¢„è§ˆé¢æ¿é«˜åº¦è‡ªé€‚åº” */
            .ai-preview-panel {
                height: auto !important;
                min-height: 300px !important;
                max-height: none !important;
                border: none !important;
                background: transparent !important;
            }
            .ai-timeline { padding: 0 !important; overflow: visible !important; }
        }
        .mobile-action-bar { display: none; }
        .voice-btn-mobile { display: none; }

        .voice-recording { 
            animation: pulse-red 1.5s infinite; 
            background: rgba(239, 68, 68, 0.2) !important; 
            border-color: rgba(239, 68, 68, 0.5) !important; 
            color: #f87171 !important; 
        }
        @keyframes pulse-red { 
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } 
        }

        /* ==========================================================================
           3. æ¨¡å¼é€‰æ‹©å™¨ (Tab Bar)
           ========================================================================== */
        .mode-selector {
            display: flex;
            flex-wrap: wrap; 
            justify-content: center; 
            align-items: center;
            gap: 8px; 
            width: 100%;
        }

        @media (min-width: 768px) {
            .mode-selector {
                justify-content: flex-end; 
                width: auto;
                flex-wrap: nowrap; 
            }
        }

        .tab-btn { 
            position: relative; 
            color: #94a3b8; 
            transition: all 0.3s; 
            padding: 0.6rem 1.2rem; 
            border-radius: 10px; 
            font-size: 14px; 
            font-weight: 600; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            flex: 1 0 auto; 
            min-width: 110px; 
            max-width: 100%; 
            white-space: nowrap; 
        }

        .tab-btn:hover { color: white; background: rgba(255,255,255,0.05); }
        .tab-btn.active { color: white; background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.3); }
        .tab-btn-ai.active { background: linear-gradient(135deg, #2563eb, #9333ea); border: none; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4); text-shadow: 0 1px 2px rgba(0,0,0,0.2); }

        @media (max-width: 480px) {
            .mode-selector { gap: 6px; }
            .tab-btn { padding: 10px 8px; font-size: 13px; min-width: 90px; }
        }

        /* ==========================================================================
           4. æ ¸å¿ƒç»„ä»¶æ ·å¼
           ========================================================================== */
        
        /* ä¿®å¤ 1: åœ¨çº¿æ„å»ºè¾“å…¥æ¡† - å¼ºåˆ¶æ·±è‰²èƒŒæ™¯ & æ ‡å‡†å±æ€§ */
        .builder-input {
            background-color: rgba(15, 23, 42, 0.6) !important; /* å¼ºåˆ¶æ·±è‰² */
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: #e2e8f0 !important;
            border-radius: 8px !important;
            padding: 10px 12px !important;
            font-size: 14px !important;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            -webkit-appearance: none; /* ç§»é™¤iOSé»˜è®¤æ ·å¼ */
            appearance: none; /* æ ‡å‡†å±æ€§ */
        }
        .builder-input:focus {
            background-color: rgba(15, 23, 42, 0.9) !important;
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
            outline: none;
        }
        .builder-input::placeholder { color: rgba(148, 163, 184, 0.5); }

        /* ä¿®å¤ 2: ç¤ºä¾‹æ ‡ç­¾ - å¢åŠ ç‚¹å‡»æ„Ÿ */
        .mobile-example-chip {
            flex: 0 0 auto;
            padding: 8px 14px; 
            background: rgba(30, 41, 59, 0.6); 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: 600;
            border: 1px solid rgba(255,255,255,0.1);
            white-space: nowrap;
            cursor: pointer; 
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none; 
        }
        .mobile-example-chip:active {
            transform: scale(0.95); 
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.4);
        }
        .mobile-example-chip::after {
            content: 'â†’';
            font-family: monospace;
            opacity: 0.4;
            font-size: 10px;
        }

        /* ä¿®å¤ 3: æ‰‹æœºç«¯ AI é¢„è§ˆå¡ç‰‡ åˆ é™¤æŒ‰é’®æ ·å¼ - æ˜¾å¼å¯è§ */
        .mobile-delete-btn {
            opacity: 1 !important; /* æ‰‹æœºç«¯å¼ºåˆ¶æ˜¾ç¤º */
            background-color: rgba(239, 68, 68, 0.15); 
            border-radius: 8px;
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }
        .mobile-delete-btn:active {
            background-color: rgba(239, 68, 68, 0.3);
            transform: scale(0.9);
        }
        
        @media (min-width: 768px) {
            .mobile-delete-btn {
                opacity: 0 !important; /* ç”µè„‘ç«¯Hoveræ˜¾ç¤º */
                background-color: transparent;
                border: none;
                color: #475569;
            }
            .group:hover .mobile-delete-btn {
                opacity: 1 !important;
            }
            .mobile-delete-btn:hover {
                color: #f87171;
            }
        }

        /* åŸæœ‰ç»„ä»¶ */
        .selection-card {
            position: relative; border-radius: 20px; overflow: hidden; cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: flex; flex-direction: column; padding: 1.5rem; min-height: 220px;
        }
        .selection-card:hover { transform: translateY(-5px) scale(1.02); }

        .card-pro-premium { background: rgba(255, 255, 255, 0.05); color: white; border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); }
        .card-pro-premium.selected { border-color: #3b82f6; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.5), 0 10px 40px rgba(59, 130, 246, 0.4); }
        .card-zen-matte { background: #ffffff; color: #18181b; border: 1px solid #e4e4e7; }
        .card-zen-matte.selected { border-color: #18181b; box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.5), 0 0 0 6px #18181b; }
        .card-cyber-neon { background: #09090b; border: 1px solid rgba(217, 70, 239, 0.3); }
        .card-cyber-neon.selected { border-color: #d946ef; box-shadow: 0 0 0 2px #09090b, 0 0 0 4px #d946ef; }

        .check-circle { position: absolute; top: 1rem; right: 1rem; z-index: 20; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: 0; transform: scale(0.5); transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .selected .check-circle { opacity: 1; transform: scale(1); }

        /* 1. ç»Ÿä¸€çš„é¢æ¿å®¹å™¨ (å·¦å³å¯¹ç§°æ ¸å¿ƒ) */
        .ai-panel-container {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 24px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 520px; /* ç”µè„‘ç«¯å›ºå®šé«˜åº¦ï¼Œå¼ºåˆ¶å¯¹ç§° */
            transition: all 0.3s ease;
        }

        /* 2. å·¦ä¾§è¾“å…¥æ¡†é‡æ„ - å»æ‰è¾¹æ¡†ï¼Œèå…¥é¢æ¿ */
        .ai-textarea {
            width: 100%;
            height: 100%;
            background: transparent !important;
            border: none !important;
            padding: 20px;
            color: #e2e8f0;
            font-size: 16px;
            line-height: 1.8;
            resize: none;
            outline: none;
            font-family: inherit;
        }
        .ai-textarea:focus { box-shadow: none !important; }

        /* 3. é¢„è§ˆé¢æ¿å†…éƒ¨æ ·å¼ */
        .ai-timeline { flex: 1; overflow-y: auto; padding: 0; }
        .timeline-day { margin-bottom: 24px; animation: slideIn 0.3s ease-out forwards; }
        .timeline-date { display: inline-flex; align-items: center; gap: 8px; background: linear-gradient(90deg, #2563eb, #3b82f6); color: white; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 800; margin-bottom: 12px; box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3); }

        /* 4. å¼•æ“å¼€å…³ä¸å¤´éƒ¨æ ·å¼ */
        .engine-switch-header {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            background: rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 56px; /* å›ºå®šå¤´éƒ¨é«˜åº¦ */
        }

        /* 5. æ‰‹æœºç«¯ç‰¹åŒ–é€‚é… (è§£å†³æ‹¥æŒ¤) */
        @media (max-width: 768px) {
            .ai-panel-container {
                height: auto !important;
                min-height: auto !important;
                background: rgba(15, 23, 42, 0.8);
                border-radius: 16px;
            }
            /* å·¦ä¾§é¢æ¿ï¼šæ‰‹æœºç«¯é»˜è®¤æŠ˜å  */
            .left-panel-mobile {
                min-height: 140px; 
                transition: min-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            /* è¾“å…¥æ¡†èšç„¦æ—¶å±•å¼€ */
            .left-panel-mobile:focus-within {
                min-height: 300px;
                border-color: #3b82f6;
                box-shadow: 0 10px 40px -10px rgba(59, 130, 246, 0.3);
            }
            .ai-textarea {
                padding: 12px 16px !important;
                font-size: 15px !important;
                height: 120px !important;
            }
            .left-panel-mobile:focus-within .ai-textarea {
                height: 240px !important;
            }
            .ai-timeline { padding: 0 !important; }
        }
        /* === 2. åŒå±‚å¡ç‰‡æ ·å¼ (ä½ å–œæ¬¢çš„é‚£ä¸ªæ¸…æ™°ç‰ˆ) === */
        
        /* å¡ç‰‡å®¹å™¨ï¼šæœ‰èƒŒæ™¯ï¼Œæœ‰åœ†è§’ï¼Œçœ‹ç€åƒä¸ªå®ä½“ */
        .ai-task-card { 
            display: flex; 
            flex-direction: column; /* ä¸Šä¸‹åˆ†ä¸¤å±‚ */
            gap: 8px; 
            background: rgba(30, 41, 59, 0.6); /* æ·±è“åŠé€æ˜èƒŒæ™¯ */
            border: 1px solid rgba(255,255,255,0.08); /* ç»†å¾®è¾¹æ¡† */
            padding: 10px 12px; 
            border-radius: 10px; 
            margin-bottom: 8px; 
            transition: all 0.2s; 
            position: relative; 
        }
        /* é€‰ä¸­/ç‚¹å‡»æ—¶ç¨å¾®äº®ä¸€ç‚¹ */
        .ai-task-card:focus-within {
            background: rgba(30, 41, 59, 0.9);
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        /* ç¬¬ä¸€è¡Œï¼šå…ƒæ•°æ® (æ—¶é—´ã€æ ‡ç­¾) */
        .ai-task-meta-row {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            height: 24px;
        }

        /* æ—¶é—´èƒ¶å›Šï¼šè“è‰²èƒŒæ™¯ï¼Œå°å·§æ¸…æ™° */
        .ai-time-edit { 
            background: rgba(59, 130, 246, 0.15); 
            border: 1px solid transparent; 
            color: #60a5fa; 
            font-family: monospace; 
            font-weight: bold; 
            width: 52px; 
            text-align: center; 
            font-size: 13px; 
            padding: 2px 0; 
            border-radius: 6px; 
        }
        .ai-time-edit:focus { border-color: #3b82f6; background: rgba(59, 130, 246, 0.25); outline: none; }
        
        /* æ—¶é•¿èƒ¶å›Šï¼šé»„è‰²èƒŒæ™¯ */
        .ai-duration-edit { 
            background: rgba(245, 158, 11, 0.15); 
            border: 1px solid transparent; 
            color: #fbbf24; 
            font-family: monospace; 
            font-weight: bold; 
            width: 36px; 
            text-align: center; 
            font-size: 13px; 
            padding: 2px 0; 
            border-radius: 6px; 
        }
        .ai-duration-edit:focus { border-color: #f59e0b; background: rgba(245, 158, 11, 0.25); outline: none; }

        /* æ ‡ç­¾ï¼šèƒ¶å›Šæ ·å¼ */
        .ai-tag-badge { 
            display: flex; align-items: center; gap: 4px;
            font-size: 11px; 
            padding: 2px 8px; 
            border-radius: 99px; 
            background: rgba(255,255,255,0.08); 
            color: #cbd5e1; 
            border: 1px solid rgba(255,255,255,0.05); 
            white-space: nowrap; 
            max-width: 100px;
        }

        /* ç¬¬äºŒè¡Œï¼šä»»åŠ¡æ ‡é¢˜ (ç‹¬å ä¸€è¡Œï¼Œå¤§ä¸”æ¸…æ™°) */
        .ai-title-edit { 
            background: transparent; 
            border: none; 
            border-bottom: 1px solid transparent; /* åªæœ‰åº•éƒ¨æœ‰ä¸€æ¡éšå½¢çº¿ */
            color: #f1f5f9; 
            font-size: 15px; 
            font-weight: 500;
            padding: 4px 0; 
            width: 100%; 
            line-height: 1.4;
            border-radius: 0;
        }
        .ai-title-edit:focus { border-bottom-color: #3b82f6; outline: none; }
        
        /* åˆ é™¤æŒ‰é’®ï¼šæ”¾åœ¨å³ä¸Šè§’ */
        .mobile-card-del {
            color: #64748b;
            padding: 4px;
            border-radius: 6px;
        }
        .mobile-card-del:hover { background: rgba(239, 68, 68, 0.1); color: #f87171; }
        /* Sample æ ·å¼ç§»æ¤ */
        .df-modal-overlay { display: none; position: fixed; inset: 0; background: rgba(2, 6, 23, 0.85); backdrop-filter: blur(8px); z-index: 9999; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; }
        .df-modal-overlay.active { display: flex; opacity: 1; }
        .df-modal-card { background: rgba(30, 41, 59, 0.9); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); backdrop-filter: blur(16px); color: white; width: 90%; max-width: 420px; border-radius: 24px; padding: 32px 24px; text-align: center; transform: scale(0.95) translateY(10px); transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .df-modal-overlay.active .df-modal-card { transform: scale(1) translateY(0); }
        .df-icon-circle { width: 64px; height: 64px; background: linear-gradient(135deg, #007AFF, #00C6FF); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; box-shadow: 0 0 30px rgba(0, 122, 255, 0.4); }
        .df-modal-title { font-size: 22px; font-weight: 800; color: white; margin-bottom: 8px; }
        .df-modal-desc { font-size: 14px; color: #94a3b8; margin-bottom: 32px; line-height: 1.6; }
        .df-actions { display: flex; flex-direction: column; gap: 12px; }
        .df-btn { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 16px; border-radius: 14px; font-size: 15px; font-weight: 700; text-decoration: none; transition: all 0.2s; cursor: pointer; border: none; }
        .df-btn-primary { background: linear-gradient(to right, #2563eb, #4f46e5); color: white; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); }
        .df-btn-primary:hover { background: linear-gradient(to right, #1d4ed8, #4338ca); transform: scale(1.02); }
        .df-btn-secondary { background: rgba(255, 255, 255, 0.05); color: white; border: 1px solid rgba(255, 255, 255, 0.1); }
        .df-btn-secondary:hover { background: rgba(255, 255, 255, 0.1); }
        .df-close { margin-top: 24px; background: none; border: none; color: #64748b; font-size: 13px; cursor: pointer; }
        .df-close:hover { color: white; }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        /* === æ–°å¢ï¼šAI è¿›åº¦æ¡ä¸æµå…‰ç‰¹æ•ˆ === */
.ai-progress-track {
    width: 100%;
    height: 3px;
    background: rgba(255, 255, 255, 0.05);
    position: relative;
    overflow: hidden;
    opacity: 0;
    transition: opacity 0.3s;
}
.ai-progress-track.active {
    opacity: 1;
}
.ai-progress-bar {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #3b82f6, #8b5cf6, #3b82f6);
    background-size: 200% 100%;
    position: relative;
    box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
    /* åˆå§‹ä¸è®¾ transitionï¼Œç”± JS åŠ¨æ€æ§åˆ¶å¿«æ…¢ */
}
/* æµå…‰åŠ¨ç”»ï¼šè®©è¿›åº¦æ¡çœ‹èµ·æ¥åœ¨â€œæµåŠ¨â€ */
.ai-progress-bar.flowing {
    animation: shimmy 1.5s infinite linear;
}
@keyframes shimmy {
    0% { background-position: 100% 0; }
    100% { background-position: -100% 0; }
}
    </style>
</head>
<body class="antialiased selection:bg-blue-500/30">

    <div class="deep-space-bg"></div>
    <div class="grid-overlay"></div>

    <nav class="fixed w-full z-50 glass-nav">
        <div class="max-w-7xl mx-auto px-6 h-20 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-gradient-to-tr from-blue-600 to-purple-600 p-1.5 rounded-lg shadow-lg"><i data-lucide="zap" class="text-white w-5 h-5"></i></div>
                <span class="font-black text-xl tracking-tight">DeepFlow</span>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="openSettings()" class="text-slate-400 hover:text-white transition p-2"><i data-lucide="settings" class="w-5 h-5"></i></button>
                <a href="index.html" class="bg-white/10 text-white px-4 py-2 rounded-full font-bold text-sm hover:bg-white/20 transition border border-white/10">
                    <i data-lucide="arrow-left" class="w-4 h-4 inline mr-1"></i> <span class="desktop-nav-text">è¿”å›ä¸»é¡µ</span>
                </a>
            </div>
        </div>
    </nav>

    <section class="relative pt-32 pb-24 md:pt-48 md:pb-32 min-h-screen">
        <div class="max-w-6xl mx-auto px-6 relative z-10 text-center">
            <h1 class="text-4xl md:text-5xl font-black mb-4 leading-tight tracking-tight text-white drop-shadow-xl">
                å¼€å§‹æ„å»ºä½ çš„å¿ƒæµ App
            </h1>
            <p class="text-slate-400 text-lg max-w-2xl mx-auto mb-12">
                é€‰æ‹©æœ€é€‚åˆä½ çš„æ–¹å¼ï¼Œå¿«é€Ÿç”Ÿæˆä¸ªæ€§åŒ–è®¡åˆ’åº”ç”¨ã€‚
            </p>

            <div class="space-y-12">
                
                <!-- 1. Data Input Panel -->
                <div class="bg-transparent md:bg-slate-900/40 md:border md:border-white/5 md:backdrop-blur-xl p-0 md:p-6 rounded-3xl text-left transition-all duration-300">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                        <div class="hidden md:block text-slate-400 text-sm font-bold tracking-wide uppercase">AI Planning Engine</div>
                        
                        <!-- æ ¸å¿ƒä¿®å¤åŒºåŸŸï¼šæ¨¡å¼é€‰æ‹©å™¨ -->
                        <div class="mode-selector">
                            <!-- AI Mode -->
                            <button onclick="switchMode('ai')" id="tab-ai" class="tab-btn tab-btn-ai active">
                                <i data-lucide="sparkles" class="w-4 h-4"></i>
                                <span>AI æ™ºèƒ½è¾“å…¥</span>
                            </button>
                            
                            <!-- åˆ†éš”ç¬¦ (ä»…æ¡Œé¢ç«¯æ˜¾ç¤º) -->
                            <div class="h-6 w-px bg-white/10 mx-1 hidden md:block"></div>
                            
                            <!-- Legacy Modes -->
                            <button onclick="switchMode('upload')" id="tab-upload" class="tab-btn">
                                <i data-lucide="upload-cloud" class="w-4 h-4"></i> Excel ä¸Šä¼ 
                            </button>
                            <button onclick="switchMode('builder')" id="tab-builder" class="tab-btn">
                                <i data-lucide="layout-list" class="w-4 h-4"></i> åœ¨çº¿æ„å»º
                            </button>
                        </div>
                    </div>

                    <!-- MODE 1: AI Intelligent Input -->
                    <div id="mode-ai" class="block animate-fadeIn">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8 items-start">
                            
                            <div class="ai-panel-container left-panel-mobile relative group">
                                <div class="engine-switch-header">
                                    <div class="text-xs font-bold text-slate-400 flex items-center gap-1.5">
                                        <i data-lucide="cpu" class="w-3.5 h-3.5"></i> 
                                        <span>è¾“å…¥å¼•æ“</span>
                                    </div>
                                    <div class="bg-slate-900 p-0.5 rounded-lg border border-white/10 flex relative cursor-pointer select-none h-8" onclick="toggleEngineMode()">
                                        <div id="engine-slider" class="absolute top-0.5 bottom-0.5 w-[calc(50%-2px)] bg-blue-600 rounded-md shadow-sm transition-all duration-300 translate-x-[100%] left-0.5"></div>
                                        
                                        <div id="btn-local" class="relative z-10 px-3 flex items-center justify-center text-[10px] font-bold text-slate-400 transition-colors w-16 md:w-20 gap-1">
                                            <i data-lucide="zap" class="w-3 h-3"></i> æœ¬åœ°
                                        </div>
                                        <div id="btn-cloud" class="relative z-10 px-3 flex items-center justify-center text-[10px] font-bold text-white transition-colors w-16 md:w-20 gap-1">
                                            <i data-lucide="sparkles" class="w-3 h-3"></i> AI
                                        </div>
                                    </div>
                                </div>

                                <div class="flex-1 relative">
                                    <textarea id="ai-input" class="ai-textarea custom-scrollbar" 
                                        placeholder="è¯·æè¿°æ‚¨çš„è®¡åˆ’...&#10;&#10;ä¾‹å¦‚ï¼š&#10;å‘¨ä¸‰æ—©ä¸Š8ç‚¹èƒŒå•è¯ï¼Œä¸‹åˆ2ç‚¹åšæ•°å­¦ã€‚&#10;ä¸‹ä¸‹å‘¨äº”æ™šä¸Š7ç‚¹å»çœ‹ç”µå½±ã€‚"
                                        oninput="ai_handleInput()"></textarea>
                                    
                                    <button id="voice-btn" onclick="toggleVoiceInput()" class="absolute right-4 bottom-4 bg-blue-600 hover:bg-blue-500 text-white w-10 h-10 rounded-full shadow-lg flex items-center justify-center transition-all hover:scale-110 active:scale-95 z-20 border border-white/10">
                                        <i data-lucide="mic" class="w-5 h-5"></i>
                                    </button>
                                </div>

                                <div class="p-3 border-t border-white/5 bg-white/0">
                                    <div class="mobile-scroll-container flex items-center gap-2">
                                        <span class="text-[10px] text-slate-500 mr-1 flex-shrink-0">è¯•ä¸€è¯•:</span>
                                        <button onclick="ai_loadSample('exam')" class="mobile-example-chip text-blue-400 border-blue-500/20 bg-blue-500/5">ğŸ“š è€ƒç ”</button>
                                        <button onclick="ai_loadSample('life')" class="mobile-example-chip text-green-400 border-green-500/20 bg-green-500/5">ğŸ¥¦ ç”Ÿæ´»</button>
                                        <button onclick="ai_loadSample('date')" class="mobile-example-chip text-orange-400 border-orange-500/20 bg-orange-500/5">ğŸ“… å€’æ•°</button>
                                    </div>
                                </div>
                            </div>

                            <div class="ai-panel-container">
                                <div class="engine-switch-header">
                                    <span class="text-xs font-bold text-slate-300 flex items-center gap-2">
                                        <i data-lucide="eye" class="w-3.5 h-3.5"></i> å®æ—¶é¢„è§ˆ
                                    </span>
                                    <div class="flex items-center gap-2">
                                        <span id="ai-status" class="text-[10px] bg-slate-700/50 text-slate-400 px-2 py-1 rounded border border-white/5">ç­‰å¾…è¾“å…¥</span>
                                        <button id="ai-confirm-btn" onclick="confirmAI()" class="hidden md:flex text-[10px] bg-emerald-600 hover:bg-emerald-500 px-3 py-1 rounded text-white transition font-bold items-center gap-1 opacity-50 cursor-not-allowed" disabled>
                                            <i data-lucide="check" class="w-3 h-3"></i> ç¡®è®¤
                                        </button>
                                    </div>
                                </div>
                                <div id="ai-loader" class="ai-progress-track">
    <div id="ai-bar" class="ai-progress-bar"></div>
</div>
                                <div id="ai-timeline-container" class="ai-timeline custom-scrollbar p-4 flex-1 overflow-y-auto">
                                    <div class="flex flex-col items-center justify-center h-full text-slate-600 opacity-60">
                                        <div class="w-16 h-16 rounded-full bg-slate-800/50 flex items-center justify-center mb-4 border border-white/5">
                                            <i data-lucide="arrow-left" class="w-6 h-6 md:block hidden"></i>
                                            <i data-lucide="arrow-up" class="w-6 h-6 md:hidden"></i>
                                        </div>
                                        <p class="text-xs">è¯·åœ¨å·¦ä¾§(æˆ–ä¸Šæ–¹)è¾“å…¥å†…å®¹</p>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                    <!-- MODE 2: Excel Upload -->
                    <div id="mode-upload" class="hidden animate-fadeIn">
                        <div class="flex justify-end mb-2">
                            <button onclick="downloadSampleExcel()" class="text-xs font-bold text-blue-400 hover:text-white flex items-center gap-1 transition-colors">
                                <i data-lucide="download" class="w-3 h-3"></i> ä¸‹è½½æ ‡å‡† Excel æ¨¡ç‰ˆ
                            </button>
                        </div>
                        <label for="excel-file" id="excel-drop-area" class="flex flex-col items-center justify-center p-20 border-2 border-dashed border-white/10 rounded-2xl cursor-pointer hover:bg-white/5 hover:border-blue-500/50 transition-all group bg-slate-900/50">
                            <div class="w-16 h-16 bg-blue-500/10 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                                <i data-lucide="file-spreadsheet" class="w-8 h-8 text-blue-400"></i>
                            </div>
                            <p class="text-lg font-bold text-white">ç‚¹å‡»ä¸Šä¼  / æ‹–æ‹½ Excel æ–‡ä»¶</p>
                            <p id="file-status" class="text-sm text-slate-400 mt-2">æ”¯æŒï¼šæ—¥æœŸã€ä»»åŠ¡æ ‡é¢˜ã€æè¿°ã€æ ‡ç­¾ã€æ—¶é—´ç­‰</p>
                            <input type="file" id="excel-file" accept=".xlsx,.csv" class="hidden" onchange="handleFileChange(event)">
                        </label>
                    </div>

                    <!-- MODE 3: Builder (Full Function) -->
                    <div id="mode-builder" class="hidden animate-fadeIn">
                         <div class="bg-slate-900/50 rounded-2xl border border-white/10 p-6">
                             <div class="flex justify-between items-center mb-6">
                                 <h3 class="font-bold text-slate-300 flex items-center gap-2"><i data-lucide="pen-tool" class="w-4 h-4"></i> åœ¨çº¿æ‰‹åŠ¨æ„å»º</h3>
                                 <div class="flex gap-2">
                                     <button onclick="addBuilderDay()" class="text-xs bg-white/5 hover:bg-white/10 px-3 py-1.5 rounded text-slate-300 transition font-bold flex items-center gap-1 border border-white/10">
                                         <i data-lucide="plus-circle" class="w-3 h-3"></i> åŠ ä¸€å¤©
                                     </button>
                                     <button id="builder-confirm-btn" onclick="confirmBuilder()" class="text-xs bg-emerald-600 hover:bg-emerald-500 px-3 py-1.5 rounded text-white transition font-bold shadow-lg flex items-center gap-1">
                                         <i data-lucide="check" class="w-3 h-3"></i> ç¡®è®¤æ„å»º
                                     </button>
                                 </div>
                             </div>
                             
                             <div id="builder-container" class="space-y-4 max-h-[500px] overflow-y-auto pr-2 custom-scrollbar">
                                 <!-- Builder Content will be injected by JS -->
                             </div>
                             
                             <div class="mt-4 text-center">
                                 <p class="text-xs text-slate-500"><i data-lucide="alert-circle" class="w-3 h-3 inline mr-1"></i> æ³¨æ„ï¼šå¦‚æœæ ‡ç­¾æ ç•™ç©ºï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è®¾ä¸º null å€¼ã€‚</p>
                             </div>
                         </div>
                    </div>
                </div>

                <!-- 2. Theme Selection -->
                <div id="theme-section" class="glass-panel p-8 rounded-3xl text-left">
                    <div class="flex items-center gap-4 mb-6">
                        <span class="text-4xl font-black text-purple-500">2</span>
                        <h2 class="text-2xl font-bold">é€‰æ‹© App ä¸»é¢˜</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div id="theme-pro" onclick="selectTheme('pro')" class="selection-card card-pro-premium group">
                            <div class="relative z-10 flex flex-col h-full">
                                <div class="flex justify-between items-start mb-6">
                                    <div class="w-12 h-12 rounded-2xl bg-white flex items-center justify-center backdrop-blur-md shadow-[0_0_20px_rgba(236,72,153,0.4)]"><i data-lucide="zap" class="w-6 h-6 text-pink-500 fill-pink-500/20"></i></div>
                                    <div class="check-circle bg-blue-500 shadow-lg shadow-blue-500/50"><i data-lucide="check" class="w-4 h-4 text-white"></i></div>
                                </div>
                                <h3 class="text-2xl font-black text-white mb-2">DeepFlow Pro</h3>
                                <p class="text-white/70 text-xs">å†…ç½®å¤šå·´èƒºåé¦ˆç®—æ³•ï¼Œç²’å­ç‰¹æ•ˆä¸æ²‰æµ¸éŸ³æ•ˆã€‚</p>
                            </div>
                        </div>
                        <div id="theme-zen" onclick="selectTheme('zen')" class="selection-card card-zen-matte group">
                            <div class="relative z-10 flex flex-col h-full">
                                <div class="flex justify-between items-start mb-6">
                                    <div class="w-12 h-12 rounded-2xl bg-white flex items-center justify-center border border-zinc-200 shadow-lg"><i data-lucide="moon" class="w-6 h-6 text-zinc-800"></i></div>
                                    <div class="check-circle bg-zinc-900 shadow-lg"><i data-lucide="check" class="w-4 h-4 text-white"></i></div>
                                </div>
                                <h3 class="text-2xl font-black text-zinc-900 mb-2">Zen Mode</h3>
                                <p class="text-zinc-500 text-xs">æè‡´çš„é»‘ç™½ç°åº¦è®¾è®¡ï¼Œåˆ›é€ é›¶ç„¦è™‘çš„ä¸“æ³¨ç¯å¢ƒã€‚</p>
                            </div>
                        </div>
                        <div id="theme-cyberpunk" onclick="selectTheme('cyberpunk')" class="selection-card card-cyber-neon group">
                            <div class="relative z-10 flex flex-col h-full">
                                <div class="flex justify-between items-start mb-6">
                                    <div class="w-12 h-12 rounded-2xl bg-transparent border border-fuchsia-500 text-fuchsia-500 flex items-center justify-center shadow-[0_0_15px_rgba(217,70,239,0.3)]"><i data-lucide="gamepad-2" class="w-6 h-6"></i></div>
                                    <div class="check-circle bg-fuchsia-500 shadow-[0_0_15px_rgba(217,70,239,0.5)]"><i data-lucide="check" class="w-4 h-4 text-white"></i></div>
                                </div>
                                <h3 class="text-2xl font-black text-white mb-2">Cyberpunk</h3>
                                <p class="text-fuchsia-200/60 text-xs">é«˜å¯¹æ¯”åº¦éœ“è™¹ç½‘ç»œï¼Œè‚¾ä¸Šè…ºç´ é©±åŠ¨çš„ HUD ç•Œé¢ã€‚</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. Final Action -->
                <div class="glass-panel p-8 rounded-3xl text-left desktop-btn">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <span class="text-4xl font-black text-emerald-500">3</span>
                            <h2 class="text-2xl font-bold">æœ€ç»ˆç¡®è®¤</h2>
                        </div>
                        <button id="generate-button" onclick="generateApp()" class="px-8 py-4 bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 text-white rounded-xl font-bold text-lg shadow-lg shadow-emerald-600/30 transition-all hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0" disabled>
                            <i data-lucide="sparkles" class="w-5 h-5 inline mr-2"></i> ç”Ÿæˆæˆ‘çš„ App
                        </button>
                    </div>
                    <div class="mt-4 text-slate-400 text-sm" id="generation-summary">
                        è¯·å…ˆå‡†å¤‡æ•°æ®å¹¶é€‰æ‹©ä¸»é¢˜ã€‚
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Mobile Bottom Action Bar (æ‰‹æœºç«¯ä¸“ç”¨) -->
    <div id="mobile-action-bar" class="mobile-action-bar">
        <button id="mobile-confirm-btn" onclick="confirmAI()" class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 opacity-50 transition-all" disabled>
            <i data-lucide="check-circle" class="w-4 h-4"></i> ç¡®è®¤è®¡åˆ’
        </button>
        <button id="mobile-generate-btn" onclick="generateApp()" class="flex-[2] bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 rounded-xl font-bold text-sm shadow-lg flex items-center justify-center gap-2 disabled:opacity-50 transition-all hover:scale-[1.02]" disabled>
            <i data-lucide="rocket" class="w-4 h-4"></i> ç”Ÿæˆ App
        </button>
    </div>

    <!-- Modals -->
    <div id="settings-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center opacity-0 hidden transition-opacity duration-300">
        <div class="bg-slate-900 p-6 rounded-2xl shadow-2xl border border-white/10 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="cpu" class="w-5 h-5 text-purple-400"></i> AI æ¨¡å‹è®¾ç½®</h3>
            <p class="text-slate-400 text-sm mb-4">æ¥å…¥ SiliconFlow (ç¡…åŸºæµåŠ¨) APIï¼Œä½¿ç”¨ DeepSeek/Qwen ç­‰æ¨¡å‹è·å¾—æ›´ç²¾å‡†çš„æ—¶é—´è¯†åˆ«å’Œ Emoji åŒ¹é…ã€‚</p>
            <div class="space-y-3">
                <div>
                    <label class="block text-xs text-slate-500 mb-1">API Key (sk-...)</label>
                    <input type="password" id="sf-api-key" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm focus:border-purple-500 outline-none" placeholder="sk-...">
                </div>
                <div>
                    <label class="block text-xs text-slate-500 mb-1">Model Name</label>
                    <input type="text" id="sf-model-name" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm focus:border-purple-500 outline-none" value="Qwen/Qwen2.5-7B-Instruct" placeholder="ä¾‹å¦‚: Qwen/Qwen2.5-7B-Instruct">
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeSettings()" class="px-4 py-2 text-slate-400 hover:text-white text-sm">å–æ¶ˆ</button>
                <button onclick="saveSettings()" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg text-sm font-bold">ä¿å­˜é…ç½®</button>
            </div>
        </div>
    </div>

    <div id="custom-alert-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center opacity-0 hidden transition-opacity duration-300">
        <div id="modal-content" class="bg-slate-900 p-8 rounded-2xl shadow-2xl border border-white/10 max-w-md w-full transform scale-95 transition-transform duration-300">
            <h3 id="alert-title" class="text-xl font-black mb-4 flex items-center gap-2 text-white"></h3>
            <p id="alert-message" class="text-slate-300 mb-6 leading-relaxed"></p>
            <div id="alert-actions" class="flex gap-3 mt-4">
                <button id="alert-secondary-btn" onclick="closeCustomAlert()" class="flex-1 bg-slate-700/50 hover:bg-slate-700 text-white font-semibold py-3 rounded-xl transition-colors">å–æ¶ˆ / å…³é—­</button>
                <button id="alert-primary-btn" onclick="closeCustomAlert()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-semibold py-3 rounded-xl transition-colors">æˆ‘æ˜ç™½äº†</button>
            </div>
        </div>
    </div>

    <div id="title-input-modal" class="fixed inset-0 bg-black/80 backdrop-blur-md z-50 flex items-center justify-center opacity-0 pointer-events-none transition-all duration-300">
        <div id="title-modal-panel" class="bg-slate-900/90 border border-blue-500/20 p-8 rounded-3xl w-full max-w-lg transform scale-95 opacity-0 transition-all duration-300">
            <h3 class="text-2xl font-black text-white mb-2 flex items-center gap-2"><i data-lucide="edit-3" class="w-6 h-6 text-blue-400"></i> ä¸ºè®¡åˆ’å‘½å</h3>
            <input type="text" id="plan-title-input" class="w-full bg-slate-950/50 border border-slate-700 rounded-xl px-5 py-4 text-white text-lg mt-4 focus:outline-none focus:border-blue-500 font-bold" placeholder="DeepFlow ä¸ªäººå­¦ä¹ è®¡åˆ’">
            <div class="flex justify-end gap-3 mt-8">
                <button onclick="cancelTitleModal()" class="px-6 py-3 text-slate-400 hover:text-white font-bold transition">å–æ¶ˆ</button>
                <button onclick="confirmTitleModal()" class="px-8 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold">å¼€å§‹ç”Ÿæˆ</button>
            </div>
        </div>
    </div>

    <!-- Result Modal (å®Œå…¨ç§»æ¤è‡ª Sample) -->
    <div id="resultModalOverlay" class="df-modal-overlay">
        <div class="df-modal-card">
            <div class="df-icon-circle"><i data-lucide="check" class="text-white w-8 h-8"></i></div>
            <h3 class="df-modal-title">è®¡åˆ’å·²ç”Ÿæˆ (Ready)</h3>
            <p class="df-modal-desc">æ‚¨çš„ DeepFlow è®¡åˆ’å·²å‡†å¤‡å°±ç»ªã€‚<br>è¯·æ ¹æ®è®¾å¤‡é€‰æ‹©æ‰“å¼€æ–¹å¼ã€‚</p>
            <div class="df-actions">
                <a id="previewButton" target="_blank" class="df-btn df-btn-primary">
                    <i data-lucide="eye" class="w-4 h-4"></i> <span>å®æ—¶é¢„è§ˆ (iOS Safari / ç”µè„‘æ¨è)</span>
                </a>
                <a id="downloadButton" class="df-btn df-btn-secondary">
                    <i data-lucide="download" class="w-4 h-4"></i> <span>ä¸‹è½½æ–‡ä»¶ (Android / ç”µè„‘æ¨è)</span>
                </a>
            </div>
            <button onclick="closeResultModal()" class="df-close">å…³é—­çª—å£</button>
        </div>
    </div>

    <script>
        // ============================================
        // å…¨å±€å˜é‡
        // ============================================
        let progressTimer = null;
let statusStepTimer = null;
        let currentMode = 'ai'; 
        let uploadedData = null; 
        let builderData = []; 
        let aiData = []; 
        let selectedTheme = null;
        let titlePromiseResolve = null;
        let aiParseTimeout = null;
        let recognition = null; // è¯­éŸ³è¯†åˆ«
        let isKeyBanned = false; 
        let useCloudEngine = true;
function startAIProgress(textLength) {
    const loader = document.getElementById('ai-loader');
    const bar = document.getElementById('ai-bar');
    const status = document.getElementById('ai-status');
    
    // 1. æ˜¾ç¤ºè¿›åº¦æ¡å®¹å™¨
    loader.classList.add('active');
    bar.classList.add('flowing'); // å¼€å¯æµå…‰ç‰¹æ•ˆ

    // 2. æ™ºèƒ½è®¡ç®—é¢„è®¡æ—¶é—´ (æ¨¡æ‹Ÿå¤§æ•°æ®å¤„ç†)
    // åŸºç¡€è€—æ—¶ 800msï¼Œæ¯10ä¸ªå­—å¢åŠ  100msï¼Œäº‘ç«¯æ¨¡å¼æ›´æ…¢ä¸€ç‚¹ä»¥æ˜¾çœŸå®
    let baseTime = 800 + (textLength / 10) * 100; 
    if (useCloudEngine) baseTime *= 1.5; // äº‘ç«¯ç¨å¾®æ…¢ç‚¹
    // é™åˆ¶æœ€é•¿ä¸è¶…è¿‡ 8ç§’ï¼Œæœ€çŸ­ä¸ä½äº 1ç§’
    const duration = Math.min(Math.max(baseTime, 1000), 8000);

    // 3. è¿›åº¦æ¡åŠ¨ç”»é€»è¾‘ (è´å¡å°”æ›²çº¿æ¨¡æ‹Ÿæ€è€ƒï¼šå¿« -> æ…¢ -> åœé¡¿)
    // é‡ç½®
    bar.style.width = '0%';
    bar.style.transition = 'none';
    
    // å¼ºåˆ¶é‡ç»˜
    bar.offsetHeight; 

    // é˜¶æ®µä¸€ï¼šè¿…é€Ÿå¯åŠ¨ (0% -> 20%)
    setTimeout(() => {
        bar.style.transition = 'width 0.3s ease-out';
        bar.style.width = '20%';
    }, 10);

    // é˜¶æ®µäºŒï¼šæ·±åº¦æ€è€ƒ (20% -> 85%) - æ ¹æ®å­—æ•°åŠ¨æ€å†³å®šé€Ÿåº¦
    setTimeout(() => {
        bar.style.transition = `width ${duration / 1000}s cubic-bezier(0.2, 0.8, 0.2, 1)`;
        bar.style.width = '85%';
    }, 300);

    // 4. çŠ¶æ€æ–‡æ¡ˆå¾ªç¯ (å¢åŠ ç§‘æŠ€æ„Ÿ)
    const steps = [
        "æ­£åœ¨è¯­ä¹‰åˆ†æ...", 
        "è¯†åˆ«æ—¶é—´æ„å›¾...", 
        "æ„å»ºç»“æ„åŒ–æ•°æ®...", 
        "æ ¡éªŒé€»è¾‘å†²çª..."
    ];
    let stepIdx = 0;
    
    // æ¸…é™¤æ—§å®šæ—¶å™¨
    if (statusStepTimer) clearInterval(statusStepTimer);
    
    statusStepTimer = setInterval(() => {
        if (stepIdx < steps.length) {
            status.innerText = steps[stepIdx];
            status.className = "text-[10px] bg-indigo-500/20 text-indigo-300 px-2 py-1 rounded border border-indigo-500/30 animate-pulse transition-all";
            stepIdx++;
        }
    }, duration / 4); // æ ¹æ®æ€»æ—¶é•¿å¹³å‡åˆ†é…æ–‡æ¡ˆåˆ‡æ¢é€Ÿåº¦
}

function stopAIProgress(success = true) {
    const loader = document.getElementById('ai-loader');
    const bar = document.getElementById('ai-bar');
    const status = document.getElementById('ai-status');

    // æ¸…é™¤å¾ªç¯æ–‡æ¡ˆ
    if (statusStepTimer) clearInterval(statusStepTimer);

    // é˜¶æ®µä¸‰ï¼šç¬é—´å®Œæˆ (85% -> 100%)
    bar.style.transition = 'width 0.3s ease-in-out';
    bar.style.width = '100%';

    setTimeout(() => {
        // éšè—å¹¶é‡ç½®
        loader.classList.remove('active');
        setTimeout(() => { 
            bar.style.width = '0%'; 
            bar.classList.remove('flowing');
        }, 300);
        
        // æ›´æ–°æœ€ç»ˆçŠ¶æ€æ–‡å­—
        if (success) {
            status.innerText = "ç”Ÿæˆå®Œæ¯•";
            status.className = "text-[10px] bg-emerald-500/20 text-emerald-400 px-2 py-1 rounded border border-emerald-500/30";
        } else {
            status.innerText = "è¯†åˆ«å¤±è´¥";
            status.className = "text-[10px] bg-red-500/20 text-red-400 px-2 py-1 rounded border border-red-500/30";
        }
    }, 400); // ç­‰å¾…è¿›åº¦æ¡è·‘æ»¡åå†éšè—
}
        // ============================================
        // Settings Logic (è®¾ç½®é€»è¾‘)
        // ============================================
        function openSettings() {
            document.getElementById('sf-api-key').value = localStorage.getItem('deepflow_sk') || '';
            document.getElementById('sf-model-name').value = localStorage.getItem('deepflow_model') || 'Qwen/Qwen2.5-7B-Instruct';
            const m = document.getElementById('settings-modal');
            m.classList.remove('hidden'); setTimeout(()=>m.classList.remove('opacity-0'),10);
        }
        function closeSettings() {
            const m = document.getElementById('settings-modal');
            m.classList.add('opacity-0'); setTimeout(()=>m.classList.add('hidden'),300);
        }
        function saveSettings() {
            localStorage.setItem('deepflow_sk', document.getElementById('sf-api-key').value.trim());
            localStorage.setItem('deepflow_model', document.getElementById('sf-model-name').value.trim());
            closeSettings();
            customAlert("é…ç½®å·²ä¿å­˜ï¼Œä¸‹æ¬¡è¾“å…¥å°†ä½¿ç”¨ AI æ¨¡å‹ï¼", "è®¾ç½®æˆåŠŸ", "cpu");
        }
        // === æ ¸å¿ƒä¿®å¤ï¼šåˆ‡æ¢å¼•æ“ (å¢åŠ çŠ¶æ€ä¿å­˜) ===
function toggleEngineMode() {
    useCloudEngine = !useCloudEngine;
    
    // 1. ä¿å­˜çŠ¶æ€
    localStorage.setItem('deepflow_engine_pref', useCloudEngine ? 'cloud' : 'local');

    // 2. æ›´æ–° UI
    updateEngineUISync();
    
    // 3. ã€é‡è¦ã€‘åˆ‡æ¢å¼•æ“æ—¶ï¼Œå¼ºåˆ¶æ¸…ç©ºè®°å¿†ï¼Œç¡®ä¿ç«‹å³é‡æ–°è§£æ
    lastAnalyzedText = null; 
    
    // 4. è§¦å‘è§£æ
    ai_handleInput();
}
        // ============================================
        // V18 æ–°å¢ï¼šæ‰‹æœºç«¯ä½“éªŒåˆå§‹åŒ– (å«éº¦å…‹é£ç‚¹å‡»ä¿®å¤)
        // ============================================
        function initMobileExperience() {
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                // 1. å¼ºåˆ¶åˆ‡æ¢åˆ° AI æ¨¡å¼
                switchMode('ai');
                
                const aiInput = document.getElementById('ai-input');
                const voiceBtn = document.getElementById('voice-btn');

                // 2. ä¼˜åŒ–è¾“å…¥æ¡†ä½“éªŒ (èšç„¦æ—¶æ»šåŠ¨)
                aiInput.placeholder = "ç‚¹è¿™é‡Œè¾“å…¥ï¼Œæˆ–è€…ç‚¹å³ä¸‹è§’è¯ç­’è¯´è¯...\nä¾‹å¦‚ï¼šæ˜å¤©å…«ç‚¹èµ·åºŠï¼Œä¹ç‚¹èƒŒå•è¯ã€‚";
                aiInput.addEventListener('focus', () => {
                    setTimeout(() => {
                        aiInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                });

                // === 3. æ ¸å¿ƒä¿®å¤ï¼šç‚¹å‡»éº¦å…‹é£ä¸æŠ˜å  ===
                if (voiceBtn) {
                    // å®šä¹‰ä¸€ä¸ªé˜»æ­¢å¤±ç„¦çš„å‡½æ•°
                    const handleVoiceClick = (e) => {
                        // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼ˆå³é˜»æ­¢è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹ï¼‰
                        e.preventDefault(); 
                        e.stopPropagation();
                        
                        // è§¦å‘å½•éŸ³é€»è¾‘
                        toggleVoiceInput();
                        
                        // å¼ºåˆ¶æŠŠç„¦ç‚¹è¿˜ç»™è¾“å…¥æ¡†ï¼ˆåŒé‡ä¿é™©ï¼‰
                        aiInput.focus();
                    };

                    // å…ˆç§»é™¤ HTML é‡Œçš„ onclickï¼Œé˜²æ­¢å†²çª
                    voiceBtn.removeAttribute('onclick');
                    
                    // ç»‘å®šè§¦æ‘¸å’Œç‚¹å‡»äº‹ä»¶
                    voiceBtn.addEventListener('touchstart', handleVoiceClick, { passive: false });
                    voiceBtn.addEventListener('mousedown', handleVoiceClick);
                }

                // 4. åˆå§‹åŒ–è¯­éŸ³èƒ½åŠ›
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    initVoiceRecognition();
                }
            }
        }

        // V18 æ–°å¢ï¼šè¯­éŸ³è¾“å…¥é€»è¾‘
        function initVoiceRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = false;
            recognition.interimResults = false;

            // 1. å¼€å§‹å½•éŸ³æ—¶ï¼šå›¾æ ‡å˜å£°æ³¢ï¼Œæç¤ºâ€œæ­£åœ¨å¬â€
            recognition.onstart = () => {
                const btn = document.getElementById('voice-btn');
                btn.classList.add('voice-recording'); // ä¿æŒåŸæœ‰çš„çº¢è‰²å‘¼å¸ç¯æ•ˆæœ
                
                // === ä¿®æ”¹ç‚¹åœ¨è¿™é‡Œï¼šæŠŠ 'mic-off' æ”¹æˆäº† 'audio-lines' (å£°æ³¢) ===
                btn.innerHTML = '<i data-lucide="audio-lines" class="w-5 h-5 animate-pulse"></i>';
                
                lucide.createIcons();
                document.getElementById('ai-input').placeholder = "æ­£åœ¨å¬...";
            };

            // 2. ç»“æŸå½•éŸ³æ—¶ï¼šå›¾æ ‡å˜å›è¯ç­’
            recognition.onend = () => {
                const btn = document.getElementById('voice-btn');
                btn.classList.remove('voice-recording');
                
                // å˜å›æ™®é€šè¯ç­’
                btn.innerHTML = '<i data-lucide="mic" class="w-5 h-5"></i>';
                
                lucide.createIcons();
                document.getElementById('ai-input').placeholder = "ç‚¹è¿™é‡Œè¾“å…¥ï¼Œæˆ–è€…ç‚¹å³ä¸‹è§’è¯ç­’è¯´è¯...";
                
                // å¼ºåˆ¶è®©è¾“å…¥æ¡†ä¿æŒå±•å¼€ (é˜²æ­¢å½•å®ŒéŸ³çªç„¶æŠ˜å )
                document.getElementById('ai-input').focus();
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                const input = document.getElementById('ai-input');
                // è¿½åŠ æ–‡æœ¬è€Œä¸æ˜¯è¦†ç›–
                input.value = input.value ? input.value + '\n' + transcript : transcript;
                ai_handleInput(); // è§¦å‘è§£æ
            };
            
            // å¢åŠ å®¹é”™ï¼šå¦‚æœå‘ç”Ÿé”™è¯¯ä¹Ÿé‡ç½®å›¾æ ‡
            recognition.onerror = (event) => {
                console.error("è¯­éŸ³è¯†åˆ«é”™è¯¯:", event.error);
                recognition.stop(); // æ‰‹åŠ¨è§¦å‘ onend é‡ç½®å›¾æ ‡
            };
        }

        function toggleVoiceInput() {
            if (!recognition) return;
            try { recognition.start(); } catch (e) { recognition.stop(); }
        }

        // ============================================
        // æ¨¡å—1ï¼šAI æ™ºèƒ½è§£æå†…æ ¸ (V27 æ ¸å¿ƒå‡çº§ï¼šå®Œæ•´æ—¥æœŸç®—æœ¯)
        // ============================================
        
        // ============================================
        // æ¨¡å—1ï¼šAI æ™ºèƒ½è§£æå†…æ ¸ (V36 - Ultimate: æ·±åº¦è¯­ä¹‰ç†è§£ä¿®å¤ç‰ˆ)
        // ============================================

        // --- 1. åŸºç¡€æ˜ å°„è¡¨ ---
        const CHINESE_NUMBER_MAP = {
            'é›¶': 0, 'ã€‡': 0, 'ï¼': 0, 'ä¸€': 1, 'å£¹': 1, 'ï¼‘': 1, 'äºŒ': 2, 'ä¸¤': 2, 'è´°': 2, 'ï¼’': 2, 
            'ä¸‰': 3, 'å': 3, 'ï¼“': 3, 'å››': 4, 'è‚†': 4, 'ï¼”': 4, 'äº”': 5, 'ä¼': 5, 'ï¼•': 5, 
            'å…­': 6, 'é™†': 6, 'ï¼–': 6, 'ä¸ƒ': 7, 'æŸ’': 7, 'ï¼—': 7, 'å…«': 8, 'æŒ': 8, 'ï¼˜': 8, 
            'ä¹': 9, 'ç–': 9, 'ï¼™': 9, 'å': 10, 'æ‹¾': 10, 'åä¸€': 11, 'åäºŒ': 12, 'åä¸‰': 13, 
            'åå››': 14, 'åäº”': 15, 'åå…­': 16, 'åä¸ƒ': 17, 'åå…«': 18, 'åä¹': 19, 'äºŒå': 20, 
            'äºŒåä¸€': 21, 'äºŒåäºŒ': 22, 'äºŒåä¸‰': 23, 'äºŒåå››': 24, 'ä¸‰å': 30, 'ä¸‰åä¸€': 31,
            'åŠ': 0.5, 'å‡ ': 5 
        };
        const SPECIAL_TIME_EXPRESSIONS = { 'åŠ': 30, 'ä¸€åˆ»': 15, 'ä¸‰åˆ»': 45, 'æ•´': 0, 'æ­£': 0 };
        const TIME_PERIOD_MAP = { 
            'å‡Œæ™¨': 0, 'æ—©æ™¨': 5, 'æ—©ä¸Š': 6, 'æ˜æ—©': 8, 'ä¸Šåˆ': 8, 
            'ä¸­åˆ': 12, 'æ™Œåˆ': 12, 'ä¸‹åˆ': 13, 'å‚æ™š': 17, 
            'æ™šä¸Š': 18, 'å¤œé‡Œ': 20, 'åˆå¤œ': 23 
        };

        // --- 2. æ—¥æœŸè®¡ç®—è¾…åŠ©å‡½æ•° (è¿™é‡Œæ˜¯ä¹‹å‰ç¼ºå¤±çš„å…³é”®éƒ¨åˆ†ï¼) ---
        
        // è·å–æ±‰å­—å¯¹åº”çš„æ˜ŸæœŸæ•°å­— (1-7, æ—¥=7)
        function getCnDayIndex(char) {
            const map = {'ä¸€':1, 'äºŒ':2, 'ä¸‰':3, 'å››':4, 'äº”':5, 'å…­':6, 'æ—¥':7, 'å¤©':7};
            return map[char] || 0;
        }

        // è®¡ç®—ç›®æ ‡å‘¨å‡ åœ¨ baseDate æ‰€åœ¨çš„åŒä¸€å‘¨æ˜¯å“ªä¸€å¤© (å‘¨ä¸€ä¸ºå§‹)
        function getDateInSameWeek(baseDate, targetDayIndex) {
            const d = new Date(baseDate);
            const currentDayIndex = d.getDay() || 7; // 0æ˜¯å‘¨æ—¥, è½¬ä¸º7
            d.setDate(d.getDate() - (currentDayIndex - 1)); // å›åˆ°å‘¨ä¸€
            d.setDate(d.getDate() + (targetDayIndex - 1)); // åŠ åç§»
            d.setHours(0,0,0,0);
            return d;
        }

        // è®¡ç®—åŸºäºä»Šå¤©çš„â€œä¸‹ä¸‹å‘¨Xâ€ (weekOffset: 0=æœ¬å‘¨, 1=ä¸‹å‘¨, 2=ä¸‹ä¸‹å‘¨)
        function calculateFutureWeekDate(targetDayIndex, weekOffset) {
            const now = new Date();
            const todayIndex = now.getDay() || 7;
            let targetDate = new Date();
            targetDate.setDate(now.getDate() - (todayIndex - 1) + (targetDayIndex - 1)); // æœ¬å‘¨è¯¥æ—¥
            targetDate.setDate(targetDate.getDate() + (weekOffset * 7)); // åŠ ä¸Šå‘¨åç§»
            targetDate.setHours(0,0,0,0);
            return targetDate;
        }

        // æ™ºèƒ½å‘¨è§£æå™¨ (è¿”å›å…ƒæ•°æ®)
        function parseSmartWeekDate(text) {
            // å¼ºåŒ¹é…ï¼šæ˜ç¡®å¸¦æœ‰â€œä¸‹â€ã€â€œæœ¬â€ã€â€œè¿™â€ç­‰ä¿®é¥°è¯
            const strongRegex = /((?:å¤§|ä¸‹|ä¸ª|æœ¬|è¿™)+)\s*(?:å‘¨|æ˜ŸæœŸ|ç¤¼æ‹œ)([ä¸€äºŒä¸‰å››äº”å…­æ—¥å¤©])/;
            // å¼±åŒ¹é…ï¼šåªæœ‰â€œå‘¨å‡ â€
            const weakRegex = /^(?:å‘¨|æ˜ŸæœŸ|ç¤¼æ‹œ)([ä¸€äºŒä¸‰å››äº”å…­æ—¥å¤©])/;

            let match = text.match(strongRegex);
            if (match) {
                const modifier = match[1]; 
                const dayChar = match[2];
                const dayIndex = getCnDayIndex(dayChar);
                
                // è®¡ç®—â€œä¸‹â€çš„æ•°é‡
                let xiaCount = (modifier.match(/ä¸‹/g) || []).length;
                if (modifier.includes('å¤§')) xiaCount += 2; 
                
                return {
                    type: 'strong', // å¼ºä¸Šä¸‹æ–‡ä¿¡å·
                    date: calculateFutureWeekDate(dayIndex, xiaCount),
                    matchStr: match[0],
                    dayIndex: dayIndex
                };
            }

            match = text.match(weakRegex);
            if (match) {
                return {
                    type: 'weak', // å¼±ä¿¡å·ï¼Œéœ€è¦ä¾èµ–ä¸Šä¸‹æ–‡
                    dayIndex: getCnDayIndex(match[1]),
                    matchStr: match[0]
                };
            }
            return null;
        }

        // ç›¸å¯¹å¤©æ•°è§£æ (3å¤©å, ç¬¬5å¤©)
        function parseDaysExpression(text) {
            const afterMatch = text.match(/([0-9é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+)\s*å¤©[ä»¥ä¹‹]?[åå¾Œ]/);
            if (afterMatch) return { type: 'after', days: parseChineseOrArabic(afterMatch[1]) };
            const dayMatch = text.match(/(?:ç¬¬|Day|D)\s*([0-9é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+)\s*(?:å¤©|æ—¥)?/i);
            if (dayMatch) return { type: 'sequence', days: parseChineseOrArabic(dayMatch[1]) };
            return null;
        }

        // å…¼å®¹æ—§é€»è¾‘çš„æ—¥æœŸè¯æå– (ç”¨äº ai_deleteTask)
        function extractLineDateWord(line) {
            line = line.trim();
            if (!line) return "";
            const daysExpr = line.match(/([0-9é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+)\s*å¤©[ä»¥ä¹‹]?[åå¾Œ]/);
            if(daysExpr) return daysExpr[0];
            const seqExpr = line.match(/(?:ç¬¬|Day|D)\s*([0-9é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+)\s*(?:å¤©|æ—¥)?/i);
            if(seqExpr) return seqExpr[0];
            const keywordMatch = line.match(/^(å¤§åå¤©|åå¤©|æ˜å¤©|æ˜å„¿|ä»Šå¤©)/);
            if(keywordMatch) return keywordMatch[0];
            return "";
        }

        // --- 3. æ ¸å¿ƒè§£æé€»è¾‘ ---

        // é€šç”¨æ•°å­—è§£æ
        function parseChineseOrArabic(str) {
            if (!str) return 0;
            str = str.toString().trim();
            if (/^\d+(\.\d+)?$/.test(str)) return parseFloat(str);
            if (CHINESE_NUMBER_MAP[str] !== undefined) return CHINESE_NUMBER_MAP[str];
            if (str.startsWith('å')) return 10 + (CHINESE_NUMBER_MAP[str.substring(1)] || 0);
            if (str.startsWith('äºŒå')) return 20 + (CHINESE_NUMBER_MAP[str.substring(2)] || 0);
            if (str.startsWith('ä¸‰å')) return 30 + (CHINESE_NUMBER_MAP[str.substring(2)] || 0);
            return 0; 
        }

        // æ—¶é•¿è§£æ
        function parseDuration(text) {
            const bracketRegex = /[\(\[ï¼ˆ]\s*([0-9\.\dé›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åä¸¤åŠå‡ ]+)\s*(å°æ—¶|ä¸ªé’Ÿ|é’Ÿå¤´|h|hr|åˆ†é’Ÿ|åˆ†|min|m)\s*[\)\]ï¼‰]/i;
            let match = text.match(bracketRegex);
            let isBracket = true;

            if (!match) {
                isBracket = false;
                const normalRegex = /([0-9\.\dé›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åä¸¤åŠå‡ ]+)\s*(å°æ—¶|ä¸ªé’Ÿ|é’Ÿå¤´|h|hr|åˆ†é’Ÿ|åˆ†|min|m)(?:\s*[ä¹‹ä»¥]?[åå¾Œ])?/i;
                match = text.match(normalRegex);
            }

            if (!match) return null;

            const numStr = match[1];
            const unit = match[2].toLowerCase();
            const fullMatchStr = match[0];
            const isRelative = !isBracket && (fullMatchStr.includes('å') || fullMatchStr.includes('å¾Œ'));

            let val = parseChineseOrArabic(numStr);
            let totalMinutes = 0;

            if (['å°æ—¶', 'ä¸ªé’Ÿ', 'é’Ÿå¤´', 'h', 'hr'].includes(unit)) totalMinutes = val * 60;
            else totalMinutes = val;

            return { minutes: Math.round(totalMinutes), matchStr: fullMatchStr, isRelative: isRelative };
        }

        // æ—¶é—´ç‚¹è§£æ
        function parseChineseTimeString(input) {
            let text = input.trim();
            let shiftDay = 0; 

            if (text.includes('æ˜æ—©')) { shiftDay = 1; text = text.replace('æ˜æ—©', 'æ—©ä¸Š'); } 
            else if (text.includes('æ˜å¤©')) { shiftDay = 1; }

            text = text.replace(/(\d+)\.(\d+)/, '$1:$2');

            let hour = -1, minute = 0;
            let type = 'fuzzy';

            const arabicMatch = text.match(/(\d{1,2})[:ç‚¹ï¼š\s]*(\d{1,2}|åŠ|åˆ»|æ•´)?/);
            if (arabicMatch) {
                hour = parseInt(arabicMatch[1]);
                const minStr = arabicMatch[2];
                if (minStr === 'åŠ') minute = 30;
                else if (minStr === 'åˆ»') minute = 15;
                else if (minStr) minute = parseInt(minStr);
                type = 'specific';
            } else {
                const cnMatch = text.match(/([é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åä¸¤]+)ç‚¹(åŠ|åˆ»|([é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åä¸¤]+))?/);
                if (cnMatch) {
                    hour = parseChineseOrArabic(cnMatch[1]);
                    const minPart = cnMatch[2];
                    if (minPart === 'åŠ') minute = 30;
                    else if (minPart === 'åˆ»') minute = 15;
                    else if (cnMatch[3]) minute = parseChineseOrArabic(cnMatch[3]);
                    type = 'specific';
                }
            }

            if (hour !== -1) {
                if (hour < 12 && /ä¸‹åˆ|æ™šä¸Š|å‚æ™š|å¤œé‡Œ/.test(text)) hour += 12;
                else if (hour < 12 && (/ä¸­åˆ|æ™Œåˆ/.test(text)) && hour === 1) hour += 12; 
                else if (hour === 12 && /å‡Œæ™¨|æ—©æ™¨|æ—©ä¸Š/.test(text)) hour = 0;
            } else {
                for (const [key, val] of Object.entries(TIME_PERIOD_MAP)) {
                    if (text.includes(key)) return { formatted: key, type: 'fuzzy', shiftDay: shiftDay }; 
                }
                return null;
            }

            return { formatted: `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`, type: 'specific' };
        }
let lastAnalyzedText = ""; 

function ai_handleInput() {
    const text = document.getElementById('ai-input').value;
    const status = document.getElementById('ai-status');
    const confirmBtn = document.getElementById('ai-confirm-btn');
    const mobileConfirmBtn = document.getElementById('mobile-confirm-btn');

    // 1. æŒ‰é’®è§£é”é€»è¾‘ (ä¿æŒä¸å˜)
    const toggleBtns = (enable) => {
        [confirmBtn, mobileConfirmBtn].forEach(btn => {
            if(!btn) return;
            if (enable) {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                // æ¢å¤ä¸ºç¡®è®¤çŠ¶æ€
                if(btn.innerText.includes('é”å®š')) {
                    btn.innerHTML = btn.id.includes('mobile') ? '<i data-lucide="check-circle" class="w-4 h-4"></i> ç¡®è®¤è®¡åˆ’' : '<i data-lucide="check" class="w-3 h-3"></i> ç¡®è®¤è®¡åˆ’';
                    btn.classList.add('bg-emerald-600', 'hover:bg-emerald-500');
                    btn.classList.remove('bg-slate-600', 'cursor-default');
                }
            } else {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        });
        lucide.createIcons();
    };

    // 2. ç©ºè¾“å…¥å¤„ç† (ä¿æŒä¸å˜)
    if (!text.trim()) {
        document.getElementById('ai-timeline-container').innerHTML = `<div class="flex flex-col items-center justify-center h-full text-slate-600 opacity-60"><i data-lucide="message-square-dashed" class="w-12 h-12 mb-3"></i><p class="text-xs">åœ¨å·¦ä¾§è¾“å…¥æ–‡å­—<br>å³ä¾§å°†å®æ—¶æ˜¾ç¤ºè§£æç»“æœ</p></div>`;
        status.innerText = "ç­‰å¾…è¾“å…¥";
        status.className = "text-[10px] bg-blue-500/20 text-blue-400 px-2 py-1 rounded border border-blue-500/30";
        aiData = [];
        lastAnalyzedText = ""; // é‡ç½®è®°å¿†
        toggleBtns(false);
        updateSummary();
        return;
    }

    // --- æ™ºèƒ½é˜²é‡å¤ï¼šå¦‚æœæ–‡å­—æ²¡å˜ï¼Œä¸”å·²ç»æœ‰æ•°æ®ï¼Œç»å¯¹ä¸é‡æ–°è¯·æ±‚ ---
    if (text === lastAnalyzedText && aiData.length > 0) {
        return; 
    }

    // 3. çŠ¶æ€æŒ‡ç¤º (ä»…è®¾ç½®ä¸€ä¸ªåˆå§‹åŠ¨ç”»çŠ¶æ€ï¼Œå…·ä½“æ–‡æœ¬äº¤ç»™ startAIProgress)
    status.innerText = "åˆ†æä¸­...";
    status.className = "text-[10px] bg-yellow-500/20 text-yellow-400 px-2 py-1 rounded border border-yellow-500/30 animate-pulse";

    // 4. é˜²æŠ–è®¡æ—¶å™¨
    if (aiParseTimeout) clearTimeout(aiParseTimeout);

    // æ™ºèƒ½å»¶è¿Ÿï¼šAI æ¨¡å¼ç­‰å¾… 1.2ç§’ (ç”¨æˆ·åœç¬”åå†è¯·æ±‚ï¼ŒçœToken)ï¼Œæœ¬åœ°æ¨¡å¼ 0.3ç§’
    const delay = useCloudEngine ? 1200 : 300;

    aiParseTimeout = setTimeout(async () => {
        // â­ã€å…³é”®ä¿®æ­£ï¼šåœ¨è¿™é‡Œå¼€å§‹è¿›åº¦æ¡ã€‘
        startAIProgress(text.length);

        try {
            const apiKey = localStorage.getItem('deepflow_sk');
            let isLocalFallback = false;
            let newData = []; // ä¸´æ—¶å­˜æ”¾æ–°æ•°æ®

            // === é€»è¾‘åˆ†æ”¯ ===
            if (!useCloudEngine || !apiKey || window.isKeyBanned) {
                // æœ¬åœ°æ¨¡å¼
                newData = ai_parseText(text);
                isLocalFallback = true;
            } else {
                // AI æ¨¡å¼
                try {
                    // startAIProgress å·²ç»å¤„ç†äº†æ€è€ƒä¸­çš„çŠ¶æ€æ–‡æœ¬
                    newData = await callSiliconFlow(text, apiKey);
                } catch (err) {
                    console.error("AI Error:", err);
                    if (err.message === "AUTH_FAILED") {
                        handleApiKeyFailure("API Key æ— æ•ˆæˆ–è¿‡æœŸ");
                        return;
                    } 
                    // ç½‘ç»œé”™è¯¯å¤„ç†
                    status.innerText = "è¿æ¥å¤±è´¥";
                    status.className = "text-[10px] bg-red-500/20 text-red-400 px-2 py-1 rounded border border-red-500/30";
                    return; 
                }
            }

            // 5. åªæœ‰æˆåŠŸè·å–åˆ°æ–°æ•°æ®åï¼Œæ‰æ›´æ–°ç•Œé¢ï¼
            const validData = newData.filter(d => d.tasks && d.tasks.length > 0);

            if (validData.length === 0) {
                // è¿›åº¦æ¡ç»“æŸï¼ˆå¤±è´¥çŠ¶æ€ï¼‰
                stopAIProgress(false); 
                
                status.innerText = "æœªè¯†åˆ«åˆ°ä»»åŠ¡";
                status.className = "text-[10px] bg-slate-500/20 text-slate-400 px-2 py-1 rounded border border-slate-500/30";

            } else {
                // === æˆåŠŸæ›´æ–° ===
                aiData = validData; // æ›¿æ¢å…¨å±€æ•°æ®
                lastAnalyzedText = text; // è®°ä½è¿™æ®µæ–‡å­—ï¼Œé˜²æ­¢é‡å¤è¯·æ±‚
                
                // â­ã€å…³é”®ä¿®æ­£ï¼šè¿›åº¦æ¡ç»“æŸ + æ¸²æŸ“ã€‘
                stopAIProgress(true); // æˆåŠŸç»“æŸè¿›åº¦æ¡åŠ¨ç”»
                ai_renderPreview(aiData); // æ¸²æŸ“é¢„è§ˆ
                toggleBtns(true); // è§£é”æŒ‰é’®
                
                // æ›´æ–°çŠ¶æ€æ é¢œè‰² (æ”¾åœ¨è¿›åº¦æ¡ç»“æŸåï¼Œé¿å…è¢«è¿›åº¦æ¡å†…éƒ¨çš„æˆåŠŸæç¤ºè¦†ç›–)
                if (isLocalFallback) {
                    status.innerText = "æœ¬åœ°æé€Ÿè§£æ";
                    status.className = "text-[10px] bg-emerald-500/20 text-emerald-400 px-2 py-1 rounded border border-emerald-500/30";
                } else {
                    status.innerText = "AI æ·±åº¦è§£æ";
                    status.className = "text-[10px] bg-blue-500/20 text-blue-400 px-2 py-1 rounded border border-blue-500/30";
                }
            }

        } catch (e) {
            console.warn("æµç¨‹å¼‚å¸¸:", e);
            // ç¡®ä¿é”™è¯¯æ—¶ä¹Ÿåœæ­¢è¿›åº¦æ¡
            stopAIProgress(false);
            
        } finally {
            updateSummary();
        }
    }, delay);
}
        // --- æ–°å¢ï¼šAPI Key è®¤è¯å¤±è´¥å¤„ç† ---
function handleApiKeyFailure(errorMessage) {
    // å…³é”®ä¿®æ­£ï¼šè®¾ç½®ç¦ç”¨æ ‡è®°ï¼Œç¡®ä¿åç»­è¾“å…¥ä¸å†å°è¯•è°ƒç”¨ API
    window.isKeyBanned = true; // å³ä½¿ä¸æ¸…é™¤ Keyï¼Œä¹Ÿç¦ç”¨ API è°ƒç”¨ï¼Œé¿å…å¾ªç¯å¼¹çª—
    
    // 1. å¼¹å‡ºè­¦å‘Šå¹¶æä¾›æ¸…é™¤é€‰é¡¹
    const m = document.getElementById('custom-alert-modal');
    document.getElementById('alert-message').innerHTML = errorMessage + 
        '<br><br>ç³»ç»Ÿå·²è‡ªåŠ¨ç¦ç”¨ AI å¼•æ“ï¼ˆæœ¬æ¬¡ä¼šè¯æœ‰æ•ˆï¼‰ã€‚<br>è¯·é€‰æ‹©ï¼š<br>1. æ¸…é™¤ Key å¼ºåˆ¶ä½¿ç”¨æœ¬åœ°æ­£åˆ™ã€‚<br>2. ç»§ç»­ä½¿ç”¨æœ¬åœ°è§£æã€‚';
    document.getElementById('alert-title').innerHTML = `<i data-lucide="alert-triangle" class="w-5 h-5"></i> æˆæƒå¤±è´¥ / AI å·²ç¦ç”¨`;
    
    // 2. æ¥ç®¡å’Œé…ç½®æŒ‰é’®
    const primaryBtn = document.getElementById('alert-primary-btn'); // è“è‰²æŒ‰é’®
    const secondaryBtn = document.getElementById('alert-secondary-btn'); // ç°è‰²æŒ‰é’®
    
    // Primary Button: æ¸…é™¤ Keyï¼ˆæ¨èæ“ä½œï¼‰
    primaryBtn.textContent = 'æ¸…é™¤æ— æ•ˆ Key';
    primaryBtn.onclick = clearAndFallback;
    primaryBtn.classList.add('bg-purple-600', 'hover:bg-purple-500'); // æ”¹ç”¨ç´«è‰²çªå‡ºé‡è¦æ€§
    primaryBtn.classList.remove('bg-blue-600', 'hover:bg-blue-500');
    
    // Secondary Button: å…³é—­å¼¹çª—ï¼Œä»…ç»§ç»­å›é€€ï¼ˆä¸æ¸…é™¤ Keyï¼‰
    secondaryBtn.textContent = 'ç»§ç»­ä½¿ç”¨æœ¬åœ°è§£æ';
    // æ³¨æ„ï¼šå…³é—­å¼¹çª—åï¼ŒisKeyBanned=true ä¼šè‡ªåŠ¨ç”Ÿæ•ˆï¼Œç³»ç»Ÿç›´æ¥èµ°æ­£åˆ™
    secondaryBtn.onclick = closeCustomAlert; 

    lucide.createIcons();
    m.classList.remove('hidden'); 
    setTimeout(() => m.classList.remove('opacity-0'), 10);
}

// --- æ–°å¢ï¼šæ¸…é™¤ Key å¹¶å›é€€åˆ°æœ¬åœ°æ¨¡å¼ ---
function clearAndFallback() {
    localStorage.removeItem('deepflow_sk');
    window.isKeyBanned = false; // <<< ä¿®æ­£ï¼šæ¸…é™¤ Key æ—¶ï¼Œé‡ç½®ç¦ç”¨æ ‡è®°
    closeCustomAlert();
    
    // å¼ºåˆ¶åˆ·æ–°è¾“å…¥æ¡†ï¼Œé‡æ–°è§¦å‘è§£æï¼ˆæ­¤æ—¶ä¼šèµ°æœ¬åœ°æ­£åˆ™ï¼‰
    ai_handleInput();
    
    // å†æ¬¡æé†’ç”¨æˆ·æœ¬åœ°è§£æçš„è¾“å…¥æ ¼å¼
    customAlert(
        "å·²æ¸…é™¤ API Keyã€‚å½“å‰ä¸º**æœ¬åœ°æ­£åˆ™è§£ææ¨¡å¼**ã€‚<br><br>è¯·ä½¿ç”¨**ä¸¥æ ¼**æ ¼å¼ï¼š<br>ä¾‹å¦‚ï¼š`å‘¨ä¸‰8ç‚¹èƒŒå•è¯ 60åˆ†é’Ÿ`", 
        "æ¨¡å¼åˆ‡æ¢æˆåŠŸ", 
        "layout-list"
    );
}
        // --- æ ¸å¿ƒä¿®å¤ï¼šSiliconFlow AI æ¥å£è°ƒç”¨ (V42 - åˆ‘æ³•çº§ä¸¥å‰ç‰ˆ) ---
async function callSiliconFlow(userText, apiKey) {
    const model = localStorage.getItem('deepflow_model') || 'deepseek-ai/DeepSeek-V3';
    
    // ==========================================
    // 1. ç²¾å‡†çš„æ—¶é—´é”šå®š (ç®—æ­»å®ƒï¼Œä¸ç»™å®ƒççŒœçš„æœºä¼š)
    // ==========================================
    const now = new Date();
    const currentYear = now.getFullYear();
    const todayStr = now.toISOString().split('T')[0]; 
    
    // è·å–å½“å‰æ˜ŸæœŸå‡  (0-6, è½¬ä¸º 1-7, å‘¨æ—¥=7)
    const dayIndex = now.getDay() || 7; 
    const weekDaysCN = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
    const currentWeekStr = "å‘¨" + weekDaysCN[now.getDay()];

    // è®¡ç®—å…³é”®é”šç‚¹æ—¥æœŸ
    // æœ¬å‘¨ä¸€
    const mondayThisWeek = new Date(now);
    mondayThisWeek.setDate(now.getDate() - dayIndex + 1);
    
    // ä¸‹å‘¨ä¸€
    const mondayNextWeek = new Date(mondayThisWeek);
    mondayNextWeek.setDate(mondayThisWeek.getDate() + 7);
    
    // ä¸‹ä¸‹å‘¨ä¸€
    const mondayNextNextWeek = new Date(mondayThisWeek);
    mondayNextNextWeek.setDate(mondayThisWeek.getDate() + 14);

    // ==========================================
    // 2. åˆ‘æ³•çº§ System Prompt (ä¸“æ²»å„ç§ä¸æœ)
    // ==========================================
    const systemPrompt = `
    Role: You are a strict Chinese Schedule Parser. NO HALLUCINATIONS.
    
    # ğŸŒ TIME ANCHOR (ABSOLUTE TRUTH)
    - **Current Time**: ${todayStr} (${currentWeekStr}).
    - **Logic Base (Week 0 Start)**: ${mondayThisWeek.toISOString().split('T')[0]}.
    - **Next Week (Week 1 Start)**: ${mondayNextWeek.toISOString().split('T')[0]}.
    - **Week After Next (Week 2 Start)**: ${mondayNextNextWeek.toISOString().split('T')[0]}.

    # âš¡ï¸ CORE LOGIC RULES (MUST FOLLOW)
    1. **The "Forward-Looking" Rule (CRITICAL)**:
       - If user says a weekday (e.g., "å‘¨å…­") that is earlier in the week or strictly passed, **IT MEANS NEXT WEEK**.
       - Example: Today is Sunday (${todayStr}). User says "å‘¨å…­".
       - WRONG: Yesterday (Past).
       - CORRECT: The coming Saturday (${new Date(mondayNextWeek.getTime() + 5*86400000).toISOString().split('T')[0]}).
       - NEVER generate tasks for dates in the past.

    2. **Dialect & Slang Translation**:
       - "æ˜å„¿/æ˜å¤©" = Today + 1 day.
       - "åå„¿/åå¤©" = Today + 2 days.
       - "å¤§åå„¿/å¤§åå¤©" = Today + 3 days.
       - "ä¸€å®¿/é€šå®µ" -> Duration: 480 mins (8 hours) or set time 22:00-06:00.
       - "ä¸‹åˆä¸‰ç‚¹åŠ" -> 15:30.
       - "æ™šä¸Šå…«ç‚¹" -> 20:00.

    3. **Noise Filtering (Cleaning)**:
       - **IGNORE** filler words: "é‚£ä¸ª", "ç„¶å", "å°±æ˜¯", "å‘—", "å˜›", "å“ˆ", "å•Š", "ç€", "æ•´", "å¼„", "ç¨å¾®".
       - **IGNORE** politeness: "å¸®æˆ‘", "è®°ä¸€ä¸‹", "éº»çƒ¦", "è¯·".
       - **EXTRACT** only the core action. (e.g. "å¸®æˆ‘æ•´ç‚¹é¥­" -> "åšé¥­").

    # ğŸ“¤ OUTPUT FORMAT (Strict JSON)
    - Returns strictly a JSON Object.
    - **tag, emoji, color MUST be null** (We handle them locally).
    {
      "days": [
        {
          "date": "YYYY-MM-DD",
          "tasks": [
            {
              "title": "Cleaned Action Title",
              "time": "HH:MM" (24h) or null,
              "duration": number (minutes) or null,
              "tag": null, "emoji": null, "color": null
            }
          ]
        }
      ]
    }
    `;

    // è°ƒè¯•ï¼šçœ‹çœ‹æˆ‘ä»¬ç»™ AI å–‚äº†ä»€ä¹ˆæ—¶é—´è¯ä¸¸
    console.log("ğŸ”¥ AI Time Anchors:", { 
        today: todayStr, 
        todayWeek: currentWeekStr,
        nextWeekStart: mondayNextWeek.toISOString().split('T')[0] 
    });

    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 90000);

    try {
        const response = await fetch("https://api.siliconflow.cn/v1/chat/completions", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: [
                    { role: "system", content: systemPrompt }, 
                    // ç‹ ç‹ åœ°ä¸¾ä¾‹æ•™è‚²å®ƒ
                    { role: "user", content: `(å‡è®¾ä»Šå¤©æ˜¯å‘¨æ—¥ ${todayStr}) å‘¨äº”å»å–é…’ã€‚æ˜å„¿æ—©ä¸Šè·‘æ­¥ã€‚éº»çƒ¦è®°ä¸€ä¸‹å“ˆï¼Œåå¤©é‚£ä¸ªå•¥ï¼Œæ•´ç‚¹çƒ§çƒ¤ã€‚` },
                    { role: "assistant", content: `{"days": [{"date": "${new Date(now.getTime() + 1*86400000).toISOString().split('T')[0]}", "tasks": [{"title": "è·‘æ­¥", "time": "08:00", "duration": null, "tag": null, "emoji": null, "color": null}]}, {"date": "${new Date(now.getTime() + 2*86400000).toISOString().split('T')[0]}", "tasks": [{"title": "åƒçƒ§çƒ¤", "time": null, "duration": null, "tag": null, "emoji": null, "color": null}]}, {"date": "${new Date(mondayNextWeek.getTime() + 4*86400000).toISOString().split('T')[0]}", "tasks": [{"title": "å–é…’", "time": null, "duration": null, "tag": null, "emoji": null, "color": null}]}]}` },
                    { role: "user", content: userText }
                ],
                temperature: 0.1, // å¿…é¡»å†·é…·ï¼Œä¸èƒ½æœ‰åˆ›é€ æ€§
                max_tokens: 4096,
                response_format: { type: "json_object" }
            }),
            signal: controller.signal
        });
        clearTimeout(timeoutId);

        if (!response.ok) {
            if (response.status === 401 || response.status === 403) throw new Error("AUTH_FAILED");
            throw new Error(`API_ERROR: ${response.status}`);
        }

        const data = await response.json();
        if (!data.choices || !data.choices[0] || !data.choices[0].message) throw new Error("EMPTY_RESPONSE");

        let rawJson = data.choices[0].message.content.replace(/```json/g, '').replace(/```/g, '').trim();
        let parsedResult = JSON.parse(rawJson);
        const days = Array.isArray(parsedResult) ? parsedResult : (parsedResult.days || parsedResult.schedule || []);

        return days.map(day => ({
            date: day.date,
            tasks: day.tasks.map(t => {
                if (!t || !t.title) return null;
                
                // æœ¬åœ°è¡¥å…… Tag (æ­£åˆ™è¿˜æ˜¯æ¯” AI å¿«ä¸”å‡†ï¼Œè¿™é‡Œå…œåº•)
                let previewRule = { category: "æ—¥å¸¸", label: "Task", emoji: "ğŸ“", color: "#8E8E93" };
                if (typeof window.autoDetectTag === 'function') {
                    previewRule = window.autoDetectTag(t.title); 
                }

                return {
                    title: t.title,
                    time: t.time || "",
                    duration: (t.duration && t.duration > 0) ? t.duration : null, 
                    tag: null, emoji: null, color: null, 
                    tagInfo: previewRule,
                    rawSegment: t.title
                };
            }).filter(t => t !== null)
        })).sort((a, b) => a.date.localeCompare(b.date));

    } catch (error) {
        clearTimeout(timeoutId);
        throw error;
    }
}
        // ä¸»è§£æå…¥å£ (æœ¬åœ°æ­£åˆ™ç‰ˆ - ä¿®å¤é»˜è®¤æ—¶é•¿)
function ai_parseText(text) {
    const lines = text.split('\n');
    let parsedData = [];
    
    let contextBaseDate = new Date(); 
    contextBaseDate.setHours(0,0,0,0);
    
    let lastEndTime = new Date(contextBaseDate); 
    lastEndTime.setHours(8, 0, 0, 0); 

    const today = new Date(); today.setHours(0,0,0,0);

    const getDateKey = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    const getDayObj = (d) => {
        const k = getDateKey(d);
        let obj = parsedData.find(p => p.date === k);
        if (!obj) { obj = { date: k, tasks: [] }; parsedData.push(obj); }
        return obj;
    };

    lines.forEach((line, lineIndex) => { 
        let lineTrimmed = line.trim();
        lineTrimmed = lineTrimmed.replace(/^(\d+)[\.ã€\s]+/, '');
        if (!lineTrimmed) return;

        let targetDate = null;
        let matchedDateString = "";
        
        const weekResult = parseSmartWeekDate(lineTrimmed);
        if (weekResult) {
            matchedDateString = weekResult.matchStr;
            if (weekResult.type === 'strong') {
                targetDate = weekResult.date;
                contextBaseDate = new Date(targetDate);
                lastEndTime = new Date(targetDate); lastEndTime.setHours(8,0,0,0);
            } else {
                targetDate = getDateInSameWeek(contextBaseDate, weekResult.dayIndex);
            }
        } else {
            const daysExpr = parseDaysExpression(lineTrimmed);
            if (daysExpr) {
                targetDate = new Date(today); 
                if (daysExpr.type === 'after') targetDate.setDate(today.getDate() + daysExpr.days);
                else if (daysExpr.type === 'sequence') targetDate.setDate(today.getDate() + Math.max(0, daysExpr.days - 1));
                contextBaseDate = new Date(targetDate);
                lastEndTime = new Date(targetDate); lastEndTime.setHours(8,0,0,0);
            }
            else if (/å¤§åå¤©/.test(lineTrimmed)) { targetDate = new Date(today); targetDate.setDate(today.getDate() + 3); contextBaseDate = new Date(targetDate); matchedDateString="å¤§åå¤©"; }
            else if (/åå¤©/.test(lineTrimmed)) { targetDate = new Date(today); targetDate.setDate(today.getDate() + 2); contextBaseDate = new Date(targetDate); matchedDateString="åå¤©"; }
            else if (/æ˜å¤©|æ˜å„¿/.test(lineTrimmed)) { targetDate = new Date(today); targetDate.setDate(today.getDate() + 1); contextBaseDate = new Date(targetDate); matchedDateString="æ˜å¤©"; }
            else if (/ä»Šå¤©/.test(lineTrimmed)) { targetDate = new Date(today); contextBaseDate = new Date(targetDate); matchedDateString="ä»Šå¤©"; }
        }

        if (!targetDate) targetDate = new Date(contextBaseDate);
        
        const taskSegments = lineTrimmed.split(/[ï¼Œã€‚,ï¼›;]/).filter(s => s.trim());

        taskSegments.forEach(segment => {
            let cleanContent = segment.trim();
            if (matchedDateString) cleanContent = cleanContent.replace(matchedDateString, '');
            else cleanContent = cleanContent.replace(/^(?:å‘¨|æ˜ŸæœŸ|ç¤¼æ‹œ)[ä¸€äºŒä¸‰å››äº”å…­æ—¥å¤©]/, '');
            
            cleanContent = cleanContent.replace(/(åˆ«å¿˜äº†|å°±è¡Œäº†|å°±è¡Œ|è®°å¾—|å•Š|å“ˆ|å“¦|å‘€|å‘—|å»|æ¥|æ‹¼æ‰‹é€Ÿ)$/g, '');

            if (!cleanContent.trim()) return;

            const durationRes = parseDuration(cleanContent);
            let taskDuration = null; // é»˜è®¤å¿…é¡»æ˜¯ null
            let isRelativeTime = false;

            if (durationRes) {
                taskDuration = durationRes.minutes;
                isRelativeTime = durationRes.isRelative;
                cleanContent = cleanContent.replace(durationRes.matchStr, ' ').trim();
            }

            let displayTime = "";
            let finalTaskDate = new Date(targetDate); 

            const timeRes = parseChineseTimeString(cleanContent);
            
            if (isRelativeTime) {
                const rTime = new Date(lastEndTime);
                displayTime = `${String(rTime.getHours()).padStart(2,'0')}:${String(rTime.getMinutes()).padStart(2,'0')}`;
                if(cleanContent.includes('å')) {
                     rTime.setMinutes(rTime.getMinutes() + (taskDuration || 30)); // ä»…ç”¨äºè®¡ç®—ä¸‹ä¸€ä¸ªæ—¶é—´ç‚¹ï¼Œä¸å½±å“å½“å‰ taskDuration
                     displayTime = `${String(rTime.getHours()).padStart(2,'0')}:${String(rTime.getMinutes()).padStart(2,'0')}`;
                     // æ³¨æ„ï¼šè¿™é‡Œå¦‚æœæ˜¯"30åˆ†é’Ÿå"ï¼Œä¸ä»£è¡¨ä»»åŠ¡æ—¶é•¿æ˜¯30åˆ†é’Ÿï¼Œæ‰€ä»¥ taskDuration ä¾ç„¶ä¿æŒåŸæ ·æˆ–è€… null
                }
            }
            else if (timeRes) {
                displayTime = timeRes.formatted;
                if (timeRes.shiftDay > 0) finalTaskDate.setDate(finalTaskDate.getDate() + timeRes.shiftDay);
                
                const timePattern = /((?:å‡Œæ™¨|æ—©æ™¨|æ—©ä¸Š|æ˜æ—©|ä¸Šåˆ|ä¸­åˆ|æ™Œåˆ|ä¸‹åˆ|å‚æ™š|æ™šä¸Š|å¤œé‡Œ|åˆå¤œ)?\s*[\dé›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+[:ç‚¹\.][\dåŠåˆ»]+(?:åˆ†)?)/;
                cleanContent = cleanContent.replace(timePattern, '').replace(/(å¼€å§‹|å‡ºå‘|å·¦å³|å¤§æ¦‚|é¢„è®¡|å‰)/g, '').trim();
            }

            if (displayTime && displayTime.includes(':')) {
                const [h, m] = displayTime.split(':').map(Number);
                lastEndTime = new Date(finalTaskDate);
                lastEndTime.setHours(h, m, 0, 0);
                // ä»…ç”¨äºæ¨ç®—ä¸‹ä¸€ä¸ªä»»åŠ¡çš„å¼€å§‹æ—¶é—´ï¼Œä¸å¼ºåˆ¶èµ‹å€¼ç»™å½“å‰ä»»åŠ¡
                lastEndTime.setMinutes(lastEndTime.getMinutes() + (taskDuration || 30)); 
            }

            cleanContent = cleanContent.replace(/^[:ï¼š\.\-\s]+/, '').trim();
            
            if (cleanContent) {
                const dayObj = getDayObj(finalTaskDate);
                const tagInfo = window.autoDetectTag ? window.autoDetectTag(cleanContent) : {};
                
                dayObj.tasks.push({
                    title: cleanContent,
                    time: displayTime,
                    duration: taskDuration || null, // ç¡®ä¿ä¸ºç©ºæ—¶æ˜¯ null
                    tag: tagInfo.label || "",
                    tagInfo: tagInfo,
                    rawSegment: segment,
                    lineIndex: lineIndex,
                    lineDateWord: matchedDateString || extractLineDateWord(lineTrimmed),
                    emoji: tagInfo.emoji, 
                    color: tagInfo.color
                });
            }
        });
    });
    return parsedData.sort((a,b) => a.date.localeCompare(b.date));
}
        /* === 3. æ¸²æŸ“å‡½æ•° (åŒå±‚å¡ç‰‡é€»è¾‘) === */
        function ai_renderPreview(data) {
    const container = document.getElementById('ai-timeline-container');
    
    // å¦‚æœæ•°æ®ä¸ºç©ºï¼Œæ˜¾ç¤ºå ä½ç¬¦
    if (!data || !data.length) { 
        container.innerHTML = '<div class="flex flex-col items-center justify-center py-10 text-slate-600 opacity-60"><i data-lucide="layout-list" class="w-8 h-8 mb-2"></i><p class="text-xs">ç­‰å¾…è¾“å…¥è®¡åˆ’...</p></div>'; 
        return; 
    }
    
    let html = '';
    data.forEach((day, dIdx) => {
        const dateObj = new Date(day.date);
        const weekStr = ['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'][dateObj.getDay()];
        
        // æ—¥æœŸå¤´
        html += `<div class="mt-4 mb-2 px-1 flex items-center gap-2 animate-slide-in">
                    <span class="text-blue-400 font-black text-sm">${weekStr}</span>
                    <span class="text-slate-500 text-xs font-mono">${day.date}</span>
                 </div>`;
        
        day.tasks.forEach((task, tIdx) => {
            // --- æ ¸å¿ƒä¿®å¤ï¼šå¤„ç† null å€¼ ---
            // å¦‚æœ task.time æ˜¯ null/undefinedï¼Œæ˜¾ç¤ºç©ºå­—ç¬¦ä¸² (placeholder ä¼šæ˜¾ç¤º '--')
            // å¦‚æœ task.duration æ˜¯ null/undefinedï¼Œæ˜¾ç¤ºç©ºå­—ç¬¦ä¸² (placeholder ä¼šæ˜¾ç¤º 'åˆ†')
            const displayTime = (task.time && task.time !== 'null') ? task.time : '';
            const displayDuration = (task.duration && task.duration !== 'null') ? task.duration : '';

            html += `
            <div class="ai-task-card group animate-fadeIn" style="animation-delay: ${tIdx * 50}ms">
                <div class="ai-task-meta-row">
                    <i data-lucide="clock" class="w-3.5 h-3.5 text-slate-500"></i>
                    
                    <input type="text" class="ai-time-edit" 
                        value="${displayTime}" 
                        placeholder="--" 
                        onclick="this.select()" 
                        onchange="ai_updateTask(${dIdx}, ${tIdx}, 'time', this.value)">
                    
                    <span class="text-slate-600 text-[10px]">+</span>
                    
                    <input type="text" class="ai-duration-edit" 
                        value="${displayDuration}" 
                        placeholder="åˆ†" 
                        onclick="this.select()" 
                        onchange="ai_updateTask(${dIdx}, ${tIdx}, 'duration', this.value)">
                    
                    <div class="ai-tag-badge">
                        <span>${task.tagInfo.emoji || 'ğŸ“'}</span>
                        <span class="max-w-[50px] truncate">${task.tagInfo.label || 'Task'}</span>
                    </div>

                    <div class="flex-1"></div> 
                    <button onclick="ai_deleteTask('${day.date}', ${tIdx})" class="mobile-card-del">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>

                <div class="w-full relative">
                    <input type="text" class="ai-title-edit" 
                        value="${task.title}" 
                        placeholder="ä»»åŠ¡å†…å®¹..." 
                        onchange="ai_updateTask(${dIdx}, ${tIdx}, 'title', this.value)">
                    <i data-lucide="pencil" class="w-3 h-3 text-slate-700 absolute right-0 top-2 pointer-events-none opacity-50"></i>
                </div>
            </div>`;
        });
    });
    container.innerHTML = html; 
    lucide.createIcons(); 
}

        // --- V22 æ™ºèƒ½åˆ é™¤æ ¸å¿ƒ (Smart Delete Core) ---
        function ai_deleteTask(dateStr, tIdx) {
            const dayObj = aiData.find(d => d.date === dateStr);
            if (!dayObj) return;
            const task = dayObj.tasks[tIdx];

            const inputEl = document.getElementById('ai-input');
            let lines = inputEl.value.split('\n');
            
            if (typeof task.lineIndex !== 'number' || task.lineIndex >= lines.length) {
                dayObj.tasks.splice(tIdx, 1); ai_renderPreview(aiData); return;
            }
            
            let targetLine = lines[task.lineIndex];
            
            let textToRemove = task.rawSegment;
            if (!targetLine.includes(textToRemove)) { textToRemove = task.title; }
            
            if (targetLine.includes(textToRemove)) {
                const idx = targetLine.indexOf(textToRemove);
                const before = targetLine.substring(0, idx);
                const after = targetLine.substring(idx + textToRemove.length);
                let combined = before + after;
                
                // è¯­æ³•æ¸…ç†
                combined = combined.replace(/([ï¼Œã€,])\s*([ã€‚ï¼›;])/g, '$2');
                combined = combined.replace(/([ï¼Œã€,])\s*([ï¼Œã€,])/g, '$1');
                combined = combined.replace(/([ã€‚])\s*([ã€‚])/g, '$1');
                
                // ç§»é™¤è¡Œé¦–å¤šä½™æ ‡ç‚¹ï¼Œä½†ä¿ç•™æ—¥æœŸè¯
                const dateWord = task.lineDateWord || "";
                if (!combined.trim().startsWith(dateWord)) {
                     combined = combined.replace(/^\s*[ï¼Œã€,ï¼›;ï¼š:]+/, '');
                }

                lines[task.lineIndex] = combined.trim();
                
                // ç©ºè¡Œæ£€æµ‹
                const checkContent = combined.replace(dateWord, '').replace(/[ï¼Œã€‚ã€ï¼›;ï¼š:\s]/g, '');
                if (checkContent.length === 0) {
                    lines.splice(task.lineIndex, 1);
                }
            }

            inputEl.value = lines.join('\n');
            ai_handleInput();
        }
        
        function ai_updateTask(dIdx, tIdx, field, val) { 
            aiData[dIdx].tasks[tIdx][field] = val; 
            const btn = document.getElementById('ai-confirm-btn');
            const mBtn = document.getElementById('mobile-confirm-btn');
            [btn, mBtn].forEach(b => {
                if(b && b.innerText.includes('å·²é”å®š')) {
                    b.innerHTML = b.id.includes('mobile') ? '<i data-lucide="check-circle" class="w-4 h-4"></i> ç¡®è®¤æ„å»º' : '<i data-lucide="check" class="w-3 h-3"></i> ç¡®è®¤æ„å»º';
                    b.classList.add('bg-emerald-600', 'hover:bg-emerald-500');
                    b.classList.remove('bg-slate-600', 'cursor-default');
                }
            });
            lucide.createIcons();
        }

        // ============================================
        // æ ¸å¿ƒä¿®æ”¹ 1: Confirm AI
        // ============================================
        function confirmAI() {
            // 1. æ ¡éªŒä¸ºç©º
            if(aiData.length === 0) { customAlert("è¯·å…ˆè¾“å…¥å†…å®¹", "æç¤º", "info"); return; }
            
            // 2. é”å®šæŒ‰é’®æ ·å¼
            const btn = document.getElementById('ai-confirm-btn');
            const mBtn = document.getElementById('mobile-confirm-btn');
            [btn, mBtn].forEach(b => {
                if(b) {
                    b.innerHTML = b.id.includes('mobile') ? '<i data-lucide="lock" class="w-4 h-4"></i> å·²é”å®š' : '<i data-lucide="check-circle" class="w-3 h-3"></i> å·²é”å®š';
                    b.classList.remove('bg-emerald-600', 'hover:bg-emerald-500');
                    b.classList.add('bg-slate-600', 'cursor-default');
                }
            });
            lucide.createIcons();
            
            // 3. æ ¸å¿ƒä¿®æ”¹ï¼šç§»é™¤ Alertï¼Œç›´æ¥å¹³æ»‘æ»šåŠ¨åˆ°ä¸»é¢˜é€‰æ‹©åŒº
            const themeSection = document.getElementById('theme-section');
            if (themeSection) {
                // ç¨å¾®å»¶è¿Ÿä¸€ç‚¹ç‚¹ï¼Œè®©é”®ç›˜æ”¶èµ·ï¼ˆæ‰‹æœºç«¯ï¼‰åå†æ»šåŠ¨ï¼Œä½“éªŒæ›´å¥½
                setTimeout(() => {
                    themeSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            }

            updateSummary();
        }

        function ai_loadSample(type) {
            const textarea = document.getElementById('ai-input');
            let text = "";
            if (type === 'exam') text = "å‘¨ä¸‰æ—©ä¸Š8ç‚¹èƒŒå•è¯ï¼Œä¸‹åˆ2ç‚¹åšæ•°å­¦å·å­ã€‚\nä¸‹å‘¨ä¸€å…¨å¤©å¤ä¹ ä¸“ä¸šè¯¾ï¼Œæ™šä¸Šçœ‹ç”µå½±ã€‚\nä¸‹ä¸‹å‘¨äº”æ—©èµ·æ™¨è·‘5å…¬é‡Œã€‚";
            if (type === 'life') text = "å‘¨å…­æ—©ä¸Šä¹°èœï¼Œä¸­åˆ11ç‚¹åŠæ¥å­©å­æ”¾å­¦ã€‚\nä¸‹å‘¨æ—¥é€å­©å­å»ç”»ç”»ï¼Œé¡ºä¾¿å»è¶…å¸‚ä¹°ç‰›å¥¶ã€‚\nä¸‹ä¸‹å‘¨ä¸‰æ™šä¸Š6ç‚¹åšé¥­ï¼Œ8ç‚¹æ´—è¡£æœã€‚";
            if (type === 'mixed') text = "æ—©ä¸Š8ç‚¹åŠå¼€ä¼šï¼Œä¸­åˆ12ç‚¹åƒé¥­ï¼Œæ™šä¸Š7ç‚¹å¥èº«ã€‚";
            if (type === 'date') text = "ä»Šå¤©å¤ä¹ ç¬¬ä¸€ç« ã€‚\n3å¤©åè¿›è¡Œå•å…ƒæµ‹è¯•ã€‚\nç¬¬10å¤©å¼€å§‹å…¨çœŸæ¨¡æ‹Ÿã€‚";
            textarea.value = text;
            ai_handleInput();
        }

        // ============================================
        // æ¨¡å—2ï¼šBuilder æ‰‹åŠ¨æ„å»º
        // ============================================
        function addBuilderDay() {
            const today = new Date();
            today.setDate(today.getDate() + builderData.length);
            const dateStr = today.toISOString().split('T')[0];
            builderData.push({ date: dateStr, tasks: [{ title: '', tag: '', desc: '', time: '', duration: null }] });
            renderBuilder(); updateSummary();
        }

        // ============================================
        // æ ¸å¿ƒä¿®æ”¹ 2: Confirm Builder
        // ============================================
        function confirmBuilder() {
            // 1. æ ¡éªŒä¸ºç©º
            if(builderData.length === 0) { customAlert("è¯·å…ˆæ·»åŠ è‡³å°‘ä¸€å¤©ä»»åŠ¡", "æç¤º", "info"); return; }
            
            // 2. é”å®šæŒ‰é’®æ ·å¼
            const btn = document.getElementById('builder-confirm-btn');
            btn.innerHTML = `<i data-lucide="check-circle" class="w-3 h-3"></i> å·²ç¡®è®¤`;
            btn.classList.remove('bg-emerald-600', 'hover:bg-emerald-500');
            btn.classList.add('bg-slate-600', 'cursor-default');
            lucide.createIcons();
            
            // 3. æ ¸å¿ƒä¿®æ”¹ï¼šç§»é™¤ Alertï¼Œç›´æ¥å¹³æ»‘æ»šåŠ¨åˆ°ä¸»é¢˜é€‰æ‹©åŒº
            const themeSection = document.getElementById('theme-section');
            if (themeSection) {
                themeSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            updateSummary();
        }

        function renderBuilder() {
            const container = document.getElementById('builder-container');
            container.innerHTML = '';
            if(builderData.length === 0) { container.innerHTML = '<div class="text-center text-slate-500 py-10 border border-dashed border-slate-700 rounded-xl">æš‚æ— æ•°æ®ï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </div>'; return; }

            builderData.forEach((day, dIdx) => {
                const dayEl = document.createElement('div');
                dayEl.className = 'builder-day group';
                dayEl.innerHTML = `
                    <div class="flex justify-between items-center mb-3 bg-slate-800/40 p-2.5 rounded-lg border border-white/5 hover:border-blue-500/30 transition-colors">
                        <div class="flex items-center gap-3">
                            <span class="text-[10px] font-bold text-slate-300 bg-slate-700/50 px-2 py-1 rounded shadow-sm">DAY ${dIdx + 1}</span>
                            <div class="h-4 w-px bg-white/10"></div>
                            <input type="text" value="${day.date || ''}" onchange="updateBuilderDate(${dIdx}, this.value)" class="bg-transparent border-none text-sm font-bold text-white focus:outline-none w-32 placeholder-slate-600" placeholder="YYYY-MM-DD">
                        </div>
                        <button onclick="removeBuilderDay(${dIdx})" class="text-slate-500 hover:text-red-400 transition opacity-0 group-hover:opacity-100 p-1.5 hover:bg-white/5 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                    <div class="space-y-3 pl-2 border-l border-white/5 ml-4">
                        ${day.tasks.map((task, tIdx) => `
                            <div class="bg-slate-900/30 p-2 rounded-lg border border-white/5 hover:border-white/10 transition">
                                <div class="flex flex-wrap gap-2 items-center mb-2"> 
                                    <input type="text" value="${task.tag || ''}" onchange="updateBuilderTask(${dIdx}, ${tIdx}, 'tag', this.value)" class="builder-input w-24 text-center text-xs text-blue-300 font-bold" placeholder="æ ‡ç­¾">
                                    <input type="text" value="${task.title}" onchange="updateBuilderTask(${dIdx}, ${tIdx}, 'title', this.value)" class="builder-input flex-1 font-bold min-w-[140px]" placeholder="ä»»åŠ¡æ ¸å¿ƒå†…å®¹">
                                    <button onclick="removeBuilderTask(${dIdx}, ${tIdx})" class="text-slate-600 hover:text-red-400 px-1"><i data-lucide="x" class="w-3.5 h-3.5"></i></button>
                                </div>
                                <div class="flex flex-wrap gap-2 items-center"> 
                                    <input type="text" value="${task.time || ''}" onchange="updateBuilderTask(${dIdx}, ${tIdx}, 'time', this.value)" class="builder-input w-24 text-xs font-mono" placeholder="09:00">
                                    <input type="text" value="${task.desc || ''}" onchange="updateBuilderTask(${dIdx}, ${tIdx}, 'desc', this.value)" class="builder-input flex-1 text-xs text-slate-400 min-w-[140px]" placeholder="å¤‡æ³¨/æè¿°...">
                                </div>
                            </div>
                        `).join('')}
                        <button onclick="addBuilderTask(${dIdx})" class="mt-2 text-[11px] text-blue-400 hover:text-blue-300 flex items-center gap-1 opacity-60 hover:opacity-100 transition px-1 py-1"><i data-lucide="plus" class="w-3 h-3"></i> æ·»åŠ ä»»åŠ¡</button>
                    </div>
                `;
                container.appendChild(dayEl);
            });
            lucide.createIcons();
        }

        function removeBuilderDay(idx) { builderData.splice(idx, 1); renderBuilder(); updateSummary(); }
        function addBuilderTask(dayIdx) { builderData[dayIdx].tasks.push({ title: '', tag: '', desc: '', time: '', duration: null }); renderBuilder(); updateSummary(); }
        function removeBuilderTask(dayIdx, taskIdx) { builderData[dayIdx].tasks.splice(taskIdx, 1); renderBuilder(); updateSummary(); }
        function updateBuilderDate(dIdx, val) { builderData[dIdx].date = val; resetBuilderConfirm(); }
        function updateBuilderTask(dIdx, tIdx, field, val) { builderData[dIdx].tasks[tIdx][field] = val; resetBuilderConfirm(); }
        function resetBuilderConfirm() {
            const btn = document.getElementById('builder-confirm-btn');
            if(btn && btn.innerText.includes('å·²ç¡®è®¤')) {
                btn.innerHTML = `<i data-lucide="check" class="w-3 h-3"></i> ç¡®è®¤æ„å»º`;
                btn.classList.add('bg-emerald-600', 'hover:bg-emerald-500');
                btn.classList.remove('bg-slate-600', 'cursor-default');
                lucide.createIcons();
            }
        }

        // ============================================
        // æ¨¡å—3ï¼šExcel & æ ¸å¿ƒç”Ÿæˆé€»è¾‘
        // ============================================
        // ã€æ–°å¢ã€‘ä¸“é—¨å¤„ç† Excel/CSV å¯¼å…¥çš„æ—¶é—´æ ¼å¼é—®é¢˜
function formatExcelTime(value) {
    if (!value) return "";

    // æƒ…å†µ1ï¼šå¦‚æœæ˜¯ Excel çš„å°æ•°æ—¶é—´ (ä¾‹å¦‚ 0.375 ä»£è¡¨ 09:00)
    if (typeof value === 'number') {
        // 24å°æ—¶ * 60åˆ† * 60ç§’
        const totalSeconds = Math.floor(value * 86400); 
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        // è¡¥é›¶ï¼Œç¡®ä¿æ˜¯ 09:00 æ ¼å¼
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
    }

    // æƒ…å†µ2ï¼šå¦‚æœæ˜¯å­—ç¬¦ä¸² (ä¾‹å¦‚ "9:00" æˆ– "9:00:00" æˆ– "09:00")
    if (typeof value === 'string') {
        const cleanVal = value.trim();
        // å¦‚æœåŒ…å«ç§’ (9:00:00)ï¼Œå»æ‰ç§’
        if (cleanVal.includes(':')) {
            const parts = cleanVal.split(':');
            // åªå–å‰ä¸¤éƒ¨åˆ† HH:MM
            const h = parts[0].padStart(2, '0');
            const m = parts[1].padStart(2, '0');
            return `${h}:${m}`;
        }
    }

    // å…¶ä»–æƒ…å†µç›´æ¥è¿”å›
    return value;
}
        function processTasksData(rawArray) {
            if (!rawArray || rawArray.length < 2) return [];
            let headerRowIndex = -1;
            let colMap = { date: -1, title: -1, desc: -1, tag: -1, time: -1, duration: -1 };

            for (let r = 0; r < Math.min(rawArray.length, 5); r++) {
                const rowStr = rawArray[r].map(c => String(c).trim().toLowerCase());
                if (rowStr.findIndex(c => c.includes('date')||c.includes('æ—¥æœŸ')) !== -1 && rowStr.findIndex(c => c.includes('task')||c.includes('æ ‡é¢˜')) !== -1) {
                    headerRowIndex = r;
                    colMap.date = rowStr.findIndex(c => c.includes('date')||c.includes('æ—¥æœŸ'));
                    colMap.title = rowStr.findIndex(c => c.includes('task')||c.includes('æ ‡é¢˜'));
                    colMap.desc = rowStr.findIndex(c => c.includes('desc')||c.includes('æè¿°'));
                    colMap.tag = rowStr.findIndex(c => c.includes('tag')||c.includes('æ ‡ç­¾'));
                    colMap.time = rowStr.findIndex(c => c.includes('time')||c.includes('æ—¶é—´'));
                    colMap.duration = rowStr.findIndex(c => c.includes('duration')||c.includes('æ—¶é•¿')||c.includes('æŒç»­')); 
                    break;
                }
            }

            if (headerRowIndex === -1) return [];
            const taskDataByDate = {};
            rawArray.slice(headerRowIndex + 1).forEach((row) => {
                const dateRaw = row[colMap.date]; if (!dateRaw) return;
                let dateStr = '';
                try {
                    if (typeof dateRaw === 'number') {
                        const dateObj = XLSX.SSF.parse_date_code(dateRaw);
                        dateStr = `${dateObj.y}-${String(dateObj.m).padStart(2,'0')}-${String(dateObj.d).padStart(2,'0')}`;
                    } else {
                        const dateString = String(dateRaw).trim();
                        const d = new Date(dateString.replace(/-/g, '/').replace(/\./g, '/'));
                        if (!isNaN(d.getTime())) dateStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                        else dateStr = dateString.split(' ')[0];
                    }
                } catch (e) { return; }

                if (!taskDataByDate[dateStr]) taskDataByDate[dateStr] = { date: dateStr, tasks: [] };
                taskDataByDate[dateStr].tasks.push({
                    title: String(row[colMap.title] || ''),
                    desc: colMap.desc > -1 ? String(row[colMap.desc] || '') : '',
                    tag: colMap.tag > -1 ? String(row[colMap.tag] || '') : '',
                    time: colMap.time > -1 ? formatExcelTime(row[colMap.time]) : '',
                    duration: colMap.duration > -1 ? (row[colMap.duration] || null) : null
                });
            });

            return Object.keys(taskDataByDate).sort().map((date, index) => {
                const dayData = taskDataByDate[date]; dayData.dayNum = index + 1; return dayData;
            });
        }

        // å¤§çº¦åœ¨ç¬¬ 1072 è¡Œ
// --- ä¿®å¤ç‰ˆï¼šä¿ç•™ Emoji å’Œ Color æ•°æ® ---
// --- ä¿®å¤ç‰ˆï¼šå¼ºåˆ¶æå– Emoji å’Œ Color ---
function convertAIDataToOriginalFormat(aiData) {
    return aiData.map((day, index) => ({
        date: day.date, 
        dayNum: index + 1,
        tasks: day.tasks.map(task => {
            // 1. è·å– AI è¯†åˆ«çš„è¯¦ç»†ä¿¡æ¯
            const info = task.tagInfo || {};
            
            // 2. å¦‚æœ AI æ²¡è¯†åˆ«å‡º Emojiï¼Œæˆ‘ä»¬å°è¯•å†æ¬¡æ‰‹åŠ¨åŒ¹é…ä¸€ä¸‹è§„åˆ™ (åŒä¿é™©)
            // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ç¡®ä¿ autoDetectTag å¯ç”¨
            let finalEmoji = info.emoji;
            let finalColor = info.color;
            let finalLocation = info.location;
            
            if (!finalEmoji && window.autoDetectTag) {
                const retry = window.autoDetectTag(task.title);
                finalEmoji = retry.emoji;
                finalColor = retry.color;
                finalLocation = retry.location;
            }

            return {
                title: task.title, 
                // ä¼˜å…ˆä½¿ç”¨ tagInfo é‡Œçš„ labelï¼Œå¦‚æœæ²¡æœ‰æ‰ç”¨ task.tag
                tag: info.label || task.tag || "",
                desc: task.desc || "", 
                time: task.time || "", 
                duration: task.duration || null,
                
                // ã€æ ¸å¿ƒä¿®å¤ã€‘æ˜¾å¼å°† Emojiã€Colorã€Location å†™å…¥æ•°æ®ç»“æ„
                // è¿™æ ·ç”Ÿæˆçš„ App å°±èƒ½ç›´æ¥è¯»å–å¹¶åœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºäº†
                emoji: finalEmoji || "ğŸ“", // ç»™ä¸ªé»˜è®¤å€¼å…œåº•
                color: finalColor || "#8E8E93",
                location: finalLocation || null
            };
        })
    }));
}
    // === æ–°å¢ï¼šå¼ºåˆ¶åº”ç”¨ rules_db.js è§„åˆ™ ===
function enrichWithRules(data) {
    if (!window.autoDetectTag) return data; // é˜²å¾¡æ€§æ£€æŸ¥

    return data.map(day => ({
        ...day,
        tasks: day.tasks.map(task => {
            // 1. å†³å®šç”¨ä»€ä¹ˆå…³é”®è¯å»åŒ¹é…è§„åˆ™
            // é€»è¾‘ï¼šå¦‚æœç”¨æˆ·æ‰‹åŠ¨å¡«äº†â€œæ ‡ç­¾â€ï¼Œä¼˜å…ˆåŒ¹é…æ ‡ç­¾ï¼›å¦åˆ™åŒ¹é…â€œæ ‡é¢˜â€
            const query = (task.tag && task.tag.trim()) ? task.tag : task.title;
            
            // 2. è°ƒç”¨ rules_db.js è¿›è¡Œè¯†åˆ«
            // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨çš„æ˜¯ä½ æœ¬åœ°åŠ è½½çš„è§„åˆ™åº“
            const rule = window.autoDetectTag(query);
            
            // 3. è¿”å›è¡¥å…¨åçš„ä»»åŠ¡å¯¹è±¡
            return {
                ...task,
                // å¦‚æœåŸä»»åŠ¡æ²¡æ ‡ç­¾ï¼Œå°±ç”¨è¯†åˆ«å‡ºæ¥çš„æ ‡ç­¾ï¼›å¦‚æœæœ‰ï¼Œå°±ä¿ç•™ç”¨æˆ·çš„
                tag: (task.tag && task.tag.trim()) ? task.tag : (rule.label || 'Task'),
                // ã€æ ¸å¿ƒä¿®å¤ã€‘å¼ºåˆ¶å†™å…¥è¯†åˆ«å‡ºçš„ Emoji å’Œé¢œè‰²
                emoji: rule.emoji || 'ğŸ“', 
                color: rule.color || '#8E8E93',
                // åŒæ—¶ä¹Ÿå†™å…¥ tagInfo ç»“æ„ï¼Œç¡®ä¿å…¼å®¹æ€§
                tagInfo: rule 
            };
        })
    }));
}
        async function generateApp() {
            // 1. åŸºç¡€æ ¡éªŒ
            if (!selectedTheme) { customAlert('è¯·é€‰æ‹©ä¸»é¢˜ï¼', 'æç¤º', 'info'); return; }
            
            // 2. UI Loading çŠ¶æ€
            const btn = document.getElementById('generate-button');
            const mBtn = document.getElementById('mobile-generate-btn');
            const originalText = btn.innerText;
            const mOriginalText = mBtn.innerHTML;
            
            [btn, mBtn].forEach(b => {
                if(b) {
                    b.disabled = true;
                    b.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4 inline mr-2"></i> å¤„ç†ä¸­...';
                }
            });
            lucide.createIcons();

            try {
                // 3. æ•°æ®å‡†å¤‡
                // 3. æ•°æ®å‡†å¤‡
                let structuredData = [];
                
                if (currentMode === 'ai') {
                    if (aiData.length === 0) throw new Error('AI æ•°æ®ä¸ºç©ºï¼Œè¯·å…ˆè¾“å…¥è®¡åˆ’');
                    // AI æ¨¡å¼çš„æ•°æ®å·²ç»åŒ…å« tagInfoï¼Œä½†ä¹Ÿå»ºè®®ç»Ÿä¸€è·‘ä¸€éç¡®ä¿ä¸€è‡´æ€§
                    structuredData = convertAIDataToOriginalFormat(aiData);
                
                } else if (currentMode === 'upload') {
                    if (!uploadedData) throw new Error('è¯·å…ˆä¸Šä¼  Excel æ–‡ä»¶');
                    
                    // 1. å…ˆè·å–åŸå§‹æ•°æ®
                    const rawData = processTasksData(uploadedData);
                    // 2. ã€æ ¸å¿ƒä¿®å¤ã€‘è°ƒç”¨è§„åˆ™åº“è¡¥å…¨ Emoji å’Œ é¢œè‰²
                    structuredData = enrichWithRules(rawData);

                } else if (currentMode === 'builder') {
                    if (builderData.length === 0) throw new Error('è¯·è‡³å°‘æ·»åŠ ä¸€å¤©ä»»åŠ¡');
                    
                    // 1. å…ˆè·å–åŸå§‹æ„å»ºæ•°æ®
                    const rawData = builderData.map((d, i) => ({
                        date: d.date, 
                        dayNum: i+1,
                        tasks: d.tasks.filter(t => t.title.trim() !== '').map(t => ({
                            title: t.title,
                            desc: t.desc || '',
                            time: t.time || '',
                            duration: (t.duration && t.duration > 0) ? t.duration : null,
                            tag: (t.tag && t.tag.trim()) ? t.tag : null 
                        }))
                    })).filter(d => d.tasks.length > 0);

                    // 2. ã€æ ¸å¿ƒä¿®å¤ã€‘è°ƒç”¨è§„åˆ™åº“è¡¥å…¨ Emoji å’Œ é¢œè‰²
                    structuredData = enrichWithRules(rawData);
                }

                if (structuredData.length === 0) throw new Error('æœ‰æ•ˆæ•°æ®ä¸ºç©º');

                // 4. è·å–æ ‡é¢˜
                const planTitle = await getPlanTitle();
                if (!planTitle) { 
                    [btn, mBtn].forEach(b => {
                        if(b) { b.disabled = false; b.innerHTML = b.id.includes('mobile') ? mOriginalText : originalText; }
                    });
                    lucide.createIcons();
                    return; 
                }

                // 5. è¯»å–æ¨¡æ¿ä¸è§„åˆ™
                let templateContent = await getTemplateContent(selectedTheme);
                const rulesDbContent = await getRulesDbContent();
                
                // --- 5.1 ã€æ ¸å¿ƒç»æ€æŠ€ã€‘ä¿®æ”¹æ¨¡æ¿é€»è¾‘ ---
                // è¿™ä¸€æ­¥ä¼šæ‰¾åˆ°æ¨¡æ¿é‡Œå¿½ç•¥ emoji çš„é‚£è¡Œä»£ç ï¼ŒæŠŠå®ƒæ”¹æˆâ€œä¼˜å…ˆä½¿ç”¨æ•°æ®é‡Œçš„ emojiâ€
                // è¿™æ ·æ— è®º app é‡Œçš„è§„åˆ™åº“æœ‰æ²¡æœ‰åŠ è½½æˆåŠŸï¼Œå®ƒéƒ½ä¼šç›´æ¥æ˜¾ç¤ºä½ åœ¨é¢„è§ˆé‡Œçœ‹åˆ°çš„é‚£ä¸ªå›¾æ ‡ï¼
                const fixLogic = `
                    let autoInfo = autoDetectTag(t.title);
                    if(t.emoji) autoInfo.emoji = t.emoji;
                    if(t.color) autoInfo.color = t.color;
                    if(t.location) autoInfo.location = t.location;
                `;
                // å°è¯•æ›¿æ¢æ¨¡æ¿ä¸­çš„æ—§é€»è¾‘
                templateContent = templateContent.replace('const autoInfo = autoDetectTag(t.title);', fixLogic);
                
                // --- 5.2 å‡†å¤‡æ•°æ® ---
                const planId = selectedTheme + '_' + Date.now();
                const safeTitle = planTitle.replace(/[<>"]/g, '');
                const escapedData = JSON.stringify(structuredData)
                    .replace(/</g, '\\u003c')
                    .replace(/>/g, '\\u003e');

                // 6. æ›¿æ¢åŸºç¡€å˜é‡
                let finalHtml = templateContent
                    .replace(/{{TASKS_DATA}}/g, escapedData)
                    .replace(/{{PLAN_TITLE}}/g, safeTitle)
                    .replace(/{{PLAN_ID}}/g, planId)
                    .replace(/{{BODY_CLASS}}/g, '');

                // 7. å®‰å…¨æ³¨å…¥è§„åˆ™åº“ (é˜²æ­¢ä¹±ç )
                if (rulesDbContent) {
                    const sTag = '<scr' + 'ipt>'; 
                    const eTag = '</scr' + 'ipt>';
                    const bodyEnd = '</bo' + 'dy>';

                    if (finalHtml.includes('src="rules_db.js"')) {
                        const regex = new RegExp('<scr' + 'ipt[^>]*src="[^"]*rules_db\\.js"[^>]*><\\/scr' + 'ipt>');
                        finalHtml = finalHtml.replace(regex, sTag + rulesDbContent + eTag);
                    } else {
                        const hook = "window.addEventListener('DOMContentLoaded', init);";
                        if (finalHtml.includes(hook)) {
                            finalHtml = finalHtml.replace(hook, rulesDbContent + "\n" + hook);
                        } else {
                            finalHtml = finalHtml.replace(new RegExp(bodyEnd), sTag + rulesDbContent + eTag + bodyEnd);
                        }
                    }
                }

                // 8. ç”Ÿæˆæ–‡ä»¶
                const safeFileName = safeTitle.replace(/[<>:"/\\|?*]/g, '_') + '_' + selectedTheme + '.html';
                const blob = new Blob([finalHtml], { type: 'text/html;charset=utf-8' });
                const blobUrl = URL.createObjectURL(blob);
                
                displayResultOptions(blobUrl, safeFileName);
                customAlert(`æˆåŠŸç”Ÿæˆ ${structuredData.length} å¤©è®¡åˆ’ï¼`, 'æ„å»ºå®Œæˆ', 'check-circle');

            } catch (error) {
                console.error(error);
                customAlert('é”™è¯¯: ' + error.message, 'ç”Ÿæˆå¤±è´¥', 'x-circle');
            } finally {
                // 9. æ¢å¤ UI
                [btn, mBtn].forEach(b => {
                    if(b) { 
                        b.disabled = false; 
                        b.innerHTML = b.id.includes('mobile') ? mOriginalText : originalText; 
                    }
                });
                lucide.createIcons();
            }
        }
        // ============================================
        // 4. UI è¾…åŠ©
        // ============================================
        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const tabBtn = document.getElementById('tab-' + mode);
            if(tabBtn) tabBtn.classList.add('active');
            
            ['ai', 'upload', 'builder'].forEach(m => {
                const el = document.getElementById('mode-' + m);
                if(el) el.classList.add('hidden');
            });
            
            const targetEl = document.getElementById('mode-' + mode);
            if(targetEl) targetEl.classList.remove('hidden');
            
            if (mode === 'builder') {
                if (builderData.length === 0) addBuilderDay();
                resetBuilderConfirm();
            } else if (mode === 'ai') {
                const btn = document.getElementById('ai-confirm-btn');
                const mBtn = document.getElementById('mobile-confirm-btn');
                [btn, mBtn].forEach(b => {
                    if(b && b.innerText.includes('å·²é”å®š')) {
                        b.innerHTML = b.id.includes('mobile') ? '<i data-lucide="check-circle" class="w-4 h-4"></i> ç¡®è®¤æ„å»º' : '<i data-lucide="check" class="w-3 h-3"></i> ç¡®è®¤æ„å»º';
                        b.classList.add('bg-emerald-600', 'hover:bg-emerald-500');
                        b.classList.remove('bg-slate-600', 'cursor-default');
                    }
                });
                lucide.createIcons();
            }
            updateSummary();
        }

        function handleFileChange(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            customAlert("æ­£åœ¨è§£æ Excel...", "å¤„ç†ä¸­", "loader-2");
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    uploadedData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
                    
                    if(uploadedData && uploadedData.length > 1) {
                        switchMode('upload'); 
                        updateSummary();
                        customAlert(`æˆåŠŸè¯»å– ${uploadedData.length-1} è¡Œæ•°æ®`, "è§£ææˆåŠŸ", "check");
                        
                        const dropArea = document.getElementById('excel-drop-area');
                        dropArea.innerHTML = `
                            <div class="w-16 h-16 bg-emerald-500/10 rounded-full flex items-center justify-center mb-4 border border-emerald-500/30">
                                <i data-lucide="check" class="w-8 h-8 text-emerald-400"></i>
                            </div>
                            <p class="text-lg font-bold text-white">å·²å°±ç»ª: ${file.name}</p>
                            <p class="text-sm text-emerald-400 mt-2 font-mono">åŒ…å« ${uploadedData.length-1} ä¸ªä»»åŠ¡</p>
                            <button onclick="document.getElementById('excel-file').click()" class="mt-4 text-xs text-slate-500 hover:text-white underline">æ›´æ¢æ–‡ä»¶</button>
                            <input type="file" id="excel-file" accept=".xlsx,.csv" class="hidden" onchange="handleFileChange(event)">
                        `;
                        lucide.createIcons();
                        
                    } else {
                        throw new Error("æ•°æ®ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®");
                    }
                } catch(err) {
                    customAlert("Excel è§£æå¤±è´¥: " + err.message, "é”™è¯¯", "x-circle");
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function getTemplateContent(theme) {
            try {
                const res = await fetch(`templates/template_${theme}.html`);
                if (!res.ok) { const fb = await fetch(`template_${theme}.html`); if (fb.ok) return await fb.text(); throw new Error('Template not found'); }
                return await res.text();
            } catch (e) { throw new Error('æ— æ³•åŠ è½½æ¨¡æ¿æ–‡ä»¶'); }
        }

        function selectTheme(theme) {
            selectedTheme = theme;
            document.querySelectorAll('.selection-card').forEach(el => el.classList.remove('selected'));
            const card = document.getElementById('theme-' + theme);
            if(card) card.classList.add('selected');
            updateSummary();
        }

        function updateSummary() {
            const s = document.getElementById('generation-summary');
            const btn = document.getElementById('generate-button');
            const mBtn = document.getElementById('mobile-generate-btn');
            const themeMap = { 'pro': 'DeepFlow Pro', 'zen': 'Zen Mode', 'cyberpunk': 'Cyberpunk' };
            const themeName = themeMap[selectedTheme] || 'æœªé€‰æ‹©';
            let count = 0, sourceText = "";
            if (currentMode === 'ai') { count = aiData.length; sourceText = "AI è§£æ"; }
            else if (currentMode === 'upload' && uploadedData) { count = uploadedData.length - 1; sourceText = "Excel"; }
            else if (currentMode === 'builder') { count = builderData.length; sourceText = "åœ¨çº¿æ„å»º"; }

            if (count > 0 && selectedTheme) { 
                if(s) s.innerHTML = `ğŸ‰ å°±ç»ªï¼æ•°æ®æºï¼š${sourceText} (${count} å¤©)ï¼Œä¸»é¢˜ï¼š${themeName}`; 
                [btn, mBtn].forEach(b => { if(b) { b.disabled = false; b.classList.remove('opacity-50'); }});
            } else { 
                if(s) s.innerHTML = count > 0 ? `æ•°æ® OK (${sourceText})ï¼Œè¯·é€‰æ‹©ä¸»é¢˜` : "ç­‰å¾…æ•°æ®é…ç½®..."; 
                [btn, mBtn].forEach(b => { if(b) { b.disabled = true; b.classList.add('opacity-50'); }});
            }
        }

        function displayResultOptions(blobUrl, fileName) {
            const modal = document.getElementById('resultModalOverlay');
            const prevBtn = document.getElementById('previewButton');
            const downBtn = document.getElementById('downloadButton');
            prevBtn.href = blobUrl;
            downBtn.href = blobUrl;
            downBtn.download = fileName;
            modal.style.display = 'flex'; 
            setTimeout(() => modal.classList.add('active'), 10);
        }
        
        function closeResultModal() {
            const modal = document.getElementById('resultModalOverlay');
            modal.classList.remove('active'); 
            setTimeout(() => modal.style.display = 'none', 300);
        }

        function getPlanTitle() {
            return new Promise((resolve) => {
                titlePromiseResolve = resolve;
                const m = document.getElementById('title-input-modal'); const p = document.getElementById('title-modal-panel');
                m.classList.remove('opacity-0', 'pointer-events-none'); p.classList.remove('opacity-0', 'scale-95'); p.classList.add('scale-100');
            });
        }
        function confirmTitleModal() { closeTitleModal(); if(titlePromiseResolve) titlePromiseResolve(document.getElementById('plan-title-input').value || 'DeepFlow è®¡åˆ’'); }
        function cancelTitleModal() { closeTitleModal(); if(titlePromiseResolve) titlePromiseResolve(null); }
        function closeTitleModal() {
            const m = document.getElementById('title-input-modal'); const p = document.getElementById('title-modal-panel');
            m.classList.add('opacity-0', 'pointer-events-none'); p.classList.add('opacity-0', 'scale-95'); p.classList.remove('scale-100');
        }

        function customAlert(msg, title, icon) {
            const m = document.getElementById('custom-alert-modal');
            document.getElementById('alert-message').textContent = msg;
            document.getElementById('alert-title').innerHTML = `<i data-lucide="${icon}" class="w-5 h-5"></i> ${title}`;
            lucide.createIcons();
            m.classList.remove('hidden'); setTimeout(() => m.classList.remove('opacity-0'), 10);
        }
        function closeCustomAlert() { const m = document.getElementById('custom-alert-modal'); m.classList.add('opacity-0'); setTimeout(() => m.classList.add('hidden'), 300); }
        function downloadSampleExcel() {
            const ws = XLSX.utils.aoa_to_sheet([["æ—¥æœŸ","ä»»åŠ¡æ ‡é¢˜","æ—¶é—´","æ ‡ç­¾"],["2025-01-01","ç¤ºä¾‹ä»»åŠ¡","09:00","æ ¸å¿ƒ"]]);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, "DeepFlow_Template.xlsx");
        }
        // è¯»å– templates/rules_db.js çš„å†…å®¹ï¼Œç”¨äºæ‰“åŒ…åˆ°æ–°æ–‡ä»¶
async function getRulesDbContent() { 
    try { 
        const res = await fetch('templates/rules_db.js'); 
        if (res.ok) return await res.text();
        console.error("æ— æ³•è¯»å– templates/rules_db.js");
        return ''; 
    } catch (e) { 
        console.error("è¯»å–è§„åˆ™åº“å¤±è´¥:", e);
        return ''; 
    } 
}
       window.onload = () => {
    // 1. åˆå§‹åŒ–å›¾æ ‡
    lucide.createIcons();
    
    // 2. æ‰‹æœºç«¯é€‚é…
    initMobileExperience();
    
    // 3. è¯»å–ç¼“å­˜ Key å’Œ æ¨¡å‹
    const cachedKey = localStorage.getItem('deepflow_sk');
    const cachedModel = localStorage.getItem('deepflow_model');
    const enginePref = localStorage.getItem('deepflow_engine_pref'); // è¯»å–ç”¨æˆ·ä¸Šæ¬¡çš„å¼•æ“åå¥½

    // 4. å¡«å……è®¾ç½®é¢æ¿
    if (cachedKey) {
        document.getElementById('sf-api-key').value = cachedKey;
        console.log("DeepFlow: API Key loaded.");
    }
    if (cachedModel) {
        document.getElementById('sf-model-name').value = cachedModel;
    }

    // 5. å†³å®šå¼•æ“çŠ¶æ€ (ä¼˜å…ˆçº§ï¼šæ— Keyå¼ºåˆ¶Local > ç”¨æˆ·åå¥½ > é»˜è®¤AI)
    if (!cachedKey) {
        useCloudEngine = false; // æ²¡ Keyï¼Œå¼ºåˆ¶æœ¬åœ°
    } else {
        // æœ‰ Key çš„æƒ…å†µä¸‹ï¼Œçœ‹ç”¨æˆ·ä¸Šæ¬¡é€‰äº†ä»€ä¹ˆ
        if (enginePref === 'local') {
            useCloudEngine = false;
        } else {
            useCloudEngine = true; // é»˜è®¤æˆ–ç”¨æˆ·é€‰äº† cloud
        }
    }

    // 6. åŒæ­¥ UI
    updateEngineUISync();

    // 7. ã€æ ¸å¿ƒã€‘æ³¨å†Œåˆ‡å±ç›‘å¬ (ä¿®å¤åˆ‡å±åçŠ¶æ€ä¸¢å¤±/å¡é¡¿)
    window.addEventListener('focus', () => {
        console.log("App æ¢å¤å‰å°ï¼Œåˆ·æ–°çŠ¶æ€...");
        // é‡æ–°è¯»å–é…ç½®ï¼Œé˜²æ­¢å¤šå¼€é¡µé¢ä¸åŒæ­¥
        const currentKey = localStorage.getItem('deepflow_sk');
        if(!currentKey && useCloudEngine) {
            // å¦‚æœåˆ‡å‡ºå»æŠŠkeyåˆ äº†ï¼Œåˆ‡å›æ¥è¦é™çº§
            useCloudEngine = false;
            updateEngineUISync();
        }
        // å¼ºåˆ¶é‡æ–°è§£æä¸€æ¬¡ï¼Œæ¿€æ´» JS çº¿ç¨‹
        const inputVal = document.getElementById('ai-input').value;
        if(inputVal.trim()) ai_handleInput();
    });

    // 8. æ‹–æ‹½ä¸Šä¼ é€»è¾‘
    const dropArea = document.querySelector('label[for="excel-file"]');
    if (dropArea) {
        dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.classList.add('border-blue-500', 'bg-white/10'); });
        dropArea.addEventListener('dragleave', () => { dropArea.classList.remove('border-blue-500', 'bg-white/10'); });
        dropArea.addEventListener('drop', (e) => { e.preventDefault(); dropArea.classList.remove('border-blue-500', 'bg-white/10'); const file = e.dataTransfer.files[0]; if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.csv'))) { const input = document.getElementById('excel-file'); const dt = new DataTransfer(); dt.items.add(file); input.files = dt.files; handleFileChange({ target: input }); switchMode('upload'); } else { customAlert('è¯·ä¸Šä¼  .xlsx æˆ– .csv æ–‡ä»¶', 'é”™è¯¯', 'file-x'); } });
    }
    
    // 9. å¤„ç† URL å‚æ•°
    const urlParams = new URLSearchParams(window.location.search);
    if(urlParams.get('theme')) selectTheme(urlParams.get('theme'));
};

        // è¾…åŠ©å‡½æ•°ï¼šä¸“é—¨è´Ÿè´£æŠŠ UI æ»‘å—å’Œ useCloudEngine å˜é‡åŒæ­¥
        function updateEngineUISync() {
            const slider = document.getElementById('engine-slider');
            const btnLocal = document.getElementById('btn-local');
            const btnCloud = document.getElementById('btn-cloud');
            const inputArea = document.getElementById('ai-input');

            if (useCloudEngine) {
                // AI çŠ¶æ€
                if(slider) {
                    slider.style.transform = "translateX(100%)";
                    slider.classList.remove('bg-emerald-600', 'shadow-emerald-600/30');
                    slider.classList.add('bg-blue-600', 'shadow-blue-600/30');
                }
                if(btnLocal) { btnLocal.classList.remove('text-white'); btnLocal.classList.add('text-slate-400'); }
                if(btnCloud) { btnCloud.classList.remove('text-slate-400'); btnCloud.classList.add('text-white'); }
                if(inputArea) inputArea.placeholder = "AI æ¨¡å¼ï¼šæ”¯æŒè‡ªç„¶è¯­è¨€ç†è§£ã€‚\nä¾‹å¦‚ï¼šä¸‹ä¸‹å‘¨ä¸‰ä¸‹åˆ3ç‚¹å¼€ä¼šï¼Œè®°å¾—å¸¦ç”µè„‘ã€‚";
            } else {
                // æœ¬åœ°çŠ¶æ€
                if(slider) {
                    slider.style.transform = "translateX(0%)";
                    slider.classList.remove('bg-blue-600', 'shadow-blue-600/30');
                    slider.classList.add('bg-emerald-600', 'shadow-emerald-600/30');
                }
                if(btnLocal) { btnLocal.classList.remove('text-slate-400'); btnLocal.classList.add('text-white'); }
                if(btnCloud) { btnCloud.classList.remove('text-white'); btnCloud.classList.add('text-slate-400'); }
                if(inputArea) inputArea.placeholder = "æé€Ÿæ¨¡å¼ï¼šè¯·ä½¿ç”¨æ¸…æ™°æ ¼å¼ã€‚\nä¾‹å¦‚ï¼šå‘¨ä¸‰ 14:00 å¼€ä¼š";
            }
        }
    </script>
</body>
</html>