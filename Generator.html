<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ„å»ºæ§åˆ¶å° | DeepFlow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=JetBrains+Mono:wght@400;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="./rules_db.js"></script>
    
    <style>
        /* åŸºç¡€ç»“æ„å’Œå­—ä½“ */
        body { font-family: 'Plus Jakarta Sans', sans-serif; overflow: hidden; transition: all 0.5s ease; background-attachment: fixed !important; background-size: cover !important; background-position: center !important; background-repeat: no-repeat !important; position: relative; }
        .console-panel { backdrop-filter: blur(24px); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); transition: all 0.5s ease; }
        
        /* Cyberpunk æ‰«æçº¿åŠ¨ç”» (ç”¨äº Cyberpunk ä¸»é¢˜) */
        .cyber-line { position: absolute; width: 100%; height: 2px; top: 0; left: 0; opacity: 0; animation: scan 2s cubic-bezier(0.4, 0, 0.2, 1) infinite; }
        @keyframes scan { 0% { top: 0%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        .upload-zone:hover .cyber-line { opacity: 1; }

        /* ç»ˆç«¯æ—¥å¿—æ»šåŠ¨æ¡ */
        #terminalLogs::-webkit-scrollbar { width: 4px; }
        #terminalLogs::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 4px; }
        
        /* DeepFlow Pro - ã€æœ€ç»ˆä¿®æ­£ï¼šç¡®ä¿è“ã€ç»¿ã€ç²‰ä¸‰è‰²å‡åŒ€æ··åˆã€‘ */
        body.bg-pro-fluid { background-color: #f7f7f7; color: #1f2937; }
        body.bg-pro-fluid::before { 
            content: ''; 
            position: absolute; 
            inset: 0; 
            /* ä¿®æ­£ï¼šå°†ä¸‰ä¸ªå¾„å‘æ¸å˜çš„åœ†å¿ƒä½ç½®å’Œå¤§å°è°ƒæ•´ä¸ºé«˜é‡å åŒºåŸŸï¼Œç¡®ä¿ä¸‰è‰²æ··åˆå‡åŒ€ */
            background: radial-gradient(circle at 10% 40%, rgba(6, 182, 212, 0.7) 0%, transparent 25%), /* è“è‰²ï¼ˆå·¦ä¸Šï¼‰ */
                        radial-gradient(circle at 90% 60%, rgba(16, 185, 129, 0.6) 0%, transparent 25%), /* ç»¿è‰²ï¼ˆå³ä¸‹ï¼‰ */
                        radial-gradient(circle at 50% 50%, rgba(244, 114, 182, 0.5) 0%, transparent 25%); /* ç²‰è‰²ï¼ˆä¸­å¿ƒï¼‰ */
            background-size: 200% 200%; 
            filter: blur(100px) saturate(2.0) contrast(1.1); 
            opacity: 0.9; 
            z-index: -1; 
            pointer-events: none; 
        }
        /* Zen Mode */
        body.bg-zen-grid { background-image: linear-gradient(rgba(0, 0, 0, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 0, 0, 0.03) 1px, transparent 1px); background-size: 30px 30px; background-color: #ffffff; color: #18181b; }
        /* Cyberpunk */
        body.bg-cyber-pulse { background-color: #000000; color: #d946ef; text-shadow: 0 0 5px rgba(217, 70, 239, 0.8); }
        body.bg-cyber-pulse::before { content: ''; position: absolute; inset: 0; background: repeating-linear-gradient(rgba(217, 70, 239, 0.2) 0px, transparent 1px, rgba(34, 211, 238, 0.1) 2px, transparent 3px); background-size: 15px 15px; opacity: 0.8; filter: brightness(1.2) contrast(1.5); z-index: -1; pointer-events: none; }
    </style>
</head>
<body class="transition-colors duration-500">
    <nav class="fixed w-full z-40 top-0 border-b border-white/5 bg-transparent backdrop-blur-md">
        <div class="max-w-5xl mx-auto px-6 h-20 flex justify-between items-center">
            <a href="ç€é™†æ¨¡æ¿.html" id="backBtn" class="flex items-center gap-2 transition group text-white">
                <i data-lucide="arrow-left" class="w-4 h-4 group-hover:-translate-x-1 transition-transform"></i>
                <span class="text-sm font-bold">åˆ‡æ¢å¼•æ“</span>
            </a>
            <div id="systemStatus" class="flex items-center gap-2 px-3 py-1 rounded-full border border-white/20">
                <div class="w-2 h-2 rounded-full animate-pulse bg-emerald-500"></div>
                <span class="text-[10px] font-mono tracking-widest uppercase text-slate-300">ç³»ç»Ÿåœ¨çº¿</span>
            </div>
        </div>
    </nav>
    <main class="min-h-screen flex flex-col items-center justify-center px-6 relative pt-10">
        <div class="text-center mb-10 space-y-4 relative z-10">
            <div id="engineLogo" class="w-16 h-16 mx-auto rounded-2xl flex items-center justify-center mb-6 transition-all duration-500 text-white"><i id="logoIcon" data-lucide="cpu" class="w-8 h-8"></i></div>
            <h1 id="mainTitle" class="text-4xl md:text-6xl font-black tracking-tight transition-colors duration-300 text-white">åˆå§‹åŒ–æ„å»º</h1>
            <p id="subTitle" class="text-lg max-w-md mx-auto transition-colors duration-300 text-slate-400">å¼•æ“å·²æŒ‚è½½ï¼Œè¯·æ³¨å…¥æ•°æ®ã€‚</p>
        </div>
        <div id="consoleCard" class="console-panel w-full max-w-xl rounded-3xl p-3 relative group transition-all duration-500">
            <div id="dropZone" class="relative w-full h-80 rounded-2xl border-2 border-dashed flex flex-col items-center justify-center cursor-pointer overflow-hidden transition-all duration-300 upload-zone">
                <input type="file" id="uploadInput" accept=".xlsx" class="hidden" onclick="this.value=null" />
                <div id="cyberLine" class="cyber-line"></div> <div id="idleState" class="flex flex-col items-center gap-6 z-10 transition-transform duration-300 group-hover:-translate-y-2">
                    <div id="uploadIcon" class="w-20 h-20 rounded-3xl flex items-center justify-center border transition-all duration-300 text-white"><i data-lucide="upload" class="w-8 h-8"></i></div>
                    <div class="text-center space-y-1"><p id="uploadText" class="text-lg font-bold text-white">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶</p><p id="uploadSub" class="text-xs font-mono opacity-60 text-slate-400">æ ¼å¼: .XLSX</p></div>
                </div>
                <div id="processingState" class="hidden absolute inset-0 z-20 flex-col p-8 font-mono text-xs">
                    <div id="terminalHeader" class="flex items-center justify-between border-b pb-4 mb-4"><span class="opacity-60">ç»ˆç«¯æ—¥å¿—</span><div class="flex gap-2"><div class="w-2 h-2 rounded-full bg-red-500"></div><div class="w-2 h-2 rounded-full bg-yellow-500"></div><div class="w-2 h-2 rounded-full bg-green-500"></div></div></div>
                    <div id="terminalLogs" class="space-y-2 flex-1 overflow-y-auto opacity-80 text-white"></div>
                </div>
            </div>
        </div>
        <div class="mt-8"><button onclick="downloadSampleExcel()" id="sampleBtn" class="text-xs font-bold transition flex items-center gap-2 px-4 py-2 rounded-lg text-slate-400 hover:text-white hover:bg-white/5"><i data-lucide="file-spreadsheet" class="w-4 h-4"></i> ä¸‹è½½æ ‡å‡†æ¨¡ç‰ˆ</button></div>
    </main>

    <script>
        // ====================================================================================
        // ã€æ ¸å¿ƒé…ç½®ä¸ä¸»é¢˜é€»è¾‘ã€‘
        // ====================================================================================

        const params = new URLSearchParams(window.location.search);
        let activeTheme = params.get('theme') || 'pro'; 
        if (activeTheme === 'zen') activeTheme = 'Zen Mode';
        else if (activeTheme === 'cyberpunk') activeTheme = 'Cyberpunk';
        else activeTheme = 'DeepFlow Pro';

        const VISUAL_CONFIG = {
            'DeepFlow Pro': {
                displayName: 'å¤šå·´èƒºå¿ƒæµ', fileSuffix: '_Pro', templateURL: 'templates/template_pro.html',
                bgClass: 'bg-transparent bg-pro-fluid', cardClass: 'bg-white/90 border border-gray-200 shadow-xl', 
                textColor: 'text-gray-900', subTextColor: 'text-gray-600', 
                accentColor: '#06b6d4', logoBg: 'bg-cyan-500/10 text-cyan-500', 
                icon: 'zap', descTitle: 'DeepFlow Pro', descSub: 'å¿ƒæµæ³¨å…¥ Â· å¤šå·´èƒºåé¦ˆå¼•æ“',
                uploadText: 'å¿ƒæµæ³¨å…¥ (Flow Infusion)', uploadSub: 'å³æ—¶è½¬æ¢ Â· å¥–åŠ±ç”Ÿæˆ',
                cssVars: `--glass-bg: rgba(255, 255, 255, 0.95); --surface: #f7f7f7; --primary: #06b6d4; --success: #10b981; --text-main: #1f2937; --text-muted: #6b7280; --progress-bg: #f3f4f6; --border: #e5e7eb; --checked-bg: rgba(235, 248, 255, 0.8); --overlay: rgba(247, 247, 247, 0.8); --bg-grad: linear-gradient(135deg, #eff6ff 0%, #d1fae5 33%, #fce7f3 66%, #e0f2f1 100%); --bg-opacity: 1; --seal-red: #b91c1c;`, 
                bodyClass: 'selection:bg-cyan-400/30 pro-style-active', iconBoxClass: 'bg-cyan-500', confetti: ['#06b6d4', '#10b981', '#f472b6']
            },
            'Zen Mode': {
    displayName: 'ç¦…æ„æ¨¡å¼', fileSuffix: '_Zen', templateURL: 'templates/template_zen.html',
    bgClass: 'bg-white bg-zen-grid', cardClass: 'bg-white/80 border border-gray-300 shadow-xl', textColor: 'text-gray-900', subTextColor: 'text-gray-600', accentColor: '#18181b', logoBg: 'bg-gray-100 text-black', icon: 'circle', scanLineColor: 'none', 
    descTitle: 'å¿ƒæµå½’æ¡£', descSub: 'å‰”é™¤æ‰€æœ‰å¹²æ‰°çš„æç®€ä¸»ä¹‰ã€‚',
    uploadText: 'æ‹–å…¥æ–‡ä»¶ä»¥å½’æ¡£', uploadSub: 'ä¸“æ³¨æ¨¡å¼ Â· æé€Ÿå¤„ç†',
    // å…³é”®ä¿®å¤ç‚¹ï¼šç¡®ä¿æ‰€æœ‰å˜é‡éƒ½ç”¨åˆ†å· ; ç»“æŸ
    cssVars: `--glass-bg: #ffffff; --surface: #ffffff; --text-main: #18181b; --text-muted: #71717a; --glass: #ffffff; --primary: #18181b; --success: #10b981; --border: #e4e4e7; --progress-bg: #f4f4f5; --checked-bg: #f4f4f5; --overlay: rgba(255, 255, 255, 0.95); --bg-grad: #ffffff; --bg-opacity: 0; --seal-red: #b91c1c;`, 
    bodyClass: 'tracking-tight selection:bg-gray-400/30',
    iconBoxClass: 'bg-black', confetti: ['#000000', '#525252']
},
            'Cyberpunk': {
                displayName: 'èµ›åšæœ‹å…‹', fileSuffix: '_Cyber', templateURL: 'templates/template_zen.html',
                bgClass: 'bg-transparent bg-cyber-pulse', cardClass: 'bg-black/80 border border-fuchsia-500/50 shadow-[0_0_30px_rgba(217,70,239,0.3)]', textColor: 'text-white', subTextColor: 'text-fuchsia-400', accentColor: '#d946ef', logoBg: 'bg-fuchsia-900/50 text-fuchsia-400', icon: 'gamepad-2', 
                scanLineColor: 'linear-gradient(90deg, transparent, #d946ef, transparent)', 
                descTitle: 'èµ›åšç«æŠ€åœº', descSub: 'å¼ºçƒˆçš„éœ“è™¹å…‰æ …ä¸æ•°æ®æµã€‚', 
                uploadText: 'ä¸Šä¼ æ•°æ®æµ (Upload Stream)', uploadSub: 'å³æ—¶è§£æ Â· å¿«é€Ÿç¼–è¯‘',
                cssVars: `--glass-bg: rgba(15, 23, 42, 0.7); --surface: #020617; --text-main: #e2e8f0; --text-muted: #94a3b8; --glass: rgba(15, 23, 42, 0.7); --primary: #d946ef; --success: #22d3ee; --border: #1e293b; --progress-bg: #1e293b; --checked-bg: #1e293b; --overlay: rgba(2, 6, 23, 0.8); --bg-grad: #020617; --bg-opacity: 0; --seal-red: #d946ef;`,
                bodyClass: 'selection:bg-fuchsia-500/30', iconBoxClass: 'bg-fuchsia-600', confetti: ['#d946ef', '#22d3ee', '#f472b6']
            }
        };
        const config = VISUAL_CONFIG[activeTheme];

        // --- ç‰¹æ•ˆæ§åˆ¶çŠ¶æ€å˜é‡ ---
        let lastMouseX = 0; 
        let lastMouseY = 0; 
        let isInsideDropZone = false;
        let enterTimeoutId = null;

        function triggerProConfetti(e) {
            if (activeTheme === 'DeepFlow Pro') {
                const xPos = e.clientX / window.innerWidth;
                const yPos = e.clientY / window.innerHeight;
                confetti({
                    particleCount: 15, spread: 360, startVelocity: 25, decay: 0.92, gravity: 0, drift: 0,
                    ticks: 150, origin: { x: xPos, y: yPos }, colors: config.confetti, shapes: ['square'], scalar: 1.0
                });
                confetti({
                    particleCount: 10, spread: 360, startVelocity: 15, decay: 0.96, gravity: 0, ticks: 150,
                    origin: { x: xPos, y: yPos }, colors: config.confetti, shapes: ['circle'], scalar: 0.6
                });
            }
        }

        function triggerConfettiBurst(e) {
            if (activeTheme === 'DeepFlow Pro' && typeof triggerProConfetti === 'function') {
                const adjustedEvent = { clientX: lastMouseX, clientY: lastMouseY, target: e.target };
                triggerProConfetti(adjustedEvent);
            }
        }

        function applyTheme() {
            document.body.className = `transition-colors duration-500 ${config.bgClass}`;
            const bgClasses = config.bgClass.split(' '); document.body.classList.add(...bgClasses); 
            document.body.classList.remove('text-white', 'text-gray-900', 'text-gray-600', 'text-fuchsia-400'); document.body.classList.add(config.textColor.replace('text-', '')); 
            
            ['mainTitle', 'subTitle', 'backBtn', 'sampleBtn'].forEach(id => {
                const el = document.getElementById(id);
                el.className = el.className.replace(/text-(white|slate-400|gray-900|gray-600|fuchsia-400)/g, '');
                el.classList.add(id === 'mainTitle' ? config.textColor : config.subTextColor);
            });
            
            document.getElementById('mainTitle').innerText = config.descTitle; 
            document.getElementById('subTitle').innerText = config.descSub; 
            
            document.getElementById('engineLogo').className = `w-16 h-16 mx-auto rounded-2xl flex items-center justify-center mb-6 transition-all duration-500 ${config.logoBg}`;
            document.getElementById('logoIcon').setAttribute('data-lucide', config.icon);
            document.getElementById('consoleCard').className = `w-full max-w-xl rounded-3xl p-3 relative group transition-all duration-500 console-panel ${config.cardClass}`;
            document.getElementById('terminalHeader').style.color = config.accentColor;
            const uploadIconBox = document.getElementById('uploadIcon');
            const iconColor = config.textColor.startsWith('text-') ? config.textColor : `text-${config.textColor}`;
            uploadIconBox.className = `w-20 h-20 rounded-3xl flex items-center justify-center border transition-all duration-300 ${iconColor}`;
            document.getElementById('uploadText').classList.add(config.textColor);
            document.getElementById('uploadSub').classList.add(config.subTextColor);
            
            document.getElementById('uploadText').innerText = config.uploadText;
            document.getElementById('uploadSub').innerText = config.uploadSub;

            const cyberLine = document.getElementById('cyberLine');
            if (activeTheme === 'Cyberpunk') {
                cyberLine.style.background = config.scanLineColor;
                cyberLine.style.display = 'block';
            } else {
                cyberLine.style.display = 'none';
            }
            
            const status = document.getElementById('systemStatus');
            status.style.borderColor = config.accentColor; status.querySelector('div').style.backgroundColor = config.accentColor;
            lucide.createIcons();
        }
        applyTheme();

        const dropZone = document.getElementById('dropZone'); 
        const fileInput = document.getElementById('uploadInput');

        // 1. é˜»æ­¢æµè§ˆå™¨é»˜è®¤è¡Œä¸º (è¿™æ˜¯æœ€å…³é”®çš„ä¸€æ­¥ï¼Œé˜²æ­¢æµè§ˆå™¨ç›´æ¥æ‰“å¼€æ–‡ä»¶)
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // 2. è§†è§‰åé¦ˆï¼šæ‹–æ‹½è¿›æ¥å˜è‰²
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.style.borderColor = config.accentColor;
                dropZone.classList.add('bg-white/5'); // å¢åŠ ä¸€ç‚¹èƒŒæ™¯é«˜äº®
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.style.borderColor = '';
                dropZone.classList.remove('bg-white/5');
            }, false);
        });

        // 3. æ ¸å¿ƒï¼šå¤„ç†æ–‡ä»¶æ”¾ä¸‹ (Drop)
        dropZone.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                handleFiles(files);
            }
        }, false);

        // 4. å¤„ç†ç‚¹å‡»ä¸Šä¼ 
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => { 
            if (e.target.files.length > 0) handleFiles(e.target.files); 
        });

        // --- (ä¿ç•™ä¹‹å‰çš„ç‰¹æ•ˆé€»è¾‘ï¼Œä¸è¦åˆ ) ---
        dropZone.addEventListener('mouseenter', (e) => { 
            // ... (è¿™é‡Œä¿ç•™ä½ ä¹‹å‰çš„ confetti ç‰¹æ•ˆä»£ç ) ...
            if (activeTheme === 'DeepFlow Pro') {
                isInsideDropZone = true; 
                if (enterTimeoutId) clearTimeout(enterTimeoutId);
                const currentEvent = e;
                enterTimeoutId = setTimeout(() => {
                    if (isInsideDropZone) triggerConfettiBurst(currentEvent);
                }, 500);
            }
        });
        
        dropZone.addEventListener('mouseleave', () => { 
            isInsideDropZone = false; 
            if (enterTimeoutId) { clearTimeout(enterTimeoutId); enterTimeoutId = null; }
        });
        
        const updateMousePosition = (e) => { lastMouseX = e.clientX; lastMouseY = e.clientY; };
        dropZone.addEventListener('mousemove', updateMousePosition);
        
        function logStep(msg, icon = 'play', isError = false) {
            const logs = document.getElementById('terminalLogs'); 
            const p = document.createElement('div');
            let iconColor = isError ? 'text-red-400' : (icon === 'check' ? 'text-emerald-400' : (icon === 'loader' ? 'text-blue-400 animate-spin' : 'text-slate-400'));
            p.innerHTML = `<span class="flex items-center gap-2"><i data-lucide="${icon}" class="w-4 h-4 ${iconColor}"></i> <span>${msg}</span></span>`;
            logs.appendChild(p); logs.scrollTop = logs.scrollHeight;
            lucide.createIcons();
        }
        function logError(title, msg) { 
            document.getElementById('processingState').style.color = '#ff0000'; 
            logStep(`[FATAL ERROR] ${title}: ${msg}`, 'alert-triangle', true); 
            setTimeout(() => { alert(`æ„å»ºå¤±è´¥: ${title} - ${msg}`); location.reload(); }, 100); 
        }

        function handleFiles(files) {
            const file = files[0];
            if (!file.name.endsWith('.xlsx')) { logError('æ ¼å¼é”™è¯¯', 'è¯·ä¸Šä¼  .xlsx æ ¼å¼æ–‡ä»¶'); return; }

            document.getElementById('idleState').classList.add('hidden');
            const processView = document.getElementById('processingState');
            processView.classList.remove('hidden'); processView.classList.add('flex');
            document.getElementById('terminalLogs').innerHTML = '';

            if(activeTheme === 'Zen Mode' || activeTheme === 'DeepFlow Pro') { 
                processView.style.background = 'rgba(255,255,255,0.95)';
                processView.style.color = '#000';
            } else { 
                processView.style.background = 'rgba(5,5,5,0.9)';
                processView.style.color = '#fff';
            }

            let pipelineTitle;
            let iconStart = config.icon;
            let themeKeywords = '';

            if (activeTheme === 'DeepFlow Pro') {
                pipelineTitle = 'DOPAMINE SEQUENCE INITIATED';
                themeKeywords = 'å¿ƒæµç®—æ³•å¯åŠ¨';
            } else if (activeTheme === 'Zen Mode') {
                pipelineTitle = 'ZEN MODE ARCHIVE SEQUENCE';
                themeKeywords = 'å½’æ¡£è¿›ç¨‹å°±ç»ª';
            } else {
                pipelineTitle = 'KERNEL UPLOAD PROTOCOL ACTIVE';
                themeKeywords = 'æ•°æ®ä¸Šä¼ åè®®';
            }
            
            logStep(`> ${pipelineTitle} - Theme: ${activeTheme}`, iconStart);
            
            async function runGeneratorPipeline() {
                try {
                    logStep(`-> [1/4] æ¥æ”¶æ–‡ä»¶: ${file.name} | æ­£åœ¨è§£ææ•°æ®ç»“æ„...`, 'loader');
                    await new Promise(r => setTimeout(r, 800)); 
                    
                    const processedData = await parseExcelData(file);
                    const dayCount = processedData.length;
                    
                    if (activeTheme === 'DeepFlow Pro') {
                         logStep(`-> [1/4] æ„‰æ‚¦åé¦ˆæ³¨å…¥æˆåŠŸï¼ä»»åŠ¡å¤©æ•°å·²æ ¡å‡†ä¸º D1 - D${dayCount}.`, 'check');
                    } else {
                         logStep(`-> [1/4] æ•°æ®æ¸…æ´—ä¸ DayNum ä¿®å¤å®Œæˆ (å…± ${dayCount} å¤©è®¡åˆ’)`, 'check');
                    }
                    
                    const planName = file.name.replace(/\.[^/.]+$/, "");
                    
                    logStep(`-> [2/4] æ ¸å¿ƒä»»åŠ¡ï¼šè¯·æ±‚æ¨¡æ¿å¹¶æ‰§è¡Œ ${themeKeywords} ...`, 'code');
                    await new Promise(r => setTimeout(r, 800)); 

                    await realGenerate(processedData, planName);
                    
                    logStep('-> [3/4] ç¼–è¯‘ä¼˜åŒ–å®Œæˆã€‚', 'check');
                    logStep('-> [4/4] æ–‡ä»¶ç”Ÿæˆå®Œæ¯•ï¼Œå·²è§¦å‘ä¸‹è½½ã€‚', 'download');
                    
                    setTimeout(() => { if(confirm(`æ„å»ºæˆåŠŸï¼\n\næ˜¯å¦ç»§ç»­æ„å»ºï¼Ÿ`)) location.reload(); }, 500);

                } catch (err) {
                    logError('å¤„ç†å¤±è´¥', err.message);
                }
            }
            
            runGeneratorPipeline();
        }

        // --- æ ¸å¿ƒå·¥å…·å‡½æ•° (ä¸ä¸Šä¸€ç‰ˆæœ¬ä¿æŒä¸€è‡´) ---
        function excelDateToJSDate(serial) {
            if (!serial) return null;
            if (typeof serial === 'string') return serial.replace(/\//g, '-').trim();
            if (typeof serial === 'number') {
                const date_info = new Date((serial - 25569) * 86400 * 1000);
                return `${date_info.getFullYear()}-${String(date_info.getMonth() + 1).padStart(2, '0')}-${String(date_info.getDate()).padStart(2, '0')}`;
            }
            return null;
        }

        // --- ã€æ›¿æ¢çš„å‡½æ•°ã€‘processData: é›†æˆæ™ºèƒ½æ ‡ç­¾è¯†åˆ«é€»è¾‘ ---
        function processData(jsonData) {
            const rows = jsonData.map(row => {
                const cleanRow = {};
                // æ•°æ®æ¸…æ´—ï¼šè½¬å°å†™å¹¶å»ç©ºæ ¼ï¼Œé˜²æ­¢ Excel åˆ—åå¤§å°å†™é—®é¢˜
                Object.keys(row).forEach(k => cleanRow[k.trim().toLowerCase()] = row[k]);
                
                // è·å–åŸºç¡€ä¿¡æ¯
                const rawDate = cleanRow['date'] || cleanRow['æ—¥æœŸ'] || cleanRow['time'];
                const title = cleanRow['tasktitle'] || cleanRow['task'] || cleanRow['ä»»åŠ¡'] || cleanRow['æ ‡é¢˜'] || 'æœªå‘½åä»»åŠ¡';
                const desc = cleanRow['taskdescription'] || cleanRow['desc'] || cleanRow['æè¿°'] || cleanRow['å¤‡æ³¨'] || '';
                
                // --- ã€æ ¸å¿ƒä¿®æ”¹å¼€å§‹ã€‘æ™ºèƒ½æ ‡ç­¾é€»è¾‘ V2.0 ---
                let finalTag = cleanRow['tag'] || cleanRow['æ ‡ç­¾'] || cleanRow['åˆ†ç±»']; // 1. ä¼˜å…ˆä½¿ç”¨ Excel å¡«å†™çš„ Tag
                
                if (!finalTag) {
                    // 2. å¦‚æœ Excel æ²¡å¡« Tagï¼Œå°è¯•è°ƒç”¨ rules_db.js è¿›è¡Œæ™ºèƒ½è¯†åˆ«
                    // å°†æ ‡é¢˜å’Œæè¿°æ‹¼èµ·æ¥ä¸€èµ·æœï¼Œå¢åŠ è¯†åˆ«ç‡
                    const contentToScan = title + " " + desc;
                    
                    // æ£€æŸ¥ autoDetectTag å‡½æ•°æ˜¯å¦å­˜åœ¨ (ç”± rules_db.js åŠ è½½)
                    if (typeof autoDetectTag === 'function') {
                        const smartResult = autoDetectTag(contentToScan);
                        
                        // æ ‡ç­¾æ ¼å¼ï¼š Emoji + ç²¾å‡†æ ‡ç­¾ (å¦‚: ğŸ‡¬ğŸ‡§ é›…æ€å± é¸­)
                        finalTag = smartResult.emoji ? `${smartResult.emoji} ${smartResult.label}` : smartResult.label; 
                    }
                }

                // 3. å®åœ¨è¯†åˆ«ä¸å‡ºæ¥ (æˆ– rules_db.js æœªåŠ è½½)ï¼Œç»™ä¸ªé»˜è®¤å€¼
                if (!finalTag) finalTag = "ğŸ“Œ æ—¥å¸¸"; 
                // --- ã€æ ¸å¿ƒä¿®æ”¹ç»“æŸã€‘ ---

                return {
                    date: excelDateToJSDate(rawDate),
                    title: title,
                    desc: desc,
                    tag: finalTag // ä½¿ç”¨æœ€ç»ˆå†³å®šçš„æ ‡ç­¾ (åŒ…å« Emoji)
                };
            }).filter(r => r.date); 

            // åç»­é€»è¾‘ä¿æŒä¸å˜ï¼šæ’åºå’ŒæŒ‰æ—¥æœŸåˆ†ç»„
            rows.sort((a, b) => new Date(a.date) - new Date(b.date));

            const uniqueDates = [...new Set(rows.map(r => r.date))];
            const dateToDayNum = {};
            uniqueDates.forEach((date, index) => {
                dateToDayNum[date] = index + 1;
            });

            const daysMap = {};
            rows.forEach(row => {
                if (!daysMap[row.date]) {
                    daysMap[row.date] = {
                        date: row.date,
                        dayNum: dateToDayNum[row.date], 
                        tasks: []
                    };
                }
                daysMap[row.date].tasks.push({ title: row.title, desc: row.desc, tag: row.tag });
            });

            return Object.values(daysMap).sort((a, b) => new Date(a.date) - new Date(b.date));
        }
        
        // è§£æ Excel æ•°æ®çš„åŒ…è£…å‡½æ•°
        function parseExcelData(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                        
                        const processedData = processData(jsonData);
                        if (processedData.length === 0) throw new Error("æœªåœ¨ Excel ä¸­æ‰¾åˆ°æœ‰æ•ˆçš„æ—¥æœŸåˆ—ã€‚");
                        
                        resolve(processedData);
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // æ ¸å¿ƒç”Ÿæˆé€»è¾‘ (Fetch æ¥å£)
        function realGenerate(processedData, planName) {
            return fetch(config.templateURL)
                .then(r => {
                    if (!r.ok) throw new Error(`æ¨¡æ¿æ–‡ä»¶ä¸å­˜åœ¨ã€‚`); return r.text();
                })
                .then(rawTemplate => {
                    // æ³¨æ„ï¼šè¿™é‡Œä»ç„¶ä½¿ç”¨ {{TASKS_DATA}} ä½œä¸º JSON æ•°æ®çš„å ä½ç¬¦
                    const finalHTML = rawTemplate
                        .replace(/{{PLAN_TITLE}}/g, planName)
                        .replace(/{{PLAN_ID}}/g, Date.now())
                        .replace('{{TASKS_DATA}}', JSON.stringify(processedData))
                        .replace('{{CSS_VARS}}', config.cssVars)
                        .replace('{{BODY_CLASS}}', config.bodyClass)
                        .replace('{{ICON_BOX_CLASS}}', config.iconBoxClass)
                        .replace('{{EXTRA_CSS}}', '') 
                        .replace('{{CONFETTI_COLORS}}', JSON.stringify(config.confetti));
                    
                    downloadHTML(finalHTML, `${planName}${config.fileSuffix}.html`);
                });
        }

        function downloadHTML(content, filename) {
            const blob = new Blob([content], {type: 'text/html'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
        function downloadSampleExcel() {
            const wb = XLSX.utils.book_new();
            const ws_data = [["Date", "Tag", "TaskTitle", "TaskDescription"], ["2025-11-28", "æ ¸å¿ƒ", "æµ‹è¯•è‡ªåŠ¨å¤©æ•°1", "è¯´æ˜"], ["2025-11-29", "è¿åŠ¨", "æµ‹è¯•è‡ªåŠ¨å¤©æ•°2", "è¯´æ˜"]];
            const ws = XLSX.utils.aoa_to_sheet(ws_data); XLSX.utils.book_append_sheet(wb, ws, "Sheet1"); XLSX.writeFile(wb, "DeepFlow_Demo.xlsx");
        }
    </script>