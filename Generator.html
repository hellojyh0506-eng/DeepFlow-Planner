<!DOCTYPE html>
<html lang="zh-CN" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepFlow | æ„å»ºä¸­å¿ƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=Noto+Sans+SC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', '"Noto Sans SC"', 'sans-serif'] },
                    animation: { 
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #020617; color: white; overflow-x: hidden; }
        .glass-nav { background: rgba(2, 6, 23, 0.7); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255,255,255,0.05); }

        /* === æ ¸å¿ƒèƒŒæ™¯è§†è§‰ === */
        .deep-space-bg {
            position: fixed; inset: 0; z-index: -2;
            background: 
                radial-gradient(circle at 15% 50%, rgba(30, 58, 138, 0.4) 0%, transparent 50%), 
                radial-gradient(circle at 85% 30%, rgba(88, 28, 135, 0.25) 0%, transparent 50%);
            background-size: 100% 100%;
        }
        .grid-overlay {
            position: fixed; inset: 0; z-index: -1;
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
            pointer-events: none;
        }

        /* === ç»ç’ƒé¢æ¿å®¹å™¨ === */
        .glass-panel { 
            background: rgba(255,255,255,0.02); 
            border: 1px solid rgba(255,255,255,0.05); 
            backdrop-filter: blur(10px);
            transition: all 0.3s; 
        }
        .glass-panel:hover { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); }

        /* ==========================================================================
           ã€æ ¸å¿ƒç§»æ¤ã€‘æ¥è‡ª Index.html çš„é¡¶çº§ç‰¹æ•ˆå¡ç‰‡æ ·å¼ (å®Œå…¨ä¿ç•™)
           ========================================================================== */
        
        /* åŸºç¡€é€‰æ‹©å¡ç‰‡å®¹å™¨ */
        .selection-card {
            position: relative;
            border-radius: 20px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            min-height: 220px;
        }
        .selection-card:hover { transform: translateY(-5px) scale(1.02); }

        /* --- PRO ä¸»é¢˜ç‰¹æ•ˆ --- */
        .card-pro-premium {
            background: rgba(255, 255, 255, 0.05); 
            color: white; 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(20px); 
        }
        .card-pro-premium::before {
            content: ''; position: absolute; inset: -50%; 
            background: 
                radial-gradient(circle at 80% 20%, rgba(255, 100, 150, 0.8) 0%, transparent 20%), 
                radial-gradient(circle at 20% 80%, rgba(255, 255, 100, 0.7) 0%, transparent 25%), 
                radial-gradient(circle at 50% 100%, rgba(59, 130, 246, 0.7) 0%, transparent 30%); 
            background-size: 300% 300%;
            filter: blur(60px) saturate(3.5) contrast(1.5);
            opacity: 0.4;
            z-index: 0;
            pointer-events: none;
            mix-blend-mode: screen; 
            transition: transform 0.8s ease, opacity 0.5s; 
        }
        .card-pro-premium:hover::before { transform: scale(1.1) rotate(5deg); opacity: 0.8; }
        .card-pro-premium:hover { border-color: rgba(236, 72, 153, 0.5); box-shadow: 0 10px 30px rgba(236, 72, 153, 0.2); }
        .card-pro-premium.selected {
            border-color: #3b82f6; 
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.5), 0 10px 40px rgba(59, 130, 246, 0.4);
        }

        /* --- ZEN ä¸»é¢˜ç‰¹æ•ˆ --- */
        .card-zen-matte {
            background: #ffffff; 
            color: #18181b; 
            border: 1px solid #e4e4e7;
        }
        .card-zen-matte .zen-text { color: #52525b; transition: color 0.3s; }
        .card-zen-matte:hover .zen-text { color: #18181b; }
        .card-zen-matte:hover { box-shadow: 0 0 30px rgba(255, 255, 255, 0.4); border-color: #d4d4d4; }
        .card-zen-matte.selected {
            border-color: #18181b;
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.5), 0 0 0 6px #18181b;
        }

        /* --- CYBER ä¸»é¢˜ç‰¹æ•ˆ --- */
        .card-cyber-neon {
            background: #09090b; border: 1px solid rgba(217, 70, 239, 0.3);
            background-image: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(217, 70, 239, 0.05) 3px);
        }
        .card-cyber-neon:hover {
            box-shadow: 0 0 40px rgba(217, 70, 239, 0.5), inset 0 0 20px rgba(217, 70, 239, 0.1);
            border-color: #d946ef;
        }
        .card-cyber-neon.selected {
            border-color: #d946ef;
            box-shadow: 0 0 0 2px #09090b, 0 0 0 4px #d946ef, 0 0 50px rgba(217, 70, 239, 0.6);
        }

        /* é€‰ä¸­çŠ¶æ€çš„æ‰“å‹¾å›¾æ ‡åŠ¨ç”» */
        .check-circle {
            position: absolute; top: 1rem; right: 1rem; z-index: 20;
            width: 24px; height: 24px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transform: scale(0.5); transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .selected .check-circle { opacity: 1; transform: scale(1); }

        /* æ¨¡æ€æ¡†åŠ¨ç”» */
        .modal-enter { opacity: 0; transform: translateY(-20px); }
        .modal-enter-active { opacity: 1; transform: translateY(0); transition: opacity 0.3s ease, transform 0.3s ease; }

        /* è®¡åˆ’æ ‡é¢˜è¾“å…¥å¼¹çª—æ ·å¼ */
        .modal-bg-enter { opacity: 0; pointer-events: none; }
        .modal-bg-enter-active { opacity: 1; pointer-events: auto; transition: opacity 0.3s ease; }
        .modal-content-enter { transform: scale(0.95) translateY(10px); opacity: 0; }
        .modal-content-enter-active { transform: scale(1) translateY(0); opacity: 1; transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); }

        /* ==========================================================================
           ã€æ–°å¢ã€‘åœ¨çº¿æ„å»ºå™¨ (Builder) æ ·å¼
           ========================================================================== */
        .tab-btn { position: relative; color: #94a3b8; transition: all 0.3s; padding-bottom: 0.5rem; }
        .tab-btn.active { color: white; font-weight: 700; }
        .tab-btn.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 2px; background: #3b82f6; box-shadow: 0 0 10px #3b82f6; }
        
        .builder-day { border-left: 2px solid rgba(255,255,255,0.1); padding-left: 1rem; margin-bottom: 1.5rem; position: relative; transition: all 0.3s; }
        .builder-day:hover { border-left-color: #3b82f6; background: rgba(255,255,255,0.02); }
        
        .builder-input { 
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); 
            color: white; padding: 0.5rem 0.75rem; border-radius: 0.5rem; width: 100%; 
            outline: none; transition: 0.3s; font-size: 0.9rem; 
        }
        .builder-input:focus { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }

    </style>
</head>
<body class="antialiased selection:bg-blue-500/30">

    <div class="deep-space-bg"></div>
    <div class="grid-overlay"></div>

    <nav class="fixed w-full z-50 glass-nav">
        <div class="max-w-7xl mx-auto px-6 h-20 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-gradient-to-tr from-blue-600 to-purple-600 p-1.5 rounded-lg shadow-lg"><i data-lucide="zap" class="text-white w-5 h-5"></i></div>
                <span class="font-black text-xl tracking-tight">DeepFlow</span>
            </div>
            <a href="index.html" class="bg-white/10 text-white px-4 py-2 rounded-full font-bold text-sm hover:bg-white/20 transition border border-white/10">
                <i data-lucide="arrow-left" class="w-4 h-4 inline mr-1"></i> è¿”å›ä¸»é¡µ
            </a>
        </div>
    </nav>

    <section class="relative pt-32 pb-24 md:pt-48 md:pb-32 min-h-screen">
        <div class="max-w-4xl mx-auto px-6 relative z-10 text-center">
            <h1 class="text-4xl md:text-5xl font-black mb-4 leading-tight tracking-tight text-white drop-shadow-xl">
                å¼€å§‹æ„å»ºä½ çš„å¿ƒæµ App
            </h1>
            <p class="text-slate-400 text-lg max-w-2xl mx-auto mb-12">
                ä¸Šä¼  Excel è®¡åˆ’è¡¨ï¼Œæˆ–åœ¨çº¿ç›´æ¥åˆ›å»ºï¼Œä¸€é”®ç”Ÿæˆã€‚
            </p>

            <div class="space-y-12">
                
                <div class="glass-panel p-8 rounded-3xl text-left transition-all duration-300">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4 border-b border-white/5 pb-4">
                        <div class="flex items-center gap-4">
                            <span class="text-4xl font-black text-blue-500">1</span>
                            <h2 class="text-2xl font-bold">å‡†å¤‡è®¡åˆ’æ•°æ®</h2>
                        </div>
                        
                        <div class="flex gap-6 text-sm font-bold w-full md:w-auto">
                            <button onclick="switchMode('upload')" id="tab-upload" class="tab-btn active flex items-center gap-2">
                                <i data-lucide="upload-cloud" class="w-4 h-4"></i> ä¸Šä¼  Excel
                            </button>
                            <button onclick="switchMode('builder')" id="tab-builder" class="tab-btn flex items-center gap-2">
                                <i data-lucide="layout-list" class="w-4 h-4"></i> åœ¨çº¿æ„å»º <span class="text-[10px] bg-blue-500 text-white px-1.5 rounded ml-1">NEW</span>
                            </button>
                        </div>
                    </div>

                    <div id="mode-upload" class="block animate-[fadeIn_0.5s_ease-out]">
                        <div class="flex justify-end mb-2">
                            <button onclick="downloadSampleExcel()" class="text-xs font-bold text-blue-400 hover:text-white flex items-center gap-1 transition-colors">
                                <i data-lucide="download" class="w-3 h-3"></i> ä¸‹è½½æ ‡å‡† Excel æ¨¡ç‰ˆ
                            </button>
                        </div>
                        <label for="excel-file" class="flex flex-col items-center justify-center p-12 border-2 border-dashed border-white/10 rounded-2xl cursor-pointer hover:bg-white/5 hover:border-blue-500/50 transition-all group bg-slate-900/50">
                            <div class="w-16 h-16 bg-blue-500/10 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                                <i data-lucide="file-spreadsheet" class="w-8 h-8 text-blue-400"></i>
                            </div>
                            <p class="text-lg font-bold text-white">ç‚¹å‡»ä¸Šä¼  / æ‹–æ‹½ Excel æ–‡ä»¶</p>
                            <p id="file-status" class="text-sm text-slate-400 mt-2">æ”¯æŒï¼šæ—¥æœŸã€ä»»åŠ¡æ ‡é¢˜ã€æè¿°ã€æ ‡ç­¾ã€æ—¶é—´ç­‰</p>
                            <input type="file" id="excel-file" accept=".xlsx" class="hidden" onchange="handleFileChange(event)">
                        </label>
                    </div>

                    <div id="mode-builder" class="hidden">
                        <div class="bg-slate-900/50 rounded-2xl border border-white/10 p-6">
                            
                            <div class="mb-6 p-4 bg-blue-500/5 rounded-xl border border-blue-500/10">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="font-bold text-blue-400 text-sm flex items-center gap-2"><i data-lucide="sparkles" class="w-4 h-4"></i> æ™ºèƒ½æ–‡æœ¬è§£æ</h3>
                                    <button onclick="parseSmartText()" class="text-xs bg-blue-600 hover:bg-blue-500 px-3 py-1.5 rounded text-white transition font-bold shadow-lg shadow-blue-500/20 flex items-center gap-1">
                                        <i data-lucide="wand-2" class="w-3 h-3"></i> ç”Ÿæˆè¡¨æ ¼
                                    </button>
                                </div>
                                <textarea id="smart-text-input" class="w-full bg-slate-950/50 border border-white/10 rounded-lg p-3 text-sm text-slate-300 focus:border-blue-500 focus:outline-none h-24 resize-none placeholder-slate-600 font-mono" placeholder="ç²˜è´´ç¤ºä¾‹ï¼š&#10;æ ¸å¿ƒ é«˜æ•°ç¬¬ä¸€ç«  åˆ·é¢˜ 0900 90&#10;è¿åŠ¨ æ™¨è·‘5KM 40"></textarea>
                                <div class="flex gap-2 mt-3 overflow-x-auto pb-1 no-scrollbar">
                                    <span class="text-[10px] text-slate-500 self-center mr-2">å¿«é€Ÿé¢„è®¾:</span>
                                    <button onclick="loadPreset('ielts')" class="whitespace-nowrap px-2 py-1 rounded border border-white/10 bg-white/5 text-[10px] hover:bg-white/10 text-slate-300 transition">ğŸ‡¬ğŸ‡§ é›…æ€å†²åˆº</button>
                                    <button onclick="loadPreset('code')" class="whitespace-nowrap px-2 py-1 rounded border border-white/10 bg-white/5 text-[10px] hover:bg-white/10 text-slate-300 transition">ğŸ’» ç®—æ³•å‘¨</button>
                                    <button onclick="loadPreset('habit')" class="whitespace-nowrap px-2 py-1 rounded border border-white/10 bg-white/5 text-[10px] hover:bg-white/10 text-slate-300 transition">ğŸ§˜ 21å¤©ä¹ æƒ¯</button>
                                </div>
                            </div>

                            <div id="builder-container" class="space-y-4 max-h-[500px] overflow-y-auto pr-2 custom-scrollbar mb-6">
                                <div class="text-center text-slate-500 py-10 border border-dashed border-slate-700 rounded-xl">
                                    æš‚æ— å†…å®¹ï¼Œè¯·ä½¿ç”¨ä¸Šæ–¹æ™ºèƒ½è§£ææˆ–ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ 
                                </div>
                            </div>

                            <div class="pt-2 flex justify-center border-t border-white/5 mt-4">
                                <button onclick="addBuilderDay()" class="w-full py-3 flex items-center justify-center gap-2 text-sm font-bold text-slate-400 hover:text-white transition hover:bg-white/5 rounded-xl border border-dashed border-slate-700 hover:border-slate-500">
                                    <i data-lucide="plus-circle" class="w-4 h-4"></i> æ·»åŠ æ–°çš„ä¸€å¤©
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass-panel p-8 rounded-3xl text-left">
                    <div class="flex items-center gap-4 mb-6">
                        <span class="text-4xl font-black text-purple-500">2</span>
                        <h2 class="text-2xl font-bold">é€‰æ‹© App ä¸»é¢˜</h2>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        
                        <div id="theme-pro" onclick="selectTheme('pro')" class="selection-card card-pro-premium group">
                            <div class="relative z-10 flex flex-col h-full">
                                <div class="flex justify-between items-start mb-6">
                                    <div class="w-12 h-12 rounded-2xl bg-white flex items-center justify-center backdrop-blur-md shadow-[0_0_20px_rgba(236,72,153,0.4)]">
                                        <i data-lucide="zap" class="w-6 h-6 text-pink-500 fill-pink-500/20"></i>
                                    </div>
                                    <div class="check-circle bg-blue-500 shadow-lg shadow-blue-500/50">
                                        <i data-lucide="check" class="w-4 h-4 text-white"></i>
                                    </div>
                                </div>
                                <h3 class="text-2xl font-black text-white mb-2 tracking-tight group-hover:text-pink-200 transition-colors">DeepFlow Pro</h3>
                                <p class="text-white/70 text-xs font-medium leading-relaxed mb-4">
                                    é›†æ•ˆç‡ä¸ç¾å­¦äºå¤§æˆã€‚å†…ç½®å¤šå·´èƒºåé¦ˆç®—æ³•ï¼Œç²’å­ç‰¹æ•ˆä¸æ²‰æµ¸éŸ³æ•ˆã€‚
                                </p>
                                <div class="mt-auto flex items-center gap-2 text-[10px] font-mono text-white/50 uppercase">
                                    <span class="bg-white/10 px-2 py-1 rounded">å¤šå·´èƒºå…‰æ•ˆ</span>
                                    <span class="bg-white/10 px-2 py-1 rounded">ASMR</span>
                                </div>
                            </div>
                        </div>

                        <div id="theme-zen" onclick="selectTheme('zen')" class="selection-card card-zen-matte group">
                            <div class="relative z-10 flex flex-col h-full">
                                <div class="flex justify-between items-start mb-6">
                                    <div class="w-12 h-12 rounded-2xl bg-white flex items-center justify-center border border-zinc-200 shadow-lg">
                                        <i data-lucide="moon" class="w-6 h-6 text-zinc-800"></i>
                                    </div>
                                    <div class="check-circle bg-zinc-900 shadow-lg">
                                        <i data-lucide="check" class="w-4 h-4 text-white"></i>
                                    </div>
                                </div>
                                <h3 class="text-2xl font-black text-zinc-900 mb-2 tracking-tight">Zen Mode</h3>
                                <p class="text-zinc-500 text-xs font-medium leading-relaxed mb-4 zen-text">
                                    æè‡´çš„é»‘ç™½ç°åº¦è®¾è®¡ã€‚å»é™¤æ‰€æœ‰è‰²å½©å¹²æ‰°ï¼Œåˆ›é€ é›¶ç„¦è™‘çš„ä¸“æ³¨ç¯å¢ƒã€‚
                                </p>
                                <div class="mt-auto flex items-center gap-2 text-[10px] font-mono text-zinc-400 uppercase">
                                    <span class="bg-zinc-100 px-2 py-1 rounded border border-zinc-200">æç®€ä¸»ä¹‰</span>
                                    <span class="bg-zinc-100 px-2 py-1 rounded border border-zinc-200">å¢¨æ°´å±æ„Ÿ</span>
                                </div>
                            </div>
                        </div>

                        <div id="theme-cyberpunk" onclick="selectTheme('cyberpunk')" class="selection-card card-cyber-neon group">
                            <div class="relative z-10 flex flex-col h-full">
                                <div class="flex justify-between items-start mb-6">
                                    <div class="w-12 h-12 rounded-2xl bg-transparent border border-fuchsia-500 text-fuchsia-500 flex items-center justify-center shadow-[0_0_15px_rgba(217,70,239,0.3)]">
                                        <i data-lucide="gamepad-2" class="w-6 h-6"></i>
                                    </div>
                                    <div class="check-circle bg-fuchsia-500 shadow-[0_0_15px_rgba(217,70,239,0.5)]">
                                        <i data-lucide="check" class="w-4 h-4 text-white"></i>
                                    </div>
                                </div>
                                <h3 class="text-2xl font-black text-white mb-2 tracking-wide" style="text-shadow: 0 0 10px rgba(217,70,239,0.5)">Cyberpunk</h3>
                                <p class="text-fuchsia-200/60 text-xs font-medium leading-relaxed mb-4">
                                    é«˜å¯¹æ¯”åº¦éœ“è™¹ç½‘ç»œã€‚å°†ä»»åŠ¡åˆ—è¡¨è½¬åŒ–ä¸ºæˆ˜æ–— HUD ç•Œé¢ã€‚è‚¾ä¸Šè…ºç´ é©±åŠ¨ã€‚
                                </p>
                                <div class="mt-auto flex items-center gap-2 text-[10px] font-mono text-fuchsia-500/70 uppercase">
                                    <span class="border border-fuchsia-900 px-2 py-1 rounded bg-fuchsia-900/10">æ•…éšœè‰ºæœ¯</span>
                                    <span class="border border-fuchsia-900 px-2 py-1 rounded bg-fuchsia-900/10">HUD</span>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="glass-panel p-8 rounded-3xl text-left">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <span class="text-4xl font-black text-emerald-500">3</span>
                            <h2 class="text-2xl font-bold">æœ€ç»ˆç¡®è®¤</h2>
                        </div>
                        
                        <button id="generate-button" onclick="generateApp()" class="px-8 py-4 bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 text-white rounded-xl font-bold text-lg shadow-lg shadow-emerald-600/30 transition-all hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0" disabled>
                            <i data-lucide="sparkles" class="w-5 h-5 inline mr-2"></i> ç”Ÿæˆæˆ‘çš„ App
                        </button>
                    </div>
                    <div class="mt-4 text-slate-400 text-sm" id="generation-summary">
                        è¯·å…ˆå‡†å¤‡æ•°æ®å¹¶é€‰æ‹©ä¸»é¢˜ã€‚
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <div id="custom-alert-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center opacity-0 hidden transition-opacity duration-300">
        <div id="modal-content" class="bg-slate-900 p-8 rounded-2xl shadow-2xl border border-white/10 max-w-md w-full transform scale-95 transition-transform duration-300">
            <h3 id="alert-title" class="text-xl font-black mb-4 flex items-center gap-2 text-white"></h3>
            <p id="alert-message" class="text-slate-300 mb-6 leading-relaxed"></p>
            <button onclick="closeCustomAlert()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-semibold py-3 rounded-xl transition-colors">
                æˆ‘æ˜ç™½äº†
            </button>
        </div>
    </div>

    <div id="title-input-modal" class="fixed inset-0 bg-black/80 backdrop-blur-md z-50 flex items-center justify-center modal-bg-enter transition-all duration-300">
        <div id="title-modal-panel" class="bg-slate-900/90 border border-blue-500/20 p-8 rounded-3xl shadow-[0_0_50px_rgba(59,130,246,0.15)] w-full max-w-lg modal-content-enter relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-blue-500/10 rounded-full blur-[50px] pointer-events-none"></div>
            
            <h3 class="text-2xl font-black text-white mb-2 flex items-center gap-2">
                <i data-lucide="edit-3" class="w-6 h-6 text-blue-400"></i> ä¸ºè®¡åˆ’å‘½å
            </h3>
            <p class="text-slate-400 text-sm mb-8 leading-relaxed">
                ç»™ç”Ÿæˆçš„ App èµ·ä¸€ä¸ªä¸“å±åå­—ã€‚è¿™å°†æ˜¾ç¤ºåœ¨æµè§ˆå™¨çš„æ ‡é¢˜æ å’Œåº”ç”¨é¦–é¡µã€‚
            </p>
            
            <div class="relative mb-8">
                <input type="text" id="plan-title-input" 
                    class="w-full bg-slate-950/50 border border-slate-700 rounded-xl px-5 py-4 text-white text-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all placeholder-slate-600 font-bold tracking-wide" 
                    placeholder="DeepFlow ä¸ªäººå­¦ä¹ è®¡åˆ’" 
                    onkeydown="if(event.key === 'Enter') confirmTitleModal(); if(event.key === 'Escape') cancelTitleModal();"
                >
                <div class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-600 text-xs font-mono border border-slate-700 px-2 py-1 rounded">ENTER ç¡®è®¤</div>
            </div>

            <div class="flex justify-end gap-3">
                <button onclick="cancelTitleModal()" class="px-6 py-3 text-slate-400 hover:text-white font-bold transition rounded-xl hover:bg-white/5">
                    å–æ¶ˆ
                </button>
                <button onclick="confirmTitleModal()" class="px-8 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white rounded-xl font-bold shadow-lg shadow-blue-600/20 transition-all transform hover:-translate-y-0.5 active:scale-95 flex items-center gap-2">
                    <i data-lucide="rocket" class="w-4 h-4"></i> å¼€å§‹ç”Ÿæˆ
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // åˆå§‹åŒ–å›¾æ ‡
        lucide.createIcons();
        
        // å…¨å±€å˜é‡
        let currentMode = 'upload'; // 'upload' | 'builder'
        let uploadedData = null;
        let builderData = []; 
        let selectedTheme = null;
        let titlePromiseResolve = null;

        // ============================================
        // æ¨¡å¼åˆ‡æ¢ä¸æ„å»ºå™¨é€»è¾‘ (NEW)
        // ============================================
        
        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tab-' + mode).classList.add('active');
            
            if(mode === 'upload') {
                document.getElementById('mode-upload').classList.remove('hidden');
                document.getElementById('mode-builder').classList.add('hidden');
            } else {
                document.getElementById('mode-upload').classList.add('hidden');
                document.getElementById('mode-builder').classList.remove('hidden');
                if(builderData.length === 0) addBuilderDay();
            }
            updateSummary();
        }

        // --- æ ¸å¿ƒä¿®å¤ï¼šæ›´å¼ºçš„æ„å»ºå™¨æ¸²æŸ“ (åŒ…å«æ‰€æœ‰å­—æ®µ) ---
        function renderBuilder() {
            const container = document.getElementById('builder-container');
            container.innerHTML = '';
            
            if(builderData.length === 0) {
                 container.innerHTML = '<div class="text-center text-slate-500 py-10 border border-dashed border-slate-700 rounded-xl">æš‚æ— æ•°æ®ï¼Œè¯·ä½¿ç”¨ä¸Šæ–¹æ™ºèƒ½è§£ææˆ–ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ </div>';
                 return;
            }

            builderData.forEach((day, dIdx) => {
                const dayEl = document.createElement('div');
                dayEl.className = 'builder-day group';
                dayEl.innerHTML = `
                    <div class="flex justify-between items-center mb-3 bg-slate-800/40 p-2.5 rounded-lg border border-white/5 hover:border-blue-500/30 transition-colors">
                        <div class="flex items-center gap-3">
                            <span class="text-[10px] font-bold text-slate-300 bg-slate-700/50 px-2 py-1 rounded shadow-sm">DAY ${dIdx + 1}</span>
                            <div class="h-4 w-px bg-white/10"></div>
                            <input type="text" value="${day.date || ''}" onchange="updateBuilderDate(${dIdx}, this.value)" class="bg-transparent border-none text-sm font-bold text-white focus:outline-none w-32 placeholder-slate-600" placeholder="YYYY-MM-DD">
                        </div>
                        <button onclick="removeBuilderDay(${dIdx})" class="text-slate-500 hover:text-red-400 transition opacity-0 group-hover:opacity-100 p-1.5 hover:bg-white/5 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                    <div class="space-y-3 pl-2 border-l border-white/5 ml-4" id="tasks-container-${dIdx}">
                        ${day.tasks.map((task, tIdx) => `
                            <div class="bg-slate-900/30 p-2 rounded-lg border border-white/5">
                                <div class="flex gap-2 items-center mb-2">
                                    <input type="text" value="${task.tag || ''}" onchange="updateBuilderTask(${dIdx}, ${tIdx}, 'tag', this.value)" class="builder-input w-20 text-center text-xs text-blue-300 font-bold" placeholder="æ ‡ç­¾">
                                    <input type="text" value="${task.title}" onchange="updateBuilderTask(${dIdx}, ${tIdx}, 'title', this.value)" class="builder-input flex-1 font-bold" placeholder="ä»»åŠ¡æ ¸å¿ƒå†…å®¹">
                                    <button onclick="removeBuilderTask(${dIdx}, ${tIdx})" class="text-slate-600 hover:text-red-400 px-1"><i data-lucide="x" class="w-3.5 h-3.5"></i></button>
                                </div>
                                <div class="flex gap-2 items-center">
                                    <input type="text" value="${task.time || ''}" onchange="updateBuilderTask(${dIdx}, ${tIdx}, 'time', this.value)" class="builder-input w-24 text-xs font-mono" placeholder="æ—¶é—´(09:00)">
                                    <input type="text" value="${task.duration || ''}" onchange="updateBuilderTask(${dIdx}, ${tIdx}, 'duration', this.value)" class="builder-input w-20 text-xs font-mono" placeholder="æ—¶é•¿(åˆ†)">
                                    <input type="text" value="${task.desc || ''}" onchange="updateBuilderTask(${dIdx}, ${tIdx}, 'desc', this.value)" class="builder-input flex-1 text-xs text-slate-400" placeholder="å¤‡æ³¨/æè¿°...">
                                </div>
                            </div>
                        `).join('')}
                        <button onclick="addBuilderTask(${dIdx})" class="mt-2 text-[11px] text-blue-400 hover:text-blue-300 flex items-center gap-1 opacity-60 hover:opacity-100 transition px-1 py-1"><i data-lucide="plus" class="w-3 h-3"></i> æ·»åŠ ä»»åŠ¡</button>
                    </div>
                `;
                container.appendChild(dayEl);
            });
            lucide.createIcons();
            updateSummary();
        }

        // æ„å»ºå™¨æ•°æ®æ“ä½œ
        function addBuilderDay() {
            const today = new Date();
            today.setDate(today.getDate() + builderData.length);
            const dateStr = today.toISOString().split('T')[0];
            // å®Œæ•´å­—æ®µåˆå§‹åŒ–ï¼Œé˜²æ­¢ç”ŸæˆæŠ¥é”™
            builderData.push({ date: dateStr, tasks: [{ title: '', tag: '', desc: '', time: '', duration: null }] });
            renderBuilder();
        }

        function removeBuilderDay(idx) {
            builderData.splice(idx, 1);
            renderBuilder();
        }

        function addBuilderTask(dayIdx) {
            builderData[dayIdx].tasks.push({ title: '', tag: '', desc: '', time: '', duration: null });
            renderBuilder();
        }

        function removeBuilderTask(dayIdx, taskIdx) {
            builderData[dayIdx].tasks.splice(taskIdx, 1);
            renderBuilder();
        }

        function updateBuilderDate(dIdx, val) { builderData[dIdx].date = val; }
        function updateBuilderTask(dIdx, tIdx, field, val) { builderData[dIdx].tasks[tIdx][field] = val; }

        // --- æ ¸å¿ƒä¿®å¤ï¼šæ™ºèƒ½è§£æ (è¯†åˆ« Tag Title Time Duration) ---
        function parseSmartText() {
            const text = document.getElementById('smart-text-input').value;
            if(!text.trim()) return;

            const lines = text.split('\n');
            const newPlan = [];
            let currentDay = null;
            let dayCount = 0;

            const datePatterns = [/day\s*(\d+)/i, /ç¬¬\s*(\d+)\s*å¤©/, /(\d{4}-\d{2}-\d{2})/, /ä»Šå¤©/, /æ˜å¤©/];

            lines.forEach(line => {
                line = line.trim();
                if(!line) return;

                // 1. æ—¥æœŸè¡Œæ£€æµ‹
                let isDateLine = false;
                for(let p of datePatterns) {
                    if(p.test(line)) {
                        isDateLine = true;
                        if(currentDay) newPlan.push(currentDay);
                        dayCount++;
                        
                        const today = new Date();
                        today.setDate(today.getDate() + (dayCount-1));
                        const dateStr = today.toISOString().split('T')[0];

                        currentDay = { date: dateStr, tasks: [] };
                        break; // ç®€å•èµ·è§ï¼Œæ—¥æœŸè¡Œä¸åŒ…å«ä»»åŠ¡
                    }
                }

                if(!isDateLine) {
                    if(!currentDay) {
                        currentDay = { date: new Date().toISOString().split('T')[0], tasks: [] };
                        dayCount++;
                    }
                    
                    // 2. ä»»åŠ¡è¡Œæ™ºèƒ½æ‹†è§£ (æ ¼å¼ï¼šTag Title... Time Duration)
                    // ç®€å•ç­–ç•¥ï¼šæŒ‰ç©ºæ ¼åˆ†å‰²ï¼Œå¹¶æ£€æµ‹æœ«å°¾çš„æ—¶é—´/æ—¶é•¿
                    const parts = line.split(/\s+/);
                    if(parts.length > 0) {
                        let tag = 'è‡ªåŠ¨', title = '', time = '', duration = null, desc = '';
                        
                        // å°è¯•è¯†åˆ«æœ«å°¾çš„çº¯æ•°å­—ä¸º duration (å¦‚ 90)
                        let last = parts[parts.length-1];
                        if(/^\d+$/.test(last) && parts.length > 1) {
                            duration = parseInt(last);
                            parts.pop();
                        }
                        
                        // å°è¯•è¯†åˆ«æœ«å°¾çš„æ—¶é—´ (å¦‚ 0900 or 09:00)
                        if(parts.length > 1) {
                             last = parts[parts.length-1];
                             if(/^(\d{4}|\d{1,2}:\d{2})$/.test(last)) {
                                 // æ ¼å¼åŒ–æ—¶é—´ 0900 -> 09:00
                                 if(last.length === 4 && !last.includes(':')) {
                                     time = last.substring(0,2) + ":" + last.substring(2);
                                 } else {
                                     time = last;
                                 }
                                 parts.pop();
                             }
                        }

                        // å°è¯•è¯†åˆ«ç¬¬ä¸€ä¸ªè¯ä¸º Tag (é•¿åº¦å°äº5ï¼Œä¸”ä¸æ˜¯çº¯æ•°å­—)
                        if(parts.length > 1 && parts[0].length < 6 && !/^\d+$/.test(parts[0])) {
                            tag = parts[0];
                            parts.shift();
                        }

                        title = parts.join(' ');
                        
                        currentDay.tasks.push({ title, tag, time, duration, desc });
                    }
                }
            });
            if(currentDay) newPlan.push(currentDay);

            if(newPlan.length > 0) {
                builderData = newPlan;
                renderBuilder();
                customAlert(`è§£ææˆåŠŸï¼ç”Ÿæˆ ${newPlan.length} å¤©è®¡åˆ’`, 'è§£ææˆåŠŸ', 'sparkles');
            }
        }
        
        function loadPreset(type) {
            const today = new Date();
            const getDate = (offset) => {
                const d = new Date(today); d.setDate(today.getDate() + offset);
                return d.toISOString().split('T')[0];
            };

            if(type === 'ielts') {
                builderData = [
                    { date: getDate(0), tasks: [{title:'èƒŒè¯µé›…æ€æ ¸å¿ƒè¯æ±‡ List 1', tag:'è¯æ±‡', desc:'', time:'08:00', duration:45}, {title:'å‰‘æ¡¥é›…æ€ 14 Test 1 å¬åŠ›', tag:'å¬åŠ›', desc:'é”™é¢˜æ•´ç†', time:'09:00', duration:40}] },
                    { date: getDate(1), tasks: [{title:'å¤ä¹ é”™é¢˜æœ¬', tag:'å¤ä¹ ', desc:'', time:'08:00', duration:30}, {title:'é˜…è¯»é•¿éš¾å¥åˆ†æ 5 å¥', tag:'é˜…è¯»', desc:'', time:'', duration:null}] }
                ];
            } else if (type === 'code') {
                builderData = [
                    { date: getDate(0), tasks: [{title:'LeetCode: Two Sum', tag:'Array', desc:'', time:'', duration:null}, {title:'LeetCode: Valid Parentheses', tag:'Stack', desc:'', time:'', duration:null}] },
                    { date: getDate(1), tasks: [{title:'å­¦ä¹ äºŒå‰æ ‘éå†ç®—æ³•', tag:'Tree', desc:'', time:'', duration:null}, {title:'å®ç°å¿«é€Ÿæ’åº', tag:'Sort', desc:'', time:'', duration:null}] }
                ];
            } else if (type === 'habit') {
                builderData = [];
                for(let i=0; i<3; i++) builderData.push({ date: getDate(i), tasks: [{title:'å†¥æƒ³ 10 åˆ†é’Ÿ', tag:'Mind', desc:'', time:'', duration:null}, {title:'é˜…è¯» 30 åˆ†é’Ÿ', tag:'Read', desc:'', time:'', duration:null}] });
            }
            renderBuilder();
        }

        // ============================================
        // æ ¸å¿ƒå·¥å…·å‡½æ•° (åŸç‰ˆä¿ç•™)
        // ============================================

        function formatExcelTime(val) {
            if (val === undefined || val === null || val === '') return '';
            
            if (typeof val === 'number') {
                const totalSeconds = Math.round(val * 86400);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const pad = (n) => n < 10 ? '0' + n : n;
                return pad(hours) + ':' + pad(minutes);
            }
            
            return String(val).trim();
        }

        // å¤„ç†Excelæ•°æ® (å®Œæ•´é€»è¾‘)
        function processTasksData(rawArray) {
            console.log('å¼€å§‹å¤„ç†Excelæ•°æ®ï¼Œè¡Œæ•°:', rawArray.length);
            
            if (!rawArray || rawArray.length < 2) {
                console.warn('æ•°æ®è¡Œæ•°ä¸è¶³');
                return [];
            }

            // æŸ¥æ‰¾è¡¨å¤´è¡Œ
            let headerRowIndex = -1;
            let colMap = {
                date: -1, 
                title: -1, 
                desc: -1, 
                tag: -1, 
                time: -1, 
                duration: -1
            };

            for (let r = 0; r < Math.min(rawArray.length, 5); r++) {
                const rowStr = rawArray[r].map(c => String(c).trim().toLowerCase());
                
                const dateIdx = rowStr.findIndex(c => c.includes('date') || c.includes('æ—¥æœŸ'));
                const titleIdx = rowStr.findIndex(c => c.includes('task') || c.includes('æ ‡é¢˜') || c.includes('ä»»åŠ¡'));

                if (dateIdx !== -1 && titleIdx !== -1) {
                    headerRowIndex = r;
                    colMap.date = dateIdx;
                    colMap.title = titleIdx;
                    colMap.desc = rowStr.findIndex(c => c.includes('desc') || c.includes('æè¿°'));
                    colMap.tag = rowStr.findIndex(c => c.includes('tag') || c.includes('æ ‡ç­¾'));
                    colMap.duration = rowStr.findIndex(c => c.includes('duration') || c.includes('æ—¶é•¿'));
                    colMap.time = rowStr.findIndex(c => (c.includes('time') || c.includes('æ—¶é—´')) && !c.includes('æ—¶é•¿'));
                    break;
                }
            }

            if (headerRowIndex === -1) {
                console.warn('æœªæ‰¾åˆ°æœ‰æ•ˆçš„è¡¨å¤´è¡Œ');
                return [];
            }

            console.log('æ‰¾åˆ°è¡¨å¤´è¡Œ:', headerRowIndex, 'åˆ—æ˜ å°„:', colMap);

            const taskDataByDate = {};
            const dataRows = rawArray.slice(headerRowIndex + 1);
            let processedRows = 0;

            dataRows.forEach((row, rowIndex) => {
                const dateRaw = row[colMap.date];
                const titleRaw = row[colMap.title];

                if (!dateRaw || !titleRaw) {
                    console.log('è·³è¿‡ç¬¬ ' + rowIndex + ' è¡Œï¼šæ—¥æœŸæˆ–æ ‡é¢˜ä¸ºç©º');
                    return;
                }

                let dateStr = '';
                try {
                    if (typeof dateRaw === 'number') {
                        // Excelæ—¥æœŸåºåˆ—å·
                        const dateObj = XLSX.SSF.parse_date_code(dateRaw);
                        dateStr = dateObj.y + '-' + 
                                 String(dateObj.m).padStart(2, '0') + '-' + 
                                 String(dateObj.d).padStart(2, '0');
                    } else {
                        // å­—ç¬¦ä¸²æ—¥æœŸ
                        const dateString = String(dateRaw).trim();
                        const d = new Date(dateString.replace(/-/g, '/').replace(/\./g, '/'));
                        
                        if (!isNaN(d.getTime())) {
                            dateStr = d.getFullYear() + '-' + 
                                     String(d.getMonth() + 1).padStart(2, '0') + '-' + 
                                     String(d.getDate()).padStart(2, '0');
                        } else {
                            dateStr = dateString.split(' ')[0];
                        }
                    }
                } catch (e) {
                    console.warn('æ—¥æœŸè§£æå¤±è´¥ï¼Œè¡Œ ' + rowIndex + ':', dateRaw, e);
                    return;
                }

                if (!taskDataByDate[dateStr]) {
                    taskDataByDate[dateStr] = {
                        date: dateStr,
                        dayNum: Object.keys(taskDataByDate).length + 1,
                        tasks: []
                    };
                }

                const title = String(titleRaw).trim();
                const desc = colMap.desc > -1 ? String(row[colMap.desc] || '').trim() : '';
                const tag = colMap.tag > -1 ? String(row[colMap.tag] || '').trim() : '';
                const timeRaw = colMap.time > -1 ? row[colMap.time] : '';
                const time = formatExcelTime(timeRaw);
                const duration = colMap.duration > -1 ? (parseInt(row[colMap.duration]) || null) : null;

                taskDataByDate[dateStr].tasks.push({
                    title: title,
                    desc: desc,
                    tag: tag,
                    time: time,
                    duration: duration
                });
                
                processedRows++;
            });

            const sortedDates = Object.keys(taskDataByDate).sort();
            return sortedDates.map((date, index) => {
                const dayData = taskDataByDate[date];
                dayData.dayNum = index + 1;
                return dayData;
            });
        }

        async function getTemplateContent(theme) {
            const templatePath = 'templates/template_' + theme + '.html';
            try {
                const response = await fetch(templatePath);
                if (!response.ok) {
                    // Fallback for root directory testing
                    const rootResponse = await fetch('template_' + theme + '.html');
                    if(rootResponse.ok) return await rootResponse.text();
                    throw new Error('HTTPé”™è¯¯: ' + response.status);
                }
                return await response.text();
            } catch (error) {
                console.error('æ¨¡æ¿åŠ è½½é”™è¯¯:', error);
                throw new Error('æ— æ³•åŠ è½½æ¨¡æ¿æ–‡ä»¶');
            }
        }

        async function getRulesDbContent() {
            try {
                const response = await fetch('templates/rules_db.js');
                if (!response.ok) {
                    const fallbackResponse = await fetch('rules_db.js');
                    if (!fallbackResponse.ok) return '';
                    return await fallbackResponse.text();
                }
                return await response.text();
            } catch (e) {
                return '';
            }
        }

        // ============================================
        // æ¨¡æ€æ¡†é€»è¾‘
        // ============================================

        function getPlanTitle() {
            return new Promise((resolve) => {
                titlePromiseResolve = resolve;
                const modal = document.getElementById('title-input-modal');
                const panel = document.getElementById('title-modal-panel');
                const input = document.getElementById('plan-title-input');
                
                modal.classList.remove('modal-bg-enter');
                panel.classList.remove('modal-content-enter');
                modal.classList.add('modal-bg-enter-active');
                panel.classList.add('modal-content-enter-active');
                
                input.value = 'DeepFlow ä¸ªäººå­¦ä¹ è®¡åˆ’';
                setTimeout(() => input.select(), 100);
            });
        }

        function confirmTitleModal() {
            const val = document.getElementById('plan-title-input').value;
            closeTitleModal();
            if (titlePromiseResolve) titlePromiseResolve(val || 'DeepFlow è®¡åˆ’');
        }

        function cancelTitleModal() {
            closeTitleModal();
            if (titlePromiseResolve) titlePromiseResolve(null);
        }

        function closeTitleModal() {
            const modal = document.getElementById('title-input-modal');
            const panel = document.getElementById('title-modal-panel');
            modal.classList.remove('modal-bg-enter-active');
            panel.classList.remove('modal-content-enter-active');
            modal.classList.add('modal-bg-enter');
            panel.classList.add('modal-content-enter');
            document.getElementById('plan-title-input').blur();
        }

        function customAlert(msg, title, iconName) {
            const modal = document.getElementById('custom-alert-modal');
            const content = document.getElementById('modal-content');
            document.getElementById('alert-message').textContent = msg;
            document.getElementById('alert-title').innerHTML = '<i data-lucide="' + iconName + '" class="w-5 h-5"></i> ' + title;
            lucide.createIcons();
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.style.opacity = '1';
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
        }

        function closeCustomAlert() {
            const modal = document.getElementById('custom-alert-modal');
            const content = document.getElementById('modal-content');
            modal.style.opacity = '0';
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        // ============================================
        // ä¸»ç”Ÿæˆé€»è¾‘
        // ============================================

        async function generateApp() {
            if (!selectedTheme) { customAlert('è¯·é€‰æ‹©ä¸»é¢˜ï¼', 'æç¤º', 'info'); return; }

            // æ•°æ®æºæ£€æŸ¥
            if (currentMode === 'upload' && !uploadedData) { customAlert('è¯·å…ˆä¸Šä¼  Excel æ–‡ä»¶ï¼', 'æç¤º', 'info'); return; }
            if (currentMode === 'builder' && builderData.length === 0) { customAlert('è¯·æ·»åŠ è‡³å°‘ä¸€å¤©ä»»åŠ¡ï¼', 'æç¤º', 'info'); return; }

            const btn = document.getElementById('generate-button');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = 'æ­£åœ¨ç”Ÿæˆ...';

            try {
                let structuredData = [];

                if (currentMode === 'upload') {
                    console.log('å¤„ç†Excelæ•°æ®...');
                    structuredData = processTasksData(uploadedData);
                } else {
                    console.log('å¤„ç†æ„å»ºå™¨æ•°æ®...');
                    // æ•°æ®æ¸…æ´—ï¼šç§»é™¤æ— æ ‡é¢˜ä»»åŠ¡ï¼Œç¡®ä¿å­—æ®µå®Œæ•´
                    structuredData = builderData.map((d, i) => ({
                        date: d.date,
                        dayNum: i + 1,
                        tasks: d.tasks.filter(t => t.title.trim() !== '').map(t => ({
                            title: t.title,
                            tag: t.tag || '',
                            desc: t.desc || '', 
                            time: t.time || '',
                            duration: t.duration || null
                        }))
                    })).filter(d => d.tasks.length > 0);
                }
                
                if (structuredData.length === 0) {
                    throw new Error('æœ‰æ•ˆæ•°æ®ä¸ºç©ºï¼Œæ— æ³•ç”Ÿæˆ');
                }

                const planTitle = await getPlanTitle();
                if (!planTitle) {
                    btn.disabled = false;
                    btn.innerText = originalText;
                    return;
                }

                const templateContent = await getTemplateContent(selectedTheme);
                const rulesDbContent = await getRulesDbContent();
                const planId = selectedTheme + '_' + Date.now();

                // å®‰å…¨è½¬ä¹‰ï¼Œé˜²æ­¢ç ´åHTMLç»“æ„
                const escapedData = JSON.stringify(structuredData)
                    .replace(/</g, '\\u003c')
                    .replace(/>/g, '\\u003e')
                    .replace(/&/g, '\\u0026')
                    .replace(/'/g, '\\u0027');

                const safeTitle = planTitle.replace(/[<>"]/g, '');

                let finalHtml = templateContent
                    .replace(/{{TASKS_DATA}}/g, escapedData)
                    .replace(/{{PLAN_TITLE}}/g, safeTitle)
                    .replace(/{{PLAN_ID}}/g, planId)
                    .replace(/{{BODY_CLASS}}/g, '');
                
                if (rulesDbContent) {
                    finalHtml = finalHtml.replace('<script src="rules_db.js"><\/script>', '<script>' + rulesDbContent + '<\/script>');
                }

                const blob = new Blob([finalHtml], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const safeFileName = safeTitle.replace(/[<>:"/\\|?*]/g, '_') + '_' + selectedTheme + '.html';
                a.download = safeFileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                customAlert(
                    'âœ… ç”ŸæˆæˆåŠŸï¼\n\nåŒ…å« ' + structuredData.length + ' å¤©è®¡åˆ’ã€‚',
                    'æˆåŠŸ',
                    'check-circle'
                );

            } catch (error) {
                console.error('ç”Ÿæˆå¤±è´¥:', error);
                customAlert('ç”Ÿæˆå¤±è´¥ï¼š' + error.message, 'é”™è¯¯', 'x-circle');
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }

        // ============================================
        // é¡µé¢äº‹ä»¶
        // ============================================

        function handleFileChange(event) {
            const file = event.target.files[0];
            if (!file) return;
            const status = document.getElementById('file-status');
            status.innerHTML = '<span class="text-blue-400">æ­£åœ¨è§£æ...</span>';
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
                    uploadedData = json;
                    const dataCount = json.length > 1 ? json.length - 1 : 0;
                    status.innerHTML = 'âœ… å·²åŠ è½½: <span class="text-white font-bold">' + file.name + '</span> (å…± ' + dataCount + ' è¡Œæ•°æ®)';
                    updateSummary();
                } catch (err) {
                    console.error(err);
                    status.innerHTML = 'âŒ è§£æå¤±è´¥: ' + err.message;
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function selectTheme(theme) {
            selectedTheme = theme;
            document.querySelectorAll('.selection-card').forEach(el => el.classList.remove('selected'));
            const current = document.getElementById('theme-' + theme);
            if(current) current.classList.add('selected');
            updateSummary();
        }

        function updateSummary() {
            const summary = document.getElementById('generation-summary');
            const btn = document.getElementById('generate-button');
            const themeMap = { 'pro': 'DeepFlow Pro', 'zen': 'Zen Mode', 'cyberpunk': 'Cyberpunk' };
            
            let dataReady = false;
            let info = "";

            if (currentMode === 'upload' && uploadedData) {
                const count = uploadedData.length > 1 ? uploadedData.length - 1 : 0;
                info = `Excel (${count} è¡Œ)`;
                dataReady = true;
            } else if (currentMode === 'builder' && builderData.length > 0) {
                info = `åœ¨çº¿æ„å»º (${builderData.length} å¤©)`;
                dataReady = true;
            }

            if (dataReady && selectedTheme) {
                summary.innerHTML = `ğŸ‰ å°±ç»ªï¼æ•°æ®ï¼š${info}ï¼Œä¸»é¢˜ï¼š${themeMap[selectedTheme]}`;
                btn.disabled = false;
            } else {
                let status = "ç­‰å¾…é…ç½®...";
                if (dataReady) status = `æ•°æ® OK (${info})ï¼Œè¯·é€‰æ‹©ä¸»é¢˜`;
                else if (selectedTheme) status = `ä¸»é¢˜ ${themeMap[selectedTheme]}ï¼Œè¯·å‡†å¤‡æ•°æ®`;
                summary.innerHTML = status;
                btn.disabled = true;
            }
        }

        function downloadSampleExcel() {
            const a = document.createElement('a');
            a.href = 'DeepFlow_Standard_Template.xlsx';
            a.download = 'DeepFlow_Standard_Template.xlsx';
            a.click();
        }

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const theme = urlParams.get('theme');
            if (theme) selectTheme(theme);
            
            // æ‹–æ‹½æ”¯æŒ
            const dropArea = document.querySelector('label[for="excel-file"]');
            if (dropArea) {
                dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.classList.add('border-blue-500', 'bg-white/10'); });
                dropArea.addEventListener('dragleave', () => { dropArea.classList.remove('border-blue-500', 'bg-white/10'); });
                dropArea.addEventListener('drop', (e) => {
                    e.preventDefault(); dropArea.classList.remove('border-blue-500', 'bg-white/10');
                    const file = e.dataTransfer.files[0];
                    if (file && file.name.endsWith('.xlsx')) {
                        const input = document.getElementById('excel-file');
                        const dt = new DataTransfer(); dt.items.add(file); input.files = dt.files;
                        handleFileChange({ target: input });
                    } else { customAlert('è¯·ä¸Šä¼  .xlsx æ–‡ä»¶', 'é”™è¯¯', 'file-x'); }
                });
            }
        });
    </script>
</body>
</html>