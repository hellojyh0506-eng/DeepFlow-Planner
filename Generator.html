<!DOCTYPE html>
<html lang="zh-CN" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DeepFlow | AI æ™ºèƒ½æ„å»º (V27 NLP Enhanced)</title>
    <!-- å¼•å…¥æ ¸å¿ƒåº“ -->
    <script src="https://deepflow-hellojyh-audio.oss-cn-hangzhou.aliyuncs.com/libs/lucide.min.js"></script>
    <script src="https://deepflow-hellojyh-audio.oss-cn-hangzhou.aliyuncs.com/libs/tailwind.js"></script>
    <script src="https://deepflow-hellojyh-audio.oss-cn-hangzhou.aliyuncs.com/libs/xlsx.full.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', '"Noto Sans SC"', 'sans-serif'] },
                    animation: { 
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 3s ease-in-out infinite',
                        'slide-in': 'slideIn 0.3s ease-out forwards',
                        'fadeIn': 'fadeIn 0.5s ease-out forwards',
                        'slideUp': 'slideUp 0.3s ease-out forwards',
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-4px)' } },
                        slideIn: { '0%': { opacity: '0', transform: 'translateX(-10px)' }, '100%': { opacity: '1', transform: 'translateX(0)' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>
    <style>
        /* ==========================================================================
           1. æ ¸å¿ƒè§†è§‰æ ·å¼
           ========================================================================== */
        html, body {
            background-color: #020617; 
            color: white; 
            overflow-x: hidden; 
            width: 100%;
            max-width: 100%;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-nav { background: rgba(2, 6, 23, 0.7); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255,255,255,0.05); }

        .deep-space-bg {
            position: fixed; inset: 0; z-index: -2;
            background: 
                radial-gradient(circle at 15% 50%, rgba(30, 58, 138, 0.4) 0%, transparent 50%), 
                radial-gradient(circle at 85% 30%, rgba(88, 28, 135, 0.25) 0%, transparent 50%);
            background-size: 100% 100%;
        }
        .grid-overlay {
            position: fixed; inset: 0; z-index: -1;
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
            pointer-events: none;
        }

        .glass-panel { 
            background: rgba(255,255,255,0.02); 
            border: 1px solid rgba(255,255,255,0.05); 
            backdrop-filter: blur(10px);
            transition: all 0.3s; 
            overflow: visible; 
            position: relative;
            z-index: 1;
        }
        .glass-panel:hover { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); }

        /* ==========================================================================
           2. æ‰‹æœºç«¯ä¸“å±ä¼˜åŒ– (Mobile First)
           ========================================================================== */
        @media (max-width: 768px) {
            .ai-textarea {
                height: 180px !important;
                font-size: 16px !important; 
                padding: 16px !important;
                background: rgba(255,255,255,0.05) !important;
                border-color: rgba(255,255,255,0.15) !important;
            }
            .desktop-nav-text { display: none !important; }
            .desktop-btn { display: none !important; }
            
            /* ä¼˜åŒ–ï¼šå¢åŠ åº•éƒ¨Paddingï¼Œé˜²æ­¢é˜´å½±è¢«æˆªæ–­ */
            .mobile-scroll-container {
                display: flex; gap: 10px; overflow-x: auto; padding: 4px 4px 12px 4px;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }
            .mobile-scroll-container::-webkit-scrollbar { display: none; }

            .mobile-action-bar {
                display: flex !important;
                position: fixed; bottom: 0; left: 0; right: 0; z-index: 999;
                background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px);
                border-top: 1px solid rgba(255,255,255,0.1);
                padding: 12px 16px; gap: 12px;
                box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
                animation: slideUp 0.3s ease-out;
            }
            
            section { padding-top: 80px !important; padding-bottom: 120px !important; } 
            .glass-panel { padding: 1.25rem !important; border-radius: 20px !important; }
            h1 { font-size: 2rem !important; line-height: 1.2 !important; }
            .voice-btn-mobile { display: flex !important; }
        }

        .mobile-action-bar { display: none; }
        .voice-btn-mobile { display: none; }

        .voice-recording { 
            animation: pulse-red 1.5s infinite; 
            background: rgba(239, 68, 68, 0.2) !important; 
            border-color: rgba(239, 68, 68, 0.5) !important; 
            color: #f87171 !important; 
        }
        @keyframes pulse-red { 
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } 
        }

        /* ==========================================================================
           3. æ¨¡å¼é€‰æ‹©å™¨ (Tab Bar)
           ========================================================================== */
        .mode-selector {
            display: flex;
            flex-wrap: wrap; 
            justify-content: center; 
            align-items: center;
            gap: 8px; 
            width: 100%;
        }

        @media (min-width: 768px) {
            .mode-selector {
                justify-content: flex-end; 
                width: auto;
                flex-wrap: nowrap; 
            }
        }

        .tab-btn { 
            position: relative; 
            color: #94a3b8; 
            transition: all 0.3s; 
            padding: 0.6rem 1.2rem; 
            border-radius: 10px; 
            font-size: 14px; 
            font-weight: 600; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            flex: 1 0 auto; 
            min-width: 110px; 
            max-width: 100%; 
            white-space: nowrap; 
        }

        .tab-btn:hover { color: white; background: rgba(255,255,255,0.05); }
        .tab-btn.active { color: white; background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.3); }
        .tab-btn-ai.active { background: linear-gradient(135deg, #2563eb, #9333ea); border: none; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4); text-shadow: 0 1px 2px rgba(0,0,0,0.2); }

        @media (max-width: 480px) {
            .mode-selector { gap: 6px; }
            .tab-btn { padding: 10px 8px; font-size: 13px; min-width: 90px; }
        }

        /* ==========================================================================
           4. æ ¸å¿ƒç»„ä»¶æ ·å¼
           ========================================================================== */
        
        /* ä¿®å¤ 1: åœ¨çº¿æ„å»ºè¾“å…¥æ¡† - å¼ºåˆ¶æ·±è‰²èƒŒæ™¯ & æ ‡å‡†å±æ€§ */
        .builder-input {
            background-color: rgba(15, 23, 42, 0.6) !important; /* å¼ºåˆ¶æ·±è‰² */
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: #e2e8f0 !important;
            border-radius: 8px !important;
            padding: 10px 12px !important;
            font-size: 14px !important;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            -webkit-appearance: none; /* ç§»é™¤iOSé»˜è®¤æ ·å¼ */
            appearance: none; /* æ ‡å‡†å±æ€§ */
        }
        .builder-input:focus {
            background-color: rgba(15, 23, 42, 0.9) !important;
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
            outline: none;
        }
        .builder-input::placeholder { color: rgba(148, 163, 184, 0.5); }

        /* ä¿®å¤ 2: ç¤ºä¾‹æ ‡ç­¾ - å¢åŠ ç‚¹å‡»æ„Ÿ */
        .mobile-example-chip {
            flex: 0 0 auto;
            padding: 8px 14px; 
            background: rgba(30, 41, 59, 0.6); 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: 600;
            border: 1px solid rgba(255,255,255,0.1);
            white-space: nowrap;
            cursor: pointer; 
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none; 
        }
        .mobile-example-chip:active {
            transform: scale(0.95); 
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.4);
        }
        .mobile-example-chip::after {
            content: 'â†’';
            font-family: monospace;
            opacity: 0.4;
            font-size: 10px;
        }

        /* ä¿®å¤ 3: æ‰‹æœºç«¯ AI é¢„è§ˆå¡ç‰‡ åˆ é™¤æŒ‰é’®æ ·å¼ - æ˜¾å¼å¯è§ */
        .mobile-delete-btn {
            opacity: 1 !important; /* æ‰‹æœºç«¯å¼ºåˆ¶æ˜¾ç¤º */
            background-color: rgba(239, 68, 68, 0.15); 
            border-radius: 8px;
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }
        .mobile-delete-btn:active {
            background-color: rgba(239, 68, 68, 0.3);
            transform: scale(0.9);
        }
        
        @media (min-width: 768px) {
            .mobile-delete-btn {
                opacity: 0 !important; /* ç”µè„‘ç«¯Hoveræ˜¾ç¤º */
                background-color: transparent;
                border: none;
                color: #475569;
            }
            .group:hover .mobile-delete-btn {
                opacity: 1 !important;
            }
            .mobile-delete-btn:hover {
                color: #f87171;
            }
        }

        /* åŸæœ‰ç»„ä»¶ */
        .selection-card {
            position: relative; border-radius: 20px; overflow: hidden; cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: flex; flex-direction: column; padding: 1.5rem; min-height: 220px;
        }
        .selection-card:hover { transform: translateY(-5px) scale(1.02); }

        .card-pro-premium { background: rgba(255, 255, 255, 0.05); color: white; border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); }
        .card-pro-premium.selected { border-color: #3b82f6; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.5), 0 10px 40px rgba(59, 130, 246, 0.4); }
        .card-zen-matte { background: #ffffff; color: #18181b; border: 1px solid #e4e4e7; }
        .card-zen-matte.selected { border-color: #18181b; box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.5), 0 0 0 6px #18181b; }
        .card-cyber-neon { background: #09090b; border: 1px solid rgba(217, 70, 239, 0.3); }
        .card-cyber-neon.selected { border-color: #d946ef; box-shadow: 0 0 0 2px #09090b, 0 0 0 4px #d946ef; }

        .check-circle { position: absolute; top: 1rem; right: 1rem; z-index: 20; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: 0; transform: scale(0.5); transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .selected .check-circle { opacity: 1; transform: scale(1); }

        .ai-input-container { display: flex; flex-direction: column; gap: 16px; width: 100%; height: 100%; }
        .ai-textarea {
            width: 100%; height: 450px; background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 20px;
            color: #e2e8f0; font-size: 16px; line-height: 1.8; resize: none; outline: none;
            transition: 0.3s; font-family: inherit;
        }
        .ai-textarea:focus { border-color: #3b82f6; background: rgba(15, 23, 42, 0.8); box-shadow: 0 0 20px rgba(59, 130, 246, 0.2); }
        
        .ai-preview-panel { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; height: 450px; display: flex; flex-direction: column; overflow: hidden; }
        .ai-timeline { flex: 1; overflow-y: auto; padding: 20px; }
        .timeline-day { margin-bottom: 24px; animation: slideIn 0.3s ease-out forwards; }
        .timeline-date { display: inline-flex; align-items: center; gap: 8px; background: linear-gradient(90deg, #2563eb, #3b82f6); color: white; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 800; margin-bottom: 12px; box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3); }
        
        .ai-task-card { display: flex; align-items: center; gap: 10px; background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(255,255,255,0.05); padding: 10px 14px; border-radius: 10px; margin-bottom: 8px; transition: all 0.2s; position: relative; overflow: hidden; }
        .ai-task-card:hover { background: rgba(30, 41, 59, 0.8); border-color: rgba(96, 165, 250, 0.3); transform: translateX(2px); }
        
        .ai-time-edit { background: transparent; border: 1px solid transparent; color: #60a5fa; font-family: monospace; font-weight: bold; width: 80px; text-align: center; font-size: 12px; padding: 2px; border-radius: 4px; transition: 0.2s; }
        .ai-time-edit:focus { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); outline: none; }
        
        .ai-title-edit { flex: 1; background: transparent; border: 1px solid transparent; color: #e2e8f0; font-size: 14px; padding: 2px 6px; border-radius: 4px; transition: 0.2s; width: 100%; min-width: 0; /* é˜²æ­¢æº¢å‡º */ }
        .ai-title-edit:focus { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); outline: none; }
        .ai-tag-badge { font-size: 10px; padding: 2px 8px; border-radius: 99px; background: rgba(255,255,255,0.05); color: #94a3b8; border: 1px solid rgba(255,255,255,0.1); white-space: nowrap; }

        /* Sample æ ·å¼ç§»æ¤ */
        .df-modal-overlay { display: none; position: fixed; inset: 0; background: rgba(2, 6, 23, 0.85); backdrop-filter: blur(8px); z-index: 9999; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; }
        .df-modal-overlay.active { display: flex; opacity: 1; }
        .df-modal-card { background: rgba(30, 41, 59, 0.9); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); backdrop-filter: blur(16px); color: white; width: 90%; max-width: 420px; border-radius: 24px; padding: 32px 24px; text-align: center; transform: scale(0.95) translateY(10px); transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .df-modal-overlay.active .df-modal-card { transform: scale(1) translateY(0); }
        .df-icon-circle { width: 64px; height: 64px; background: linear-gradient(135deg, #007AFF, #00C6FF); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; box-shadow: 0 0 30px rgba(0, 122, 255, 0.4); }
        .df-modal-title { font-size: 22px; font-weight: 800; color: white; margin-bottom: 8px; }
        .df-modal-desc { font-size: 14px; color: #94a3b8; margin-bottom: 32px; line-height: 1.6; }
        .df-actions { display: flex; flex-direction: column; gap: 12px; }
        .df-btn { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 16px; border-radius: 14px; font-size: 15px; font-weight: 700; text-decoration: none; transition: all 0.2s; cursor: pointer; border: none; }
        .df-btn-primary { background: linear-gradient(to right, #2563eb, #4f46e5); color: white; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); }
        .df-btn-primary:hover { background: linear-gradient(to right, #1d4ed8, #4338ca); transform: scale(1.02); }
        .df-btn-secondary { background: rgba(255, 255, 255, 0.05); color: white; border: 1px solid rgba(255, 255, 255, 0.1); }
        .df-btn-secondary:hover { background: rgba(255, 255, 255, 0.1); }
        .df-close { margin-top: 24px; background: none; border: none; color: #64748b; font-size: 13px; cursor: pointer; }
        .df-close:hover { color: white; }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
    </style>
</head>
<body class="antialiased selection:bg-blue-500/30">

    <div class="deep-space-bg"></div>
    <div class="grid-overlay"></div>

    <nav class="fixed w-full z-50 glass-nav">
        <div class="max-w-7xl mx-auto px-6 h-20 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-gradient-to-tr from-blue-600 to-purple-600 p-1.5 rounded-lg shadow-lg"><i data-lucide="zap" class="text-white w-5 h-5"></i></div>
                <span class="font-black text-xl tracking-tight">DeepFlow</span>
            </div>
            <a href="index.html" class="bg-white/10 text-white px-4 py-2 rounded-full font-bold text-sm hover:bg-white/20 transition border border-white/10">
                <i data-lucide="arrow-left" class="w-4 h-4 inline mr-1"></i> <span class="desktop-nav-text">è¿”å›ä¸»é¡µ</span>
            </a>
        </div>
    </nav>

    <section class="relative pt-32 pb-24 md:pt-48 md:pb-32 min-h-screen">
        <div class="max-w-6xl mx-auto px-6 relative z-10 text-center">
            <h1 class="text-4xl md:text-5xl font-black mb-4 leading-tight tracking-tight text-white drop-shadow-xl">
                å¼€å§‹æ„å»ºä½ çš„å¿ƒæµ App
            </h1>
            <p class="text-slate-400 text-lg max-w-2xl mx-auto mb-12">
                é€‰æ‹©æœ€é€‚åˆä½ çš„æ–¹å¼ï¼Œå¿«é€Ÿç”Ÿæˆä¸ªæ€§åŒ–è®¡åˆ’åº”ç”¨ã€‚
            </p>

            <div class="space-y-12">
                
                <!-- 1. Data Input Panel -->
                <div class="glass-panel p-8 rounded-3xl text-left transition-all duration-300 shadow-2xl shadow-blue-900/10">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4 border-b border-white/5 pb-4">
                        <div class="flex items-center gap-4">
                            <span class="text-4xl font-black text-blue-500">1</span>
                            <h2 class="text-2xl font-bold">å‡†å¤‡è®¡åˆ’æ•°æ®</h2>
                        </div>
                        
                        <!-- æ ¸å¿ƒä¿®å¤åŒºåŸŸï¼šæ¨¡å¼é€‰æ‹©å™¨ -->
                        <div class="mode-selector">
                            <!-- AI Mode -->
                            <button onclick="switchMode('ai')" id="tab-ai" class="tab-btn tab-btn-ai active">
                                <i data-lucide="sparkles" class="w-4 h-4"></i>
                                <span>AI æ™ºèƒ½è¾“å…¥</span>
                            </button>
                            
                            <!-- åˆ†éš”ç¬¦ (ä»…æ¡Œé¢ç«¯æ˜¾ç¤º) -->
                            <div class="h-6 w-px bg-white/10 mx-1 hidden md:block"></div>
                            
                            <!-- Legacy Modes -->
                            <button onclick="switchMode('upload')" id="tab-upload" class="tab-btn">
                                <i data-lucide="upload-cloud" class="w-4 h-4"></i> Excel ä¸Šä¼ 
                            </button>
                            <button onclick="switchMode('builder')" id="tab-builder" class="tab-btn">
                                <i data-lucide="layout-list" class="w-4 h-4"></i> åœ¨çº¿æ„å»º
                            </button>
                        </div>
                    </div>

                    <!-- MODE 1: AI Intelligent Input -->
                    <div id="mode-ai" class="block animate-fadeIn">
                        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
                            <div class="lg:col-span-6 ai-input-container">
                                <div class="relative group w-full h-full">
                                    <textarea id="ai-input" class="ai-textarea relative custom-scrollbar" 
                                        placeholder="è¯·åœ¨æ­¤ç”¨è‡ªç„¶è¯­è¨€æè¿°æ‚¨çš„è®¡åˆ’...&#10;&#10;ä¾‹å¦‚ï¼š&#10;å‘¨ä¸‰æ—©ä¸Š8ç‚¹èƒŒå•è¯ï¼Œä¸‹åˆ2ç‚¹åšæ•°å­¦å·å­ã€‚&#10;æ˜å¤©å…¨å¤©å¤ä¹ ä¸“ä¸šè¯¾ï¼Œæ™šä¸Šçœ‹ç”µå½±ã€‚&#10;åå¤©åå‚åŠ è€ƒè¯•ï¼Œç¬¬5å¤©å¼€å§‹å¤ä¹ ã€‚"
                                        oninput="ai_handleInput()"></textarea>
                                    
                                    <!-- æ‰‹æœºç«¯è¯­éŸ³æŒ‰é’® (é»˜è®¤éšè—) -->
                                    <button id="voice-btn" onclick="toggleVoiceInput()" class="voice-btn-mobile hidden absolute right-3 bottom-3 bg-blue-600 hover:bg-blue-500 text-white p-3 rounded-full shadow-lg transition-all active:scale-95 items-center justify-center border border-white/20">
                                        <i data-lucide="mic" class="w-5 h-5"></i>
                                    </button>
                                </div>
                                
                                <!-- ç¤ºä¾‹åº“ï¼šæ‰‹æœºç«¯æ»‘åŠ¨ï¼ŒPCç«¯æ™®é€š -->
                                <div class="text-xs text-slate-500 px-2">
                                    <!-- å¢åŠ å¼•å¯¼æ–‡æ¡ˆ -->
                                    <div class="mb-2 flex items-center gap-2 opacity-60">
                                        <i data-lucide="mouse-pointer-2" class="w-3 h-3"></i>
                                        <span>ç‚¹å‡»ä¸‹æ–¹è¯•ç”¨ç¤ºä¾‹ï¼š</span>
                                    </div>
                                    
                                    <div class="mobile-scroll-container md:flex-wrap md:gap-2 md:flex md:items-center">
                                        <!-- ä¼˜åŒ–åçš„æ ‡ç­¾æŒ‰é’® -->
                                        <button onclick="ai_loadSample('exam')" class="mobile-example-chip text-blue-400 hover:text-blue-300">ğŸ“š è€ƒç ”å¤ä¹ </button>
                                        <button onclick="ai_loadSample('life')" class="mobile-example-chip text-green-400 hover:text-green-300">ğŸ¥¦ ç”Ÿæ´»æ—¥å¸¸</button>
                                        <button onclick="ai_loadSample('mixed')" class="mobile-example-chip text-purple-400 hover:text-purple-300">ğŸ”€ æ··åˆå®‰æ’</button>
                                        <button onclick="ai_loadSample('date')" class="mobile-example-chip text-orange-400 hover:text-orange-300">ğŸ“… å€’æ•°æ—¥</button>
                                    </div>
                                </div>
                            </div>

                            <div class="lg:col-span-6 w-full h-full">
                                <div class="ai-preview-panel">
                                    <div class="p-4 border-b border-white/10 bg-slate-900/50 flex justify-between items-center">
                                        <span class="text-sm font-bold text-slate-300 flex items-center gap-2"><i data-lucide="eye" class="w-4 h-4"></i> è¯†åˆ«é¢„è§ˆ (å¯ç‚¹å‡»åˆ é™¤)</span>
                                        <div class="flex items-center gap-3">
                                            <span id="ai-status" class="text-[10px] bg-blue-500/20 text-blue-400 px-2 py-1 rounded border border-blue-500/30">ç­‰å¾…è¾“å…¥</span>
                                            <!-- PCç«¯ç¡®è®¤æŒ‰é’®ï¼Œæ‰‹æœºç«¯éšè— -->
                                            <button id="ai-confirm-btn" onclick="confirmAI()" class="desktop-btn text-xs bg-emerald-600 hover:bg-emerald-500 px-3 py-1.5 rounded text-white transition font-bold shadow-lg flex items-center gap-1 opacity-50 cursor-not-allowed" disabled>
                                                <i data-lucide="check" class="w-3 h-3"></i> ç¡®è®¤æ„å»º
                                            </button>
                                        </div>
                                    </div>
                                    <div id="ai-timeline-container" class="ai-timeline custom-scrollbar">
                                        <!-- å ä½ç¬¦ -->
                                        <div class="flex flex-col items-center justify-center h-full text-slate-600 opacity-60">
                                            <i data-lucide="message-square-dashed" class="w-12 h-12 mb-3"></i>
                                            <p class="text-xs">åœ¨å·¦ä¾§è¾“å…¥æ–‡å­—<br>å³ä¾§å°†å®æ—¶æ˜¾ç¤ºè§£æç»“æœ</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- MODE 2: Excel Upload -->
                    <div id="mode-upload" class="hidden animate-fadeIn">
                        <div class="flex justify-end mb-2">
                            <button onclick="downloadSampleExcel()" class="text-xs font-bold text-blue-400 hover:text-white flex items-center gap-1 transition-colors">
                                <i data-lucide="download" class="w-3 h-3"></i> ä¸‹è½½æ ‡å‡† Excel æ¨¡ç‰ˆ
                            </button>
                        </div>
                        <label for="excel-file" id="excel-drop-area" class="flex flex-col items-center justify-center p-20 border-2 border-dashed border-white/10 rounded-2xl cursor-pointer hover:bg-white/5 hover:border-blue-500/50 transition-all group bg-slate-900/50">
                            <div class="w-16 h-16 bg-blue-500/10 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                                <i data-lucide="file-spreadsheet" class="w-8 h-8 text-blue-400"></i>
                            </div>
                            <p class="text-lg font-bold text-white">ç‚¹å‡»ä¸Šä¼  / æ‹–æ‹½ Excel æ–‡ä»¶</p>
                            <p id="file-status" class="text-sm text-slate-400 mt-2">æ”¯æŒï¼šæ—¥æœŸã€ä»»åŠ¡æ ‡é¢˜ã€æè¿°ã€æ ‡ç­¾ã€æ—¶é—´ç­‰</p>
                            <input type="file" id="excel-file" accept=".xlsx,.csv" class="hidden" onchange="handleFileChange(event)">
                        </label>
                    </div>

                    <!-- MODE 3: Builder (Full Function) -->
                    <div id="mode-builder" class="hidden animate-fadeIn">
                         <div class="bg-slate-900/50 rounded-2xl border border-white/10 p-6">
                             <div class="flex justify-between items-center mb-6">
                                 <h3 class="font-bold text-slate-300 flex items-center gap-2"><i data-lucide="pen-tool" class="w-4 h-4"></i> åœ¨çº¿æ‰‹åŠ¨æ„å»º</h3>
                                 <div class="flex gap-2">
                                     <button onclick="addBuilderDay()" class="text-xs bg-white/5 hover:bg-white/10 px-3 py-1.5 rounded text-slate-300 transition font-bold flex items-center gap-1 border border-white/10">
                                         <i data-lucide="plus-circle" class="w-3 h-3"></i> åŠ ä¸€å¤©
                                     </button>
                                     <button id="builder-confirm-btn" onclick="confirmBuilder()" class="text-xs bg-emerald-600 hover:bg-emerald-500 px-3 py-1.5 rounded text-white transition font-bold shadow-lg flex items-center gap-1">
                                         <i data-lucide="check" class="w-3 h-3"></i> ç¡®è®¤æ„å»º
                                     </button>
                                 </div>
                             </div>
                             
                             <div id="builder-container" class="space-y-4 max-h-[500px] overflow-y-auto pr-2 custom-scrollbar">
                                 <!-- Builder Content will be injected by JS -->
                             </div>
                             
                             <div class="mt-4 text-center">
                                 <p class="text-xs text-slate-500"><i data-lucide="alert-circle" class="w-3 h-3 inline mr-1"></i> æ³¨æ„ï¼šå¦‚æœæ ‡ç­¾æ ç•™ç©ºï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è®¾ä¸º null å€¼ã€‚</p>
                             </div>
                         </div>
                    </div>
                </div>

                <!-- 2. Theme Selection -->
                <div id="theme-section" class="glass-panel p-8 rounded-3xl text-left">
                    <div class="flex items-center gap-4 mb-6">
                        <span class="text-4xl font-black text-purple-500">2</span>
                        <h2 class="text-2xl font-bold">é€‰æ‹© App ä¸»é¢˜</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div id="theme-pro" onclick="selectTheme('pro')" class="selection-card card-pro-premium group">
                            <div class="relative z-10 flex flex-col h-full">
                                <div class="flex justify-between items-start mb-6">
                                    <div class="w-12 h-12 rounded-2xl bg-white flex items-center justify-center backdrop-blur-md shadow-[0_0_20px_rgba(236,72,153,0.4)]"><i data-lucide="zap" class="w-6 h-6 text-pink-500 fill-pink-500/20"></i></div>
                                    <div class="check-circle bg-blue-500 shadow-lg shadow-blue-500/50"><i data-lucide="check" class="w-4 h-4 text-white"></i></div>
                                </div>
                                <h3 class="text-2xl font-black text-white mb-2">DeepFlow Pro</h3>
                                <p class="text-white/70 text-xs">å†…ç½®å¤šå·´èƒºåé¦ˆç®—æ³•ï¼Œç²’å­ç‰¹æ•ˆä¸æ²‰æµ¸éŸ³æ•ˆã€‚</p>
                            </div>
                        </div>
                        <div id="theme-zen" onclick="selectTheme('zen')" class="selection-card card-zen-matte group">
                            <div class="relative z-10 flex flex-col h-full">
                                <div class="flex justify-between items-start mb-6">
                                    <div class="w-12 h-12 rounded-2xl bg-white flex items-center justify-center border border-zinc-200 shadow-lg"><i data-lucide="moon" class="w-6 h-6 text-zinc-800"></i></div>
                                    <div class="check-circle bg-zinc-900 shadow-lg"><i data-lucide="check" class="w-4 h-4 text-white"></i></div>
                                </div>
                                <h3 class="text-2xl font-black text-zinc-900 mb-2">Zen Mode</h3>
                                <p class="text-zinc-500 text-xs">æè‡´çš„é»‘ç™½ç°åº¦è®¾è®¡ï¼Œåˆ›é€ é›¶ç„¦è™‘çš„ä¸“æ³¨ç¯å¢ƒã€‚</p>
                            </div>
                        </div>
                        <div id="theme-cyberpunk" onclick="selectTheme('cyberpunk')" class="selection-card card-cyber-neon group">
                            <div class="relative z-10 flex flex-col h-full">
                                <div class="flex justify-between items-start mb-6">
                                    <div class="w-12 h-12 rounded-2xl bg-transparent border border-fuchsia-500 text-fuchsia-500 flex items-center justify-center shadow-[0_0_15px_rgba(217,70,239,0.3)]"><i data-lucide="gamepad-2" class="w-6 h-6"></i></div>
                                    <div class="check-circle bg-fuchsia-500 shadow-[0_0_15px_rgba(217,70,239,0.5)]"><i data-lucide="check" class="w-4 h-4 text-white"></i></div>
                                </div>
                                <h3 class="text-2xl font-black text-white mb-2">Cyberpunk</h3>
                                <p class="text-fuchsia-200/60 text-xs">é«˜å¯¹æ¯”åº¦éœ“è™¹ç½‘ç»œï¼Œè‚¾ä¸Šè…ºç´ é©±åŠ¨çš„ HUD ç•Œé¢ã€‚</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. Final Action -->
                <div class="glass-panel p-8 rounded-3xl text-left desktop-btn">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <span class="text-4xl font-black text-emerald-500">3</span>
                            <h2 class="text-2xl font-bold">æœ€ç»ˆç¡®è®¤</h2>
                        </div>
                        <button id="generate-button" onclick="generateApp()" class="px-8 py-4 bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 text-white rounded-xl font-bold text-lg shadow-lg shadow-emerald-600/30 transition-all hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0" disabled>
                            <i data-lucide="sparkles" class="w-5 h-5 inline mr-2"></i> ç”Ÿæˆæˆ‘çš„ App
                        </button>
                    </div>
                    <div class="mt-4 text-slate-400 text-sm" id="generation-summary">
                        è¯·å…ˆå‡†å¤‡æ•°æ®å¹¶é€‰æ‹©ä¸»é¢˜ã€‚
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Mobile Bottom Action Bar (æ‰‹æœºç«¯ä¸“ç”¨) -->
    <div id="mobile-action-bar" class="mobile-action-bar">
        <button id="mobile-confirm-btn" onclick="confirmAI()" class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 opacity-50 transition-all" disabled>
            <i data-lucide="check-circle" class="w-4 h-4"></i> ç¡®è®¤è®¡åˆ’
        </button>
        <button id="mobile-generate-btn" onclick="generateApp()" class="flex-[2] bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 rounded-xl font-bold text-sm shadow-lg flex items-center justify-center gap-2 disabled:opacity-50 transition-all hover:scale-[1.02]" disabled>
            <i data-lucide="rocket" class="w-4 h-4"></i> ç”Ÿæˆ App
        </button>
    </div>

    <!-- Modals -->
    <div id="custom-alert-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center opacity-0 hidden transition-opacity duration-300">
        <div id="modal-content" class="bg-slate-900 p-8 rounded-2xl shadow-2xl border border-white/10 max-w-md w-full transform scale-95 transition-transform duration-300">
            <h3 id="alert-title" class="text-xl font-black mb-4 flex items-center gap-2 text-white"></h3>
            <p id="alert-message" class="text-slate-300 mb-6 leading-relaxed"></p>
            <button onclick="closeCustomAlert()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-semibold py-3 rounded-xl transition-colors">æˆ‘æ˜ç™½äº†</button>
        </div>
    </div>

    <div id="title-input-modal" class="fixed inset-0 bg-black/80 backdrop-blur-md z-50 flex items-center justify-center opacity-0 pointer-events-none transition-all duration-300">
        <div id="title-modal-panel" class="bg-slate-900/90 border border-blue-500/20 p-8 rounded-3xl w-full max-w-lg transform scale-95 opacity-0 transition-all duration-300">
            <h3 class="text-2xl font-black text-white mb-2 flex items-center gap-2"><i data-lucide="edit-3" class="w-6 h-6 text-blue-400"></i> ä¸ºè®¡åˆ’å‘½å</h3>
            <input type="text" id="plan-title-input" class="w-full bg-slate-950/50 border border-slate-700 rounded-xl px-5 py-4 text-white text-lg mt-4 focus:outline-none focus:border-blue-500 font-bold" placeholder="DeepFlow ä¸ªäººå­¦ä¹ è®¡åˆ’">
            <div class="flex justify-end gap-3 mt-8">
                <button onclick="cancelTitleModal()" class="px-6 py-3 text-slate-400 hover:text-white font-bold transition">å–æ¶ˆ</button>
                <button onclick="confirmTitleModal()" class="px-8 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold">å¼€å§‹ç”Ÿæˆ</button>
            </div>
        </div>
    </div>

    <!-- Result Modal (å®Œå…¨ç§»æ¤è‡ª Sample) -->
    <div id="resultModalOverlay" class="df-modal-overlay">
        <div class="df-modal-card">
            <div class="df-icon-circle"><i data-lucide="check" class="text-white w-8 h-8"></i></div>
            <h3 class="df-modal-title">è®¡åˆ’å·²ç”Ÿæˆ (Ready)</h3>
            <p class="df-modal-desc">æ‚¨çš„ DeepFlow è®¡åˆ’å·²å‡†å¤‡å°±ç»ªã€‚<br>è¯·æ ¹æ®è®¾å¤‡é€‰æ‹©æ‰“å¼€æ–¹å¼ã€‚</p>
            <div class="df-actions">
                <a id="previewButton" target="_blank" class="df-btn df-btn-primary">
                    <i data-lucide="eye" class="w-4 h-4"></i> <span>å®æ—¶é¢„è§ˆ (iOS & Safariæ¨è)</span>
                </a>
                <a id="downloadButton" class="df-btn df-btn-secondary">
                    <i data-lucide="download" class="w-4 h-4"></i> <span>ä¸‹è½½æ–‡ä»¶ (ç”µè„‘ / æ‰‹æœºæ¨è)</span>
                </a>
            </div>
            <button onclick="closeResultModal()" class="df-close">å…³é—­çª—å£</button>
        </div>
    </div>

    <script>
        // ============================================
        // å…¨å±€å˜é‡
        // ============================================
        let currentMode = 'ai'; 
        let uploadedData = null; 
        let builderData = []; 
        let aiData = []; 
        let selectedTheme = null;
        let titlePromiseResolve = null;
        let aiParseTimeout = null;
        let recognition = null; // è¯­éŸ³è¯†åˆ«

        // ============================================
        // V18 æ–°å¢ï¼šæ‰‹æœºç«¯ä½“éªŒåˆå§‹åŒ–
        // ============================================
        function initMobileExperience() {
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                // 1. å¼ºåˆ¶åˆ‡æ¢åˆ° AI æ¨¡å¼
                switchMode('ai');
                
                // 2. ä¼˜åŒ–è¾“å…¥æ¡†ä½“éªŒ (èšç„¦æ—¶æ»šåŠ¨)
                const aiInput = document.getElementById('ai-input');
                aiInput.placeholder = "ç‚¹è¿™é‡Œè¾“å…¥ï¼Œæˆ–è€…ç‚¹å³ä¸‹è§’è¯ç­’è¯´è¯...\nä¾‹å¦‚ï¼šæ˜å¤©å…«ç‚¹èµ·åºŠï¼Œä¹ç‚¹èƒŒå•è¯ã€‚";
                aiInput.addEventListener('focus', () => {
                    setTimeout(() => {
                        aiInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                });

                // 3. åˆå§‹åŒ–è¯­éŸ³
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    initVoiceRecognition();
                }
            }
        }

        // V18 æ–°å¢ï¼šè¯­éŸ³è¾“å…¥é€»è¾‘
        function initVoiceRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onstart = () => {
                const btn = document.getElementById('voice-btn');
                btn.classList.add('voice-recording');
                btn.innerHTML = '<i data-lucide="mic-off" class="w-5 h-5"></i>';
                lucide.createIcons();
                document.getElementById('ai-input').placeholder = "æ­£åœ¨å¬...";
            };

            recognition.onend = () => {
                const btn = document.getElementById('voice-btn');
                btn.classList.remove('voice-recording');
                btn.innerHTML = '<i data-lucide="mic" class="w-5 h-5"></i>';
                lucide.createIcons();
                document.getElementById('ai-input').placeholder = "è¯·ç›´æ¥è¾“å…¥...";
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                const input = document.getElementById('ai-input');
                // è¿½åŠ æ–‡æœ¬è€Œä¸æ˜¯è¦†ç›–ï¼Œæ–¹ä¾¿è¿ç»­è¯´è¯
                input.value = input.value ? input.value + '\n' + transcript : transcript;
                ai_handleInput(); // è§¦å‘è§£æ
            };
        }

        function toggleVoiceInput() {
            if (!recognition) return;
            try { recognition.start(); } catch (e) { recognition.stop(); }
        }

        // ============================================
        // æ¨¡å—1ï¼šAI æ™ºèƒ½è§£æå†…æ ¸ (V27 æ ¸å¿ƒå‡çº§ï¼šå®Œæ•´æ—¥æœŸç®—æœ¯)
        // ============================================
        
        const CHINESE_NUMBER_MAP = {
            'é›¶': 0, 'ã€‡': 0, 'ï¼': 0, 'ä¸€': 1, 'å£¹': 1, 'ï¼‘': 1, 'äºŒ': 2, 'ä¸¤': 2, 'è´°': 2, 'ï¼’': 2, 
            'ä¸‰': 3, 'å': 3, 'ï¼“': 3, 'å››': 4, 'è‚†': 4, 'ï¼”': 4, 'äº”': 5, 'ä¼': 5, 'ï¼•': 5, 
            'å…­': 6, 'é™†': 6, 'ï¼–': 6, 'ä¸ƒ': 7, 'æŸ’': 7, 'ï¼—': 7, 'å…«': 8, 'æŒ': 8, 'ï¼˜': 8, 
            'ä¹': 9, 'ç–': 9, 'ï¼™': 9, 'å': 10, 'æ‹¾': 10, 'åä¸€': 11, 'åäºŒ': 12, 'åä¸‰': 13, 
            'åå››': 14, 'åäº”': 15, 'åå…­': 16, 'åä¸ƒ': 17, 'åå…«': 18, 'åä¹': 19, 'äºŒå': 20, 
            'äºŒåä¸€': 21, 'äºŒåäºŒ': 22, 'äºŒåä¸‰': 23, 'äºŒåå››': 24, 'ä¸‰å': 30, 'ä¸‰åä¸€': 31
        };
        const SPECIAL_TIME_EXPRESSIONS = { 'åŠ': 30, 'ä¸€åˆ»': 15, 'ä¸‰åˆ»': 45, 'æ•´': 0, 'æ­£': 0 };
        const TIME_PERIOD_MAP = { 
            'å‡Œæ™¨': '00:00-05:00', 'æ—©æ™¨': '05:00-08:00', 'æ—©ä¸Š': '05:00-08:00', 'ä¸Šåˆ': '08:00-12:00', 
            'ä¸­åˆ': '11:00-13:00', 'æ™Œåˆ': '11:00-13:00', 'ä¸‹åˆ': '13:00-18:00', 'å‚æ™š': '17:00-19:00', 
            'æ™šä¸Š': '18:00-24:00', 'å¤œé‡Œ': '20:00-24:00', 'åˆå¤œ': '23:00-01:00' 
        };

        // --- V27 æ–°å¢ï¼šæ—¥æœŸç®—æœ¯è¾…åŠ©å‡½æ•° ---
        function calculateDaysToNextWeekday(targetDayIndex) {
            const today = new Date();
            const todayIndex = today.getDay(); // 0 (Sun) - 6 (Sat)
            let diff = targetDayIndex - todayIndex;
            // å¦‚æœç›®æ ‡æ˜¯ä»Šå¤©æˆ–è¿‡å»ï¼Œæ‰¾ä¸‹å‘¨çš„è¿™ä¸€å¤©
            // ç”¨æˆ·é€»è¾‘ï¼šå‘¨äº”(ä»Šå¤©å‘¨å››) -> æ˜å¤©(1)ã€‚å‘¨äº”(ä»Šå¤©å‘¨äº”) -> ä¸‹å‘¨äº”(7)ã€‚
            if (diff <= 0) diff += 7;
            return diff;
        }

        // --- V27 æ–°å¢ï¼šæ™ºèƒ½å‘¨è§£æå™¨ (æ ¸å¿ƒ) ---
        function parseSmartWeekDate(text) {
            // æ­£åˆ™è¯´æ˜ï¼š
            // Group 1: æ•è·æ‰€æœ‰ "ä¸‹" (å¯èƒ½åŒ…å« "ä¸ª"ã€"å¤§")ï¼Œç”¨äºè®¡æ•°
            // Group 2: æ˜ŸæœŸå‡ å…³é”®è¯
            // Group 3: ä¸€äºŒä¸‰å››äº”å…­æ—¥å¤©
            const regex = /((?:å¤§|ä¸‹|ä¸ª)+)\s*(å‘¨|æ˜ŸæœŸ|ç¤¼æ‹œ)([ä¸€äºŒä¸‰å››äº”å…­æ—¥å¤©])/;
            // ç®€å•å‘¨å‡ åŒ¹é… (æ— ä¿®é¥°)
            const simpleRegex = /^(å‘¨|æ˜ŸæœŸ|ç¤¼æ‹œ)([ä¸€äºŒä¸‰å››äº”å…­æ—¥å¤©])/;

            let match = text.match(regex);
            let xiaCount = 0;
            let dayChar = '';
            let fullMatch = '';

            if (match) {
                fullMatch = match[0];
                const prefix = match[1];
                dayChar = match[3];
                // è®¡ç®— "ä¸‹" çš„æ•°é‡
                xiaCount = (prefix.match(/ä¸‹/g) || []).length;
            } else {
                match = text.match(simpleRegex);
                if (match) {
                    fullMatch = match[0];
                    dayChar = match[2];
                    xiaCount = 0; // æ— ä¿®é¥° = æœ€è¿‘çš„ä¸€ä¸ª
                }
            }

            if (match) {
                const dayMap = {'æ—¥':0, 'å¤©':0, 'ä¸€':1, 'äºŒ':2, 'ä¸‰':3, 'å››':4, 'äº”':5, 'å…­':6};
                const targetIndex = dayMap[dayChar];
                
                if (targetIndex === undefined) return null;
                
                // 1. è®¡ç®—åˆ°ä¸‹ä¸€ä¸ªè¯¥æ˜ŸæœŸçš„åŸºç¡€å¤©æ•°
                const daysUntilNext = calculateDaysToNextWeekday(targetIndex);
                
                // 2. åŠ ä¸Š "ä¸‹" çš„å‘¨æ•° (æ¯ä¸ª "ä¸‹" åŠ  7 å¤©)
                // æ³¨æ„ï¼šå¦‚æœ xiaCount=0 (å¦‚"å‘¨äº”")ï¼Œå°±æ˜¯ daysUntilNext
                // å¦‚æœ xiaCount=1 (å¦‚"ä¸‹å‘¨äº”")ï¼Œé€šå¸¸æŒ‡ "ä¸‹ä¸ªå‘¨äº”"ï¼Œå¦‚æœæ˜¯ä»Šå¤©å‘¨å››ï¼Œå‘¨äº”æ˜¯æ˜å¤©ã€‚
                // è¿™é‡Œçš„è¯­ä¹‰å®šä¹‰ï¼š
                // "å‘¨äº”" = æœ€è¿‘çš„å‘¨äº”
                // "ä¸‹å‘¨äº”" = æœ€è¿‘å‘¨äº” + 7å¤©
                // "ä¸‹ä¸‹å‘¨äº”" = æœ€è¿‘å‘¨äº” + 14å¤©
                const totalDaysToAdd = daysUntilNext + (xiaCount * 7);
                
                const targetDate = new Date();
                targetDate.setDate(targetDate.getDate() + totalDaysToAdd);
                targetDate.setHours(0,0,0,0);
                
                return {
                    date: targetDate,
                    matchStr: fullMatch
                };
            }
            return null;
        }

        // --- è¾…åŠ©å‡½æ•° ---
        function parseChineseOrArabic(str) {
            str = str.trim();
            if (/^\d+$/.test(str)) return parseInt(str);
            if (CHINESE_NUMBER_MAP[str] !== undefined) return CHINESE_NUMBER_MAP[str];
            if (str.startsWith('å')) return 10 + (CHINESE_NUMBER_MAP[str.substring(1)] || 0);
            if (str.startsWith('äºŒå')) return 20 + (CHINESE_NUMBER_MAP[str.substring(2)] || 0);
            if (str.startsWith('ä¸‰å')) return 30 + (CHINESE_NUMBER_MAP[str.substring(2)] || 0);
            return 0; 
        }

        function parseChineseTimeString(input) {
            let text = input.trim();
            const arabicMatch = text.match(/(\d{1,2})[:ç‚¹](åŠ|åˆ»|\d{1,2})?/);
            if (arabicMatch) {
                let hour = parseInt(arabicMatch[1]);
                let minuteStr = arabicMatch[2];
                let minute = 0;
                if (minuteStr === 'åŠ') minute = 30; else if (minuteStr === 'åˆ»') minute = 15; else if (minuteStr) minute = parseInt(minuteStr);
                if (hour < 12 && /ä¸‹åˆ|æ™šä¸Š|å‚æ™š|å¤œé‡Œ/.test(text)) hour += 12; else if (hour === 12 && /å‡Œæ™¨/.test(text)) hour = 0;
                return { formatted: `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`, type: 'specific' };
            }
            const chinesePattern = /([é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åä¸¤]+)ç‚¹(åŠ|åˆ»|([é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åä¸¤]+))?/;
            const chineseMatch = text.match(chinesePattern);
            if (chineseMatch) {
                const hourVal = parseChineseOrArabic(chineseMatch[1]);
                let minuteVal = 0;
                if (chineseMatch[2]) {
                    const minuteExpr = chineseMatch[2];
                    if (SPECIAL_TIME_EXPRESSIONS[minuteExpr] !== undefined) minuteVal = SPECIAL_TIME_EXPRESSIONS[minuteExpr];
                    else if (chineseMatch[3]) minuteVal = parseChineseOrArabic(chineseMatch[3]);
                }
                let finalHour = hourVal;
                if (finalHour < 12) {
                    for (const [period, _] of Object.entries(TIME_PERIOD_MAP)) {
                        if (text.includes(period) && ['ä¸‹åˆ', 'æ™šä¸Š', 'å‚æ™š', 'å¤œé‡Œ'].includes(period)) { finalHour += 12; break; }
                    }
                }
                return { formatted: `${String(finalHour).padStart(2, '0')}:${String(minuteVal).padStart(2, '0')}`, type: 'specific' };
            }
            for (const [period, range] of Object.entries(TIME_PERIOD_MAP)) { if (text.includes(period)) return { formatted: period, type: 'fuzzy' }; }
            return null;
        }

        function parseDaysExpression(text) {
            const afterMatch = text.match(/([0-9é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+)\s*å¤©[ä»¥ä¹‹]?[åå¾Œ]/);
            if (afterMatch) return { type: 'after', days: parseChineseOrArabic(afterMatch[1]) };
            const dayMatch = text.match(/(?:ç¬¬|Day|D)\s*([0-9é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+)\s*(?:å¤©|æ—¥)?/i);
            if (dayMatch) return { type: 'sequence', days: parseChineseOrArabic(dayMatch[1]) };
            return null;
        }

        // --- V27 æ›´æ–°ï¼šä¿ç•™åŸºç¡€æ—¥æœŸè¯æå–ä»¥å…¼å®¹æ—§é€»è¾‘ ---
        function extractLineDateWord(line) {
            line = line.trim();
            if (!line) return "";
            const daysExpr = line.match(/([0-9é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+)\s*å¤©[ä»¥ä¹‹]?[åå¾Œ]/);
            if(daysExpr) return daysExpr[0];
            const seqExpr = line.match(/(?:ç¬¬|Day|D)\s*([0-9é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+)\s*(?:å¤©|æ—¥)?/i);
            if(seqExpr) return seqExpr[0];
            const keywordMatch = line.match(/^(å¤§åå¤©|åå¤©|æ˜å¤©|æ˜å„¿|ä»Šå¤©)/);
            if(keywordMatch) return keywordMatch[0];
            // V27: è¿™é‡Œä¸å†å¤„ç†å‘¨å‡ ï¼Œå› ä¸º parseSmartWeekDate ä¼šå¤„ç†
            return "";
        }

        // --- ä¸»å¤„ç†å‡½æ•° ---
        function ai_handleInput() {
            const text = document.getElementById('ai-input').value;
            const status = document.getElementById('ai-status');
            const confirmBtn = document.getElementById('ai-confirm-btn');
            const mobileConfirmBtn = document.getElementById('mobile-confirm-btn');
            
            [confirmBtn, mobileConfirmBtn].forEach(btn => {
                if(btn && btn.innerText.includes('å·²é”å®š')) {
                    btn.innerHTML = btn.id.includes('mobile') ? '<i data-lucide="check-circle" class="w-4 h-4"></i> ç¡®è®¤è®¡åˆ’' : '<i data-lucide="check" class="w-3 h-3"></i> ç¡®è®¤è®¡åˆ’';
                    btn.classList.add('bg-emerald-600', 'hover:bg-emerald-500');
                    btn.classList.remove('bg-slate-600', 'cursor-default');
                }
            });
            lucide.createIcons();

            if (!text.trim()) {
                document.getElementById('ai-timeline-container').innerHTML = `<div class="flex flex-col items-center justify-center h-full text-slate-600 opacity-60"><i data-lucide="message-square-dashed" class="w-12 h-12 mb-3"></i><p class="text-xs">åœ¨å·¦ä¾§è¾“å…¥æ–‡å­—<br>å³ä¾§å°†å®æ—¶æ˜¾ç¤ºè§£æç»“æœ</p></div>`;
                status.innerText = "ç­‰å¾…è¾“å…¥"; status.className = "text-[10px] bg-blue-500/20 text-blue-400 px-2 py-1 rounded border border-blue-500/30";
                
                [confirmBtn, mobileConfirmBtn].forEach(btn => {
                    if(btn) { btn.disabled = true; btn.classList.add('opacity-50', 'cursor-not-allowed'); }
                });
                
                aiData = []; updateSummary(); lucide.createIcons(); return;
            }

            status.innerText = "åˆ†æä¸­..."; status.className = "text-[10px] bg-yellow-500/20 text-yellow-400 px-2 py-1 rounded border border-yellow-500/30 animate-pulse";
            
            if (aiParseTimeout) clearTimeout(aiParseTimeout);
            aiParseTimeout = setTimeout(() => {
                aiData = ai_parseText(text);
                ai_renderPreview(aiData);
                status.innerText = "åˆ†æå®Œæˆ"; status.className = "text-[10px] bg-emerald-500/20 text-emerald-400 px-2 py-1 rounded border border-emerald-500/30";
                if(aiData.length > 0) { 
                    [confirmBtn, mobileConfirmBtn].forEach(btn => {
                        if(btn) { btn.disabled = false; btn.classList.remove('opacity-50', 'cursor-not-allowed'); }
                    });
                }
                updateSummary();
            }, 500);
        }

        // --- V27 è§£æå™¨ï¼šé›†æˆæ‰€æœ‰é€»è¾‘ ---
        function ai_parseText(text) {
            const lines = text.split('\n');
            let parsedData = [];
            let baseDate = new Date(); baseDate.setHours(0,0,0,0);
            let currentDate = new Date(baseDate);

            const getDateKey = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            const getDayObj = (d) => {
                const k = getDateKey(d);
                let obj = parsedData.find(p => p.date === k);
                if (!obj) { obj = { date: k, tasks: [] }; parsedData.push(obj); }
                return obj;
            };

            lines.forEach((line, lineIndex) => { 
                let lineTrimmed = line.trim();
                if (!lineTrimmed) return;

                let targetDate = new Date(currentDate); let dateFound = false;
                let matchedDateString = ""; // ç”¨äºåç»­æ¸…ç†

                // 1. ä¼˜å…ˆå°è¯• V27 æ™ºèƒ½å‘¨ç®—æœ¯ (Smart Week Logic)
                const smartWeek = parseSmartWeekDate(lineTrimmed);
                if (smartWeek) {
                    targetDate = smartWeek.date;
                    dateFound = true;
                    matchedDateString = smartWeek.matchStr;
                } else {
                    // 2. å°è¯•å¸¸è§„é€»è¾‘ (å¤©æ•°ã€æ˜å¤©ç­‰)
                    const daysExpr = parseDaysExpression(lineTrimmed);
                    if (daysExpr) {
                        targetDate = new Date(baseDate); 
                        if (daysExpr.type === 'after') targetDate.setDate(baseDate.getDate() + daysExpr.days);
                        else if (daysExpr.type === 'sequence') targetDate.setDate(baseDate.getDate() + Math.max(0, daysExpr.days - 1));
                        dateFound = true;
                    } 
                    else if (/å¤§åå¤©/.test(lineTrimmed)) { targetDate = new Date(baseDate); targetDate.setDate(baseDate.getDate() + 3); dateFound = true; }
                    else if (/åå¤©/.test(lineTrimmed)) { targetDate = new Date(baseDate); targetDate.setDate(baseDate.getDate() + 2); dateFound = true; }
                    else if (/æ˜å¤©|æ˜å„¿/.test(lineTrimmed)) { targetDate = new Date(baseDate); targetDate.setDate(baseDate.getDate() + 1); dateFound = true; }
                    else if (/ä»Šå¤©/.test(lineTrimmed)) { targetDate = new Date(baseDate); dateFound = true; }
                }

                if(dateFound) currentDate = targetDate;
                
                const dayObj = getDayObj(currentDate);

                const taskRegex = /[^ï¼Œã€‚,ï¼›;]+(?=[ï¼Œã€‚,ï¼›;\n]|$)/g;
                let match;
                
                while ((match = taskRegex.exec(line)) !== null) {
                    let segment = match[0]; 
                    
                    let cleanContent = segment
                         .replace(/(?:Day|D)\s*[0-9]+\s*/gi, '')
                         .replace(/ç¬¬\s*[0-9é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+\s*[å¤©æ—¥]/g, '')
                         .replace(/[0-9é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+\s*å¤©[ä»¥ä¹‹]?[åå¾Œ]/g, '')
                         .replace(/æ˜å¤©|åå¤©|ä»Šå¤©/g, ''); // ç§»é™¤æ™®é€šæ—¶é—´è¯
                    
                    // V27 æ ¸å¿ƒï¼šç§»é™¤åŒ¹é…åˆ°çš„â€œä¸‹ä¸‹å‘¨äº”â€ç­‰å¤æ‚è¯
                    if (matchedDateString) {
                        cleanContent = cleanContent.replace(matchedDateString, '');
                    } else {
                        // å…œåº•ç§»é™¤ç®€å•çš„å‘¨å‡  (å¦‚æœ parseSmartWeekDate æ²¡å‘½ä¸­ä½†è¿™é‡Œæœ‰æ®‹ç•™)
                        cleanContent = cleanContent.replace(/å‘¨[ä¸€äºŒä¸‰å››äº”å…­æ—¥]/g, '');
                    }
                    
                    cleanContent = cleanContent.trim();
                    if (!cleanContent) continue;

                    const timeRes = parseChineseTimeString(segment);
                    let displayTime = "";
                    if (timeRes) displayTime = timeRes.formatted;
                    
                    cleanContent = cleanContent.replace(/((?:å‡Œæ™¨|æ—©æ™¨|æ—©ä¸Š|ä¸Šåˆ|ä¸­åˆ|æ™Œåˆ|ä¸‹åˆ|å‚æ™š|æ™šä¸Š|å¤œé‡Œ|åˆå¤œ)?\s*(?:[0-9]{1,2}[:ç‚¹](?:[0-9]{1,2}|åŠ|åˆ»)?|[é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åä¸¤]+ç‚¹(?:åŠ|åˆ»|[é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åä¸¤]+)?))/g, '').trim();
                    cleanContent = cleanContent.replace(/^(å‡†å¤‡|å¼€å§‹)\s*/, '').trim();

                    if(cleanContent) {
                        dayObj.tasks.push({
                            title: cleanContent,
                            time: displayTime,
                            duration: null,
                            tag: "",
                            rawSegment: segment, 
                            lineIndex: lineIndex,
                            lineDateWord: matchedDateString || extractLineDateWord(lineTrimmed) // ä¼˜å…ˆä½¿ç”¨æ™ºèƒ½åŒ¹é…çš„è¯
                        });
                    }
                }
            });
            return parsedData.sort((a,b) => a.date.localeCompare(b.date));
        }

        function ai_renderPreview(data) {
            const container = document.getElementById('ai-timeline-container');
            if (!data.length) { container.innerHTML = '<div class="text-center text-slate-500 mt-10 text-xs">æœªè¯†åˆ«åˆ°æœ‰æ•ˆä»»åŠ¡</div>'; return; }
            let html = '';
            data.forEach((day, dIdx) => {
                const dateObj = new Date(day.date);
                const weekStr = ['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'][dateObj.getDay()];
                html += `<div class="timeline-day"><div class="timeline-date">${day.date} Â· ${weekStr}</div>`;
                day.tasks.forEach((task, tIdx) => {
                    html += `
                    <div class="ai-task-card group">
                        <input type="text" class="ai-time-edit" value="${task.time || ''}" placeholder="æ—¶é—´" onchange="ai_updateTask(${dIdx}, ${tIdx}, 'time', this.value)">
                        <input type="text" class="ai-title-edit" value="${task.title}" placeholder="ä»»åŠ¡å†…å®¹" onchange="ai_updateTask(${dIdx}, ${tIdx}, 'title', this.value)">
                        <span class="ai-tag-badge">è‡ªåŠ¨</span>
                        <button onclick="ai_deleteTask('${day.date}', ${tIdx})" class="mobile-delete-btn md:text-slate-600 md:hover:text-red-400 transition p-2 md:px-2" title="åˆ é™¤"><i data-lucide="trash-2" class="w-4 h-4 md:w-3.5 md:h-3.5"></i></button>
                    </div>`;
                });
                html += `</div>`;
            });
            container.innerHTML = html; lucide.createIcons();
        }

        // --- V22 æ™ºèƒ½åˆ é™¤æ ¸å¿ƒ (Smart Delete Core) ---
        function ai_deleteTask(dateStr, tIdx) {
            const dayObj = aiData.find(d => d.date === dateStr);
            if (!dayObj) return;
            const task = dayObj.tasks[tIdx];

            const inputEl = document.getElementById('ai-input');
            let lines = inputEl.value.split('\n');
            
            if (typeof task.lineIndex !== 'number' || task.lineIndex >= lines.length) {
                dayObj.tasks.splice(tIdx, 1); ai_renderPreview(aiData); return;
            }
            
            let targetLine = lines[task.lineIndex];
            
            let textToRemove = task.rawSegment;
            if (!targetLine.includes(textToRemove)) { textToRemove = task.title; }
            
            if (targetLine.includes(textToRemove)) {
                const idx = targetLine.indexOf(textToRemove);
                const before = targetLine.substring(0, idx);
                const after = targetLine.substring(idx + textToRemove.length);
                let combined = before + after;
                
                // è¯­æ³•æ¸…ç†
                combined = combined.replace(/([ï¼Œã€,])\s*([ã€‚ï¼›;])/g, '$2');
                combined = combined.replace(/([ï¼Œã€,])\s*([ï¼Œã€,])/g, '$1');
                combined = combined.replace(/([ã€‚])\s*([ã€‚])/g, '$1');
                
                // ç§»é™¤è¡Œé¦–å¤šä½™æ ‡ç‚¹ï¼Œä½†ä¿ç•™æ—¥æœŸè¯
                const dateWord = task.lineDateWord || "";
                if (!combined.trim().startsWith(dateWord)) {
                     combined = combined.replace(/^\s*[ï¼Œã€,ï¼›;ï¼š:]+/, '');
                }

                lines[task.lineIndex] = combined.trim();
                
                // ç©ºè¡Œæ£€æµ‹
                const checkContent = combined.replace(dateWord, '').replace(/[ï¼Œã€‚ã€ï¼›;ï¼š:\s]/g, '');
                if (checkContent.length === 0) {
                    lines.splice(task.lineIndex, 1);
                }
            }

            inputEl.value = lines.join('\n');
            ai_handleInput();
        }
        
        function ai_updateTask(dIdx, tIdx, field, val) { 
            aiData[dIdx].tasks[tIdx][field] = val; 
            const btn = document.getElementById('ai-confirm-btn');
            const mBtn = document.getElementById('mobile-confirm-btn');
            [btn, mBtn].forEach(b => {
                if(b && b.innerText.includes('å·²é”å®š')) {
                    b.innerHTML = b.id.includes('mobile') ? '<i data-lucide="check-circle" class="w-4 h-4"></i> ç¡®è®¤æ„å»º' : '<i data-lucide="check" class="w-3 h-3"></i> ç¡®è®¤æ„å»º';
                    b.classList.add('bg-emerald-600', 'hover:bg-emerald-500');
                    b.classList.remove('bg-slate-600', 'cursor-default');
                }
            });
            lucide.createIcons();
        }

        // ============================================
        // æ ¸å¿ƒä¿®æ”¹ 1: Confirm AI
        // ============================================
        function confirmAI() {
            // 1. æ ¡éªŒä¸ºç©º
            if(aiData.length === 0) { customAlert("è¯·å…ˆè¾“å…¥å†…å®¹", "æç¤º", "info"); return; }
            
            // 2. é”å®šæŒ‰é’®æ ·å¼
            const btn = document.getElementById('ai-confirm-btn');
            const mBtn = document.getElementById('mobile-confirm-btn');
            [btn, mBtn].forEach(b => {
                if(b) {
                    b.innerHTML = b.id.includes('mobile') ? '<i data-lucide="lock" class="w-4 h-4"></i> å·²é”å®š' : '<i data-lucide="check-circle" class="w-3 h-3"></i> å·²é”å®š';
                    b.classList.remove('bg-emerald-600', 'hover:bg-emerald-500');
                    b.classList.add('bg-slate-600', 'cursor-default');
                }
            });
            lucide.createIcons();
            
            // 3. æ ¸å¿ƒä¿®æ”¹ï¼šç§»é™¤ Alertï¼Œç›´æ¥å¹³æ»‘æ»šåŠ¨åˆ°ä¸»é¢˜é€‰æ‹©åŒº
            const themeSection = document.getElementById('theme-section');
            if (themeSection) {
                // ç¨å¾®å»¶è¿Ÿä¸€ç‚¹ç‚¹ï¼Œè®©é”®ç›˜æ”¶èµ·ï¼ˆæ‰‹æœºç«¯ï¼‰åå†æ»šåŠ¨ï¼Œä½“éªŒæ›´å¥½
                setTimeout(() => {
                    themeSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            }

            updateSummary();
        }

        function ai_loadSample(type) {
            const textarea = document.getElementById('ai-input');
            let text = "";
            if (type === 'exam') text = "å‘¨ä¸‰æ—©ä¸Š8ç‚¹èƒŒå•è¯ï¼Œä¸‹åˆ2ç‚¹åšæ•°å­¦å·å­ã€‚\nä¸‹å‘¨ä¸€å…¨å¤©å¤ä¹ ä¸“ä¸šè¯¾ï¼Œæ™šä¸Šçœ‹ç”µå½±ã€‚\nä¸‹ä¸‹å‘¨äº”æ—©èµ·æ™¨è·‘5å…¬é‡Œã€‚";
            if (type === 'life') text = "å‘¨å…­æ—©ä¸Šä¹°èœï¼Œä¸­åˆ11ç‚¹åŠæ¥å­©å­æ”¾å­¦ã€‚\nä¸‹å‘¨æ—¥é€å­©å­å»ç”»ç”»ï¼Œé¡ºä¾¿å»è¶…å¸‚ä¹°ç‰›å¥¶ã€‚\nä¸‹ä¸‹å‘¨ä¸‰æ™šä¸Š6ç‚¹åšé¥­ï¼Œ8ç‚¹æ´—è¡£æœã€‚";
            if (type === 'mixed') text = "æ—©ä¸Š8ç‚¹åŠå¼€ä¼šï¼Œä¸­åˆ12ç‚¹åƒé¥­ï¼Œæ™šä¸Š7ç‚¹å¥èº«ã€‚";
            if (type === 'date') text = "ä»Šå¤©å¤ä¹ ç¬¬ä¸€ç« ã€‚\n3å¤©åè¿›è¡Œå•å…ƒæµ‹è¯•ã€‚\nç¬¬10å¤©å¼€å§‹å…¨çœŸæ¨¡æ‹Ÿã€‚";
            textarea.value = text;
            ai_handleInput();
        }

        // ============================================
        // æ¨¡å—2ï¼šBuilder æ‰‹åŠ¨æ„å»º
        // ============================================
        function addBuilderDay() {
            const today = new Date();
            today.setDate(today.getDate() + builderData.length);
            const dateStr = today.toISOString().split('T')[0];
            builderData.push({ date: dateStr, tasks: [{ title: '', tag: '', desc: '', time: '', duration: null }] });
            renderBuilder(); updateSummary();
        }

        // ============================================
        // æ ¸å¿ƒä¿®æ”¹ 2: Confirm Builder
        // ============================================
        function confirmBuilder() {
            // 1. æ ¡éªŒä¸ºç©º
            if(builderData.length === 0) { customAlert("è¯·å…ˆæ·»åŠ è‡³å°‘ä¸€å¤©ä»»åŠ¡", "æç¤º", "info"); return; }
            
            // 2. é”å®šæŒ‰é’®æ ·å¼
            const btn = document.getElementById('builder-confirm-btn');
            btn.innerHTML = `<i data-lucide="check-circle" class="w-3 h-3"></i> å·²ç¡®è®¤`;
            btn.classList.remove('bg-emerald-600', 'hover:bg-emerald-500');
            btn.classList.add('bg-slate-600', 'cursor-default');
            lucide.createIcons();
            
            // 3. æ ¸å¿ƒä¿®æ”¹ï¼šç§»é™¤ Alertï¼Œç›´æ¥å¹³æ»‘æ»šåŠ¨åˆ°ä¸»é¢˜é€‰æ‹©åŒº
            const themeSection = document.getElementById('theme-section');
            if (themeSection) {
                themeSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            updateSummary();
        }

        function renderBuilder() {
            const container = document.getElementById('builder-container');
            container.innerHTML = '';
            if(builderData.length === 0) { container.innerHTML = '<div class="text-center text-slate-500 py-10 border border-dashed border-slate-700 rounded-xl">æš‚æ— æ•°æ®ï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </div>'; return; }

            builderData.forEach((day, dIdx) => {
                const dayEl = document.createElement('div');
                dayEl.className = 'builder-day group';
                dayEl.innerHTML = `
                    <div class="flex justify-between items-center mb-3 bg-slate-800/40 p-2.5 rounded-lg border border-white/5 hover:border-blue-500/30 transition-colors">
                        <div class="flex items-center gap-3">
                            <span class="text-[10px] font-bold text-slate-300 bg-slate-700/50 px-2 py-1 rounded shadow-sm">DAY ${dIdx + 1}</span>
                            <div class="h-4 w-px bg-white/10"></div>
                            <input type="text" value="${day.date || ''}" onchange="updateBuilderDate(${dIdx}, this.value)" class="bg-transparent border-none text-sm font-bold text-white focus:outline-none w-32 placeholder-slate-600" placeholder="YYYY-MM-DD">
                        </div>
                        <button onclick="removeBuilderDay(${dIdx})" class="text-slate-500 hover:text-red-400 transition opacity-0 group-hover:opacity-100 p-1.5 hover:bg-white/5 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                    <div class="space-y-3 pl-2 border-l border-white/5 ml-4">
                        ${day.tasks.map((task, tIdx) => `
                            <div class="bg-slate-900/30 p-2 rounded-lg border border-white/5 hover:border-white/10 transition">
                                <div class="flex flex-wrap gap-2 items-center mb-2"> 
                                    <input type="text" value="${task.tag || ''}" onchange="updateBuilderTask(${dIdx}, ${tIdx}, 'tag', this.value)" class="builder-input w-24 text-center text-xs text-blue-300 font-bold" placeholder="æ ‡ç­¾">
                                    <input type="text" value="${task.title}" onchange="updateBuilderTask(${dIdx}, ${tIdx}, 'title', this.value)" class="builder-input flex-1 font-bold min-w-[140px]" placeholder="ä»»åŠ¡æ ¸å¿ƒå†…å®¹">
                                    <button onclick="removeBuilderTask(${dIdx}, ${tIdx})" class="text-slate-600 hover:text-red-400 px-1"><i data-lucide="x" class="w-3.5 h-3.5"></i></button>
                                </div>
                                <div class="flex flex-wrap gap-2 items-center"> 
                                    <input type="text" value="${task.time || ''}" onchange="updateBuilderTask(${dIdx}, ${tIdx}, 'time', this.value)" class="builder-input w-24 text-xs font-mono" placeholder="09:00">
                                    <input type="text" value="${task.desc || ''}" onchange="updateBuilderTask(${dIdx}, ${tIdx}, 'desc', this.value)" class="builder-input flex-1 text-xs text-slate-400 min-w-[140px]" placeholder="å¤‡æ³¨/æè¿°...">
                                </div>
                            </div>
                        `).join('')}
                        <button onclick="addBuilderTask(${dIdx})" class="mt-2 text-[11px] text-blue-400 hover:text-blue-300 flex items-center gap-1 opacity-60 hover:opacity-100 transition px-1 py-1"><i data-lucide="plus" class="w-3 h-3"></i> æ·»åŠ ä»»åŠ¡</button>
                    </div>
                `;
                container.appendChild(dayEl);
            });
            lucide.createIcons();
        }

        function removeBuilderDay(idx) { builderData.splice(idx, 1); renderBuilder(); updateSummary(); }
        function addBuilderTask(dayIdx) { builderData[dayIdx].tasks.push({ title: '', tag: '', desc: '', time: '', duration: null }); renderBuilder(); updateSummary(); }
        function removeBuilderTask(dayIdx, taskIdx) { builderData[dayIdx].tasks.splice(taskIdx, 1); renderBuilder(); updateSummary(); }
        function updateBuilderDate(dIdx, val) { builderData[dIdx].date = val; resetBuilderConfirm(); }
        function updateBuilderTask(dIdx, tIdx, field, val) { builderData[dIdx].tasks[tIdx][field] = val; resetBuilderConfirm(); }
        function resetBuilderConfirm() {
            const btn = document.getElementById('builder-confirm-btn');
            if(btn && btn.innerText.includes('å·²ç¡®è®¤')) {
                btn.innerHTML = `<i data-lucide="check" class="w-3 h-3"></i> ç¡®è®¤æ„å»º`;
                btn.classList.add('bg-emerald-600', 'hover:bg-emerald-500');
                btn.classList.remove('bg-slate-600', 'cursor-default');
                lucide.createIcons();
            }
        }

        // ============================================
        // æ¨¡å—3ï¼šExcel & æ ¸å¿ƒç”Ÿæˆé€»è¾‘
        // ============================================
        function processTasksData(rawArray) {
            if (!rawArray || rawArray.length < 2) return [];
            let headerRowIndex = -1;
            let colMap = { date: -1, title: -1, desc: -1, tag: -1, time: -1, duration: -1 };

            for (let r = 0; r < Math.min(rawArray.length, 5); r++) {
                const rowStr = rawArray[r].map(c => String(c).trim().toLowerCase());
                if (rowStr.findIndex(c => c.includes('date')||c.includes('æ—¥æœŸ')) !== -1 && rowStr.findIndex(c => c.includes('task')||c.includes('æ ‡é¢˜')) !== -1) {
                    headerRowIndex = r;
                    colMap.date = rowStr.findIndex(c => c.includes('date')||c.includes('æ—¥æœŸ'));
                    colMap.title = rowStr.findIndex(c => c.includes('task')||c.includes('æ ‡é¢˜'));
                    colMap.desc = rowStr.findIndex(c => c.includes('desc')||c.includes('æè¿°'));
                    colMap.tag = rowStr.findIndex(c => c.includes('tag')||c.includes('æ ‡ç­¾'));
                    colMap.time = rowStr.findIndex(c => c.includes('time')||c.includes('æ—¶é—´'));
                    break;
                }
            }

            if (headerRowIndex === -1) return [];
            const taskDataByDate = {};
            rawArray.slice(headerRowIndex + 1).forEach((row) => {
                const dateRaw = row[colMap.date]; if (!dateRaw) return;
                let dateStr = '';
                try {
                    if (typeof dateRaw === 'number') {
                        const dateObj = XLSX.SSF.parse_date_code(dateRaw);
                        dateStr = `${dateObj.y}-${String(dateObj.m).padStart(2,'0')}-${String(dateObj.d).padStart(2,'0')}`;
                    } else {
                        const dateString = String(dateRaw).trim();
                        const d = new Date(dateString.replace(/-/g, '/').replace(/\./g, '/'));
                        if (!isNaN(d.getTime())) dateStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                        else dateStr = dateString.split(' ')[0];
                    }
                } catch (e) { return; }

                if (!taskDataByDate[dateStr]) taskDataByDate[dateStr] = { date: dateStr, tasks: [] };
                taskDataByDate[dateStr].tasks.push({
                    title: String(row[colMap.title] || ''),
                    desc: colMap.desc > -1 ? String(row[colMap.desc] || '') : '',
                    tag: colMap.tag > -1 ? String(row[colMap.tag] || '') : '',
                    time: colMap.time > -1 ? String(row[colMap.time] || '') : ''
                });
            });

            return Object.keys(taskDataByDate).sort().map((date, index) => {
                const dayData = taskDataByDate[date]; dayData.dayNum = index + 1; return dayData;
            });
        }

        function convertAIDataToOriginalFormat(aiData) {
            return aiData.map((day, index) => ({
                date: day.date, dayNum: index + 1,
                tasks: day.tasks.map(task => ({
                    title: task.title, tag: "", desc: "", time: task.time || "", duration: task.duration || null
                }))
            }));
        }

        async function generateApp() {
            if (!selectedTheme) { customAlert('è¯·é€‰æ‹©ä¸»é¢˜ï¼', 'æç¤º', 'info'); return; }
            
            const btn = document.getElementById('generate-button');
            const mBtn = document.getElementById('mobile-generate-btn');
            const originalText = btn.innerText;
            const mOriginalText = mBtn.innerHTML;
            
            [btn, mBtn].forEach(b => {
                if(b) {
                    b.disabled = true;
                    b.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4 inline mr-2"></i> å¤„ç†ä¸­...';
                }
            });
            lucide.createIcons();

            try {
                let structuredData = [];
                if (currentMode === 'ai') {
                    if (aiData.length === 0) throw new Error('AI æ•°æ®ä¸ºç©ºï¼Œè¯·å…ˆè¾“å…¥è®¡åˆ’');
                    structuredData = convertAIDataToOriginalFormat(aiData);
                } else if (currentMode === 'upload') {
                    if (!uploadedData) throw new Error('è¯·å…ˆä¸Šä¼  Excel æ–‡ä»¶');
                    structuredData = processTasksData(uploadedData);
                } else if (currentMode === 'builder') {
                    if (builderData.length === 0) throw new Error('è¯·è‡³å°‘æ·»åŠ ä¸€å¤©ä»»åŠ¡');
                    structuredData = builderData.map((d, i) => ({
                        date: d.date, dayNum: i+1,
                        tasks: d.tasks.filter(t => t.title.trim() !== '').map(t => ({
                            ...t,
                            tag: (t.tag && t.tag.trim()) ? t.tag : null 
                        }))
                    })).filter(d => d.tasks.length > 0);
                }

                if (structuredData.length === 0) throw new Error('æœ‰æ•ˆæ•°æ®ä¸ºç©º');

                const planTitle = await getPlanTitle();
                if (!planTitle) { 
                    [btn, mBtn].forEach(b => {
                        if(b) { b.disabled = false; b.innerHTML = b.id.includes('mobile') ? mOriginalText : originalText; }
                    });
                    lucide.createIcons();
                    return; 
                }

                let templateContent = await getTemplateContent(selectedTheme);
                const rulesDbContent = await getRulesDbContent();
                const planId = selectedTheme + '_' + Date.now();
                const safeTitle = planTitle.replace(/[<>"]/g, '');
                const escapedData = JSON.stringify(structuredData).replace(/</g, '\\u003c').replace(/>/g, '\\u003e').replace(/&/g, '\\u0026').replace(/'/g, '\\u0027');

                let finalHtml = templateContent
                    .replace(/{{TASKS_DATA}}/g, escapedData)
                    .replace(/{{PLAN_TITLE}}/g, safeTitle)
                    .replace(/{{PLAN_ID}}/g, planId)
                    .replace(/{{BODY_CLASS}}/g, '');

                if (rulesDbContent) {
                    if (finalHtml.includes('src="rules_db.js"')) {
                        finalHtml = finalHtml.replace(/<script[^>]*src="[^"]*rules_db\.js"[^>]*><\/script>/, '<script>' + rulesDbContent + '<\/script>');
                    } else {
                        finalHtml = finalHtml.replace('</head>', '<script>' + rulesDbContent + '<\/script></head>');
                    }
                }

                const safeFileName = safeTitle.replace(/[<>:"/\\|?*]/g, '_') + '_' + selectedTheme + '.html';
                const blob = new Blob([finalHtml], { type: 'text/html;charset=utf-8' });
                const blobUrl = URL.createObjectURL(blob);
                
                displayResultOptions(blobUrl, safeFileName);
                customAlert(`æˆåŠŸç”Ÿæˆ ${structuredData.length} å¤©è®¡åˆ’ï¼`, 'æ„å»ºå®Œæˆ', 'check-circle');

            } catch (error) {
                console.error(error); customAlert('é”™è¯¯: ' + error.message, 'ç”Ÿæˆå¤±è´¥', 'x-circle');
            } finally {
                [btn, mBtn].forEach(b => {
                    if(b) { b.disabled = false; b.innerHTML = b.id.includes('mobile') ? mOriginalText : originalText; }
                });
                lucide.createIcons();
            }
        }

        // ============================================
        // 4. UI è¾…åŠ©
        // ============================================
        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const tabBtn = document.getElementById('tab-' + mode);
            if(tabBtn) tabBtn.classList.add('active');
            
            ['ai', 'upload', 'builder'].forEach(m => {
                const el = document.getElementById('mode-' + m);
                if(el) el.classList.add('hidden');
            });
            
            const targetEl = document.getElementById('mode-' + mode);
            if(targetEl) targetEl.classList.remove('hidden');
            
            if (mode === 'builder') {
                if (builderData.length === 0) addBuilderDay();
                resetBuilderConfirm();
            } else if (mode === 'ai') {
                const btn = document.getElementById('ai-confirm-btn');
                const mBtn = document.getElementById('mobile-confirm-btn');
                [btn, mBtn].forEach(b => {
                    if(b && b.innerText.includes('å·²é”å®š')) {
                        b.innerHTML = b.id.includes('mobile') ? '<i data-lucide="check-circle" class="w-4 h-4"></i> ç¡®è®¤æ„å»º' : '<i data-lucide="check" class="w-3 h-3"></i> ç¡®è®¤æ„å»º';
                        b.classList.add('bg-emerald-600', 'hover:bg-emerald-500');
                        b.classList.remove('bg-slate-600', 'cursor-default');
                    }
                });
                lucide.createIcons();
            }
            updateSummary();
        }

        function handleFileChange(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            customAlert("æ­£åœ¨è§£æ Excel...", "å¤„ç†ä¸­", "loader-2");
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    uploadedData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
                    
                    if(uploadedData && uploadedData.length > 1) {
                        switchMode('upload'); 
                        updateSummary();
                        customAlert(`æˆåŠŸè¯»å– ${uploadedData.length-1} è¡Œæ•°æ®`, "è§£ææˆåŠŸ", "check");
                        
                        const dropArea = document.getElementById('excel-drop-area');
                        dropArea.innerHTML = `
                            <div class="w-16 h-16 bg-emerald-500/10 rounded-full flex items-center justify-center mb-4 border border-emerald-500/30">
                                <i data-lucide="check" class="w-8 h-8 text-emerald-400"></i>
                            </div>
                            <p class="text-lg font-bold text-white">å·²å°±ç»ª: ${file.name}</p>
                            <p class="text-sm text-emerald-400 mt-2 font-mono">åŒ…å« ${uploadedData.length-1} ä¸ªä»»åŠ¡</p>
                            <button onclick="document.getElementById('excel-file').click()" class="mt-4 text-xs text-slate-500 hover:text-white underline">æ›´æ¢æ–‡ä»¶</button>
                            <input type="file" id="excel-file" accept=".xlsx,.csv" class="hidden" onchange="handleFileChange(event)">
                        `;
                        lucide.createIcons();
                        
                    } else {
                        throw new Error("æ•°æ®ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®");
                    }
                } catch(err) {
                    customAlert("Excel è§£æå¤±è´¥: " + err.message, "é”™è¯¯", "x-circle");
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function getTemplateContent(theme) {
            try {
                const res = await fetch(`templates/template_${theme}.html`);
                if (!res.ok) { const fb = await fetch(`template_${theme}.html`); if (fb.ok) return await fb.text(); throw new Error('Template not found'); }
                return await res.text();
            } catch (e) { throw new Error('æ— æ³•åŠ è½½æ¨¡æ¿æ–‡ä»¶'); }
        }
        async function getRulesDbContent() { try { const res = await fetch('templates/rules_db.js'); return res.ok ? await res.text() : ''; } catch { return ''; } }

        function selectTheme(theme) {
            selectedTheme = theme;
            document.querySelectorAll('.selection-card').forEach(el => el.classList.remove('selected'));
            const card = document.getElementById('theme-' + theme);
            if(card) card.classList.add('selected');
            updateSummary();
        }

        function updateSummary() {
            const s = document.getElementById('generation-summary');
            const btn = document.getElementById('generate-button');
            const mBtn = document.getElementById('mobile-generate-btn');
            const themeMap = { 'pro': 'DeepFlow Pro', 'zen': 'Zen Mode', 'cyberpunk': 'Cyberpunk' };
            const themeName = themeMap[selectedTheme] || 'æœªé€‰æ‹©';
            let count = 0, sourceText = "";
            if (currentMode === 'ai') { count = aiData.length; sourceText = "AI è§£æ"; }
            else if (currentMode === 'upload' && uploadedData) { count = uploadedData.length - 1; sourceText = "Excel"; }
            else if (currentMode === 'builder') { count = builderData.length; sourceText = "åœ¨çº¿æ„å»º"; }

            if (count > 0 && selectedTheme) { 
                if(s) s.innerHTML = `ğŸ‰ å°±ç»ªï¼æ•°æ®æºï¼š${sourceText} (${count} å¤©)ï¼Œä¸»é¢˜ï¼š${themeName}`; 
                [btn, mBtn].forEach(b => { if(b) { b.disabled = false; b.classList.remove('opacity-50'); }});
            } else { 
                if(s) s.innerHTML = count > 0 ? `æ•°æ® OK (${sourceText})ï¼Œè¯·é€‰æ‹©ä¸»é¢˜` : "ç­‰å¾…æ•°æ®é…ç½®..."; 
                [btn, mBtn].forEach(b => { if(b) { b.disabled = true; b.classList.add('opacity-50'); }});
            }
        }

        function displayResultOptions(blobUrl, fileName) {
            const modal = document.getElementById('resultModalOverlay');
            const prevBtn = document.getElementById('previewButton');
            const downBtn = document.getElementById('downloadButton');
            prevBtn.href = blobUrl;
            downBtn.href = blobUrl;
            downBtn.download = fileName;
            modal.style.display = 'flex'; 
            setTimeout(() => modal.classList.add('active'), 10);
        }
        
        function closeResultModal() {
            const modal = document.getElementById('resultModalOverlay');
            modal.classList.remove('active'); 
            setTimeout(() => modal.style.display = 'none', 300);
        }

        function getPlanTitle() {
            return new Promise((resolve) => {
                titlePromiseResolve = resolve;
                const m = document.getElementById('title-input-modal'); const p = document.getElementById('title-modal-panel');
                m.classList.remove('opacity-0', 'pointer-events-none'); p.classList.remove('opacity-0', 'scale-95'); p.classList.add('scale-100');
            });
        }
        function confirmTitleModal() { closeTitleModal(); if(titlePromiseResolve) titlePromiseResolve(document.getElementById('plan-title-input').value || 'DeepFlow è®¡åˆ’'); }
        function cancelTitleModal() { closeTitleModal(); if(titlePromiseResolve) titlePromiseResolve(null); }
        function closeTitleModal() {
            const m = document.getElementById('title-input-modal'); const p = document.getElementById('title-modal-panel');
            m.classList.add('opacity-0', 'pointer-events-none'); p.classList.add('opacity-0', 'scale-95'); p.classList.remove('scale-100');
        }

        function customAlert(msg, title, icon) {
            const m = document.getElementById('custom-alert-modal');
            document.getElementById('alert-message').textContent = msg;
            document.getElementById('alert-title').innerHTML = `<i data-lucide="${icon}" class="w-5 h-5"></i> ${title}`;
            lucide.createIcons();
            m.classList.remove('hidden'); setTimeout(() => m.classList.remove('opacity-0'), 10);
        }
        function closeCustomAlert() { const m = document.getElementById('custom-alert-modal'); m.classList.add('opacity-0'); setTimeout(() => m.classList.add('hidden'), 300); }
        function downloadSampleExcel() {
            const ws = XLSX.utils.aoa_to_sheet([["æ—¥æœŸ","ä»»åŠ¡æ ‡é¢˜","æ—¶é—´","æ ‡ç­¾"],["2025-01-01","ç¤ºä¾‹ä»»åŠ¡","09:00","æ ¸å¿ƒ"]]);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, "DeepFlow_Template.xlsx");
        }

        window.onload = () => {
            lucide.createIcons();
            initMobileExperience();
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.get('theme')) selectTheme(urlParams.get('theme'));
            const dropArea = document.querySelector('label[for="excel-file"]');
            if (dropArea) {
                dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.classList.add('border-blue-500', 'bg-white/10'); });
                dropArea.addEventListener('dragleave', () => { dropArea.classList.remove('border-blue-500', 'bg-white/10'); });
                dropArea.addEventListener('drop', (e) => { e.preventDefault(); dropArea.classList.remove('border-blue-500', 'bg-white/10'); const file = e.dataTransfer.files[0]; if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.csv'))) { const input = document.getElementById('excel-file'); const dt = new DataTransfer(); dt.items.add(file); input.files = dt.files; handleFileChange({ target: input }); switchMode('upload'); } else { customAlert('è¯·ä¸Šä¼  .xlsx æˆ– .csv æ–‡ä»¶', 'é”™è¯¯', 'file-x'); } });
            }
        };
    </script>
</body>
</html>