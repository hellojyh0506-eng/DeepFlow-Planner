<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title id="previewTitle">DeepFlow 预览中...</title>
    <meta name="theme-color" content="#020617">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json"> 
    <script src="https://deepflow-hellojyh-audio.oss-cn-hangzhou.aliyuncs.com/libs/tailwind.js"></script>
    <script src="https://deepflow-hellojyh-audio.oss-cn-hangzhou.aliyuncs.com/libs/confetti.browser.min.js"></script>
    <script src="https://deepflow-hellojyh-audio.oss-cn-hangzhou.aliyuncs.com/libs/lucide.min.js"></script>
    
    </head>
<body>
    <div id="dynamicContent">正在加载您的计划...</div>
    
    <script>
        // 核心加载逻辑：从 localStorage 读取数据并替换模板中的占位符
        window.onload = function() {
            const data = localStorage.getItem('DF_LIVE_DATA');
            const title = localStorage.getItem('DF_LIVE_TITLE');
            const theme = localStorage.getItem('DF_LIVE_THEME');
            
            if (data && theme) {
                // 1. 设置标题
                document.getElementById('previewTitle').innerText = title || "DeepFlow 预览计划";
                
                // 2. 动态加载模板 (这是最复杂的部分，最好是预先将模板代码注入)
                // 简化处理：假设您已经将 template_pro.html 的内容（包含{{TASKS_DATA}}）复制到这里
                
                // 3. 模拟模板替换（假设整个页面就是 Pro 模板）
                const templateHTML = document.documentElement.outerHTML; // 假设页面是模板
                const finalHTML = templateHTML
                    .replace(/{{TASKS_DATA}}/g, JSON.parse(data).escapedData) // 从本地数据获取转义后的数据
                    .replace(/{{PLAN_TITLE}}/g, title)
                    .replace(/{{PLAN_ID}}/g, 'live_preview_1');
                
                document.open();
                document.write(finalHTML);
                document.close();
                
                // 清理数据
                localStorage.removeItem('DF_LIVE_DATA');
                localStorage.removeItem('DF_LIVE_TITLE');
                localStorage.removeItem('DF_LIVE_THEME');

            } else {
                document.getElementById('dynamicContent').innerText = "加载失败，请从生成器重新尝试。";
            }
            
            // 确保 Service Worker 注册（复制自 template_pro.html 底部）
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js').catch(error => {
                    console.warn('SW registration failed:', error);
                });
            }
        };
    </script>
</body>
</html>