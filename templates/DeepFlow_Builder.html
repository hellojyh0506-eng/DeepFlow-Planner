<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepFlow ç‹¬ç«‹æ„å»ºå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=Noto+Sans+SC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', '"Noto Sans SC"', 'sans-serif'] },
                    colors: { deep: { 900: '#020617', 800: '#0f172a', 700: '#1e293b' } }
                }
            }
        }
    </script>
    <style>
        body { background-color: #020617; color: white; min-height: 100vh; }
        
        .aurora-bg {
            position: fixed; inset: 0; z-index: -1;
            background: 
                radial-gradient(circle at 0% 0%, rgba(59, 130, 246, 0.15) 0%, transparent 50%), 
                radial-gradient(circle at 100% 100%, rgba(168, 85, 247, 0.15) 0%, transparent 50%);
            pointer-events: none;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .input-dark {
            background: rgba(2, 6, 23, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e2e8f0;
            transition: all 0.2s;
        }
        .input-dark:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .theme-btn.active {
            background-color: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: white;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.25); }
    </style>
</head>
<body class="antialiased p-6 md:p-12">

    <div class="aurora-bg"></div>

    <div class="max-w-7xl mx-auto">
        <header class="flex justify-between items-end mb-8">
            <div>
                <h1 class="text-3xl md:text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400 mb-2">
                    DeepFlow Builder
                </h1>
                <p class="text-slate-400 text-sm">ç‹¬ç«‹è®¡åˆ’ç¼–è¾‘å™¨ (Fixed Version)</p>
            </div>
            <div class="flex gap-3">
                <button onclick="clearAll()" class="px-4 py-2 text-sm text-slate-400 hover:text-red-400 transition flex items-center gap-2 border border-transparent hover:border-red-900 rounded-lg">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> æ¸…ç©º
                </button>
                <button onclick="downloadJson()" class="px-4 py-2 text-sm text-slate-400 hover:text-white transition flex items-center gap-2 border border-slate-700 rounded-lg hover:bg-white/5">
                    <i data-lucide="save" class="w-4 h-4"></i> å¤‡ä»½ JSON
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-4 space-y-6">
                <div class="glass-card rounded-2xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-bold text-white flex items-center gap-2">
                            <i data-lucide="sparkles" class="w-5 h-5 text-blue-400"></i> æ™ºèƒ½è§£æ
                        </h2>
                        <span class="text-[10px] bg-blue-500/20 text-blue-300 px-2 py-1 rounded border border-blue-500/30">AI Parser</span>
                    </div>
                    
                    <textarea id="raw-input" 
                        class="w-full h-64 input-dark rounded-xl p-4 text-sm font-mono leading-relaxed resize-none mb-4 placeholder-slate-600"
                        placeholder="è¯·åœ¨æ­¤ç²˜è´´è®¡åˆ’...&#10;&#10;å®Œç¾é€‚é…æ ¼å¼ï¼š&#10;[æ ‡ç­¾] [å†…å®¹] [æ—¶é—´] [æ—¶é•¿]&#10;&#10;ç¤ºä¾‹ï¼š&#10;æ ¸å¿ƒ é«˜æ•°ç¬¬ä¸€ç« å¤ä¹  09:00 90&#10;è¿åŠ¨ æ™¨è·‘5å…¬é‡Œ 0700 40&#10;èƒŒè¯µ é›…æ€å•è¯List1"></textarea>
                    
                    <button onclick="parseAndFill()" class="w-full py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-bold rounded-xl shadow-lg transition-all transform hover:scale-[1.02] flex justify-center items-center gap-2">
                        <i data-lucide="arrow-right-circle" class="w-5 h-5"></i> è¯†åˆ«å¹¶è¦†ç›–åˆ—è¡¨
                    </button>
                    
                    <div class="mt-4 text-xs text-slate-500 leading-relaxed border-t border-white/5 pt-4">
                        <p class="font-bold text-slate-400 mb-1">ğŸ’¡ è¯†åˆ«é€»è¾‘ (ç©ºæ ¼åˆ†éš”)ï¼š</p>
                        <ul class="list-disc pl-4 space-y-1">
                            <li>æœ«å°¾çº¯æ•°å­— -> <span class="text-blue-400">æ—¶é•¿</span> (åˆ†é’Ÿ)</li>
                            <li>æœ«å°¾æ—¶é—´æ ¼å¼ -> <span class="text-blue-400">æ—¶é—´</span> (0900/09:00)</li>
                            <li>å¼€å¤´çŸ­è¯ -> <span class="text-blue-400">æ ‡ç­¾</span> (å¦‚"æ ¸å¿ƒ")</li>
                        </ul>
                    </div>
                </div>

                <div class="glass-card rounded-2xl p-6">
                    <h2 class="font-bold text-white mb-4 flex items-center gap-2">
                        <i data-lucide="download" class="w-5 h-5 text-emerald-400"></i> ç”Ÿæˆè®¾ç½®
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs text-slate-400 mb-1.5 ml-1">è®¡åˆ’æ ‡é¢˜</label>
                            <input type="text" id="plan-title" class="w-full input-dark rounded-lg px-4 py-2.5 font-bold text-white" value="æˆ‘çš„ DeepFlow è®¡åˆ’">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1.5 ml-1">é€‰æ‹©æ¨¡æ¿</label>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="selectTheme('pro')" id="btn-pro" class="theme-btn active border border-slate-700 text-slate-400 rounded-lg py-2 text-xs font-bold transition">Pro</button>
                                <button onclick="selectTheme('zen')" id="btn-zen" class="theme-btn border border-slate-700 text-slate-400 rounded-lg py-2 text-xs font-bold transition">Zen</button>
                                <button onclick="selectTheme('cyberpunk')" id="btn-cyberpunk" class="theme-btn border border-slate-700 text-slate-400 rounded-lg py-2 text-xs font-bold transition">Cyber</button>
                            </div>
                            <p class="text-[10px] text-slate-500 mt-2">* éœ€å°† template_*.html å’Œ rules_db.js æ”¾åœ¨åŒç›®å½•</p>
                        </div>
                        <button onclick="generateFile()" class="w-full py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl shadow-lg transition-all flex justify-center items-center gap-2 mt-2">
                            <i data-lucide="check-circle" class="w-5 h-5"></i> ç”Ÿæˆ HTML
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8">
                <div class="glass-card rounded-2xl min-h-[700px] flex flex-col">
                    <div class="p-6 border-b border-white/5 flex justify-between items-center bg-white/5">
                        <h2 class="font-bold text-lg flex items-center gap-2 text-slate-200">
                            <i data-lucide="list-todo" class="w-5 h-5 text-emerald-400"></i> è®¡åˆ’é¢„è§ˆä¸å¾®è°ƒ
                        </h2>
                        <button onclick="addDay()" class="text-xs bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded-lg transition flex items-center gap-1">
                            <i data-lucide="plus" class="w-3 h-3"></i> æ·»åŠ ä¸€å¤©
                        </button>
                    </div>
                    
                    <div id="editor-container" class="flex-1 p-6 space-y-6 overflow-y-auto max-h-[85vh]">
                        <div class="text-center py-32 text-slate-500 border-2 border-dashed border-slate-800 rounded-2xl">
                            <i data-lucide="layout-template" class="w-12 h-12 mx-auto mb-4 opacity-20"></i>
                            <p>åˆ—è¡¨ä¸ºç©º</p>
                            <p class="text-xs mt-2">è¯·åœ¨å·¦ä¾§è¾“å…¥å†…å®¹å¹¶ç‚¹å‡»â€œè¯†åˆ«å¹¶è¦†ç›–åˆ—è¡¨â€</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        
        let planData = [];
        let currentTheme = 'pro';

        // é»˜è®¤é€‰ä¸­ Pro
        selectTheme('pro');

        // ============================================
        // 1. æ ¸å¿ƒé€»è¾‘ï¼šè§£æç®—æ³•
        // ============================================
        function parseAndFill() {
            const text = document.getElementById('raw-input').value;
            if(!text.trim()) { alert("è¯·å…ˆè¾“å…¥å†…å®¹"); return; }

            const lines = text.split('\n');
            const newPlan = [];
            let currentDay = null;
            let dayCount = 0;

            const datePatterns = [/day\s*(\d+)/i, /ç¬¬\s*(\d+)\s*å¤©/, /(\d{4}-\d{2}-\d{2})/, /ä»Šå¤©/, /æ˜å¤©/];

            lines.forEach(line => {
                line = line.trim();
                if(!line) return;

                let isDateLine = false;
                for(let p of datePatterns) {
                    if(p.test(line)) {
                        isDateLine = true;
                        if(currentDay) newPlan.push(currentDay);
                        dayCount++;
                        
                        const d = new Date(); d.setDate(d.getDate() + (dayCount-1));
                        const dateStr = d.toISOString().split('T')[0];
                        currentDay = { date: dateStr, tasks: [] };
                        break;
                    }
                }

                if(!isDateLine) {
                    if(!currentDay) {
                        const d = new Date();
                        currentDay = { date: d.toISOString().split('T')[0], tasks: [] };
                        dayCount++;
                    }

                    const parts = line.split(/\s+/);
                    if(parts.length > 0) {
                        let tag = 'æ—¥å¸¸';
                        let title = '';
                        let time = '';
                        let duration = null;
                        let desc = '';

                        // å€’åºæ‰¾æ—¶é•¿
                        let lastIdx = parts.length - 1;
                        if(lastIdx >= 0) {
                            let val = parts[lastIdx];
                            if(/^\d+$/.test(val) && val.length <= 3) {
                                duration = parseInt(val);
                                parts.pop(); lastIdx--;
                            }
                        }

                        // å€’åºæ‰¾æ—¶é—´
                        if(lastIdx >= 0) {
                            let val = parts[lastIdx];
                            if(/^(\d{1,2}:\d{2}|\d{4})$/.test(val)) {
                                if(val.length === 4 && !val.includes(':')) {
                                    time = val.substring(0,2) + ":" + val.substring(2);
                                } else {
                                    time = val;
                                }
                                parts.pop(); lastIdx--;
                            }
                        }

                        // æ­£åºæ‰¾æ ‡ç­¾
                        if(parts.length > 1) { 
                            let first = parts[0];
                            if(first.length <= 6 && !/^\d+$/.test(first)) {
                                tag = first;
                                parts.shift();
                            }
                        }

                        title = parts.join(' ');
                        currentDay.tasks.push({ title, tag, time, duration, desc });
                    }
                }
            });

            if(currentDay) newPlan.push(currentDay);
            
            if(newPlan.length > 0) {
                planData = newPlan;
                renderEditor();
                const btn = document.querySelector('button[onclick="parseAndFill()"]');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = `<i data-lucide="check" class="w-5 h-5"></i> è¯†åˆ«æˆåŠŸ`;
                btn.classList.add('bg-emerald-600', 'from-emerald-600', 'to-emerald-600');
                lucide.createIcons();
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('bg-emerald-600', 'from-emerald-600', 'to-emerald-600');
                    lucide.createIcons();
                }, 1500);
            }
        }

        // ============================================
        // 2. æ¸²æŸ“ UI
        // ============================================
        function renderEditor() {
            const container = document.getElementById('editor-container');
            container.innerHTML = '';

            if(planData.length === 0) {
                container.innerHTML = `<div class="text-center py-20 text-slate-500 border-2 border-dashed border-slate-800 rounded-2xl">æš‚æ— æ•°æ®</div>`;
                return;
            }

            planData.forEach((day, dIdx) => {
                const dayEl = document.createElement('div');
                dayEl.className = 'group animate-[fadeIn_0.3s_ease-out]';
                dayEl.innerHTML = `
                    <div class="flex items-center gap-3 mb-3">
                        <div class="h-px bg-white/10 flex-1"></div>
                        <span class="text-xs font-bold text-blue-400 bg-blue-500/10 px-3 py-1 rounded-full border border-blue-500/20">DAY ${dIdx + 1}</span>
                        <input type="date" value="${day.date}" onchange="updateDate(${dIdx}, this.value)" class="bg-transparent text-slate-400 text-sm font-mono focus:text-white outline-none border border-transparent focus:border-slate-700 rounded px-2">
                        <button onclick="removeDay(${dIdx})" class="text-slate-600 hover:text-red-400 p-1 hover:bg-white/5 rounded transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        <div class="h-px bg-white/10 flex-1"></div>
                    </div>
                    
                    <div class="space-y-3">
                        ${day.tasks.map((task, tIdx) => `
                            <div class="bg-slate-900/40 border border-white/5 rounded-xl p-3 hover:border-blue-500/30 transition-colors">
                                <div class="flex gap-2 mb-2">
                                    <input type="text" value="${task.tag}" onchange="updateTask(${dIdx}, ${tIdx}, 'tag', this.value)" 
                                        class="w-20 bg-blue-500/10 text-blue-300 text-xs text-center font-bold rounded border border-blue-500/20 focus:border-blue-500 outline-none placeholder-blue-900" placeholder="æ ‡ç­¾">
                                    <input type="text" value="${task.title}" onchange="updateTask(${dIdx}, ${tIdx}, 'title', this.value)" 
                                        class="flex-1 bg-transparent text-white font-bold text-sm border-b border-transparent focus:border-white/20 outline-none" placeholder="ä»»åŠ¡å†…å®¹">
                                    <button onclick="removeTask(${dIdx}, ${tIdx})" class="text-slate-600 hover:text-red-400 transition"><i data-lucide="x" class="w-4 h-4"></i></button>
                                </div>
                                <div class="flex gap-2 items-center">
                                    <div class="flex items-center gap-1 bg-black/20 px-2 py-1.5 rounded text-slate-400 border border-white/5 w-24">
                                        <i data-lucide="clock" class="w-3 h-3"></i>
                                        <input type="text" value="${task.time || ''}" onchange="updateTask(${dIdx}, ${tIdx}, 'time', this.value)" 
                                            class="bg-transparent w-full text-xs font-mono focus:text-white outline-none" placeholder="09:00">
                                    </div>
                                    <div class="flex items-center gap-1 bg-black/20 px-2 py-1.5 rounded text-slate-400 border border-white/5 w-20">
                                        <i data-lucide="hourglass" class="w-3 h-3"></i>
                                        <input type="number" value="${task.duration || ''}" onchange="updateTask(${dIdx}, ${tIdx}, 'duration', this.value)" 
                                            class="bg-transparent w-full text-xs font-mono focus:text-white outline-none" placeholder="min">
                                    </div>
                                    <input type="text" value="${task.desc || ''}" onchange="updateTask(${dIdx}, ${tIdx}, 'desc', this.value)" 
                                        class="flex-1 bg-transparent text-xs text-slate-500 focus:text-slate-300 border-b border-transparent focus:border-white/10 outline-none px-2 py-1" placeholder="æ·»åŠ å¤‡æ³¨/æè¿°...">
                                </div>
                            </div>
                        `).join('')}
                        
                        <button onclick="addTask(${dIdx})" class="w-full py-2 border border-dashed border-slate-700 hover:border-slate-500 rounded-lg text-slate-500 hover:text-slate-300 text-xs transition flex justify-center items-center gap-1">
                            <i data-lucide="plus" class="w-3 h-3"></i> æ·»åŠ ä»»åŠ¡
                        </button>
                    </div>
                `;
                container.appendChild(dayEl);
            });
            lucide.createIcons();
        }

        // ============================================
        // 3. æ•°æ®æ“ä½œ
        // ============================================
        function addDay() {
            const d = new Date(); d.setDate(d.getDate() + planData.length);
            planData.push({ date: d.toISOString().split('T')[0], tasks: [{ title: '', tag: 'æ—¥å¸¸', time: '', duration: null, desc: '' }] });
            renderEditor();
        }
        function removeDay(idx) { planData.splice(idx, 1); renderEditor(); }
        function addTask(dIdx) { planData[dIdx].tasks.push({ title: '', tag: 'æ—¥å¸¸', time: '', duration: null, desc: '' }); renderEditor(); }
        function removeTask(dIdx, tIdx) { planData[dIdx].tasks.splice(tIdx, 1); renderEditor(); }
        function updateDate(idx, val) { planData[idx].date = val; }
        function updateTask(dIdx, tIdx, field, val) { 
            if(field === 'duration') val = val ? parseInt(val) : null;
            planData[dIdx].tasks[tIdx][field] = val; 
        }
        function clearAll() { if(confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰å†…å®¹å—ï¼Ÿ')) { planData = []; document.getElementById('raw-input').value=''; renderEditor(); } }

        // ============================================
        // 4. ç”Ÿæˆæ–‡ä»¶ (æ ¸å¿ƒä¿®å¤éƒ¨åˆ†)
        // ============================================
        function selectTheme(t) {
            currentTheme = t;
            // ä¿®å¤ï¼šç¡®ä¿æ‰€æœ‰æŒ‰é’®çŠ¶æ€è¢«é‡ç½®
            document.querySelectorAll('.theme-btn').forEach(b => {
                b.classList.remove('active'); 
            });
            
            // ä¿®å¤ï¼šå¤„ç† Cyberpunk çš„ ID æ˜ å°„é—®é¢˜
            // ä¼ å…¥ 'cyberpunk' -> ID 'btn-cyberpunk'
            let btnId = 'btn-' + t;
            const btn = document.getElementById(btnId);
            if(btn) {
                btn.classList.add('active');
            } else {
                console.error("Button ID not found:", btnId);
            }
        }

        async function generateFile() {
            if(planData.length === 0) { alert('è¯·å…ˆè¾“å…¥è®¡åˆ’å†…å®¹ï¼'); return; }
            
            const title = document.getElementById('plan-title').value || 'My Plan';
            const planId = currentTheme + '_' + Date.now();
            const btn = document.querySelector('button[onclick="generateFile()"]');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> å¤„ç†ä¸­...`;
            lucide.createIcons();

            try {
                // 1. è¯»å–æ¨¡æ¿ (æ·»åŠ é”™è¯¯å¤„ç†)
                let templateStr = '';
                let rulesContent = '';

                try {
                    const templateResponse = await fetch(`template_${currentTheme}.html`);
                    if (!templateResponse.ok) throw new Error(`æ— æ³•æ‰¾åˆ° template_${currentTheme}.html`);
                    templateStr = await templateResponse.text();
                } catch (e) {
                    throw new Error(`è¯»å–æ¨¡æ¿å¤±è´¥: ${e.message}\nè¯·ç¡®ä¿æ–‡ä»¶åœ¨åŒä¸€ç›®å½•ï¼Œå¹¶ä½¿ç”¨ Live Server æ‰“å¼€ã€‚`);
                }

                // 2. ä¿®å¤ï¼šè¯»å– rules_db.js å¹¶å†…åµŒ (è§£å†³ç©ºå£³é—®é¢˜)
                try {
                    const rulesResponse = await fetch(`rules_db.js`);
                    if (rulesResponse.ok) {
                        rulesContent = await rulesResponse.text();
                    } else {
                        console.warn("rules_db.js è¯»å–å¤±è´¥ï¼Œç”Ÿæˆçš„é¡µé¢å¯èƒ½ç¼ºå°‘AIæ ‡ç­¾åŠŸèƒ½");
                    }
                } catch (e) {
                    console.warn("æ— æ³•è¯»å– rules_db.js");
                }

                // 3. æ•°æ®æ¸…æ´—
                const cleanData = planData.map((d, i) => ({
                    date: d.date,
                    dayNum: i + 1,
                    tasks: d.tasks.filter(t => t.title.trim()).map(t => ({
                        title: t.title,
                        tag: t.tag,
                        desc: t.desc || '',
                        time: t.time || '',
                        duration: t.duration
                    }))
                })).filter(d => d.tasks.length > 0);

                if(cleanData.length === 0) throw new Error("æœ‰æ•ˆæ•°æ®ä¸ºç©º");

                const dataJson = JSON.stringify(cleanData)
                    .replace(/\\/g, '\\\\').replace(/'/g, '\\\'').replace(/</g, '\\u003c');

                // 4. æ›¿æ¢å†…å®¹
                let finalHtml = templateStr
                    .replace(/{{TASKS_DATA}}/g, dataJson)
                    .replace(/{{PLAN_TITLE}}/g, title)
                    .replace(/{{PLAN_ID}}/g, planId)
                    .replace(/{{BODY_CLASS}}/g, '');

                // 5. å…³é”®ä¿®å¤ï¼šå†…åµŒ rules_db.js
                if (rulesContent) {
                    finalHtml = finalHtml.replace('<script src="rules_db.js"><\/script>', `<script>${rulesContent}<\/script>`);
                }

                // 6. ä¸‹è½½
                const blob = new Blob([finalHtml], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${title}_${currentTheme}.html`;
                a.click();
                
                btn.innerHTML = `<i data-lucide="check" class="w-5 h-5"></i> æˆåŠŸ`;
                setTimeout(() => { btn.innerHTML = originalText; lucide.createIcons(); }, 2000);

            } catch(e) {
                console.error(e);
                alert(`ç”Ÿæˆå¤±è´¥ï¼š\n${e.message}\n\næ³¨æ„ï¼šç›´æ¥åŒå‡»æ‰“å¼€å¯èƒ½å¯¼è‡´æµè§ˆå™¨å®‰å…¨æ‹¦æˆªã€‚è¯·ä½¿ç”¨ VSCode å³é”® -> 'Open with Live Server'ã€‚`);
                btn.innerHTML = originalText;
                lucide.createIcons();
            }
        }

        function downloadJson() {
            const blob = new Blob([JSON.stringify(planData, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'deepflow_data_backup.json';
            a.click();
        }
    </script>
</body>
</html>