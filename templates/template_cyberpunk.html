<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <script src="https://deepflow-hellojyh-audio.oss-cn-hangzhou.aliyuncs.com/libs/tailwind.js"></script>
    <script src="https://deepflow-hellojyh-audio.oss-cn-hangzhou.aliyuncs.com/libs/confetti.min.js"></script>
    <script src="https://deepflow-hellojyh-audio.oss-cn-hangzhou.aliyuncs.com/libs/lucide.min.js"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json"> 
    <meta name="theme-color" content="#020617"> 

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="DeepFlow">

    <link rel="apple-touch-icon" href="icon-192.png">
    <title>DeepFlow 系统终端</title>

<style>
/* 2. [修正] 赛博字体栈：无 Google Fonts，秒开且硬核 */
:root { 
    --font-display: "Impact", "Arial Black", "Heiti SC", "SimHei", sans-serif; 
    --font-mono: "Consolas", "Monaco", "Menlo", "Courier New", monospace; 
    --font-tech: "Segoe UI", "Roboto", "Helvetica Neue", "Microsoft YaHei", sans-serif; 
    --active-color: #00f3ff; 
    --secondary-color: #ff00ff; 
}

/* 强制覆盖 Tailwind 字体类 */
.font-\[\'Orbitron\'\] { font-family: var(--font-display) !important; letter-spacing: 1px; }
.font-\[\'Share_Tech_Mono\'\] { font-family: var(--font-mono) !important; }
.font-\[\'JetBrains_Mono\'\] { font-family: var(--font-mono) !important; }
.font-\[\'Rajdhani\'\] { font-family: var(--font-tech) !important; text-transform: uppercase; }

/* 基础设置 */
body { margin: 0; padding: 0; overflow: hidden; background: #000; height: 100vh; width: 100vw; user-select: none; font-family: var(--font-tech); }
.hidden-core { display: none !important; }
.no-scrollbar::-webkit-scrollbar { display: none; }
body.theme-b { --active-color: #00fff9; --secondary-color: #9600ff; }

/* 3. [新增] 战术下拉菜单样式 (手机端专属) */
.cyber-select-wrapper {
    position: relative;
    border: 1px solid var(--active-color);
    background: rgba(0, 20, 40, 0.9);
    clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
    box-shadow: 0 0 10px rgba(0, 243, 255, 0.2);
}
.cyber-select {
    width: 100%;
    background: transparent;
    color: var(--active-color);
    font-family: var(--font-mono);
    font-weight: bold;
    border: none;
    padding: 10px 40px 10px 15px;
    appearance: none;
    outline: none;
    text-transform: uppercase;
}
.cyber-select-icon {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--active-color);
    pointer-events: none;
}

/* 噪点层 */
#noise-layer {
position: fixed; inset: 0; pointer-events: none; z-index: 8000; opacity: 0.03;
background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
}

/* 底部切换台 */
#system-control-deck {
position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
z-index: 9000; display: flex; justify-content: center;
padding-bottom: 10px; pointer-events: none;
}
.cyber-lever-btn {
pointer-events: auto;
background: rgba(10, 15, 20, 0.95); border: 1px solid #444; color: #888;
padding: 12px 36px; font-family: var(--font-display); font-weight: bold; font-size: 12px;
cursor: pointer; display: flex; align-items: center; gap: 10px;
clip-path: polygon(15px 0, 100% 0, 100% 100%, 0 100%, 0 15px);
transition: all 0.3s; box-shadow: 0 -5px 30px rgba(0,0,0,0.8);
text-transform: uppercase; letter-spacing: 2px; border-top: 3px solid var(--active-color);
}
.cyber-lever-btn:hover { color: #fff; box-shadow: 0 -5px 40px var(--active-color); text-shadow: 0 0 8px var(--active-color); }

/* 悬浮番茄钟 */
#globalDockWrapper { position: fixed; bottom: 100px; right: 40px; z-index: 10000; transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
#dockOrb {
width: 72px; height: 72px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
cursor: pointer; position: relative; z-index: 10001; transition: transform 0.2s;
background: rgba(5, 5, 10, 0.9); border: 2px solid var(--active-color);
box-shadow: 0 0 25px var(--active-color), inset 0 0 10px var(--active-color);
}
#dockOrb:hover { transform: scale(1.1); box-shadow: 0 0 40px var(--active-color); }
#dockOrb:active { transform: scale(0.95); }
.reactor-spin { animation: spin 10s linear infinite; transform-origin: center; }
.reactor-pulse { animation: pulse-light 2s ease-in-out infinite; }
@keyframes spin { 100% { transform: rotate(360deg); } }
@keyframes pulse-light { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
#dockTooltip {
position: absolute; right: 80px; top: 50%; transform: translateY(-50%) translateX(10px);
background: rgba(29, 29, 31, 0.9); color: white; padding: 8px 14px;
border-radius: 6px; font-size: 12px; font-weight: 700; white-space: nowrap; pointer-events: none; opacity: 0;
transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 4px 20px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 6px;
border: 1px solid var(--active-color);
}
#dockTooltip.show { opacity: 1; transform: translateY(-50%) translateX(0); }
#dockTooltip::after { content: ''; position: absolute; right: -5px; top: 50%; transform: translateY(-50%); border-width: 5px 0 5px 6px; border-color: transparent transparent transparent rgba(29, 29, 31, 0.9); border: 1px solid var(--active-color);}
#dockPanel {
position: absolute; width: 300px;
background: rgba(8, 8, 12, 0.98); border: 2px solid var(--active-color);
padding: 20px;
display: none; opacity: 0; transform: scale(0.9); transition: all 0.2s;
box-shadow: 0 0 50px rgba(0,0,0,0.9); z-index: 10002;
}
#dockPanel.open { display: block; opacity: 1; transform: scale(1); }

/* 沉浸模式 */
#immersiveLayer {
position: fixed; inset: 0; z-index: 99999; background: #000;
display: none; flex-direction: column; align-items: center; justify-content: center;
opacity: 0; transition: opacity 0.5s;
}
#immersiveLayer.active { display: flex; opacity: 1; }
.imm-controls { position: relative; z-index: 100000; display: flex; gap: 40px; margin-top: 60px; }
.imm-btn { width: 80px; height: 80px; border-radius: 50%; border: 2px solid #fff; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.6); cursor: pointer; transition: 0.2s; pointer-events: auto; }
.imm-btn:hover { transform: scale(1.15); background: #fff; color: #000; box-shadow: 0 0 30px #fff; }
.imm-btn.danger { border-color: #ff2a2a; color: #ff2a2a; }
.imm-btn.danger:hover { background: #ff2a2a; color: #000; box-shadow: 0 0 30px #ff2a2a; }

/* THEME A: QUANTUM HIVE */
#core_A {
--a-bg: #020408; --a-panel: rgba(5, 15, 30, 0.85); --a-accent: #00f3ff;
color: #fff; background-color: var(--a-bg);
height: 100vh; width: 100vw; display: flex; flex-direction: column; position: relative;
overflow: hidden;
}
#core_A .aurora-bg {
position: absolute; inset: -50%; z-index: -3; opacity: 0.4;
background: radial-gradient(circle at 20% 50%, #001f3f 0%, transparent 50%),
radial-gradient(circle at 80% 30%, #003366 0%, transparent 50%);
filter: blur(60px); animation: aurora-flow 20s ease-in-out infinite alternate;
}
@keyframes aurora-flow { 0% { transform: scale(1) rotate(0deg); } 100% { transform: scale(1.1) rotate(5deg); } }
#core_A .hex-grid {
position: absolute; inset: 0; z-index: -2;
background-image: url("data:image/svg+xml,%3Csvg width='60' height='104' viewBox='0 0 60 104' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 0l30 17.3v34.6L30 69.2 0 51.9V17.3zM30 104l30-17.3V52L30 34.6 0 52v34.7z' fill='none' stroke='%2300f3ff' stroke-opacity='0.08' stroke-width='1'/%3E%3C/svg%3E");
background-size: 60px 104px;
mask-image: radial-gradient(circle at center, black 40%, transparent 90%);
}
.hex-pulse {
position: absolute; width: 60px; height: 60px;
background: rgba(0, 243, 255, 0.1);
clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
animation: pulse-hex 4s infinite;
}
@keyframes pulse-hex { 0%,100% { opacity: 0; } 50% { opacity: 1; box-shadow: 0 0 20px rgba(0,243,255,0.4); } }
.radar-sweep {
position: absolute; inset: -50%; width: 200%; height: 200%;
background: conic-gradient(from 0deg at 50% 50%, transparent 0deg, rgba(0, 243, 255, 0.05) 60deg, transparent 60deg);
animation: radar-spin 10s linear infinite; z-index: -1; pointer-events: none;
}
@keyframes radar-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
#core_A .a-card {
background: linear-gradient(135deg, rgba(10,20,35,0.9) 0%, rgba(5,10,20,0.95) 100%);
border: 1px solid rgba(0, 243, 255, 0.2);
box-shadow: 0 10px 40px rgba(0,0,0,0.6);
backdrop-filter: blur(10px); position: relative;
clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
}
#core_A .a-card::before { content: ''; position: absolute; top: 0; left: 0; width: 20px; height: 20px; border-top: 2px solid var(--a-accent); border-left: 2px solid var(--a-accent); }
#core_A .a-card::after { content: ''; position: absolute; bottom: 0; right: 0; width: 20px; height: 20px; border-bottom: 2px solid var(--a-accent); border-right: 2px solid var(--a-accent); }
#core_A .nav-item {
padding: 12px 16px; margin-bottom: 4px; cursor: pointer;
font-family: var(--font-mono); font-size: 14px;
color: #64748b; border-right: 2px solid transparent; border-left: 2px solid transparent;
transition: all 0.3s; display: flex; align-items: center; justify-content: space-between;
}
#core_A .nav-item:hover { color: #94a3b8; background: rgba(255,255,255,0.02); }
#core_A .nav-item.active {
color: var(--a-accent); background: linear-gradient(90deg, transparent, rgba(0, 243, 255, 0.05));
border-right-color: var(--a-accent); text-shadow: 0 0 8px rgba(0,243,255,0.5);
}
#core_A .nav-item.completed-day {
color: #fff; text-shadow: 0 0 5px var(--a-accent);
border-left-color: var(--a-accent); background: linear-gradient(90deg, rgba(0,243,255,0.1), transparent);
}
.task-data-line { font-family: var(--font-mono); font-size: 10px; color: #555; display: flex; gap: 12px; margin-bottom: 4px; text-transform: uppercase; }
#core_A .task-row {
position: relative; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05);
padding: 16px; margin-bottom: 12px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
display: flex; gap: 16px; align-items: center;
}
#core_A .task-row:hover {
background: rgba(0, 243, 255, 0.05); border-color: rgba(0, 243, 255, 0.3);
transform: translateX(4px); box-shadow: -4px 0 10px rgba(0, 243, 255, 0.1);
}
#core_A .task-row::before {
content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 2px;
background: var(--a-accent); transform: scaleY(0); transition: transform 0.2s;
}
#core_A .task-row:hover::before { transform: scaleY(1); }
#core_A .task-row.checked { opacity: 0.5; filter: grayscale(1); border-color: transparent; }
#core_A .task-row.checked h4 { text-decoration: line-through; color: #555; }
.a-checkbox-container { position: static; }
.a-checkbox { width: 20px; height: 20px; border: 1px solid #555; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; transition: 0.2s; flex-shrink: 0; }
.task-row:hover .a-checkbox { border-color: var(--a-accent); box-shadow: 0 0 5px var(--a-accent); }
.energy-cells { display: flex; gap: 4px; height: 12px; width: 100%; margin-top: 8px; }
.energy-cell { flex: 1; background: #1a2530; transform: skewX(-20deg); transition: 0.3s; }
.energy-cell.active { background: var(--a-accent); box-shadow: 0 0 8px var(--a-accent); }
.text-glow { text-shadow: 0 0 10px var(--a-accent); }

/* THEME B: CYBER DECK */
#core_B {
font-family: var(--font-tech); background-color: #050508; color: #00fff9;
height: 100vh; width: 100vw; overflow: hidden; display: flex; position: relative;
}
#core_B .b-grid-flow {
position: absolute; inset: -100%; width: 300%; height: 300%; z-index: 0; pointer-events: none;
opacity: 0.6;
background-image:
linear-gradient(rgba(160, 0, 255, 0.5) 1px, transparent 1px),
linear-gradient(90deg, rgba(160, 0, 255, 0.5) 1px, transparent 1px);
background-size: 60px 60px;
transform: perspective(800px) rotateX(70deg);
animation: grid-down 2s linear infinite;
}
@keyframes grid-down { 0% { transform: perspective(800px) rotateX(70deg) translateY(0); } 100% { transform: perspective(800px) rotateX(70deg) translateY(60px); } }
.b-sidebar { width: 320px; flex-shrink: 0; height: 100%; background: rgba(8, 5, 15, 0.98); border-right: 2px solid #9600ff; padding: 30px; padding-top: 60px; z-index: 20; display: flex; flex-direction: column; }
.b-main { flex: 1; height: 100%; overflow-y: auto; padding: 40px; z-index: 10; background: radial-gradient(circle, transparent 50%, #000 100%); }
.heatmap-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-top: 15px; }
.heatmap-cell { aspect-ratio: 1; background: #15151e; border: 1px solid #333; cursor: pointer; transition: 0.1s; position: relative; }
.heatmap-cell:hover { transform: scale(1.2); z-index: 10; box-shadow: 0 0 10px #fff; border-color: #fff; }
.heatmap-cell.active { border-color: #fff; }
.heatmap-cell.current { border: 2px solid #fff; animation: blink-border 1.5s infinite; }
@keyframes blink-border { 50% { border-color: transparent; } }
.heatmap-nav { display: flex; justify-content: space-between; margin-top: 10px; font-family: var(--font-mono); font-size: 10px; color: #888; }
.heatmap-btn { cursor: pointer; transition: 0.2s; }
.heatmap-btn:hover { color: #fff; text-shadow: 0 0 5px #fff; }
.b-task-data-line { font-family: var(--font-mono); font-size: 11px; color: #00fff9; display: flex; gap: 16px; margin-bottom: 4px; align-items: center; }
#core_B .b-task-item {
background: rgba(13, 20, 26, 0.7); backdrop-filter: blur(5px);
border: 1px solid rgba(0, 255, 249, 0.1); border-left: 4px solid #00fff9;
padding: 20px; margin-bottom: 16px; display: flex; gap: 20px; align-items: center;
cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative;
box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}
#core_B .b-task-item:hover {
border-color: rgba(0, 255, 249, 0.6); background: rgba(0, 255, 249, 0.05);
transform: translateX(4px) scale(1.005); box-shadow: 0 0 25px rgba(0, 255, 249, 0.1);
}
#core_B .b-task-item.checked { opacity: 0.5; filter: grayscale(1); border-left-color: #444; background: rgba(0,0,0,0.4); }
#core_B .b-task-item h4 { color: #fff; text-shadow: 0 0 5px rgba(0,0,0,0.5); font-family: var(--font-tech); letter-spacing: 1px; }
#core_B .b-task-item.checked h4 { text-decoration: line-through; color: #666; }

/* 终极加载层 */
#loader-layer { position: fixed; inset: 0; z-index: 60000; background: #000; display: none; align-items: center; justify-content: center; overflow: hidden; }
#loader-layer.show { display: flex; }
.loader-mode-a { position: absolute; inset: 0; background: #000508; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.iris-aperture { width: 200px; height: 200px; border: 2px solid rgba(0, 243, 255, 0.3); border-radius: 50%; position: relative; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 30px rgba(0, 243, 255, 0.1); }
.iris-blade { position: absolute; width: 100%; height: 100%; border: 1px solid #00f3ff; border-radius: 50%; border-top-color: transparent; border-bottom-color: transparent; animation: iris-spin 2s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite; }
.iris-center { width: 10px; height: 10px; background: #00f3ff; border-radius: 50%; box-shadow: 0 0 20px #00f3ff; animation: pulse-light 0.5s infinite alternate; }
.iris-scan-line { position: absolute; width: 100%; height: 2px; background: #00f3ff; top: 0; animation: scan-down 1.5s ease-in-out infinite; opacity: 0.5; box-shadow: 0 0 10px #00f3ff; }
.iris-text { margin-top: 30px; font-family: var(--font-display); color: #00f3ff; letter-spacing: 5px; font-size: 14px; text-shadow: 0 0 10px #00f3ff; }
@keyframes iris-spin { 0% { transform: rotate(0deg) scale(0.8); } 50% { transform: rotate(180deg) scale(1.1); } 100% { transform: rotate(360deg) scale(0.8); } }
@keyframes scan-down { 0% { top: 0%; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
.loader-mode-b-neural { position: absolute; inset: 0; background: radial-gradient(circle, #0a0514 0%, #000 90%); display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; perspective: 1000px; }
.neural-hex { position: relative; width: 140px; height: 160px; background: rgba(10, 0, 20, 0.8); clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); display: flex; align-items: center; justify-content: center; box-shadow: 0 0 30px rgba(150, 0, 255, 0.1); animation: hex-breath 3s ease-in-out infinite; z-index: 10; }
.neural-hex::before { content: ''; position: absolute; inset: 4px; clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); border: 2px solid #9600ff; opacity: 0.6; }
.neural-hex-inner { width: 80px; height: 92px; background: #9600ff; clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); opacity: 0.2; animation: inner-pulse 0.5s infinite alternate; }
.neural-text { margin-top: 40px; font-family: var(--font-tech); font-weight: 700; color: #b026ff; font-size: 20px; letter-spacing: 4px; text-transform: uppercase; z-index: 10; text-shadow: 0 0 10px rgba(176, 38, 255, 0.5); }
.neural-sub { margin-top: 5px; font-family: var(--font-mono); color: #008b8b; font-size: 12px; opacity: 0.7; z-index: 10; }
.scan-beam { position: absolute; width: 100%; height: 4px; background: #9600ff; box-shadow: 0 0 20px #9600ff; opacity: 0.3; top: 0; animation: soft-scan 2s ease-in-out infinite; z-index: 5; }
@keyframes hex-breath { 0%, 100% { transform: scale(1); box-shadow: 0 0 30px rgba(150, 0, 255, 0.1); } 50% { transform: scale(1.05); box-shadow: 0 0 50px rgba(150, 0, 255, 0.3); } }
@keyframes inner-pulse { from { opacity: 0.1; } to { opacity: 0.4; } }
@keyframes soft-scan { 0% { top: -10%; opacity: 0; } 20% { opacity: 0.5; } 80% { opacity: 0.5; } 100% { top: 110%; opacity: 0; } }
.modal-overlay { position: fixed; inset: 0; z-index: 30000; background: rgba(0,0,0,0.95); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; }
.modal-overlay.show { display: flex; }
.modal-box { width: 450px; border: 2px solid var(--active-color); background: #050508; padding: 30px; box-shadow: 0 0 60px rgba(0,0,0,0.8); }
.modal-input { width: 100%; background: rgba(255,255,255,0.1); border: 1px solid #555; color: white; padding: 10px; font-family: var(--font-mono); outline: none; margin-top: 10px; }
.modal-input:focus { border-color: var(--active-color); }
.modal-btn { background: transparent; border: 1px solid var(--active-color); color: var(--active-color); padding: 8px 20px; font-family: var(--font-display); cursor: pointer; margin: 0 10px; transition: 0.2s; }
.modal-btn:hover { background: var(--active-color); color: #000; box-shadow: 0 0 15px var(--active-color); }
#holo-toast {position: fixed; top: 40px; left: 50%; transform: translateX(-50%) translateY(-100px); 
    background: rgba(0, 5, 10, 0.95); 
    border: 1px solid var(--active-color); 
    border-left: 4px solid var(--active-color); /* 左侧加粗强调 */
    color: #fff; 
    padding: 10px 30px; 
    font-family: var(--font-mono); 
    font-size: 12px;
    font-weight: bold;
    letter-spacing: 1px;
    z-index: 100001; 
    transition: 0.4s cubic-bezier(0.22, 1, 0.36, 1); 
    opacity: 0; 
    box-shadow: 0 0 20px rgba(0, 243, 255, 0.15), inset 0 0 10px rgba(0, 243, 255, 0.05); 
    text-transform: uppercase;
    white-space: nowrap;
    clip-path: polygon(0 0, 100% 0, 100% 80%, 95% 100%, 0 100%); /* 切角设计 */
}
#holo-toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
/* 添加一个微小的扫描线动画 */
#holo-toast::after {
    content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
    background: var(--active-color); opacity: 0.5;
    animation: scan-toast 2s infinite linear;
}
@keyframes scan-toast { 0% {top:0;} 100% {top:100%;} }
#holo-toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
/* --- Cyber Theme Noise UI --- */
#noiseOrb {
    background: rgba(0, 10, 15, 0.9);
    border: 1px solid var(--active-color);
    box-shadow: 0 0 15px var(--active-color);
    color: var(--active-color);
}
#noisePanel {
    background: rgba(5, 5, 10, 0.95);
    border: 1px solid var(--active-color);
    box-shadow: 0 0 30px rgba(0,0,0,0.8);
    color: #fff;
    clip-path: polygon(0 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%);
    transform: scale(0.9);
}
.noise-card {
    height: 40px;
    border: 1px solid rgba(0, 243, 255, 0.2);
    background: rgba(0,0,0,0.3);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: all 0.2s;
    color: #aaa;
}
.noise-card:hover { border-color: var(--active-color); color: #fff; box-shadow: inset 0 0 10px rgba(0,243,255,0.2); }
.noise-card.active {
    background: var(--active-color); color: #000; box-shadow: 0 0 15px var(--active-color); font-weight: bold;
}
#noiseRipple { background-color: var(--active-color); }
/* === [Cyber CSS 新增] === */
#noiseOrb {
    background: rgba(0, 10, 15, 0.9); border: 1px solid var(--active-color);
    box-shadow: 0 0 15px var(--active-color); color: var(--active-color); overflow: visible !important;
}
/* 能量环动画 */
.cyber-ring {
    position: absolute; inset: -4px; border: 1px dashed var(--active-color);
    border-radius: 50%; opacity: 0; pointer-events: none; transition: 0.3s;
}
#noiseOrb.is-playing .cyber-ring-1 {
    animation: cyber-spin 3s linear infinite; inset: -5px; border-width: 2px; opacity: 1;
}
#noiseOrb.is-playing .cyber-ring-2 {
    animation: cyber-spin-rev 5s linear infinite; inset: -10px; border-style: dotted; opacity: 0.5;
}
@keyframes cyber-spin { 100% { transform: rotate(360deg); } }
@keyframes cyber-spin-rev { 100% { transform: rotate(-360deg); } }

/* 停止按钮 (高亮对勾) */
.stop-active {
    background: var(--active-color) !important; color: #000 !important;
    box-shadow: 0 0 10px var(--active-color); opacity: 1 !important; font-weight: 900;
}
/* 赛博角标 */
.variant-badge {
    position: absolute; top: -5px; right: -5px; width: 14px; height: 14px;
    background: var(--active-color); color: #000; font-weight: bold;
    font-size: 9px; display: flex; align-items: center; justify-content: center;
    clip-path: polygon(20% 0, 100% 0, 100% 80%, 80% 100%, 0 100%, 0 20%);
}
</style>
</head>
<body class="theme-a">
<div id="noise-layer"></div>
<div id="holo-toast">SYSTEM MESSAGE</div>
<div id="loader-layer"></div>
<div id="system-control-deck">
<button onclick="switchArchitecture()" class="cyber-lever-btn">
<i data-lucide="refresh-cw" class="w-4 h-4"></i>
<span>切换构型 / SWITCH</span>
</button>
</div>
<div id="globalDockWrapper">
<div id="dockTooltip" class="show"><span>番茄钟   </span><i data-lucide="crosshair" class="w-4 h-4 text-white"></i></div>
<div id="dockOrb">
<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="reactor-spin">
<circle cx="12" cy="12" r="10"></circle>
<path d="m4.93 4.93 14.14 14.14M19.07 4.93 4.93 19.07"></path>
<circle cx="12" cy="12" r="4" fill="white" class="reactor-pulse"></circle>
</svg>
</div>
<div id="dockPanel">
<div class="text-center text-white">
<div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
    <span class="text-[10px] font-bold uppercase tracking-widest opacity-80">专注引擎</span>
    <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
</div>
<div id="dockTime" class="text-5xl font-['Orbitron'] font-bold mb-4 cursor-pointer hover:text-cyan-300" onclick="showTimeInput()">25:00</div>
<div class="flex justify-center gap-4 text-xs font-mono text-gray-500 mb-4">
<span class="cursor-pointer hover:text-white" onclick="adjTime(-5)">[-5分]</span>
<span class="cursor-pointer hover:text-white" onclick="adjTime(5)">[+5分]</span>
</div>
<div id="timeInputRow" style="display:none; margin-bottom:10px; justify-content:center;">
<input type="text" id="customTimeInput" class="bg-transparent border-b border-white text-center text-white w-20 outline-none font-mono" placeholder="25">
<button onclick="submitTime()" class="text-xs border px-2 ml-2 hover:bg-white hover:text-black">确认</button>
</div>
<button id="timerBtn" onclick="toggleTimer()" class="w-full py-3 border border-white font-bold hover:bg-white hover:text-black transition">启动任务 (START)</button>
<button onclick="enterImmersive()" class="w-full py-2 mt-2 text-xs text-gray-500 hover:text-white font-bold">>> 沉浸模式 <<</button>
</div>
</div>
</div>
<div id="immersiveLayer">
<div id="immMatrix" style="position:absolute; inset:0; z-index:-1; opacity:0.4;"></div>
<div class="relative z-10 text-center pointer-events-none">
<div class="text-xl font-black tracking-[0.5em] text-white mb-8 animate-pulse font-['Orbitron']">NEURAL LINK ACTIVE</div>
<div id="immTime" class="text-[150px] font-['Orbitron'] font-bold text-white leading-none" style="text-shadow:0 0 50px var(--active-color)">25:00</div>
</div>
<div class="imm-controls">
<button id="immPlayBtn" class="imm-btn" onclick="toggleTimer()">
<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
</button>
<button class="imm-btn danger" onclick="exitImmersive()">
<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#ff2a2a" stroke-width="2"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><line x1="12" y1="2" x2="12" y2="12"/></svg>
</button>
</div>
</div>
<div id="core_A" class="active" style="position:absolute; inset:0; z-index:10;">
<div class="aurora-bg"></div>
<div class="hex-grid"></div>
<div class="radar-sweep"></div>
<div class="hex-pulse" style="top:20%; left:10%"></div>
<div class="hex-pulse" style="top:60%; left:80%; animation-delay:1s"></div>
<div class="hex-pulse" style="top:80%; left:30%; animation-delay:2.5s"></div>
<header class="flex justify-between items-start p-6 z-20">
<div class="flex items-center gap-5 cursor-pointer group" onclick="openRenameModal()">
<div class="relative w-12 h-12 flex items-center justify-center border border-cyan-500/30 bg-black/40 skew-x-[-10deg]">
<i data-lucide="aperture" class="text-cyan-400 w-6 h-6 animate-[spin_10s_linear_infinite]"></i>
</div>
<div>
<div class="text-[10px] text-cyan-600 tracking-[0.4em] font-black mb-1 font-['Orbitron']">操作系统 (OS)</div>
<div class="flex items-center gap-3">
<h1 id="title_A" class="text-4xl text-white font-black font-['Orbitron'] tracking-wide text-glow">系统初始化...</h1>
<i data-lucide="edit-3" class="w-4 h-4 text-cyan-400 opacity-0 group-hover:opacity-100 transition"></i>
</div>
</div>
</div>
<div class="flex flex-col items-end gap-2">
<div class="flex items-center gap-4">
<button onclick="openResetModal()" class="text-[10px] text-red-500 hover:text-red-400 font-mono tracking-wider border-b border-red-900 pb-1">重置协议 (RESET)</button>
<div class="text-right pl-4 border-l border-cyan-900/50">
<div class="text-[10px] text-gray-500 font-mono">同步率 (SYNC)</div>
<div class="text-2xl font-['Orbitron'] text-cyan-400 font-bold" id="sync_A">0%</div>
</div>
</div>
</div>
</header>
<div class="flex flex-1 overflow-hidden px-8 pb-8 gap-8 z-10">
<aside class="hidden md:flex flex-col w-64 a-card p-4 overflow-y-auto no-scrollbar">
<div class="text-[10px] text-cyan-800 font-black tracking-widest mb-4 pl-2 font-['Orbitron']">时间轴导航</div>
<div id="sidebar_A" class="space-y-1"></div>
</aside>
<main class="flex-1 overflow-y-auto no-scrollbar relative">
<div class="md:hidden mb-6 px-1">
    <div class="cyber-select-wrapper">
        <select id="mobileDateSelect" 
            onchange="gotoDay(parseInt(this.value))" 
            class="cyber-select">
        </select>
        <i data-lucide="chevron-down" class="cyber-select-icon w-4 h-4"></i>
    </div>
</div>

<div class="max-w-5xl mx-auto pb-32">
<div class="a-card p-8 mb-6 flex flex-col md:flex-row justify-between items-center relative overflow-hidden group">
<div class="absolute right-0 top-0 w-64 h-full bg-gradient-to-l from-cyan-900/10 to-transparent pointer-events-none"></div>
<div class="relative z-10 w-full md:w-auto">
<div class="flex items-center gap-3 mb-2">
<span class="bg-cyan-500/10 text-cyan-400 border border-cyan-500/30 px-2 py-0.5 text-[10px] font-mono font-bold">扇区 <span id="dayNum_A">01</span></span>
<div class="h-px flex-1 bg-cyan-900/50"></div>
</div>
<h2 id="dateStr_A" class="text-5xl font-['Orbitron'] font-bold text-white tracking-tight mb-4">--</h2>
<div class="w-full md:w-80">
<div class="flex justify-between text-[10px] text-gray-400 font-mono mb-1">
<span>能量产出</span>
<span id="progressText_A" class="text-cyan-400">0/0</span>
</div>
<div class="energy-cells" id="energy_bar_A"></div>
</div>
</div>
<div id="stamp_A" class="opacity-10 grayscale mt-6 md:mt-0 transition-all duration-700 transform scale-95">
<i data-lucide="hexagon" class="w-32 h-32 text-cyan-400 stroke-[0.5]"></i>
<div class="absolute inset-0 flex items-center justify-center font-['Orbitron'] text-xs text-cyan-400 font-bold tracking-widest mt-1">任务完成</div>
</div>
</div>
<div id="list_A" class="space-y-2"></div>
</div>
</main>
</div>
</div>
<div id="core_B" class="hidden-core">
<div class="b-grid-flow"></div>
<aside class="b-sidebar">
<h2 class="text-xl font-bold mb-8 text-yellow-300 tracking-widest font-['Rajdhani'] border-b-2 border-purple-500/50 pb-4">系统监控 V4.5</h2>
<div class="space-y-6 opacity-90 text-sm font-['Share_Tech_Mono']">
<div class="flex justify-between border-b border-purple-900 pb-2"><span>运行状态:</span> <span class="text-cyan-400">正常</span></div>
<div class="flex justify-between border-b border-purple-900 pb-2"><span>内存占用:</span> <span class="text-pink-500" id="ram_B">--</span></div>
<div class="flex justify-between border-b border-purple-900 pb-2"><span>网络连接:</span> <span class="text-cyan-400">已连接</span></div>
</div>
<div class="mt-8">
<div class="text-xs text-gray-500 mb-2 font-bold">数据热力图 (28天)</div>
<div class="heatmap-grid" id="heatmap_B"></div>
<div class="heatmap-nav">
<span class="heatmap-btn hover:text-cyan-400" onclick="heatmapPage(-1)">< 上一页</span>
<span id="heatmap_page">第 1 页</span>
<span class="heatmap-btn hover:text-cyan-400" onclick="heatmapPage(1)">下一页 ></span>
</div>
</div>
<div class="mt-auto h-32 overflow-hidden border-t-2 border-purple-900 pt-2 text-[10px] text-green-500 font-mono opacity-70 bg-black/50 p-2" id="sys_log_B"></div>
</aside>
<main class="b-main">
<header class="flex justify-between items-end mb-8 border-b-2 border-purple-900 pb-4">
<div>
<div class="text-xs text-purple-400 mb-1 font-mono">> 终端接入 (TERMINAL_ACCESS)</div>
<div class="flex items-center gap-4 cursor-pointer group" onclick="openRenameModal()">
<h1 id="title_B" class="text-6xl font-['Rajdhani'] font-bold text-white tracking-tighter shadow-pink-500">初始化中...</h1>
<i data-lucide="wrench" class="w-5 h-5 text-purple-500 opacity-50 group-hover:opacity-100"></i>
</div>
</div>
<div class="text-right"><div class="text-xs text-gray-500">当前周期</div><div id="dateStr_B" class="text-3xl text-yellow-300 font-bold">--</div></div>
</header>
<div class="mb-8">
<div class="flex justify-between text-xs text-cyan-400 font-mono mb-1"><span>同步状态</span><span id="sync_B">0%</span></div>
<div class="h-4 w-full bg-gray-900 border border-cyan-500"><div id="bar_B" class="h-full bg-gradient-to-r from-cyan-500 to-purple-500 w-0 transition-all duration-500"></div></div>
</div>
<div class="flex justify-between mb-6">
<button onclick="changeDay(-1)" class="text-xs border border-cyan-500 text-cyan-500 px-3 py-1 hover:bg-cyan-500 hover:text-black transition font-mono">< 上一日</button>
<button onclick="changeDay(1)" class="text-xs border border-cyan-500 text-cyan-500 px-3 py-1 hover:bg-cyan-500 hover:text-black transition font-mono">下一日 ></button>
</div>
<div id="list_B" class="space-y-4 pb-32"></div>
<footer class="mt-auto border-t border-purple-900 pt-4 flex justify-between items-center">
<span class="text-xs text-gray-600 font-mono">ID: 0X9EE7</span>
<button onclick="openResetModal()" class="text-xs text-red-500 hover:bg-red-900/20 px-3 py-2 border border-transparent hover:border-red-900 transition font-bold">>> 系统重置 <<</button>
</footer>
</main>
</div>
<div id="modalOverlay" class="modal-overlay"><div class="modal-box"><div class="modal-inner"><h3 id="modalTitle" class="text-2xl font-['Orbitron'] text-white font-bold mb-4">标题</h3><p id="modalDesc" class="text-gray-400 text-sm font-mono mb-6">描述</p><input type="text" id="modalInput" class="modal-input" style="display:none;"><div class="flex justify-center mt-8"><button id="modalBtnCancel" class="modal-btn" style="border-color:#666; color:#999" onclick="closeModal()">取消</button><button id="modalBtnConfirm" class="modal-btn">确认</button></div></div></div></div>
<script src="rules_db.js"></script>
<script>
const NEON_PALETTE = ['#ff00ff', '#00fff9', '#ffe600', '#ff3366', '#b026ff', '#00ff66'];
const RAW_DATA = '{{TASKS_DATA}}';
let tasksData = [];
let defaultTitle = "{{PLAN_TITLE}}";
let planTitle = defaultTitle;
try {
if (RAW_DATA.includes('{{')) {
planTitle = "赛博双核计划";
const today = new Date();
for(let i=0; i<5; i++) {
let d = new Date(today); d.setDate(today.getDate() + i);
tasksData.push({ date: d.toISOString().split('T')[0], dayNum: i+1, tasks: [{ title: '神经校准', desc: '同步数据', tag: '维护' }, { title: '数据上传', desc: '50TB', tag: '上传' }] });
}
} else {
tasksData = JSON.parse(RAW_DATA);
}
} catch(e) { tasksData = []; }

// 智能排序权重 (Cyberpunk 风格优化)
const SORT_WEIGHTS = { "健康": 420, "英语": 540, "学习": 600, "工作": 840, "运动": 1020, "生活": 1140, "财务": 1200, "娱乐": 1260 };
function getTaskScore(t) {
    const ai = typeof autoDetectTag === 'function' ? autoDetectTag(t.title + " " + (t.desc || "")) : { label: '日常' };
    return SORT_WEIGHTS[ai.label] || 9999;
}
// 初始化时对所有天数的任务进行排序
tasksData.forEach(day => {
if(day.tasks && day.tasks.length > 0) {
day.tasks.sort((a, b) => getTaskScore(a) - getTaskScore(b));
}
});
/* --------------------------------------------------------- */
const PLAN_ID = 'cyber_v1_core';
const KEY_PROGRESS = 'df_prog_' + PLAN_ID;
const KEY_TITLE = 'df_title_' + PLAN_ID;
const KEY_DAY_IDX = 'df_day_idx_' + PLAN_ID;
const KEY_THEME = 'df_theme_' + PLAN_ID;
let userProgress = JSON.parse(localStorage.getItem(KEY_PROGRESS) || '{}');
let savedTitle = localStorage.getItem(KEY_TITLE);
if(savedTitle) planTitle = savedTitle;
let currentDayIdx = parseInt(localStorage.getItem(KEY_DAY_IDX)) || 0;
let currentTheme = localStorage.getItem(KEY_THEME) || 'A';
if (currentDayIdx >= tasksData.length) {
currentDayIdx = tasksData.length > 0 ? tasksData.length - 1 : 0;
localStorage.setItem(KEY_DAY_IDX, currentDayIdx);
}
let heatmapOffset = 0;

// --- 核心音频系统重构 ---
const OSS_BASE = "https://deepflow-hellojyh-audio.oss-cn-hangzhou.aliyuncs.com";
const AUDIO_SYSTEM = {
    sfxEnabled: localStorage.getItem('cyber_sfx_enabled') !== 'false',
    pools: {
        check: [ OSS_BASE + "/audio/cyber/check.MP3", OSS_BASE + "/audio/cyber/check1.MP3", OSS_BASE + "/audio/cyber/check2.MP3", OSS_BASE + "/audio/cyber/check4.MP3" ],
        switch: [ OSS_BASE + "/audio/cyber/switch1.MP3", OSS_BASE + "/audio/cyber/switch2.MP3" ],
        finish: [ OSS_BASE + "/audio/cyber/finish1.MP3", OSS_BASE + "/audio/cyber/finish2.MP3" ]
    },
    cache: {},
    preload: function() {
        Object.keys(this.pools).forEach(key => {
            this.cache[key] = this.pools[key].map(src => { const audio = new Audio(); audio.src = src; audio.preload = 'auto'; audio.volume = 0.8; return audio; });
        });
        this.updateBtn();
    },
    toggle: function() {
        this.sfxEnabled = !this.sfxEnabled;
        localStorage.setItem('cyber_sfx_enabled', this.sfxEnabled);
        this.updateBtn();
        if(typeof showToast === 'function') showToast(this.sfxEnabled ? ">> 界面音效: 已开启" : ">> 界面音效: 已静音");
    },
    updateBtn: function() {
        const btn = document.getElementById('sfxToggleBtn');
        if(!btn) return;
        const icon = btn.querySelector('i');
        if(this.sfxEnabled) {
            btn.innerHTML = `<i data-lucide="volume-2" class="w-3 h-3"></i> 界面音效: ON`;
            btn.style.opacity = "1";
            btn.style.borderColor = "var(--active-color)";
            btn.style.color = "var(--active-color)";
        } else {
            btn.innerHTML = `<i data-lucide="volume-x" class="w-3 h-3"></i> 界面音效: OFF`;
            btn.style.opacity = "0.5";
            btn.style.borderColor = "#555";
            btn.style.color = "#555";
        }
        lucide.createIcons();
    },
    play: function(type) {
        if (!this.sfxEnabled) return; 
        if (!this.cache[type]) return;
        const audios = this.cache[type];
        const audio = audios[Math.floor(Math.random() * audios.length)];
        audio.currentTime = 0;
        audio.play().catch(e => console.log('Audio fail', e));
    }
};
function toggleSFX() { AUDIO_SYSTEM.toggle(); }
AUDIO_SYSTEM.preload();

function init() {
    document.documentElement.style.setProperty('--active-color', currentTheme === 'A' ? '#00f3ff' : '#00fff9');
    document.body.className = currentTheme === 'A' ? 'theme-a' : 'theme-b';
    document.getElementById(currentTheme==='A'?'core_A':'core_B').classList.remove('hidden-core');
    document.getElementById(currentTheme==='A'?'core_B':'core_A').classList.add('hidden-core');
    renderAll();
    renderHeatmap();
    setInterval(updateLog, 1500);
    setTimeout(lucide.createIcons, 100);
    
    // 初始化下拉菜单数据
    const mobSelect = document.getElementById('mobileDateSelect');
    if(mobSelect) {
        mobSelect.innerHTML = ''; 
        tasksData.forEach((task, index) => {
            const opt = document.createElement('option');
            opt.value = index;
            opt.text = `扇区 ${String(task.dayNum).padStart(2,'0')} | ${task.date}`;
            mobSelect.appendChild(opt);
        });
        mobSelect.value = currentDayIdx; 
    }
    
    setTimeout(() => {
        const tip = document.getElementById('dockTooltip');
        if(tip) {
            tip.classList.remove('show');
            tip.style.opacity = '0';
            tip.style.transform = 'translateY(-50%) translateX(10px)';
        }
    }, 4000);
}

function switchArchitecture() {
    AUDIO_SYSTEM.play('switch');
    const loader = document.getElementById('loader-layer');
    const target = currentTheme === 'A' ? 'B' : 'A';
    loader.className = 'show';
    if (target === 'A') {
        loader.innerHTML = `<div class="loader-mode-a"><div class="iris-aperture"><div class="iris-scan-line"></div><div class="iris-blade"></div><div class="iris-center"></div></div><div class="iris-text">生物特征识别通过 // 接入系统 A</div></div>`;
    } else {
        loader.innerHTML = `<div class="loader-mode-b-neural"><div class="neural-hex"><div class="neural-hex-inner"></div></div><div class="neural-text">系统重构中</div><div class="neural-sub">正在解密神经元数据...</div><div class="scan-beam"></div></div>`;
    }
    setTimeout(() => {
        currentTheme = target;
        localStorage.setItem(KEY_THEME, currentTheme);
        document.documentElement.style.setProperty('--active-color', currentTheme === 'A' ? '#00f3ff' : '#00fff9');
        document.body.className = currentTheme === 'A' ? 'theme-a' : 'theme-b';
        document.getElementById(currentTheme==='A'?'core_A':'core_B').classList.remove('hidden-core');
        document.getElementById(currentTheme==='A'?'core_B':'core_A').classList.add('hidden-core');
        if(target === 'B') { updateLog(); renderHeatmap(); }
        loader.classList.remove('show');
        lucide.createIcons();
    }, 2500);
}

function renderAll() {
    lucide.createIcons();
    document.getElementById('title_A').innerText = planTitle;
    document.getElementById('title_B').innerText = planTitle;
    const day = tasksData[currentDayIdx]; if(!day) return;
    document.getElementById('dateStr_A').innerText = day.date; document.getElementById('dayNum_A').innerText = String(day.dayNum).padStart(2,'0');
    renderListA(day); renderSidebarA(); updateStatsA(day);
    document.getElementById('dateStr_B').innerText = day.date;
    renderListB(day); updateStatsB(day);
    updateGlobalSync(); lucide.createIcons();
    const mobSelect = document.getElementById('mobileDateSelect');
    if(mobSelect) mobSelect.value = currentDayIdx;
}

function renderListA(day) {
const el = document.getElementById('list_A'); el.innerHTML = '';
day.tasks.forEach((t, i) => {
const uid = day.date + '_' + i; const checked = !!userProgress[uid];
const aiInfo = typeof autoDetectTag === 'function' ? autoDetectTag(t.title + " " + (t.desc||"")) : {category:'日常'};
const displayTag = t.tag || (aiInfo.category !== '日常' ? aiInfo.label : '');
const aiPrefix = (aiInfo.emoji && aiInfo.category !== '日常') ? `<span class="mr-2 opacity-80 text-cyan-200 text-xs">${aiInfo.emoji}</span>` : '';
let timeInfoHtml = '';
if (t.time || t.duration) {
timeInfoHtml = `<div class="task-data-line">`;
if (t.time) timeInfoHtml += `<span>⏰ ${t.time}</span>`;
if (t.duration) timeInfoHtml += `<span>⏳ ${t.duration}M</span>`;
timeInfoHtml += `</div>`;
}
el.innerHTML += `
<div onclick="toggle('${uid}')" class="task-row cursor-pointer ${checked?'checked':''}">
<div class="a-checkbox-container"><div class="a-checkbox flex-shrink-0">${checked?'<i data-lucide="check" class="w-3 h-3 text-cyan-400"></i>':''}</div></div>
<div class="flex-1">
${timeInfoHtml}
<h4 class="text-white text-sm font-bold tracking-wide">${aiPrefix}${t.title}</h4>
<div class="flex items-center gap-2 mt-1">
${displayTag ? `<span class="text-[10px] bg-cyan-900/50 text-cyan-400 px-1 border border-cyan-800 tracking-wider">${displayTag.toUpperCase()}</span>` : ''}
<p class="text-xs text-gray-500 font-mono">${t.desc||'暂无数据描述'}</p>
</div>
</div>
</div>`;
});
}
function renderListB(day) {
const el = document.getElementById('list_B'); el.innerHTML = '';
day.tasks.forEach((t, i) => {
const uid = day.date + '_' + i; const checked = !!userProgress[uid];
const aiInfo = typeof autoDetectTag === 'function' ? autoDetectTag(t.title + " " + (t.desc||"")) : {category:'日常'};
const displayTag = t.tag || (aiInfo.category !== '日常' ? aiInfo.label : '');
const aiPrefix = (aiInfo.emoji && aiInfo.category !== '日常') ? `<span class="mr-2 text-purple-300 text-lg opacity-80">${aiInfo.emoji}</span>` : '';
let timeInfoHtml = '';
if (t.time || t.duration) {
timeInfoHtml = `<div class="b-task-data-line">`;
if (t.time) timeInfoHtml += `<span class="flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> ${t.time}</span>`;
if (t.duration) timeInfoHtml += `<span class="flex items-center gap-1"><i data-lucide="hourglass" class="w-3 h-3"></i> ${t.duration}M</span>`;
timeInfoHtml += `</div>`;
}
el.innerHTML += `
<div onclick="toggle('${uid}')" class="b-task-item ${checked?'checked':''}">
<div class="flex-shrink-0 w-6 h-6 border border-cyan-400 flex items-center justify-center bg-black text-pink-500 font-bold">${checked?'X':''}</div>
<div class="flex-1">
${timeInfoHtml}
<h4 class="text-white font-['Rajdhani'] text-xl ${checked?'line-through text-gray-500':''}">${aiPrefix}${t.title}</h4>
<div class="text-xs text-cyan-600 font-mono flex gap-2 items-center">
${displayTag ? `<span class="text-purple-400 font-bold">[${displayTag.toUpperCase()}]</span>` : ''}
// ${t.desc||'NO_DATA'}
</div>
</div>
</div>`;
});
}
function renderSidebarA() {
const el = document.getElementById('sidebar_A'); el.innerHTML = '';
tasksData.forEach((d, i) => {
const active = i === currentDayIdx;
const isAllDone = d.tasks.length > 0 && d.tasks.every((_, tIdx) => userProgress[d.date + '_' + tIdx]);
const dateLabel = d.date.substring(5).replace('-', '.');
let completeIcon = '';
let extraClass = '';
if (isAllDone) {
completeIcon = `<i data-lucide="crosshair" class="w-3 h-3 text-cyan-400 animate-pulse"></i>`;
extraClass = 'completed-day';
} else if (active) {
completeIcon = `<i data-lucide="chevron-left" class="w-3 h-3"></i>`;
}
el.innerHTML += `
<div onclick="gotoDay(${i})" class="nav-item ${active?'active':''} ${extraClass}">
<div class="flex items-center gap-3">
<span>DAY ${String(d.dayNum).padStart(2,'0')}</span>
<span class="text-[10px] font-mono opacity-60 ml-1 tracking-tighter">[${dateLabel}]</span>
</div>
<div>${completeIcon}</div>
</div>`;
});
}
function renderHeatmap() {
const el = document.getElementById('heatmap_B'); if(!el) return;
el.innerHTML = '';
const start = heatmapOffset * 28;
const end = Math.min(start + 28, tasksData.length);
for(let i=start; i<end; i++) {
const day = tasksData[i];
const done = day.tasks.length > 0 && day.tasks.every((_, ti) => userProgress[day.date+'_'+ti]);
const isCurrent = i === currentDayIdx;
let cls = "heatmap-cell";
let style = "";
if(done) {
cls += " active";
const neonColor = NEON_PALETTE[i % NEON_PALETTE.length];
style = `background:${neonColor}; box-shadow:0 0 15px ${neonColor}; border-color:#fff;`;
}
if(isCurrent) cls += " current";
el.innerHTML += `<div class="${cls}" style="${style}" onclick="gotoDay(${i}); showToast('正在访问扇区: ${day.date}')" title="${day.date}"></div>`;
}
for(let i=end; i<start+28; i++) { el.innerHTML += `<div class="heatmap-cell" style="background:#111; cursor:default"></div>`; }
document.getElementById('heatmap_page').innerText = `第 ${heatmapOffset+1} 页`;
}
function heatmapPage(d) { const max=Math.ceil(tasksData.length/28)-1; heatmapOffset+=d; if(heatmapOffset<0)heatmapOffset=0; if(heatmapOffset>max)heatmapOffset=max; renderHeatmap(); }

// === [Cyber 修复：防闪烁逻辑] ===
let cyberToastTimer = null;
function showToast(msg) { 
    const t = document.getElementById('holo-toast'); 
    if(!t) return;
    if (cyberToastTimer) clearTimeout(cyberToastTimer);
    t.innerText = msg; 
    t.classList.add('show'); 
    cyberToastTimer = setTimeout(() => { 
        t.classList.remove('show'); 
        cyberToastTimer = null;
    }, 2000); 
}

function updateLog() {
const el = document.getElementById('sys_log_B');
if(currentTheme === 'B' && el) {
const logs = ["> 延迟: 14ms", "> 数据包接收完毕", "> 内存整理完成", "> 加密连接建立"];
el.innerHTML += `<br>${logs[Math.floor(Math.random()*logs.length)]}`;
el.scrollTop = el.scrollHeight;
}
const ram = document.getElementById('ram_B'); if(ram) ram.innerText = (Math.random()*6+4).toFixed(2) + "GB";
}

// --- 核心修复：独立音频逻辑 + Confetti ---
function toggle(uid) {
    const isChecking = !userProgress[uid]; 
    if(userProgress[uid]) delete userProgress[uid];
    else userProgress[uid] = true;
    localStorage.setItem(KEY_PROGRESS, JSON.stringify(userProgress));

    const dayDate = uid.split('_')[0];
    const dayObj = tasksData.find(d => d.date === dayDate);
    if (isChecking && dayObj) {
        const total = dayObj.tasks.length;
        const doneCount = dayObj.tasks.filter((_, i) => userProgress[dayDate+'_'+i]).length;
        if (total > 0 && doneCount === total) {
            AUDIO_SYSTEM.play('finish');
            // 触发礼花特效
            // 方案 2：系统过载 (冲击力强)
// 特点：高速度、故障红/青配色、瞬间爆发
if(window.confetti) {
    confetti({
        particleCount: 150,
        spread: 100,
        startVelocity: 45,              // 初始速度更快
        origin: { y: 0.6 },
        colors: ['#ff0055', '#00f3ff', '#ffffff'], // 红+青+白 (故障配色)
        shapes: ['square', 'circle'],   // 混合形状
        gravity: 1.2,                   // 重力大，下落快
        decay: 0.9,                     // 消失得快
        scalar: 1.2                     // 粒子大，更有冲击力
    });
}
        } else {
            AUDIO_SYSTEM.play('check');
        }
    }
    renderAll(); renderHeatmap();
}

function updateStatsA(day) {
const total=day.tasks.length; const done=day.tasks.filter((_,i)=>userProgress[day.date+'_'+i]).length;
const pct = total ? (done/total) : 0;
const cellContainer = document.getElementById('energy_bar_A');
cellContainer.innerHTML = '';
const cellCount = 20; const filledCount = Math.floor(pct * cellCount);
for(let i=0; i<cellCount; i++) {
const d = document.createElement('div');
d.className = `energy-cell ${i < filledCount ? 'active' : ''}`;
cellContainer.appendChild(d);
}
document.getElementById('progressText_A').innerText = `${done}/${total} 单元`;
document.getElementById('sync_A').innerText = Math.round(pct*100) + '%';
const stamp = document.getElementById('stamp_A');
if(done===total && total>0) {
stamp.classList.remove('opacity-10','grayscale','scale-95'); stamp.classList.add('opacity-100','scale-100'); stamp.style.filter = "drop-shadow(0 0 20px #00f3ff)";
} else {
stamp.classList.add('opacity-10','grayscale','scale-95'); stamp.classList.remove('opacity-100','scale-100'); stamp.style.filter = "none";
}
}
function updateStatsB(day) {
const total=day.tasks.length; const done=day.tasks.filter((_,i)=>userProgress[day.date+'_'+i]).length;
const pct = total ? Math.round((done/total)*100) : 0;
document.getElementById('bar_B').style.width = pct + '%';
document.getElementById('sync_B').innerText = pct + '%';
}
function updateGlobalSync() {
let t=0, d=0; tasksData.forEach(day => day.tasks.forEach((_, i) => { t++; if(userProgress[day.date+'_'+i]) d++; }));
const pct = t ? Math.round((d/t)*100) : 0; document.getElementById('sync_A').innerText = pct + '%';
}
function changeDay(d) {
const n = currentDayIdx+d;
if(n>=0 && n<tasksData.length) {
currentDayIdx = n;
localStorage.setItem(KEY_DAY_IDX, currentDayIdx);
renderAll();
renderHeatmap();
}
}
function gotoDay(i) {
currentDayIdx = i;
localStorage.setItem(KEY_DAY_IDX, currentDayIdx);
renderAll();
renderHeatmap();
}
function openRenameModal() {
const m=document.getElementById('modalOverlay');
document.getElementById('modalTitle').innerText="重命名系统 (RENAME)";
document.getElementById('modalDesc').innerText="请输入新的计划名称:";
const i=document.getElementById('modalInput');
i.style.display='block'; i.value=planTitle;
document.getElementById('modalBtnConfirm').onclick=()=>{
if(i.value){
planTitle=i.value;
localStorage.setItem(KEY_TITLE, planTitle);
renderAll();
closeModal();
}
};
m.classList.add('show');
}
function openResetModal() {
const m=document.getElementById('modalOverlay');
document.getElementById('modalTitle').innerText="系统重置 (RESET)";
document.getElementById('modalDesc').innerText="警告：确认清除所有进度数据？此操作不可逆。";
document.getElementById('modalInput').style.display='none';
document.getElementById('modalBtnConfirm').onclick=()=>{
localStorage.removeItem(KEY_PROGRESS);
localStorage.removeItem(KEY_DAY_IDX);
localStorage.removeItem(KEY_THEME);
userProgress = {};
currentDayIdx = 0;
currentTheme = 'A';
renderAll();
closeModal();
showToast("系统重置完毕");
document.documentElement.style.setProperty('--active-color', '#00f3ff');
document.body.className = 'theme-a';
document.getElementById('core_A').classList.remove('hidden-core');
document.getElementById('core_B').classList.add('hidden-core');
};
m.classList.add('show');
}
function closeModal() { document.getElementById('modalOverlay').classList.remove('show'); }
let timer=null, timeLeft=1500, isRun=false;
const dockWrapper = document.getElementById('globalDockWrapper');
const orb = document.getElementById('dockOrb');
let isDrag = false, startX, startY, initialLeft, initialTop;

function handleDragStart(e) {
    if(e.target.closest('#dockPanel')) return;
    isDrag = false;
    const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
    const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
    startX = clientX; startY = clientY;
    let rect = dockWrapper.getBoundingClientRect();
    initialLeft = rect.left; initialTop = rect.top;
    dockWrapper.style.transition = 'none';
    document.addEventListener('mousemove', handleDragMove);
    document.addEventListener('touchmove', handleDragMove, {passive: false});
    document.addEventListener('mouseup', handleDragEnd);
    document.addEventListener('touchend', handleDragEnd);
}
function handleDragMove(e) {
    const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
    const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
    if(Math.abs(clientX - startX) > 5 || Math.abs(clientY - startY) > 5) {
        isDrag = true; e.preventDefault();
        dockWrapper.style.left = (initialLeft + clientX - startX) + 'px';
        dockWrapper.style.top = (initialTop + clientY - startY) + 'px';
        dockWrapper.style.right = 'auto'; dockWrapper.style.bottom = 'auto';
    }
}
function handleDragEnd() {
    document.removeEventListener('mousemove', handleDragMove);
    document.removeEventListener('touchmove', handleDragMove);
    document.removeEventListener('mouseup', handleDragEnd);
    document.removeEventListener('touchend', handleDragEnd);
    dockWrapper.style.transition = 'all 0.4s cubic-bezier(0.25, 1, 0.5, 1)';
    if(!isDrag) { toggleDock(); } else { snapDock(); }
}
orb.addEventListener('mousedown', handleDragStart);
orb.addEventListener('touchstart', handleDragStart, {passive: false});
function snapDock() {
const rect = dockWrapper.getBoundingClientRect();
const winW = window.innerWidth; const winH = window.innerHeight;
const SNAP_THRESHOLD = 100; const MARGIN = 32;
let targetLeft = rect.left; let targetTop = rect.top;
if (rect.left < SNAP_THRESHOLD) targetLeft = MARGIN;
else if (winW - rect.right < SNAP_THRESHOLD) targetLeft = winW - rect.width - MARGIN;
if (rect.top < SNAP_THRESHOLD) targetTop = MARGIN;
else if (winH - rect.bottom < SNAP_THRESHOLD) targetTop = winH - rect.height - MARGIN;
dockWrapper.style.left = `${Math.max(MARGIN, Math.min(winW - rect.width - MARGIN, targetLeft))}px`;
dockWrapper.style.top = `${Math.max(MARGIN, Math.min(winH - rect.height - MARGIN, targetTop))}px`;
}
function updatePanelPosition() {
const rect = dockWrapper.getBoundingClientRect();
const panel = document.getElementById('dockPanel');
const winH = window.innerHeight; const winW = window.innerWidth;
panel.style.top = ''; panel.style.bottom = ''; panel.style.left = ''; panel.style.right = '';
panel.style.transformOrigin = '';
if (rect.top > winH / 2) { panel.style.bottom = '85px'; panel.style.transformOrigin = 'bottom '; } else { panel.style.top = '85px'; panel.style.transformOrigin = 'top '; }
if (rect.left > winW / 2) { panel.style.right = '0'; panel.style.transformOrigin += 'right'; } else { panel.style.left = '0'; panel.style.transformOrigin += 'left'; }
}
function toggleDock() {
const panel = document.getElementById('dockPanel');
if (!panel.classList.contains('open')) { updatePanelPosition(); }
panel.classList.toggle('open');
}
function showTimeInput() { document.getElementById('timeInputRow').style.display='flex'; document.getElementById('customTimeInput').focus(); }
function submitTime() { const v=document.getElementById('customTimeInput').value; let m=parseInt(v)||25; if(m>120)m=120; setTime(m); document.getElementById('timeInputRow').style.display='none'; }
function adjTime(v) { if(!isRun) { let m=Math.floor(timeLeft/60)+v; if(m<1)m=1; setTime(m); } }
function setTime(m) { if(!isRun) { timeLeft=m*60; updateUI(); } }
function toggleTimer() { if(isRun){ clearInterval(timer); isRun=false; } else { isRun=true; AUDIO_SYSTEM.play('switch'); timer=setInterval(()=>{ if(timeLeft>0) { timeLeft--; updateUI(); } else finishTimer(); }, 1000); } updateUI(); }
function finishTimer() { clearInterval(timer); isRun=false; AUDIO_SYSTEM.play('finish'); alert("DONE"); updateUI(); }
function updateUI() {
const m=Math.floor(timeLeft/60).toString().padStart(2,'0'), s=(timeLeft%60).toString().padStart(2,'0');
document.getElementById('dockTime').innerText=`${m}:${s}`;
document.getElementById('immTime').innerText=`${m}:${s}`;
document.getElementById('timerBtn').innerText=isRun?'暂停 (PAUSE)':'启动 (START)';
const immBtn = document.getElementById('immPlayBtn');
if(immBtn) {
if(isRun) {
immBtn.innerHTML = `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>`;
} else {
immBtn.innerHTML = `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>`;
}
}
}
function enterImmersive() { document.getElementById('immersiveLayer').classList.add('active'); initMatrix(); document.getElementById('dockPanel').classList.remove('open'); updateUI(); }
function exitImmersive() { document.getElementById('immersiveLayer').classList.remove('active'); }
function initMatrix() {
const c = document.getElementById('immMatrix'); c.innerHTML='';
const w = window.innerWidth;
for(let i=0; i<Math.floor(w/20); i++) {
const d = document.createElement('div');
d.style.cssText = `position:absolute; top:-100px; left:${i*20}px; color:${currentTheme==='A'?'#00f3ff':'#00fff9'}; writing-mode:vertical-rl; font-family:monospace; animation:fall ${Math.random()*2+2}s linear infinite`;
d.innerText = Math.random().toString(2).substring(2);
c.appendChild(d);
}
}
document.head.insertAdjacentHTML("beforeend", `<style>@keyframes fall { to { transform: translateY(110vh); } }</style>`)
window.addEventListener('DOMContentLoaded', init);
</script>

<div id="noiseDockWrapper" style="position: fixed; bottom: 200px; right: 32px; left: auto; z-index: 20000; touch-action: none;">
    <div id="noiseOrb" style="width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: grab; transition: transform 0.1s; position: relative; z-index: 20002;">
        <i data-lucide="headphones" class="w-6 h-6 pointer-events-none relative z-10"></i>
        <div class="cyber-ring cyber-ring-1"></div>
        <div class="cyber-ring cyber-ring-2"></div>
    </div>
    
    <div id="noisePanel" style="position: absolute; bottom: 0; width: 260px; padding: 20px; border-radius: 2px; display: none; opacity: 0; transition: all 0.3s; z-index: 20001;">
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-2">
                <span class="text-[10px] font-bold uppercase tracking-widest opacity-60">声景系统</span>
                <button id="sfxToggleBtn" onclick="toggleSFX()" class="text-[9px] border border-current px-2 py-0.5 text-cyan-400 hover:bg-cyan-900/50 transition font-mono tracking-wider flex items-center gap-1">
                    <i data-lucide="volume-2" class="w-3 h-3"></i> UI音效
                </button>
            </div>
            <input type="range" min="0" max="1" step="0.1" value="0.6" oninput="changeNoiseVolume(this.value)" class="w-20 h-1 rounded-lg appearance-none bg-gray-500/30 cursor-pointer accent-current">
        </div>
        
        <div class="grid grid-cols-4 gap-3 mb-4">
            <div class="noise-card relative" onclick="playNoise('rain')"><i data-lucide="cloud-rain"></i></div>
            <div class="noise-card relative" onclick="playNoise('ocean')"><i data-lucide="waves"></i></div>
            <div class="noise-card relative" onclick="playNoise('forest')"><i data-lucide="trees"></i></div>
            <div class="noise-card relative" onclick="playNoise('fire')"><i data-lucide="flame"></i></div>
            <div class="noise-card relative" onclick="playNoise('cafe')"><i data-lucide="coffee"></i></div>
            <div class="noise-card relative" onclick="playNoise('train')"><i data-lucide="train"></i></div>
            <div class="noise-card relative" onclick="playNoise('night')"><i data-lucide="moon"></i></div>
            <div class="noise-card relative" onclick="playNoise('keyboard')"><i data-lucide="keyboard"></i></div>
        </div>
        
        <button id="noiseStopBtn" onclick="stopAllNoise()" class="w-full text-xs py-2 font-bold opacity-60 hover:opacity-100 transition border border-current flex items-center justify-center gap-2">
            <i data-lucide="square" class="w-3 h-3"></i> 切断信号 (CUT_SIGNAL)
        </button>
    </div>
</div>

<script>
    // --- 1. 音频引擎 (Web Audio API 版本) ---
    const NOISE_BASE = "https://deepflow-hellojyh-audio.oss-cn-hangzhou.aliyuncs.com/audio/ambience/";
    const noiseConfig = {
        'rain': [ {n:'霓虹雨夜', f:'rain.mp3'}, {n:'雷暴轰鸣', f:'rain_2.mp3'}, {n:'涓涓雨滴', f:'rain_3.mp3'} ],
        'ocean': [ {n:'数据之海', f:'ocean.mp3'}, {n:'深潜模式', f:'ocean_2.mp3'} ],
        'forest': [ {n:'全息森林', f:'forest.mp3'}, {n:'电子蝉鸣', f:'forest_2.mp3'}, {n:'故障风声', f:'forest_3.mp3'} ],
        'fire': [ {n:'数字篝火', f:'fire.mp3'} ],
        'cafe': [ {n:'网络终端', f:'cafe.mp3'} ],
        'train': [ {n:'超导列车', f:'train.mp3'} ],
        'night': [ {n:'夜之城', f:'night.mp3'} ],
        'keyboard': [ {n:'黑客入侵', f:'keyboard.mp3'} ]
    };
    
    // Web Audio API 核心组件
    let audioContext = null; 
    let masterGainNode = null; // 用于控制全局音量
    let audioBufferCache = {}; // 缓存已解码的音频数据 (AudioBuffer)

    let currentCat = null; 
    let currentVarIdx = 0; 
    let currentSourceNode = null; // 存储当前的 AudioBufferSourceNode
    let masterVol = 0.6;
    let isPaused = false;
    
    // --- 核心函数：初始化 AudioContext ---
    function initializeAudioContext() {
        if (!audioContext) {
            // 解决跨浏览器兼容性问题
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // 创建主增益节点并连接到扬声器
            masterGainNode = audioContext.createGain();
            masterGainNode.connect(audioContext.destination);
            changeNoiseVolume(masterVol); // 设置初始音量
        }
    }

    // --- 核心函数：加载和解码音频数据 (异步) ---
    async function loadSound(url) {
        if (audioBufferCache[url]) {
            return audioBufferCache[url];
        }
        
        try {
            const response = await fetch(url);
            const arrayBuffer = await response.arrayBuffer();
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
            audioBufferCache[url] = audioBuffer;
            return audioBuffer;
        } catch (e) {
            console.error('Error loading audio:', e);
            showToast(">> 信号加载失败！请检查URL和网络。");
            return null;
        }
    }

    function playNoise(cat) {
        initializeAudioContext(); // 确保 Context 已初始化
        if (currentCat === cat && isPaused) { togglePlayback(); return; }
        if (currentCat === cat) currentVarIdx = (currentVarIdx + 1) % noiseConfig[cat].length;
        else { currentCat = cat; currentVarIdx = 0; }
        
        loadAndPlay();
    }

    async function loadAndPlay() {
        if(currentSourceNode) currentSourceNode.stop(); // 停止当前正在播放的节点
        
        const item = noiseConfig[currentCat][currentVarIdx];
        const url = NOISE_BASE + item.f;
        
        showToast(">> 正在缓冲: " + item.n);
        
        const buffer = await loadSound(url);
        if (!buffer) return;

        // --- 使用 AudioBufferSourceNode 播放 ---
        currentSourceNode = audioContext.createBufferSource();
        currentSourceNode.buffer = buffer; 
        currentSourceNode.loop = true; // Web Audio API 的循环更精确
        
        // 连接到音量控制节点
        currentSourceNode.connect(masterGainNode);
        
        // 立即播放
        currentSourceNode.start(0);
        
        isPaused = false;
        updateNoiseUI();
        showToast(">> 信号接入: " + item.n); 
    }

    // --- 修改：Web Audio API 没有真正的 '暂停'，只能停止和重新开始 ---
    function togglePlayback() {
        if (!currentSourceNode && !currentCat) return;
        
        const item = noiseConfig[currentCat][currentVarIdx];
        
        if (isPaused) { 
            // 恢复播放：重新加载并播放音频
            loadAndPlay();
            showToast(">> 信号恢复: " + item.n); 
        } else { 
            // 暂停：停止当前节点
            currentSourceNode.stop();
            isPaused = true; 
        }
        updateNoiseUI();
    }

    function stopAllNoise() { togglePlayback(); }
    
    function changeNoiseVolume(v) { 
        masterVol = parseFloat(v); 
        if(masterGainNode) {
            // 通过 GainNode 控制音量，范围是 0.0 到 1.0
            masterGainNode.gain.setValueAtTime(masterVol, audioContext.currentTime);
        }
    }

    function updateNoiseUI() {
        // ... (保持原有的 UI 更新逻辑，因为它仍然依赖 DOM API) ...
        const orb = document.getElementById('noiseOrb');
        const btn = document.getElementById('noiseStopBtn');
        if(currentCat && !isPaused) orb.classList.add('is-playing'); else orb.classList.remove('is-playing');
        
        if (!currentCat) {
            btn.className = "w-full text-xs py-2 font-bold opacity-60 hover:opacity-100 transition border border-current flex items-center justify-center gap-2";
            btn.innerHTML = `<i data-lucide="radio" class="w-3 h-3"></i> 等待输入 (WAITING)`;
        } else if (isPaused) {
            btn.classList.remove('stop-active'); btn.style.opacity = "0.6"; btn.style.boxShadow = "none";
            btn.innerHTML = `<i data-lucide="play" class="w-3 h-3"></i> 恢复连接 (RESUME)`;
        } else {
            btn.classList.add('stop-active'); btn.style.opacity = "1";
            btn.innerHTML = `<i data-lucide="pause" class="w-3 h-3"></i> 暂停传输 (PAUSE)`;
        }
        document.querySelectorAll('.noise-card').forEach(el => {
            el.classList.remove('active');
            const oldB = el.querySelector('.variant-badge'); if(oldB) oldB.remove();
            if(el.getAttribute('onclick').includes(`'${currentCat}'`)) {
                el.classList.add('active');
                if(noiseConfig[currentCat].length > 1) {
                    el.insertAdjacentHTML('beforeend', `<span class="variant-badge">${currentVarIdx+1}</span>`);
                }
            }
        });
        // 假设 lucide.createIcons() 是一个外部函数
        if (typeof lucide !== 'undefined' && lucide.createIcons) {
            lucide.createIcons();
        }
    }
    setTimeout(updateNoiseUI, 500);
    // --- 2. 物理拖拽与吸附引擎 ---
    const nWrapper = document.getElementById('noiseDockWrapper');
    const nOrb = document.getElementById('noiseOrb');
    const nPanel = document.getElementById('noisePanel');
    let noise_isDragging = false, noise_hasMoved = false, noise_startX, noise_startY, noise_initialLeft, noise_initialTop;

    nOrb.addEventListener('mousedown', noiseDragStart);
    nOrb.addEventListener('touchstart', noiseDragStart, {passive: false});

    function noiseDragStart(e) {
        if(e.target.closest('#noisePanel')) return;
        noise_isDragging = true; noise_hasMoved = false;
        const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
        const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
        noise_startX = clientX; noise_startY = clientY;
        const rect = nWrapper.getBoundingClientRect();
        noise_initialLeft = rect.left; noise_initialTop = rect.top;
        nWrapper.style.transition = 'none'; nOrb.style.cursor = 'grabbing'; nOrb.style.transform = 'scale(0.95)';
        document.addEventListener('mousemove', noiseDragMove); document.addEventListener('touchmove', noiseDragMove, {passive: false});
        document.addEventListener('mouseup', noiseDragEnd); document.addEventListener('touchend', noiseDragEnd);
    }

    function noiseDragMove(e) {
        if (!noise_isDragging) return; e.preventDefault(); 
        const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
        const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
        const dx = clientX - noise_startX; const dy = clientY - noise_startY;
        if (Math.abs(dx) > 3 || Math.abs(dy) > 3) {
            noise_hasMoved = true;
            if(nPanel.style.display !== 'none') { nPanel.style.opacity = '0'; nPanel.style.pointerEvents = 'none'; setTimeout(() => { nPanel.style.display = 'none'; }, 200); }
        }
        nWrapper.style.left = `${noise_initialLeft + dx}px`; nWrapper.style.top = `${noise_initialTop + dy}px`; nWrapper.style.bottom = 'auto'; 
    }

    function noiseDragEnd() {
        if (!noise_isDragging) return; noise_isDragging = false;
        nOrb.style.cursor = 'grab'; nOrb.style.transform = 'scale(1)';
        document.removeEventListener('mousemove', noiseDragMove); document.removeEventListener('touchmove', noiseDragMove);
        document.removeEventListener('mouseup', noiseDragEnd); document.removeEventListener('touchend', noiseDragEnd);

        if (noise_hasMoved) {
            const winW = window.innerWidth; const winH = window.innerHeight; const rect = nWrapper.getBoundingClientRect();
            const ORB_SIZE = 50; const MARGIN = 32; const SNAP_THRESHOLD = 80; const CENTER_SNAP_ZONE = 0.2;
            let targetLeft = rect.left; let targetTop = rect.top;   

            const isNearLeft = rect.left < SNAP_THRESHOLD;
            const isNearRight = (winW - (rect.left + ORB_SIZE)) < SNAP_THRESHOLD;
            const isNearTop = rect.top < SNAP_THRESHOLD;
            const isNearBottom = (winH - (rect.top + ORB_SIZE)) < SNAP_THRESHOLD;

            if (isNearLeft || isNearRight || isNearTop || isNearBottom) {
                nWrapper.style.transition = 'all 0.4s cubic-bezier(0.25, 1, 0.5, 1)'; 
                const centerX = rect.left + ORB_SIZE / 2;
                const isNearHorizontalCenter = centerX > winW * (0.5 - CENTER_SNAP_ZONE / 2) && centerX < winW * (0.5 + CENTER_SNAP_ZONE / 2);
                
                if (isNearLeft || isNearRight) {
                    if (isNearHorizontalCenter) targetLeft = (winW / 2) - (ORB_SIZE / 2);
                    else if (isNearLeft) targetLeft = MARGIN;
                    else if (isNearRight) targetLeft = winW - ORB_SIZE - MARGIN;
                } else if (isNearHorizontalCenter) {
                    targetLeft = (winW / 2) - (ORB_SIZE / 2);
                }
                
                const centerY = rect.top + ORB_SIZE / 2;
                const isNearVerticalCenter = centerY > winH * (0.5 - CENTER_SNAP_ZONE / 2) && centerY < winH * (0.5 + CENTER_SNAP_ZONE / 2);

                if (isNearTop || isNearBottom) {
                    if (isNearVerticalCenter) targetTop = (winH / 2) - (ORB_SIZE / 2);
                    else if (isNearTop) targetTop = MARGIN;
                    else if (isNearBottom) targetTop = winH - ORB_SIZE - MARGIN;
                } else if (isNearVerticalCenter) {
                     targetTop = (winH / 2) - (ORB_SIZE / 2);
                }
                
                targetLeft = Math.max(MARGIN, Math.min(winW - ORB_SIZE - MARGIN, targetLeft));
                targetTop = Math.max(MARGIN, Math.min(winH - ORB_SIZE - MARGIN, targetTop));

                nWrapper.style.left = `${targetLeft}px`; nWrapper.style.top = `${targetTop}px`; nWrapper.style.bottom = 'auto'; 

            } else {
                nWrapper.style.transition = 'all 0.1s linear'; 
                nWrapper.style.left = `${targetLeft}px`; nWrapper.style.top = `${targetTop}px`; nWrapper.style.bottom = 'auto'; 
            }
        } else {
            toggleNoisePanel();
        }
    }

    function toggleNoisePanel() {
        const isOpen = nPanel.style.display === 'block' && nPanel.style.opacity !== '0';
        if (isOpen) {
            nPanel.style.opacity = '0'; nPanel.style.transform = 'scale(0.9)'; setTimeout(() => { nPanel.style.display = 'none'; }, 200);
        } else {
            nPanel.style.display = 'block'; nPanel.style.pointerEvents = 'auto';
            const wrapperRect = nWrapper.getBoundingClientRect(); const winW = window.innerWidth; const winH = window.innerHeight;
            nPanel.style.top = ''; nPanel.style.bottom = ''; nPanel.style.left = ''; nPanel.style.right = '';
            
            if (wrapperRect.left > winW / 2) { nPanel.style.right = '0px'; nPanel.style.transformOrigin = 'bottom right'; } 
            else { nPanel.style.left = '0px'; nPanel.style.transformOrigin = 'bottom left'; }

            if (wrapperRect.top > winH / 2) { nPanel.style.bottom = '65px'; nPanel.style.transformOrigin = nPanel.style.transformOrigin.replace('top', 'bottom'); } 
            else { nPanel.style.top = '65px'; nPanel.style.transformOrigin = nPanel.style.transformOrigin.replace('bottom', 'top'); }

            nPanel.offsetHeight; nPanel.style.opacity = '1'; nPanel.style.transform = 'scale(1)';
        }
    }
    
    setTimeout(lucide.createIcons, 500);
</script>
</body>
</html>