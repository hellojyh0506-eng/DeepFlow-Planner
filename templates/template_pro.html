<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DeepFlow Pro - {{PLAN_TITLE}}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+SC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --primary: #007AFF; --primary-dark: #0056b3; --primary-light: rgba(0, 122, 255, 0.08); --text-on-primary: #ffffff; --surface: #f5f5f7; --glass-border: rgba(255, 255, 255, 0.6); --seal-red: #b91c1c;  }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Noto Sans SC', sans-serif; background-color: var(--surface); color: #1d1d1f; transition: background-color 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); -webkit-font-smoothing: antialiased; }
        .bg-spotlight { position: fixed; top: -20%; left: -20%; width: 140vw; height: 140vh; z-index: -1; background: radial-gradient(circle at 50% 30%, var(--primary-light), transparent 70%); opacity: 1; transition: background 0.8s ease; pointer-events: none; }
        .ios-card { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--glass-border); box-shadow: 0 4px 24px rgba(0,0,0,0.04); transition: all 0.3s; }
        .ios-card:hover { transform: translateY(-2px); box-shadow: 0 8px 32px rgba(0,0,0,0.08); border-color: rgba(255,255,255,0.9); }
        .palette-wrapper { position: relative; z-index: 50; }
        .palette-btn { width: 36px; height: 36px; border-radius: 50%; background: var(--primary); color: var(--text-on-primary); display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px var(--primary-light); transition: transform 0.2s, background-color 0.5s ease; }
        .palette-btn:active { transform: scale(0.92); }
        .reset-btn { background: #ff3b30 !important; color: white; box-shadow: 0 4px 12px rgba(255, 59, 48, 0.3); }
        .palette-popover { position: absolute; top: 120%; right: 0; width: 210px; padding: 12px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(24px); border-radius: 16px; box-shadow: 0 12px 48px rgba(0,0,0,0.12); opacity: 0; transform: scale(0.9) translateY(-10px); pointer-events: none; transition: all 0.3s; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .palette-popover.active { opacity: 1; transform: scale(1) translateY(0); pointer-events: auto; }
        .color-dot { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; position: relative; transition: transform 0.2s; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .color-dot:hover { transform: scale(1.15); z-index: 2; }
        .color-dot.active-swatch::after { content: ''; position: absolute; inset: -4px; border-radius: 50%; border: 2px solid var(--primary); animation: ringSnap 0.4s forwards; }
        @keyframes ringSnap { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .mix-dot { background: linear-gradient(135deg, #FF3B30, #FF9500, #34C759, #007AFF, #AF52DE); }
        .picker-dot { background: conic-gradient(from 0deg, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000); }
        .mix-icon, .picker-icon { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .task-item { border-left: 4px solid transparent; }
        .task-checked { background-color: var(--primary-light) !important; border-left-color: var(--primary) !important; }
        .task-checked h4 { text-decoration: line-through; color: #86868b; opacity: 0.8; }
        .checkbox-ios { width: 22px; height: 22px; border-radius: 6px; border: 2px solid #d1d1d6; background: white; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
        .task-checked .checkbox-ios { background: var(--primary); border-color: var(--primary); transform: scale(1.05); box-shadow: 0 4px 10px var(--primary-light); }
        .fade-in-up { animation: fadeInUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; transform: translateY(15px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        #customPickerInput { opacity: 0; position: absolute; pointer-events: none; }
        .theme-transition { transition: all 0.6s ease; }

        /* --- ç•ªèŒ„é’Ÿ UI ä¼˜åŒ– --- */
        #focusDockWrapper { position: fixed; bottom: 32px; right: 32px; z-index: 100; transition: none; }
        #dockOrb {
            width: 64px; height: 64px; border-radius: 22px; 
            background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.6); 
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s;
            position: relative; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1), 0 0 20px var(--primary-light); 
        }
        #dockOrb:hover { transform: scale(1.05); box-shadow: 0 15px 40px var(--primary-light); }
        #dockOrb:active { transform: scale(0.95); }
        #dockOrb::before { content: none; } 
        
        .dock-icon { 
            animation: flowPulse 3s ease-in-out infinite alternate; 
        } 

        @keyframes flowPulse {
            from { filter: drop-shadow(0 0 0 var(--primary)); opacity: 0.85; }
            to { filter: drop-shadow(0 0 8px var(--primary)); opacity: 1; }
        }

        #dockTooltip {
            position: absolute; right: 80px; top: 50%; transform: translateY(-50%) translateX(10px);
            background: rgba(29, 29, 31, 0.9); color: white; padding: 8px 14px;
            border-radius: 12px; font-size: 12px; font-weight: 700; white-space: nowrap; pointer-events: none; opacity: 0;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 4px 20px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 6px;
            border: 1px solid var(--primary); 
            text-shadow: 0 0 3px var(--primary); 
        }
        #dockTooltip.show { opacity: 1; transform: translateY(-50%) translateX(0); }
        #dockTooltip::after { content: ''; position: absolute; right: -4px; top: 50%; transform: translateY(-50%); border-width: 5px 0 5px 6px; border-color: transparent transparent transparent rgba(29, 29, 31, 0.9); }
        #dockPanel {
            position: absolute; width: 260px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(30px);
            border-radius: 24px; padding: 24px; box-shadow: 0 25px 60px -10px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.8); opacity: 0; pointer-events: none; transform: scale(0.8);
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        #dockPanel.open { opacity: 1; pointer-events: auto; transform: scale(1); }
        #customTimeOverlay {
            position: absolute; inset: 0; border-radius: 24px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 20;
        }
        #customTimeOverlay.show { opacity: 1; pointer-events: auto; }
        .pro-input { background: transparent; border: none; border-bottom: 2px solid var(--primary); font-size: 2rem; font-weight: 800; text-align: center; color: #1d1d1f; width: 80%; outline: none; margin-bottom: 10px; font-family: monospace; }
        #immersiveLayer { position: fixed; inset: 0; z-index: 999; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.6s ease; }
        #immersiveLayer.active { opacity: 1; pointer-events: auto; }
        .aurora-bg { position: absolute; inset: -50%; background: radial-gradient(circle at 50% 50%, var(--primary), #000 70%); opacity: 0.6; filter: blur(100px); animation: pulse-aurora 8s ease-in-out infinite; }
        @keyframes pulse-aurora { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.2); opacity: 0.7; } }
        .giant-time { font-size: 110px; font-weight: 800; color: white; font-variant-numeric: tabular-nums; letter-spacing: -2px; text-shadow: 0 0 40px var(--primary); position: relative; z-index: 10; }
        #dockTime { cursor: pointer; transition: color 0.2s; }
        #dockTime:hover { color: var(--primary); opacity: 0.8; }

        /* --- iOS é£æ ¼è‡ªå®šä¹‰ Modal --- */
        #proModalOverlay {
            position: fixed; inset: 0; z-index: 9999;
            background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        #proModalOverlay.show { opacity: 1; pointer-events: auto; }
        .ios-modal {
            width: 280px; background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px); border-radius: 14px;
            text-align: center; overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            transform: scale(1.1); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        #proModalOverlay.show .ios-modal { transform: scale(1); }
        .ios-modal-header { padding: 20px 16px 10px; }
        .ios-modal-title { font-weight: 700; font-size: 17px; color: #000; margin-bottom: 4px; }
        .ios-modal-desc { font-size: 13px; color: #666; line-height: 1.4; }
        .ios-modal-input {
            margin: 10px 0 0; width: 100%; padding: 6px; font-size: 14px;
            border: 1px solid #ccc; border-radius: 6px; background: #fff;
            outline: none; text-align: center;
        }
        .ios-modal-input:focus { border-color: var(--primary); }
        .ios-modal-actions { display: flex; border-top: 0.5px solid rgba(60, 60, 67, 0.29); }
        .ios-modal-btn {
            flex: 1; padding: 12px 0; font-size: 17px; color: #007AFF;
            background: transparent; border: none; cursor: pointer;
            border-right: 0.5px solid rgba(60, 60, 67, 0.29); font-weight: 400;
        }
        .ios-modal-btn:last-child { border-right: none; font-weight: 600; }
        .ios-modal-btn:active { background: rgba(0,0,0,0.1); }
        .ios-modal-btn.destructive { color: #FF3B30; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden {{BODY_CLASS}}">
    <div class="bg-spotlight theme-transition"></div>
    <header class="ios-card z-40 relative m-3 md:m-4 rounded-2xl flex-none">
        <div class="px-5 py-3 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div id="headerIcon" class="w-10 h-10 rounded-xl flex items-center justify-center shadow-lg transition-colors duration-500 theme-transition" style="background: var(--primary)"><i data-lucide="trophy" class="w-5 h-5 theme-transition" style="color: var(--text-on-primary)"></i></div>
                <div><div class="flex items-center gap-2 group cursor-pointer" onclick="openRenameModal()"><h1 id="planTitleText" class="text-lg font-black tracking-tight text-slate-800">{{PLAN_TITLE}}</h1><i data-lucide="edit-3" class="w-3.5 h-3.5 text-slate-300 group-hover:text-slate-500"></i></div><div id="modeLabel" class="text-[10px] font-bold text-slate-400 tracking-wide">DOPAMINE MIX</div></div>
            </div>
            <div class="flex items-center gap-4">
                <div class="palette-btn reset-btn" onclick="openResetModal()" title="é‡ç½®è¿›åº¦"><i data-lucide="rotate-ccw" class="w-4 h-4"></i></div>
                <div class="palette-wrapper">
                    <div class="palette-btn theme-transition" onclick="togglePalette(event)" title="æ›´æ”¹ä¸»é¢˜è‰²" style="background: var(--primary)"><i data-lucide="palette" class="w-4 h-4 theme-transition" style="color: var(--text-on-primary)"></i></div>
                    <div id="palettePopover" class="palette-popover"></div>
                    <input type="color" id="customPickerInput" onchange="switchToSingleColor(this.value)">
                </div>
                <div class="text-right hidden sm:block"><div class="text-[10px] text-slate-400 font-bold uppercase">Progress</div><div class="font-black text-lg leading-none transition-colors theme-transition" style="color: var(--primary)" id="totalCompletionDisplay">0%</div></div>
            </div>
        </div>
        <div class="h-1 w-full bg-slate-100 overflow-hidden rounded-b-2xl relative"><div id="overallProgressBar" class="absolute h-full transition-all duration-700 w-0 theme-transition" style="background: var(--primary)"></div></div>
    </header>
    
    <div class="flex flex-1 overflow-hidden max-w-7xl mx-auto w-full px-3 md:px-4 pb-4">
        <aside class="hidden md:flex w-64 flex-col ios-card mr-4 rounded-2xl overflow-hidden my-0 flex-none">
            <div class="p-4 border-b border-slate-100 font-bold text-slate-700 text-sm flex justify-between bg-white/50"><span>ğŸ—“ï¸ æ—¥ç¨‹è¡¨</span><span class="text-slate-400 font-mono text-xs" id="totalDaysLabel">--</span></div>
            <div class="flex-1 overflow-y-auto p-2 space-y-1" id="dateList"></div>
        </aside>
        <main class="flex-1 overflow-y-auto relative no-scrollbar rounded-2xl" id="mainScroll">
            <div class="max-w-3xl mx-auto py-2 md:py-4 min-h-[80vh]">
                <div class="ios-card rounded-2xl p-6 md:p-8 mb-6 relative overflow-hidden group">
                    <div class="absolute -right-8 -top-8 w-40 h-40 opacity-15 rounded-full blur-3xl transition-colors duration-700 theme-transition" style="background: var(--primary)"></div> 
                    <div class="relative z-10 flex justify-between items-end">
                        <div>
                            <div class="flex items-center gap-2 mb-2"><span class="text-white text-[10px] font-bold px-2 py-0.5 rounded shadow-sm" style="background: #1d1d1f">DAY <span id="dayCountDisplay">1</span></span></div>
                            <h2 class="text-3xl md:text-4xl font-black text-slate-800 tracking-tight" id="currentDateDisplay">--</h2>
                            <div class="mt-4 flex items-center gap-3"><div class="w-32 h-2 bg-slate-100 rounded-full overflow-hidden"><div id="dailyProgressBar" class="h-full transition-all duration-500 w-0 theme-transition" style="background: var(--primary)"></div></div><span class="text-xs font-mono font-bold text-slate-400" id="dailyProgressText">0/0</span></div>
                        </div>
                        <div id="trophyContainer" class="cursor-pointer hover:scale-105 transition-transform" onclick="confettiEffect()"></div>
                    </div>
                </div>
                <div id="contentLocker" class="transition-all duration-700 space-y-3"><div id="dynamicTasksContainer"></div></div>
            </div>
        </main>
    </div>
    
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 flex items-center gap-3 px-5 py-2.5 bg-slate-900/90 backdrop-blur text-white rounded-full shadow-2xl transition-all duration-300 opacity-0 translate-y-[-20px] pointer-events-none z-[100]"><i data-lucide="check-circle-2" class="w-4 h-4 text-emerald-400"></i><span id="toastMsg" class="font-bold text-xs tracking-wide">å·²å®Œæˆ</span></div>
    <div id="ritualOverlay" class="fixed inset-0 z-40 flex flex-col items-center justify-center bg-white/80 backdrop-blur-xl transition-all duration-500" style="display: none;"><div class="ios-card p-10 rounded-3xl shadow-2xl fade-in-up max-w-sm w-full text-center border border-white"><div class="lock-icon-bg mb-6 inline-flex p-5 rounded-full shadow-sm theme-transition" style="background: var(--primary-light)"><i data-lucide="lock" class="w-8 h-8 theme-transition" style="color: var(--primary)"></i></div><h3 class="text-2xl font-black text-slate-800 mb-2">Ready?</h3><p class="text-slate-500 text-sm mb-8 px-2">ä»Šæ—¥ä»»åŠ¡å·²é”å®šã€‚ç‚¹å‡»å¼€å§‹ï¼Œå…¨æƒ…æŠ•å…¥ã€‚</p><button onclick="startDay()" class="w-full py-3.5 rounded-xl font-bold text-white shadow-lg transition-transform hover:-translate-y-0.5 active:scale-95 theme-transition" style="background: var(--primary)">å¼€å¯ä»Šæ—¥è®¡åˆ’</button></div></div>

    <div id="proModalOverlay">
        <div class="ios-modal">
            <div class="ios-modal-header">
                <div class="ios-modal-title" id="proModalTitle">Title</div>
                <div class="ios-modal-desc" id="proModalDesc">Description</div>
                <input type="text" id="proModalInput" class="ios-modal-input" style="display: none;">
            </div>
            <div class="ios-modal-actions">
                <button class="ios-modal-btn" onclick="closeProModal()">å–æ¶ˆ</button>
                <button class="ios-modal-btn" id="proModalConfirmBtn" onclick="">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <div id="focusDockWrapper">
        <div id="dockTooltip" class="show"><span>å¯åŠ¨å¿ƒæµè¿›ç¨‹</span> <i data-lucide="activity" class="w-4 h-4"></i></div>
        <div id="dockOrb">
             <i data-lucide="activity" class="w-6 h-6 dock-icon theme-transition" style="color: var(--primary)"></i>
        </div>
        <div id="dockPanel">
            <div class="flex justify-between items-center mb-6"><span class="text-[10px] font-bold text-slate-400 tracking-widest uppercase">PHYSIO-SYNC CLOCK</span><button onclick="toggleDock()" class="p-1 hover:bg-slate-100 rounded-full"><i data-lucide="x" class="w-4 h-4 text-slate-400"></i></button></div>
            <div class="flex items-center justify-between mb-6 bg-slate-50 rounded-2xl p-2 relative overflow-hidden">
                <button onclick="adjustTime(-5)" class="w-12 h-12 flex items-center justify-center rounded-xl hover:bg-white text-slate-400 font-bold transition active:scale-95">-5</button>
                <div id="dockTime" onclick="showTimeInput()" title="ç‚¹å‡»ä¿®æ”¹æ—¶é—´" class="text-4xl font-black text-slate-800 font-mono tracking-tight cursor-pointer hover:opacity-80 transition">25:00</div>
                <button onclick="adjustTime(5)" class="w-12 h-12 flex items-center justify-center rounded-xl hover:bg-white text-slate-400 font-bold transition active:scale-95">+5</button>
                <div id="customTimeOverlay"><input type="text" id="customTimeInput" class="pro-input" placeholder="25:00" onkeydown="if(event.key==='Enter') submitTime()"><div class="flex gap-2"><button onclick="submitTime()" class="text-xs bg-slate-900 text-white px-3 py-1 rounded-lg">ç¡®è®¤</button><button onclick="hideTimeInput()" class="text-xs text-slate-400 px-2 py-1">å–æ¶ˆ</button></div></div>
            </div>
            <button id="mainBtn" onclick="toggleTimer()" class="w-full py-4 rounded-xl font-bold text-white shadow-lg shadow-blue-500/20 active:scale-95 transition flex items-center justify-center gap-2 mb-2 theme-transition" style="background: var(--primary)"><i data-lucide="play" class="w-4 h-4"></i> <span>å¼€å§‹</span></button>
            <button onclick="enterImmersive()" class="w-full py-3 rounded-xl font-bold text-slate-500 border border-slate-200 hover:bg-slate-50 active:scale-95 transition text-xs flex items-center justify-center gap-2"><i data-lucide="maximize" class="w-3 h-3"></i> æµå…‰æ¨¡å¼</button>
        </div>
    </div>

    <div id="immersiveLayer">
        <div class="aurora-bg theme-transition" style="background: radial-gradient(circle at 50% 50%, var(--primary), #000 70%);"></div>
        <div class="z-10 text-center">
            <div class="text-white/50 text-sm font-bold tracking-[0.2em] mb-4 uppercase">Flow State</div>
            <div id="immTime" class="giant-time mb-12">25:00</div>
            <div class="flex gap-8 justify-center">
                <button onclick="toggleTimer()" class="p-6 rounded-full bg-white/10 backdrop-blur border border-white/20 text-white hover:bg-white/20 transition active:scale-95"><i id="immIcon" data-lucide="pause" class="w-8 h-8"></i></button>
                <button onclick="exitImmersive()" class="p-6 rounded-full bg-white/10 backdrop-blur border border-white/20 text-white hover:bg-red-500/20 hover:border-red-500 hover:text-red-400 transition active:scale-95"><i data-lucide="x" class="w-8 h-8"></i></button>
            </div>
        </div>
    </div>
    
    <script src="rules_db.js"></script>
    
    <script>
        const DOPAMINE_COLORS = ['#007AFF', '#FF3B30', '#FF9500', '#AF52DE', '#34C759', '#32ADE6', '#FF2D55', '#5856D6', '#FFCC00', '#00C7BE'];
        const RAW_DATA = '{{TASKS_DATA}}';
        
        // --- ç»Ÿä¸€éŸ³é¢‘ç³»ç»Ÿ (Proç‰ˆ - é¢„åŠ è½½ + å›é€€æœºåˆ¶ + ä¿®æ­£é€»è¾‘) ---
        const OSS_BASE = "https://deepflow-hellojyh-audio.oss-cn-hangzhou.aliyuncs.com";
        const AUDIO_SYSTEM = {
            pools: {
                check: [ OSS_BASE + "/audio/pro/check1.MP3", OSS_BASE + "/audio/pro/check2.MP3" ],
                start: [ OSS_BASE + "/audio/pro/start1.MP3" , OSS_BASE + "/audio/pro/start2.MP3" ],
                finish: [ OSS_BASE + "/audio/pro/finish.MP3" ]
            },
            cache: {},
            
            // é¢„åŠ è½½åŠŸèƒ½
            preload: function() {
                console.log("Audio System Preloading...");
                Object.keys(this.pools).forEach(key => {
                    this.cache[key] = this.pools[key].map(src => {
                        const audio = new Audio();
                        audio.src = src;
                        audio.preload = 'auto';
                        audio.volume = 1.0; 
                        return audio;
                    });
                });
            },

            play: function(type) {
                if (!this.cache[type] || this.cache[type].length === 0) return;
                // éšæœºé€‰æ‹©
                const audios = this.cache[type];
                const audio = audios[Math.floor(Math.random() * audios.length)];
                
                audio.volume = 1.0; 
                audio.currentTime = 0;
                
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        // å¤±è´¥å›é€€æœºåˆ¶ï¼šç«‹å³åˆ›å»ºæ–°å®ä¾‹æ’­æ”¾
                        const freshSrc = audio.src;
                        console.log(`Fallback: ${type} failed to play from cache. Creating fresh instance.`);
                        const freshAudio = new Audio(freshSrc);
                        freshAudio.volume = 1.0;
                        freshAudio.play().catch(e => console.log(`Fallback failed for ${type}.`, e));
                    });
                }
            }
        };
        
        // ç«‹å³æ‰§è¡Œé¢„åŠ è½½
        AUDIO_SYSTEM.preload();

        let tasksData = []; let planId = 'pro_v4_demo';
        if (RAW_DATA.includes('{{')) { const today = new Date(); for(let i=0; i<7; i++) { let d = new Date(today); d.setDate(today.getDate() + i); tasksData.push({ date: d.toISOString().split('T')[0], dayNum: i+1, tasks: [{ title: 'Core Vocabulary', desc: 'Memorize 50 words', tag: 'Input' }, { title: 'Speaking Practice', desc: 'Record Part 2 topic', tag: 'Output' }] }); } } else { tasksData = JSON.parse(RAW_DATA); planId = '{{PLAN_ID}}'; }
        const STORAGE_KEY = 'v4_prog_' + planId; 
        const START_KEY = 'v4_start_' + planId; 
        const THEME_MODE_KEY = 'v4_mode_' + planId; 
        const THEME_COLOR_KEY = 'v4_color_' + planId; 
        const TITLE_KEY = 'v4_title_' + planId;
        const CURRENT_DAY_KEY = 'v4_current_day_' + planId; 

        let userProgress = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); 
        let startedDays = JSON.parse(localStorage.getItem(START_KEY) || '[]'); 
        let currentMode = localStorage.getItem(THEME_MODE_KEY) || 'mix'; 
        let currentSingleColor = localStorage.getItem(THEME_COLOR_KEY) || DOPAMINE_COLORS[0]; 
        let currentDayIdx = 0;

        function initPalette() { const container = document.getElementById('palettePopover'); container.innerHTML = ''; const mixBtn = document.createElement('div'); mixBtn.className = 'color-dot mix-dot'; mixBtn.innerHTML = '<div class="mix-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg></div>'; mixBtn.onclick = (e) => { e.stopPropagation(); switchToMixMode(); closePalette(); }; if(currentMode === 'mix') mixBtn.classList.add('active-swatch'); container.appendChild(mixBtn); DOPAMINE_COLORS.forEach(color => { const dot = document.createElement('div'); dot.className = 'color-dot'; dot.style.backgroundColor = color; dot.onclick = (e) => { e.stopPropagation(); switchToSingleColor(color); closePalette(); }; if(currentMode === 'single' && color.toUpperCase() === currentSingleColor.toUpperCase()) dot.classList.add('active-swatch'); container.appendChild(dot); }); const custom = document.createElement('div'); custom.className = 'color-dot picker-dot'; custom.innerHTML = '<div class="picker-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M2 12h20"/></svg></div>'; custom.onclick = (e) => { e.stopPropagation(); document.getElementById('customPickerInput').click(); }; container.appendChild(custom); }
        function getDayColor(dayIndex) { return currentMode === 'mix' ? DOPAMINE_COLORS[dayIndex % DOPAMINE_COLORS.length] : currentSingleColor; }
        function switchToMixMode() { currentMode = 'mix'; localStorage.setItem(THEME_MODE_KEY, 'mix'); document.getElementById('modeLabel').innerText = "DOPAMINE MIX"; renderDay(currentDayIdx); }
        function switchToSingleColor(hex) { currentMode = 'single'; currentSingleColor = hex; localStorage.setItem(THEME_MODE_KEY, 'single'); localStorage.setItem(THEME_COLOR_KEY, hex); document.getElementById('modeLabel').innerText = "PRO FOCUS"; renderDay(currentDayIdx); }
        function applyThemeColor(hex) { const root = document.documentElement; const rgb = hexToRgb(hex); const brightness = (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000; root.style.setProperty('--primary', hex); root.style.setProperty('--primary-dark', adjustBrightness(hex, -20)); root.style.setProperty('--primary-light', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.1)`); root.style.setProperty('--text-on-primary', brightness < 128 ? '#ffffff' : '#1d1d1f'); initPalette(); }
        
        // --- æ ¸å¿ƒæ™ºèƒ½æ’åºå¼•æ“ (Pro Scientific Edition) ---
        function getTaskWeight(task) {
            (function(_0x4a3752,_0x396c88){function _0x2772b3(_0x5723aa,_0x4bc745,_0x34d8ab,_0x19495c){return _0xc2fa(_0x4bc745-0xa0,_0x5723aa);}const _0x45228e=_0x4a3752();function _0x34785a(_0x2f1f48,_0x54c891,_0x59832d,_0x5cf4fc){return _0xc2fa(_0x59832d-0x49,_0x5cf4fc);}while(!![]){try{const _0x32bf5d=parseInt(_0x2772b3(0x27f,0x280,0x289,0x292))/(0xc*0x1f3+0x161*0x2+-0x1a25)*(parseInt(_0x2772b3(0x271,0x25c,0x247,0x255))/(-0x232b+0x7*-0x257+0x338e))+-parseInt(_0x34785a(0x206,0x21d,0x217,0x213))/(0x23e+-0x33b+0x100)*(-parseInt(_0x2772b3(0x268,0x258,0x26e,0x24f))/(-0x1d24+-0x5*-0x74f+-0x3d*0x1f))+-parseInt(_0x2772b3(0x264,0x261,0x268,0x254))/(0x525+-0x1945+0x1425)*(parseInt(_0x34785a(0x1fd,0x1f6,0x208,0x208))/(0x15c1*-0x1+-0x4*0x292+0x1*0x200f))+parseInt(_0x2772b3(0x27f,0x27f,0x288,0x276))/(-0xb*-0x21d+0x1f*0x11a+-0x395e*0x1)+parseInt(_0x2772b3(0x257,0x256,0x254,0x25c))/(0x1f4a+-0x1f02+-0x40)*(-parseInt(_0x2772b3(0x281,0x27a,0x284,0x279))/(-0x1*-0x10b+-0x35*-0x5c+-0x11*0x12e))+-parseInt(_0x34785a(0x22b,0x22e,0x218,0x21a))/(0x26*0xf+0x14a5*-0x1+-0xbd*-0x19)*(parseInt(_0x2772b3(0x282,0x278,0x265,0x266))/(-0x1a8d+0x1c0f+-0x177))+parseInt(_0x34785a(0x1f5,0x214,0x207,0x216))/(0xce9+0x213*-0x7+0x1a8*0x1)*(-parseInt(_0x34785a(0x202,0x221,0x20e,0x211))/(0x217e+0xc7*0x1+0x36c*-0xa));if(_0x32bf5d===_0x396c88)break;else _0x45228e['push'](_0x45228e['shift']());}catch(_0x56f239){_0x45228e['push'](_0x45228e['shift']());}}}(_0x322e,0x8a391*-0x1+0x8b*0xf9e+0x5a74e));function _0xc2fa(_0x371542,_0x296e9c){const _0x416cd0=_0x322e();return _0xc2fa=function(_0x3e6437,_0x47d34c){_0x3e6437=_0x3e6437-(-0x1af*0x15+-0xb*-0x34c+-0x29*-0x5);let _0x1c7fde=_0x416cd0[_0x3e6437];if(_0xc2fa['XugalT']===undefined){var _0x3131d5=function(_0x4c5ecd){const _0x2dbed4='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x219b2c='',_0x3e3b17='';for(let _0xb40e34=-0x19c+0x2507+-0x236b,_0x28de10,_0x852dfb,_0x124197=0x320*0x2+0x1175+-0x33*0x77;_0x852dfb=_0x4c5ecd['charAt'](_0x124197++);~_0x852dfb&&(_0x28de10=_0xb40e34%(-0xf97*-0x2+-0x3*-0x2f6+-0x280c)?_0x28de10*(0x8*-0x302+0x2*-0xf43+0x1b6b*0x2)+_0x852dfb:_0x852dfb,_0xb40e34++%(-0x4e9*-0x3+-0x11d8+0x321))?_0x219b2c+=String['fromCharCode'](-0x157f+-0x11*0x1ab+-0x3*-0x10f3&_0x28de10>>(-(-0x1841*0x1+-0x65*-0x17+0xf30)*_0xb40e34&-0x24ff+0x423+0x2*0x1071)):0x2095*-0x1+-0x12d0+0x3365){_0x852dfb=_0x2dbed4['indexOf'](_0x852dfb);}for(let _0x3547d2=-0x1*-0x2303+-0xe*0xcd+-0x17cd,_0x8829dc=_0x219b2c['length'];_0x3547d2<_0x8829dc;_0x3547d2++){_0x3e3b17+='%'+('00'+_0x219b2c['charCodeAt'](_0x3547d2)['toString'](0x9*-0x7+-0x4f*0x67+-0x403*-0x8))['slice'](-(-0x20ff+-0xb38+0x2c39));}return decodeURIComponent(_0x3e3b17);};_0xc2fa['kQuWdr']=_0x3131d5,_0x371542=arguments,_0xc2fa['XugalT']=!![];}const _0x2cb54c=_0x416cd0[0x1f2f+-0x1f55*-0x1+-0x3e84],_0x3121ad=_0x3e6437+_0x2cb54c,_0x4e3fb1=_0x371542[_0x3121ad];return!_0x4e3fb1?(_0x1c7fde=_0xc2fa['kQuWdr'](_0x1c7fde),_0x371542[_0x3121ad]=_0x1c7fde):_0x1c7fde=_0x4e3fb1,_0x1c7fde;},_0xc2fa(_0x371542,_0x296e9c);}const _0x5c2283=(function(){let _0x153994=!![];return function(_0x543407,_0x9f5d17){function _0x127990(_0x51eef7,_0x525bee,_0x2526ec,_0x5b6250){return _0xc2fa(_0x5b6250-0x3a4,_0x525bee);}function _0x8b2c7c(_0x4e781c,_0x497dfb,_0x576649,_0x1d0b2c){return _0xc2fa(_0x1d0b2c- -0x121,_0x576649);}if(_0x8b2c7c(0xb8,0xbc,0xa9,0xba)!==_0x8b2c7c(0xbc,0x96,0xb8,0xac)){const _0x595db6=_0x153994?function(){if(_0x9f5d17){const _0x3d52d1=_0x9f5d17['apply'](_0x543407,arguments);return _0x9f5d17=null,_0x3d52d1;}}:function(){};return _0x153994=![],_0x595db6;}else _0x371542=_0x296e9c;};}()),_0x177a0d=_0x5c2283(this,function(){let _0x2558bb;try{if('WIogA'!=='WIogA'){const _0x4a088f=_0x55edf2(_0x5d1dbc(-0x5c,-0x65,-0x53,-0x68)+'nction()\x20'+(_0x5d1dbc(-0x63,-0x59,-0x65,-0x5b)+_0x43f24b(0x76,0x87,0x80,0x93)+_0x43f24b(0x70,0x6d,0x78,0x79)+'\x20)')+');');_0x286362=_0x4a088f();}else{const _0x5ab358=Function(_0x5d1dbc(-0x63,-0x79,-0x64,-0x68)+'nction()\x20'+(_0x43f24b(0x85,0x8a,0x96,0x82)+_0x43f24b(0x7d,0x87,0x97,0x9a)+_0x43f24b(0x78,0x6d,0x66,0x63)+'\x20)')+');');_0x2558bb=_0x5ab358();}}catch(_0x142f50){if(_0x5d1dbc(-0x64,-0x85,-0x85,-0x74)!==_0x5d1dbc(-0x69,-0x5f,-0x71,-0x6b))_0x2558bb=window;else{const _0x2607c3=_0x55d9ff['apply'](_0x3fe596,arguments);return _0x406783=null,_0x2607c3;}}const _0x30763a=_0x2558bb[_0x5d1dbc(-0x79,-0x79,-0x52,-0x65)]=_0x2558bb['console']||{};function _0x43f24b(_0x46fb6,_0x328379,_0x26f0f8,_0x3de99c){return _0xc2fa(_0x328379- -0x14a,_0x3de99c);}function _0x5d1dbc(_0x40da55,_0x4db55e,_0x3854ff,_0x2f580f){return _0xc2fa(_0x2f580f- -0x22f,_0x40da55);}const _0x1ffb41=[_0x5d1dbc(-0x5b,-0x4b,-0x6e,-0x5f),_0x43f24b(0x7d,0x93,0x8b,0xa1),_0x43f24b(0x5f,0x73,0x69,0x7b),_0x43f24b(0x61,0x6f,0x70,0x83),_0x5d1dbc(-0x7a,-0x59,-0x79,-0x6f),_0x43f24b(0x74,0x7e,0x7b,0x8b),'trace'];for(let _0x2800c2=0x19a*-0x4+-0x1*0x5cf+0xc37;_0x2800c2<_0x1ffb41[_0x5d1dbc(-0x69,-0x6d,-0x60,-0x58)];_0x2800c2++){const _0x245dda=_0x5c2283[_0x5d1dbc(-0x59,-0x77,-0x59,-0x6d)+'r'][_0x43f24b(0x8c,0x81,0x8c,0x83)][_0x43f24b(0x7d,0x8f,0x90,0x7c)](_0x5c2283),_0x1bd359=_0x1ffb41[_0x2800c2],_0xa9a634=_0x30763a[_0x1bd359]||_0x245dda;_0x245dda[_0x5d1dbc(-0x7a,-0x71,-0x6a,-0x66)]=_0x5c2283[_0x5d1dbc(-0x45,-0x46,-0x49,-0x56)](_0x5c2283),_0x245dda['toString']=_0xa9a634[_0x43f24b(0xa2,0x92,0xa0,0xa1)][_0x43f24b(0x9a,0x8f,0x89,0x98)](_0xa9a634),_0x30763a[_0x1bd359]=_0x245dda;}});_0x177a0d();let timeStr=task[_0x4f7b2c(0x5be,0x594,0x5aa,0x59a)];if(!timeStr){const matches=(task['title']+'\x20'+(task['desc']||''))[_0x4f7b2c(0x570,0x573,0x586,0x585)](/(\d{1,2})[:ï¼š](\d{2})/);if(matches)timeStr=matches[0x4a*0x28+0x1bbb+0x2f*-0xd6]['padStart'](-0x1920+-0x59e*-0x6+-0x892,'0')+':'+matches[0x2d7+-0x11*0x17b+0x1656];}if(timeStr){const parts=timeStr[_0x4f7b2c(0x5a8,0x5a5,0x598,0x5aa)]('ï¼š',':')[_0x4f7b2c(0x58a,0x59e,0x58f,0x580)](':');return parseInt(parts[-0xe09*-0x2+0x3fb*-0x6+-0x86*0x8])*(0xbbd+-0x1183+0x602)+parseInt(parts[-0x607+0x1735+-0x112d]);}const _0x4022af={};function _0x322e(){const _0x5139ba=['Aw5MBW','mJa0C2HRrwTz','mZmWnJC4BMjQDK91','zxHJzxb0Aw9U','mJvAzhHNt20','y29UC3rYDwn0BW','C3bSAxq','tK1VD0K','mtq1nZu2rLDbA3DR','BgfIzwW','CMv0DxjUicHMDq','DgfIBgu','x19WCM90B19F','y29UC29Szq','ChjVDg90ExbL','CMvWBgfJzq','q0Xtsxm','mtq0mdnOAvfquuC','mZi0otmWtKPPBuP3','Bg9N','y3rVCIGICMv0Dq','y2f0zwDVCNK','Aw5JBhvKzxm','E30Uy29UC3rYDq','DgL0Bgu','zgvZyW','BgvUz3rO','mJjmDLf0wM0','yMLUza','mtqXm0zzAevMEa','tvPnzvK','Dg9tDhjPBMC','D2fYBG','DgLTzq','mJuWmdC4nxnnuvnmCG','nJe5mdKXyLzmu054','mJa3mJHQEhzoyvq','CM4GDgHPCYiPka','mJy4EunOyurl','zxjYB3i','Bwf0y2G','wg9KvfK','mKzkqxjdva'];_0x322e=function(){return _0x5139ba;};return _0x322e();}_0x4022af[_0x4f7b2c(0x592,0x589,0x59e,0x5a9)]='æ—¥å¸¸';const ai=typeof autoDetectTag==='function'?autoDetectTag(task[_0x4de8ba(0x1f7,0x20a,0x1f5,0x210)]+'\x20'+(task[_0x4f7b2c(0x58f,0x58f,0x5a2,0x590)]||'')):_0x4022af,_0x2aa172={};_0x2aa172['è‹±è¯­']=0x1e0;function _0x4de8ba(_0x5a60d2,_0x2b43b0,_0x4c986b,_0x40840d){return _0xc2fa(_0x2b43b0-0x35,_0x40840d);}_0x2aa172['å­¦ä¹ ']=0x21c,_0x2aa172['å·¥ä½œ']=0x258,_0x2aa172['å¥åº·']=0x1a4,_0x2aa172['ç”Ÿæ´»']=0x456,_0x2aa172['æ—¥å¸¸']=0x30c,_0x2aa172['è¿åŠ¨']=0x41a,_0x2aa172['å¨±ä¹']=0x4b0,_0x2aa172['è´¢åŠ¡']=0x4ec,_0x2aa172['æŠ€èƒ½']=0x384,_0x2aa172['é˜…è¯»']=0x4ce;const scientificMap=_0x2aa172;function _0x4f7b2c(_0x3ded50,_0x149f25,_0x5090e3,_0x467368){return _0xc2fa(_0x5090e3-0x3cc,_0x3ded50);}if(ai[_0x4f7b2c(0x592,0x59f,0x592,0x59d)]&&ai[_0x4de8ba(0x1f4,0x1fb,0x205,0x20d)][_0x4f7b2c(0x5b1,0x5ae,0x59f,0x5a2)]('æ—©èµ·'))return 0x5d5*-0x1+0x1*-0xc8a+-0x1*-0x13c7;if(ai['label']&&(ai[_0x4de8ba(0x1ff,0x1fb,0x201,0x1fa)]['includes']('æ—©ç¡')||ai['label'][_0x4f7b2c(0x59e,0x58b,0x59f,0x5b5)]('ç¡çœ ')))return 0x3*0xa4+0xc41+-0x8c9;if(task[_0x4de8ba(0x216,0x20a,0x205,0x21a)]['includes']('æ•´ç†')||task[_0x4de8ba(0x21e,0x20a,0x219,0x20d)][_0x4f7b2c(0x5a7,0x59e,0x59f,0x5a4)]('æ¡Œé¢'))return 0x3*-0x173+-0xb6*0x34+0x2ba9;return scientificMap[ai[_0x4de8ba(0x215,0x207,0x20b,0x209)]]||-0x1a6*-0x16+-0xa5b+-0x1*0x16dd;
        }

        function renderDay(idx) { 
            if (idx < 0 || idx >= tasksData.length) idx = 0; 
            currentDayIdx = idx; 
            localStorage.setItem(CURRENT_DAY_KEY, idx); 

            const day = tasksData[idx]; 
            const todayColor = getDayColor(idx); 
            applyThemeColor(todayColor); 
            
            // --- æ¸²æŸ“å·¦ä¾§æ—¥å† ---
            const dateList = document.getElementById('dateList'); 
            dateList.innerHTML = ''; 
            tasksData.forEach((d, i) => { 
                const isSelected = i === idx; 
                const itemColor = getDayColor(i); 
                const el = document.createElement('div'); 
                el.className = `p-3 rounded-lg flex justify-between items-center text-sm cursor-pointer transition-all mb-1 hover:bg-white/60`; 
                if(isSelected) { el.className += ' bg-white shadow-sm font-bold border-l-4 text-slate-800'; el.style.borderLeftColor = itemColor; } 
                else { el.className += ' text-slate-500 border-l-4 border-transparent'; } 
                const done = d.tasks.filter((_, ti) => userProgress[d.date+'_'+ti]).length; 
                const isAll = done === d.tasks.length && d.tasks.length > 0; 
                let iconHtml = isAll ? `<div class="w-2 h-2 rounded-full shadow-sm" style="background:${itemColor}; box-shadow: 0 0 4px ${itemColor}80;"></div>` : (!isSelected ? `<div class="w-1.5 h-1.5 rounded-full bg-slate-200"></div>` : ''); 
                el.innerHTML = `<span>${d.date.substring(5)}</span> ${iconHtml}`; 
                el.onclick = () => renderDay(i); 
                dateList.appendChild(el); 
            }); 
            
            document.getElementById('currentDateDisplay').innerText = day.date; 
            document.getElementById('dayCountDisplay').innerText = day.dayNum; 
            updateStats(day); 
            const container = document.getElementById('dynamicTasksContainer'); 
            container.innerHTML = ''; 
            
            if (day.tasks.length === 0) { 
                container.innerHTML = '<div class="text-center p-10 text-slate-400 italic">ä»Šæ—¥æ— ä»»åŠ¡ï¼Œå°½æƒ…äº«å—æ—¶å…‰ã€‚</div>'; 
            } else { 
                // --- æ™ºèƒ½æ’åºæ‰§è¡Œ (Scientific Sort Execution) ---
                const sortedTasksWithIndex = day.tasks.map((t, i) => ({...t, originalIndex: i})).sort((a, b) => {
                    return getTaskWeight(a) - getTaskWeight(b);
                });

                let lastTimePeriod = '';

                sortedTasksWithIndex.forEach((t, i) => { 
                    const tid = day.date + '_' + t.originalIndex; 
                    const checked = !!userProgress[tid]; 
                    
                    const aiInfo = (typeof autoDetectTag === 'function') ? autoDetectTag(t.title + " " + (t.desc||"")) : { category: 'æ—¥å¸¸', label: '', emoji: '', color: '' };
                    const displayTag = t.tag || (aiInfo.category !== 'æ—¥å¸¸' ? aiInfo.label : '');
                    const themeDefaultColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
                    const displayColor = t.tagColor || (aiInfo.category !== 'æ—¥å¸¸' ? aiInfo.color : themeDefaultColor);
                    const titlePrefix = (aiInfo.emoji && aiInfo.category !== 'æ—¥å¸¸') ? aiInfo.emoji + ' ' : '';

                    // --- ç§‘å­¦æ—¶é—´æ®µåˆ’åˆ† (Scientific Time Blocks) ---
                    const weight = getTaskWeight(t); // è·å–åˆ†é’Ÿæ•° (0-1440)
                    let currentTimePeriod = '';
                    
                    // ä¸¥æ ¼æŒ‰ç…§æ—¶é—´è½´åˆ’åˆ†ï¼Œä¸å†æœ‰"TASKS"å…œåº•
                    if (weight < 12 * 60) currentTimePeriod = 'MORNING';      // 00:00 - 11:59
                    else if (weight < 18 * 60) currentTimePeriod = 'AFTERNOON'; // 12:00 - 17:59
                    else currentTimePeriod = 'EVENING';                         // 18:00 - 23:59

                    // æ’å…¥æ—¶é—´æ®µåˆ†å‰²çº¿ (åŒ…æ‹¬ç¬¬ä¸€ä¸ª)
                    if (i === 0 || (currentTimePeriod !== lastTimePeriod && lastTimePeriod !== '')) {
                         if (currentTimePeriod) {
                             container.insertAdjacentHTML('beforeend', `<div class="flex items-center gap-4 py-2 opacity-40 fade-in-up" style="animation-delay: ${(i)*0.05}s"><div class="h-px bg-slate-300 flex-1"></div><span class="text-[10px] font-black tracking-widest text-slate-400 uppercase">${currentTimePeriod}</span><div class="h-px bg-slate-300 flex-1"></div></div>`);
                        }
                    }
                    lastTimePeriod = currentTimePeriod;

                    // è®¡ç®—æ—¶é—´æ˜¾ç¤º (å¦‚æœåŸä»»åŠ¡æ²¡æ—¶é—´ï¼Œä½†é€šè¿‡ç®—æ³•æœ‰äº†æƒé‡ï¼Œåˆ™ä¸å¼ºè¡Œæ˜¾ç¤ºè™šæ‹Ÿæ—¶é—´ï¼Œé™¤éä½ æƒ³æ˜¾ç¤ºå»ºè®®æ—¶é—´)
                    // è¿™é‡Œæˆ‘ä»¬ä¿æŒåŸæ ·ï¼šåªæœ‰å½“ regex åŒ¹é…åˆ°æˆ–è€…æœ‰ time å­—æ®µæ‰æ˜¾ç¤ºæ—¶é—´æ–‡æœ¬
                    let timeDisplay = t.time;
                    if (!timeDisplay) {
                         const timeMatch = (t.title + " " + (t.desc||"")).match(/(\d{1,2})[:ï¼š](\d{2})/);
                         if (timeMatch) timeDisplay = `${timeMatch[1].padStart(2,'0')}:${timeMatch[2]}`;
                    }

                    const badge = displayTag ? `<span class="text-[10px] font-bold px-1.5 py-0.5 rounded border opacity-80" style="color:${displayColor}; border-color:${displayColor}">${displayTag}</span>` : ''; 
                    let timeInfoHtml = (timeDisplay || t.duration) ? `<div class="flex gap-3 text-xs font-mono font-bold text-slate-400 mb-1">${timeDisplay ? `<span>â° ${timeDisplay}</span>` : ''}${t.duration ? `<span>â³ ${t.duration}m</span>` : ''}</div>` : ''; 
                    
                    const div = document.createElement('div'); 
                    div.className = `task-item ios-card p-4 rounded-xl flex gap-4 cursor-pointer hover:bg-white transition-all ${checked ? 'task-checked' : ''} fade-in-up`; 
                    div.style.animationDelay = `${i * 0.05}s`;
                    div.onclick = () => toggleTask(tid); 
                    div.innerHTML = `<div class="checkbox-ios flex-shrink-0"><svg class="w-3.5 h-3.5 text-white ${checked ? 'opacity-100' : 'opacity-0'}" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="4"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg></div><div class="flex-1">${timeInfoHtml}<div class="flex justify-between items-start mb-1"><h4 class="font-bold text-slate-800 text-base leading-tight transition-colors">${titlePrefix}${t.title}</h4>${badge}</div><p class="text-sm text-slate-500 font-medium leading-relaxed">${t.desc}</p></div>`; 
                    container.appendChild(div); 
                }); 
            } 
            checkLock(day.date); lucide.createIcons(); 
        }
        
        async function toggleTask(tid) { 
            if(document.getElementById('contentLocker').style.filter.includes('blur')) return; 
            
            // 1. ç¡®å®šæ˜¯æ‰“å‹¾è¿˜æ˜¯å–æ¶ˆ
            const isChecking = !userProgress[tid];

            if(userProgress[tid]) { 
                delete userProgress[tid]; 
            } else { 
                userProgress[tid] = true; 
            } 
            
            // 2. å…ˆæ›´æ–°æ•°æ®ï¼Œä¸ºäº†å‡†ç¡®è®¡ç®—å®Œæˆåº¦
            localStorage.setItem(STORAGE_KEY, JSON.stringify(userProgress)); 
            
            // 3. æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ
            const dayDate = tid.split('_')[0]; 
            const dayObj = tasksData.find(d => d.date === dayDate); 
            const total = dayObj.tasks.length;
            const doneCount = dayObj.tasks.filter((_, i) => userProgress[dayDate+'_'+i]).length;
            const isAllDone = (doneCount === total && total > 0);

            // 4. éŸ³æ•ˆäº’æ–¥é€»è¾‘ (æ ¸å¿ƒä¿®å¤)
            if (isChecking) {
                // åªæœ‰åœ¨â€œæ‰“å‹¾â€åŠ¨ä½œæ—¶æ‰æ’­å£°éŸ³
                if (isAllDone) {
                    AUDIO_SYSTEM.play('finish'); // å…¨éƒ¨å®Œæˆï¼Œåªæ’­ finish
                    confettiEffect(); 
                } else {
                    AUDIO_SYSTEM.play('check'); // æ™®é€šæ‰“å‹¾ï¼Œåªæ’­ check
                    showToast(); 
                }
                if(navigator.vibrate) navigator.vibrate(10); 
            }

            renderDay(currentDayIdx); 
            const currentTask = tasksData[currentDayIdx].tasks[parseInt(tid.split('_')[1])]; 
            if (currentTask && currentTask.duration) { setTime(parseInt(currentTask.duration)); } 
        }

        function openResetModal() {
            const overlay = document.getElementById('proModalOverlay');
            document.getElementById('proModalTitle').innerText = "é‡ç½®è¿›åº¦";
            document.getElementById('proModalDesc').innerText = "ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ‰“å¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚";
            document.getElementById('proModalInput').style.display = 'none';
            const confirmBtn = document.getElementById('proModalConfirmBtn');
            confirmBtn.innerText = "é‡ç½®";
            confirmBtn.classList.add('destructive');
            confirmBtn.onclick = confirmReset;
            overlay.classList.add('show');
        }

        function confirmReset() {
            userProgress = {}; startedDays = [];
            localStorage.removeItem(STORAGE_KEY); localStorage.removeItem(START_KEY);
            localStorage.removeItem(CURRENT_DAY_KEY); 
            switchToMixMode(); location.reload();
        }

        function openRenameModal() {
            const overlay = document.getElementById('proModalOverlay');
            const titleEl = document.getElementById('planTitleText');
            document.getElementById('proModalTitle').innerText = "é‡å‘½åè®¡åˆ’";
            document.getElementById('proModalDesc').innerText = "ä¸ºå½“å‰çš„è®¡åˆ’è¾“å…¥ä¸€ä¸ªæ–°çš„åç§°ã€‚";
            const input = document.getElementById('proModalInput');
            input.style.display = 'block';
            input.value = titleEl.innerText;
            const confirmBtn = document.getElementById('proModalConfirmBtn');
            confirmBtn.innerText = "ä¿å­˜";
            confirmBtn.classList.remove('destructive');
            confirmBtn.onclick = confirmRename;
            overlay.classList.add('show');
            setTimeout(() => input.focus(), 100);
        }

        function confirmRename() {
            const val = document.getElementById('proModalInput').value;
            if(val) {
                document.getElementById('planTitleText').innerText = val;
                localStorage.setItem(TITLE_KEY, val);
                closeProModal();
            }
        }

        function closeProModal() { document.getElementById('proModalOverlay').classList.remove('show'); }

        function updateStats(day) { const total = day.tasks.length; const done = day.tasks.filter((_, i) => userProgress[day.date+'_'+i]).length; const pct = total ? (done/total)*100 : 0; document.getElementById('dailyProgressBar').style.width = pct + '%'; document.getElementById('dailyProgressText').innerText = done + '/' + total; 
            const trophy = document.getElementById('trophyContainer');
            trophy.innerHTML = (done === total && total > 0) ? `<div class="p-3 rounded-full text-white shadow-lg animate-bounce theme-bg-target" style="background: var(--primary)"><i data-lucide="award" class="w-6 h-6"></i></div>` : `<div class="bg-slate-100 p-3 rounded-full text-slate-300"><i data-lucide="target" class="w-6 h-6"></i></div>`;
            let allT=0, allD=0; tasksData.forEach(d => { allT += d.tasks.length; allD += d.tasks.filter((_,i) => userProgress[d.date+'_'+i]).length; }); const gPct = allT ? Math.round((allD/allT)*100) : 0; document.getElementById('totalCompletionDisplay').innerText = gPct + '%'; document.getElementById('overallProgressBar').style.width = gPct + '%'; lucide.createIcons(); }
        
        // æ ¸å¿ƒä¿®å¤ï¼šstartDay ä¸­æ’­æ”¾ start éŸ³æ•ˆ
        function startDay() { 
            const d = tasksData[currentDayIdx].date; 
            if(!startedDays.includes(d)) { 
                startedDays.push(d); 
                localStorage.setItem(START_KEY, JSON.stringify(startedDays)); 
            } 
            AUDIO_SYSTEM.play('start'); 
            document.getElementById('ritualOverlay').style.opacity = '0'; 
            setTimeout(() => { 
                document.getElementById('ritualOverlay').style.display = 'none'; 
                unlockContent(); 
            }, 500); 
        }
        
        function checkLock(date) { const overlay = document.getElementById('ritualOverlay'); const locker = document.getElementById('contentLocker'); const hasStarted = startedDays.includes(date) || Object.keys(userProgress).some(k => k.startsWith(date)); if(hasStarted) { overlay.style.display = 'none'; unlockContent(); } else { overlay.style.display = 'flex'; overlay.style.opacity = '1'; locker.style.filter = 'blur(8px)'; locker.style.pointerEvents = 'none'; locker.style.opacity = '0.5'; } }
        function unlockContent() { const locker = document.getElementById('contentLocker'); locker.style.filter = 'none'; locker.style.pointerEvents = 'auto'; locker.style.opacity = '1'; }
        function showToast() { const t = document.getElementById('toast'); t.style.opacity = '1'; t.style.transform = 'translate(-50%, 0)'; setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translate(-50%, -20px)'; }, 1500); }
        function confettiEffect(colors) { confetti({ particleCount: 80, spread: 60, origin: { y: 0.65 }, colors: colors || [getComputedStyle(document.documentElement).getPropertyValue('--primary').trim()] }); }
        function togglePalette(e) { if(e) e.stopPropagation(); const p = document.getElementById('palettePopover'); if(!p.classList.contains('active')) initPalette(); p.classList.toggle('active'); }
        function closePalette() { document.getElementById('palettePopover').classList.remove('active'); }
        function hexToRgb(hex) { let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : {r:0,g:0,b:0}; }
        function adjustBrightness(hex, percent) { let num = parseInt(hex.replace("#",""),16), amt = Math.round(2.55 * percent), R = (num >> 16) + amt, B = (num >> 8 & 0x00FF) + amt, G = (num & 0x0000FF) + amt; return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 + (B<255?B<1?0:B:255)*0x100 + (G<255?G<1?0:G:255)).toString(16).slice(1); }
        function renamePlan() { openRenameModal(); } 
        function init() { 
            if (!RAW_DATA.includes('{{')) { 
                const st = localStorage.getItem(TITLE_KEY); 
                if(st) document.getElementById('planTitleText').innerText = st; 
            } 
            document.getElementById('totalDaysLabel').innerText = tasksData.length; 
            let initialDayIdx = parseInt(localStorage.getItem(CURRENT_DAY_KEY) || '0');
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('day')) {
                const urlDayIdx = parseInt(urlParams.get('day'));
                if (!isNaN(urlDayIdx) && urlDayIdx >= 0 && urlDayIdx < tasksData.length) {
                    initialDayIdx = urlDayIdx;
                }
            }
            renderDay(initialDayIdx); 
            document.getElementById('modeLabel').innerText = currentMode === 'mix' ? "DOPAMINE MIX" : "PRO FOCUS"; 
            document.addEventListener('click', (e) => { if(!e.target.closest('.palette-wrapper')) closePalette(); }); 
            setTimeout(() => { 
                const tip = document.getElementById('dockTooltip'); 
                if(tip) { tip.classList.remove('show'); tip.style.opacity = '0'; tip.style.transform = 'translateY(-50%) translateX(10px)'; } 
            }, 4000); 
        }
        window.addEventListener('DOMContentLoaded', init);

        // --- ç•ªèŒ„é’Ÿé€»è¾‘ ---
        let timer = null, timeLeft = 25 * 60, isRunning = false;
        const dockWrapper = document.getElementById('focusDockWrapper'); 
        const orb = document.getElementById('dockOrb'); 
        let isDrag = false, startX, startY;
        
        orb.addEventListener('mousedown', (e) => {
            if(e.target.closest('#dockPanel')) return; 
            isDrag = false; startX = e.clientX; startY = e.clientY;
            let rect = dockWrapper.getBoundingClientRect(); let offX = rect.left, offY = rect.top;
            dockWrapper.style.transition = 'none';
            const onMove = (ev) => { if(Math.abs(ev.clientX - startX) > 5 || Math.abs(ev.clientY - startY) > 5) { isDrag = true; dockWrapper.style.left = (offX + ev.clientX - startX) + 'px'; dockWrapper.style.top = (offY + ev.clientY - startY) + 'px'; dockWrapper.style.right = 'auto'; dockWrapper.style.bottom = 'auto'; } };
            const onUp = () => { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); dockWrapper.style.transition = 'all 0.4s cubic-bezier(0.25, 1, 0.5, 1)'; if(!isDrag) { toggleDock(); } else { snapDock(); } };
            document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onUp);
        });

        function snapDock() {
            const rect = dockWrapper.getBoundingClientRect(); const winW = window.innerWidth; const winH = window.innerHeight;
            const SNAP_THRESHOLD = 100; const MARGIN = 32;
            let targetLeft = rect.left; let targetTop = rect.top;
            if (rect.left < SNAP_THRESHOLD) targetLeft = MARGIN; else if (winW - rect.right < SNAP_THRESHOLD) targetLeft = winW - rect.width - MARGIN;
            if (rect.top < SNAP_THRESHOLD) targetTop = MARGIN; else if (winH - rect.bottom < SNAP_THRESHOLD) targetTop = winH - rect.height - MARGIN;
            dockWrapper.style.left = `${Math.max(MARGIN, Math.min(winW - rect.width - MARGIN, targetLeft))}px`;
            dockWrapper.style.top = `${Math.max(MARGIN, Math.min(winH - rect.height - MARGIN, targetTop))}px`;
        }
        function updatePanelPosition() {
            const rect = dockWrapper.getBoundingClientRect(); const panel = document.getElementById('dockPanel'); const winH = window.innerHeight; const winW = window.innerWidth;
            panel.style.top = ''; panel.style.bottom = ''; panel.style.left = ''; panel.style.right = ''; panel.style.transformOrigin = '';
            if (rect.top > winH / 2) { panel.style.bottom = '80px'; panel.style.transformOrigin = 'bottom '; } else { panel.style.top = '80px'; panel.style.transformOrigin = 'top '; }
            if (rect.left > winW / 2) { panel.style.right = '0'; panel.style.transformOrigin += 'right'; } else { panel.style.left = '0'; panel.style.transformOrigin += 'left'; }
        }
        function toggleDock() { const panel = document.getElementById('dockPanel'); if (!panel.classList.contains('open')) { updatePanelPosition(); } panel.classList.toggle('open'); }
        function showTimeInput() { if (isRunning) return; const overlay = document.getElementById('customTimeOverlay'); const input = document.getElementById('customTimeInput'); overlay.classList.add('show'); const m = Math.floor(timeLeft / 60); const s = timeLeft % 60; input.value = s > 0 ? `${m}:${String(s).padStart(2,'0')}` : m; input.focus(); input.select(); }
        function hideTimeInput() { document.getElementById('customTimeOverlay').classList.remove('show'); }
        function submitTime() { const input = document.getElementById('customTimeInput').value; let m = 0, s = 0; if (input.includes(':') || input.includes('ï¼š')) { const parts = input.replace('ï¼š', ':').split(':'); m = parseInt(parts[0]) || 0; s = parseInt(parts[1]) || 0; } else { m = parseInt(input) || 0; } if (m > 120) m = 120; timeLeft = m * 60 + s; if (timeLeft < 1) timeLeft = 25 * 60; updateUI(); hideTimeInput(); }
        function adjustTime(delta) { if(isRunning) return; let m = Math.floor(timeLeft/60)+delta; if(m<1) m=1; setTime(m); }
        function setTime(m) { if(isRunning) return; timeLeft = m * 60; updateUI(); }
        
        function toggleTimer() {
            if(isRunning) { clearInterval(timer); isRunning = false; }
            else { 
                isRunning = true; 
                // æ ¸å¿ƒä¿®å¤ï¼šè¿™é‡Œä¸å†æ’­æ”¾ start éŸ³æ•ˆ
                timer = setInterval(() => { if(timeLeft>0) { timeLeft--; updateUI(); } else { finish(); } }, 1000); 
            }
            updateUI();
        }
        function finish() { clearInterval(timer); isRunning = false; AUDIO_SYSTEM.play('finish'); alert("Focus Complete!"); confettiEffect(); timeLeft=25*60; exitImmersive(); updateUI(); }
        
        function updateUI() {
            const str = Math.floor(timeLeft/60).toString().padStart(2,'0') + ':' + (timeLeft%60).toString().padStart(2,'0');
            document.getElementById('dockTime').innerText = str; document.getElementById('immTime').innerText = str;
            const btn = document.getElementById('mainBtn'); btn.innerHTML = isRunning ? `<i data-lucide="pause" class="w-4 h-4"></i> <span>æš‚åœ</span>` : `<i data-lucide="play" class="w-4 h-4"></i> <span>å¼€å§‹ä¸“æ³¨</span>`;
            document.getElementById('immIcon').setAttribute('data-lucide', isRunning ? 'pause' : 'play'); lucide.createIcons();
        }
        function enterImmersive() { document.getElementById('immersiveLayer').classList.add('active'); document.getElementById('dockPanel').classList.remove('open'); if(!isRunning) toggleTimer(); }
        function exitImmersive() { document.getElementById('immersiveLayer').classList.remove('active'); }
    </script>
</body>
</html>