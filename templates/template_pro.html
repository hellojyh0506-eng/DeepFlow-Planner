<!DOCTYPE html>
<html lang="zh-CN">
<head>
<link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DeepFlow Pro - {{PLAN_TITLE}}</title>
    <meta name="theme-color" content="#020617">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="DeepFlow">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://deepflow-hellojyh-audio.oss-cn-hangzhou.aliyuncs.com/libs/tailwind.js"></script>
    <script src="https://deepflow-hellojyh-audio.oss-cn-hangzhou.aliyuncs.com/libs/confetti.browser.min.js"></script>
    <script src="https://deepflow-hellojyh-audio.oss-cn-hangzhou.aliyuncs.com/libs/lucide.min.js"></script>

    <style>
        /* 2. åŸºç¡€æ ·å¼ä¸å­—ä½“ä¿®å¤ */
        :root { --primary: #007AFF; --primary-dark: #0056b3; --primary-light: rgba(0, 122, 255, 0.08); --text-on-primary: #ffffff; --surface: #f5f5f7; --glass-border: rgba(255, 255, 255, 0.6); --seal-red: #b91c1c; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif; background-color: var(--surface); color: #1d1d1f; transition: background-color 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); -webkit-font-smoothing: antialiased; visibility: visible !important; opacity: 1 !important;}
        
        /* æ»šåŠ¨æ¡éšè—å·¥å…·ç±» (ä¿®å¤ç¼ºå¤±) */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* --- æ–°å¢ï¼šåŠ¨æ€èƒŒæ™¯ä¸ç‰¹æ•ˆæ ·å¼ --- */
#particleCanvas { 
    position: fixed; inset: 0; z-index: -2; pointer-events: none; 
    mix-blend-mode: screen; /* è®©ç²’å­å‘å…‰çš„å…³é”® */
}

/* --- ä¿®å¤ç‰ˆï¼šèƒŒæ™¯åŠ¨ç”» (å®Œç¾é€‚é…æ‰‹æœº) --- */
#bg-gradient {
    position: fixed; inset: 0; z-index: -5;
    width: 100%; height: 100%; /* å¼ºåˆ¶å®½é«˜ */
    transition: opacity 1s ease;
    transform: translate3d(0,0,0); /* å¼€å¯ç¡¬ä»¶åŠ é€Ÿ */
}

/* å¤šå·´èƒºæ··åˆæ¨¡å¼ - ä½¿ç”¨å¤§å°ºå¯¸èƒŒæ™¯ç§»åŠ¨ */
.bg-mix-mode {
    background: linear-gradient(135deg, #ff9a9e, #fad0c4, #fad0c4, #a18cd1, #fbc2eb);
    background-size: 400% 400%;
    animation: gradientBG 15s ease infinite;
}

/* ä¸“æ³¨å•è‰²æ¨¡å¼ */
.bg-single-mode {
    background: radial-gradient(circle at 50% 30%, var(--primary-light), transparent 80%),
                linear-gradient(180deg, #ffffff 0%, #f0f2f5 100%);
    background-size: 100% 100%;
}

@keyframes gradientBG {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

/* å¼ºåˆ¶ä¿®å¤å›¾æ ‡é¢œè‰² */
#headerIcon i, #headerIcon svg {
    color: #ffffff !important; /* å¼ºåˆ¶ç™½è‰²ï¼Œé˜²æ­¢å˜é‡å¤±æ•ˆ */
    stroke: #ffffff !important;
}
/* ç‰¹æ•ˆèœå•æ ·å¼å¾®è°ƒ */
.visual-option {
    padding: 8px; font-size: 12px; font-weight: bold; color: #555;
    cursor: pointer; border-radius: 8px; transition: all 0.2s;
    text-align: left;
}
.visual-option:hover { background: rgba(0,0,0,0.05); color: var(--primary); }
.ios-card .blur-3xl {
    filter: blur(64px); /* å¢å¤§æ¨¡ç³ŠåŠå¾„ */
    opacity: 0.2;       /*ç¨å¾®å¢åŠ ä¸é€æ˜åº¦è®©é¢œè‰²æ›´æ˜¾çœ¼ */
}
        .ios-card { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--glass-border); box-shadow: 0 4px 24px rgba(0,0,0,0.04); transition: all 0.3s; }
        .ios-card:hover { transform: translateY(-2px); box-shadow: 0 8px 32px rgba(0,0,0,0.08); border-color: rgba(255,255,255,0.9); }
        
        /* è°ƒè‰²ç›˜ */
        .palette-wrapper { position: relative; z-index: 50; }
        .palette-btn { width: 36px; height: 36px; border-radius: 50%; background: var(--primary); color: var(--text-on-primary); display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px var(--primary-light); transition: transform 0.2s, background-color 0.5s ease; }
        .palette-btn:active { transform: scale(0.92); }
        .reset-btn { background: #ff3b30 !important; color: white; box-shadow: 0 4px 12px rgba(255, 59, 48, 0.3); }
        /* --- ä¿®å¤ç‰ˆï¼šè°ƒè‰²ç›˜æ ·å¼ --- */
.palette-popover { 
    position: absolute; 
    top: 120%; 
    right: 0; 
    width: 210px; 
    padding: 12px; 
    background: rgba(255, 255, 255, 0.95); 
    backdrop-filter: blur(24px); 
    border-radius: 16px; 
    box-shadow: 0 12px 48px rgba(0,0,0,0.12); 
    opacity: 0; 
    transform: scale(0.9) translateY(-10px); 
    pointer-events: none; 
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); /* æ›´ä¸æ»‘çš„å¼¹çª—åŠ¨ç”» */
    display: grid; 
    grid-template-columns: repeat(4, 1fr); 
    gap: 10px; 
    z-index: 100; /* ç¡®ä¿ä¸è¢«é®æŒ¡ */
}
.palette-popover.active { 
    opacity: 1 !important; 
    transform: scale(1) translateY(0) !important; 
    pointer-events: auto !important; 
}

/* å½©è™¹æ¸å˜çƒ (Mix Mode) */
.mix-dot { 
    background: linear-gradient(135deg, #FF3B30, #FF9500, #34C759, #007AFF, #AF52DE) !important; 
    border: 2px solid white;
}

/* è‰²ç¯å–è‰²çƒ (Picker) */
.picker-dot { 
    background: conic-gradient(from 0deg, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000) !important; 
    border: 2px solid white;
}

/* é€‰ä¸­çŠ¶æ€çš„å…‰åœˆåŠ¨ç”» */
.color-dot.active-swatch::after { 
    content: ''; 
    position: absolute; 
    inset: -4px; 
    border-radius: 50%; 
    border: 2px solid var(--primary); 
    animation: ringSnap 0.4s forwards; 
}
        .palette-popover.active { opacity: 1; transform: scale(1) translateY(0); pointer-events: auto; }
        .color-dot { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; position: relative; transition: transform 0.2s; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .color-dot:hover { transform: scale(1.15); z-index: 2; }
        .color-dot.active-swatch::after { content: ''; position: absolute; inset: -4px; border-radius: 50%; border: 2px solid var(--primary); animation: ringSnap 0.4s forwards; }
.mix-dot { 
    background: linear-gradient(135deg, #FF3B30, #FF9500, #34C759, #007AFF, #AF52DE); 
}
/* è‰²ç¯æ‹¾è‰²å™¨çƒ */
.picker-dot { 
    background: conic-gradient(from 0deg, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000); 
}
/* é€‰ä¸­æ—¶çš„å‘¼å¸å…‰ç¯ */
.color-dot.active-swatch::after { 
    content: ''; 
    position: absolute; 
    inset: -4px; 
    border-radius: 50%; 
    border: 2px solid var(--primary); 
    animation: ringSnap 0.4s forwards; 
}
@keyframes ringSnap { 
    0% { transform: scale(0.8); opacity: 0; } 
    100% { transform: scale(1); opacity: 1; } 
}
        .mix-icon, .picker-icon { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        
        /* ä»»åŠ¡åˆ—è¡¨ */
        /* --- Bento Grid æ–°æ ·å¼ --- */
.task-item { 
    border-left: 1px solid rgba(255,255,255,0.6); /* åŸºç¡€è¾¹æ¡† */
}
.task-checked { 
    background-color: var(--primary-light) !important; 
    border-color: var(--primary) !important;
    box-shadow: none !important;
}
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    line-clamp: 2;
}
.checkbox-ios {
    width: 24px; 
    height: 24px; 
    border-radius: 8px; /* åœ†è§’ */
    border: 2px solid #e2e8f0; 
    background: white; 
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    
    /* ğŸ‘‡ è¡¥å›è¿™ä¸‰è¡Œï¼Œå¯¹å‹¾å°±ä¼šä¹–ä¹–å›åˆ°æ­£ä¸­é—´ ğŸ‘‡ */
    display: flex;
    align-items: center;
    justify-content: center;
    
    /* å¾®è°ƒï¼šä¸ºäº†è·Ÿæ ‡é¢˜æ–‡å­—å¯¹é½ï¼Œç¨å¾®åŠ ä¸€ç‚¹ç‚¹ä¸Šè¾¹è· */
    margin-top: 2px;
}
        .task-checked h4 { text-decoration: line-through; color: #86868b; opacity: 0.8; }
        .task-checked .checkbox-ios { background: var(--primary); border-color: var(--primary); transform: scale(1.05); box-shadow: 0 4px 10px var(--primary-light); }
        .fade-in-up { animation: fadeInUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; transform: translateY(15px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        #customPickerInput { opacity: 0; position: absolute; pointer-events: none; }
        .theme-transition { transition: all 0.6s ease; }

        /* --- ç•ªèŒ„é’Ÿ UI --- */
        #focusDockWrapper { position: fixed; bottom: 32px; right: 32px; z-index: 100; transition: none; }
        #dockOrb {
            width: 64px; height: 64px; border-radius: 22px; 
            background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.6); 
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s;
            position: relative; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1), 0 0 20px var(--primary-light); 
        }
        #dockOrb:hover { transform: scale(1.05); box-shadow: 0 15px 40px var(--primary-light); }
        #dockOrb:active { transform: scale(0.95); }
        .dock-icon { animation: flowPulse 3s ease-in-out infinite alternate; } 
        @keyframes flowPulse { from { filter: drop-shadow(0 0 0 var(--primary)); opacity: 0.85; } to { filter: drop-shadow(0 0 8px var(--primary)); opacity: 1; } }
        #dockTooltip {
            position: absolute; right: 80px; top: 50%; transform: translateY(-50%) translateX(10px);
            background: rgba(29, 29, 31, 0.9); color: white; padding: 8px 14px;
            border-radius: 12px; font-size: 12px; font-weight: 700; white-space: nowrap; pointer-events: none; opacity: 0;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 4px 20px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 6px;
            border: 1px solid var(--primary); text-shadow: 0 0 3px var(--primary); 
        }
        #dockTooltip.show { opacity: 1; transform: translateY(-50%) translateX(0); }
        #dockTooltip::after { content: ''; position: absolute; right: -4px; top: 50%; transform: translateY(-50%); border-width: 5px 0 5px 6px; border-color: transparent transparent transparent rgba(29, 29, 31, 0.9); }
        #dockPanel {
            position: absolute; width: 260px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(30px);
            border-radius: 24px; padding: 24px; box-shadow: 0 25px 60px -10px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.8); opacity: 0; pointer-events: none; transform: scale(0.8);
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        #dockPanel.open { opacity: 1; pointer-events: auto; transform: scale(1); }
        #customTimeOverlay {
            position: absolute; inset: 0; border-radius: 24px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 20;
        }
        #customTimeOverlay.show { opacity: 1; pointer-events: auto; }
        .pro-input { background: transparent; border: none; border-bottom: 2px solid var(--primary); font-size: 2rem; font-weight: 800; text-align: center; color: #1d1d1f; width: 80%; outline: none; margin-bottom: 10px; font-family: monospace; }
        
        /* æ²‰æµ¸æ¨¡å¼ */
/* --- æ²‰æµ¸æ¨¡å¼ (ä¸»é¢˜è·Ÿéš + æ‰‹æœºé€‚é…ç‰ˆ) --- */
/* --- æ²‰æµ¸æ¨¡å¼ (æœ€ç»ˆä¿®æ­£ç‰ˆ) --- */
#immersiveLayer { 
    position: fixed; inset: 0; z-index: 999; 
    background: #0f172a; 
    opacity: 0; pointer-events: none; transition: opacity 0.5s ease; 
    overflow: hidden; 
}
#immersiveLayer.active { opacity: 1; pointer-events: auto; }

/* å¼ºåˆ¶å†…å®¹ç»å¯¹å±…ä¸­å®¹å™¨ */
.full-center-wrapper {
    position: absolute; inset: 0;
    display: flex; flex-direction: column; 
    align-items: center; justify-content: center;
    z-index: 20; /* ç¡®ä¿åœ¨å…‰å›¢ä¹‹ä¸Š */
    width: 100%; height: 100%;
}

/* å…‰å›¢æ ·å¼ (ä¿æŒæµä½“æ„Ÿ) */
.immersive-blob {
    position: absolute; border-radius: 50%;
    filter: blur(60px); opacity: 0.8;
    will-change: transform; mix-blend-mode: hard-light;
    animation: flowMove 20s infinite alternate;
}
@media (max-width: 768px) {
    .immersive-blob { width: 150vw; height: 150vw; opacity: 0.7; }
}
@media (min-width: 769px) {
    .immersive-blob { width: 80vw; height: 80vw; filter: blur(100px); mix-blend-mode: screen; }
}

/* é¢œè‰²æ¨¡å¼ */
.im-mix { background: #1a0b2e; }
.im-mix .blob-1 { top: -20%; left: -20%; background: #FF3B30; animation-duration: 25s; }
.im-mix .blob-2 { bottom: -20%; right: -20%; background: #007AFF; animation-duration: 30s; animation-direction: alternate-reverse; }
.im-mix .blob-3 { top: 40%; left: 10%; background: #FF9500; width: 120vw; height: 120vw; opacity: 0.5; animation: flowPulse 15s infinite; }

.im-single { background: #000; }
.im-single .blob-1 { top: -30%; left: -30%; background: var(--primary); opacity: 0.4; }
.im-single .blob-2 { bottom: -30%; right: -30%; background: var(--primary); opacity: 0.3; }
.im-single .blob-3 { top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--primary); opacity: 0.15; width: 180vw; height: 180vw; animation: flowPulse 10s infinite; }

/* åŠ¨ç”»å…³é”®å¸§ */
@keyframes flowMove { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(15%, 10%) scale(1.1); } }
@keyframes flowPulse { 0%, 100% { transform: scale(1); opacity: 0.3; } 50% { transform: scale(1.1); opacity: 0.5; } }

/* æ–‡æœ¬ä¸æŒ‰é’®ä¼˜åŒ– */
.flow-label {
    font-size: 12px; font-weight: 800; letter-spacing: 0.5em; 
    color: rgba(255,255,255,0.6); text-transform: uppercase; 
    margin-bottom: 2vh; text-shadow: 0 2px 10px rgba(0,0,0,0.2);
}
.giant-time { 
    font-size: 20vw; font-weight: 800; color: white; 
    font-variant-numeric: tabular-nums; letter-spacing: -2px; 
    text-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-bottom: 8vh;
}
@media (min-width: 768px) { .giant-time { font-size: 140px; margin-bottom: 60px; } }

/* --- æŒ‰é’®åˆ†çº§ç³»ç»Ÿ (å…³é”®ä¿®æ”¹) --- */
/* ä¸»æŒ‰é’® (å¤§) */
.btn-hero {
    width: 88px; height: 88px;
    border-radius: 50%;
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
}
.btn-hero:active { transform: scale(0.9); background: rgba(255,255,255,0.25); }

/* å‰¯æŒ‰é’® (å°ä¸”é€æ˜) */
.btn-sub {
    width: 50px; height: 50px;
    border-radius: 50%;
    background: transparent; /* é€æ˜èƒŒæ™¯ */
    border: 1px solid rgba(255,255,255,0.1); /* æç»†è¾¹æ¡† */
    color: rgba(255,255,255,0.6); /* ç°è‰²å›¾æ ‡ */
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
}
.btn-sub:active { background: rgba(255, 59, 48, 0.2); border-color: #FF3B30; color: #FF3B30; transform: scale(0.95); }
        /* --- å¤šå·´èƒºä¸“ä¸š Modal --- */
        #proModalOverlay { 
            position: fixed; inset: 0; z-index: 9999; 
            background: rgba(0, 0, 0, 0.4); 
            backdrop-filter: blur(8px); 
            display: flex; align-items: center; justify-content: center; 
            opacity: 0; pointer-events: none; transition: opacity 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); 
        }
        #proModalOverlay.show { opacity: 1; pointer-events: auto; }
        
        .deepflow-modal { 
            width: 300px; /* ç•¥å¾®å¢å¤§ */
            background: rgba(255, 255, 255, 0.95); /* æ›´ä¸é€æ˜ */
            backdrop-filter: blur(30px); 
            border-radius: 20px; /* æ›´åœ†æ¶¦ */
            overflow: hidden; 
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.25); 
            transform: translateY(20px) scale(0.9); 
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }
        #proModalOverlay.show .deepflow-modal { transform: translateY(0) scale(1); }
        
        .df-modal-header { padding: 24px 24px 16px; text-align: center; }
        .df-modal-title { font-weight: 800; font-size: 20px; color: #1d1d1f; margin-bottom: 4px; }
        .df-modal-desc { font-size: 14px; color: #64748b; line-height: 1.5; }
        .df-modal-input { 
            margin: 15px 0 10px; width: 100%; 
            padding: 10px 16px; font-size: 16px; 
            border: 2px solid #e2e8f0; 
            border-radius: 12px; 
            background: #f8fafc; 
            outline: none; 
            text-align: center; 
            font-weight: 600;
            color: #1d1d1f;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .df-modal-input:focus { 
            border-color: var(--primary); 
            background: #fff;
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        
        .df-modal-actions { 
            display: flex; 
            padding: 16px 24px;
            background: #f8fafc; /* åº•éƒ¨æ“ä½œåŒºèƒŒæ™¯ */
            border-top: 1px solid #e2e8f0;
        }
        
        .df-modal-btn { 
            flex: 1; 
            padding: 12px; 
            font-size: 15px; 
            font-weight: 700; 
            border: none; 
            cursor: pointer; 
            border-radius: 10px;
            transition: all 0.2s;
        }
        
        .df-btn-cancel { 
            background: #e2e8f0; 
            color: #475569; 
            margin-right: 8px; 
        }
        .df-btn-cancel:hover { background: #cbd5e1; }
        .df-btn-cancel:active { transform: scale(0.98); }

        .df-btn-confirm { 
            background: var(--primary); 
            color: white; 
            box-shadow: 0 4px 12px var(--primary-light); 
        }
        .df-btn-confirm:hover { filter: brightness(1.05); }
        .df-btn-confirm:active { transform: scale(0.98); }
        
        .df-btn-confirm.destructive { 
            background: #FF3B30; 
            box-shadow: 0 4px 12px rgba(255, 59, 48, 0.3);
        }
        
        /* --- Pro Theme Noise UI --- */
        #noiseOrb {
            background: rgba(255,255,255,0.8); backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.5); color: #1d1d1f;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: visible !important;
        }
        /* å‘¼å¸å…‰æ™• */
        #noiseOrb::before, #noiseOrb::after {
            content: ''; position: absolute; inset: 0; border-radius: 50%;
            background: var(--primary); z-index: -1; opacity: 0; transform: scale(0.8); transition: 0.5s;
        }
        #noiseOrb.is-playing {
            background: #fff; color: var(--primary); border-color: var(--primary);
        }
        #noiseOrb.is-playing::before { animation: pro-breath 3s ease-in-out infinite; }
        #noiseOrb.is-playing::after { animation: pro-breath 3s ease-in-out infinite; animation-delay: 1.5s; }
        @keyframes pro-breath {
            0% { transform: scale(0.9); opacity: 0.3; }
            50% { transform: scale(1.4); opacity: 0; }
            100% { transform: scale(0.9); opacity: 0; }
        }

        /* ç™½å™ªéŸ³é¢æ¿å¡ç‰‡ */
        .noise-card {
            height: 40px;
            background: rgba(255,255,255,0.5);
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s;
            color: #666;
        }
        .noise-card:hover { background: #fff; transform: scale(1.05); color: #007AFF; }
        
        /* é€‰ä¸­æ€è·Ÿéšä¸»é¢˜ */
        .noise-card.active {
            background: var(--primary) !important; 
            color: #fff !important; 
            box-shadow: 0 4px 12px var(--primary-light) !important;
            border-color: transparent !important;
        }
        
        /* æŒ‰é’®æ¿€æ´»æ€è·Ÿéšä¸»é¢˜ */
        .stop-active {
            background: var(--primary) !important; 
            border-color: var(--primary) !important; 
            color: #fff !important; 
            opacity: 1 !important;
        }

        /* iOS çº¢ç‚¹ */
        .variant-badge {
            position: absolute; top: -5px; right: -5px; width: 16px; height: 16px;
            background: #ff3b30; color: white; border-radius: 50%; font-size: 10px; font-weight: 600;
            display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        /* æç¤ºæ¡†å¼ºåˆ¶ç½®é¡¶ (ä¿®å¤å±‚çº§é—®é¢˜) */
        #toast {
            z-index: 20005 !important;
            bottom: 120px !important;
            top: auto !important;
            opacity: 0; 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        #toast.show-toast-active {
            opacity: 1 !important;
            transform: translate(-50%, 0) !important;
        }
        /* --- ğŸ® æ¸¸æˆåŒ–ç³»ç»Ÿæ ·å¼ --- */
#profileModalOverlay.show { opacity: 1; pointer-events: auto; }
#profileModalOverlay.show #profileModalContent { transform: scale(1); }

.xp-bar-container { 
    width: 100%; height: 10px; background: #f1f5f9; 
    border-radius: 99px; overflow: hidden; position: relative;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
}
.xp-bar-fill { 
    height: 100%; 
    background: linear-gradient(90deg, #4f46e5, #9333ea); 
    width: 0%; 
    border-radius: 99px;
    transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: 0 0 10px rgba(147, 51, 234, 0.3);
}

.badge-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
.badge-item { 
    aspect-ratio: 1; background: #f8fafc; border-radius: 16px; 
    display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 6px; 
    transition: all 0.3s; border: 1px solid #e2e8f0; opacity: 0.4; filter: grayscale(100%); 
}
.badge-item.unlocked { 
    opacity: 1; filter: grayscale(0%); background: #fff; 
    box-shadow: 0 8px 20px -4px rgba(0,0,0,0.1); border-color: #e0e7ff; transform: translateY(-2px);
}
.badge-name { font-size: 10px; font-weight: 700; color: #64748b; text-align: center; line-height: 1.1; }
/* --- æ’è¡Œæ¦œä¸Tabæ ·å¼ --- */
.rank-filter-btn {
    padding: 6px 12px; border-radius: 99px; font-size: 12px; font-weight: bold; color: #64748b; background: transparent; border: 1px solid transparent; transition: all 0.2s; white-space: nowrap;
}
.rank-filter-btn.active {
    background: var(--primary); color: white; box-shadow: 0 4px 10px var(--primary-light);
}
.rank-row {
    display: flex; align-items: center; padding: 12px 16px; border-bottom: 1px solid #f1f5f9; transition: background 0.2s;
}
.rank-row:last-child { border-bottom: none; }
.rank-num {
    font-size: 14px; font-weight: 900; width: 30px; color: #94a3b8; font-style: italic;
}
.rank-1 .rank-num { color: #eab308; font-size: 18px; text-shadow: 0 2px 4px rgba(234, 179, 8, 0.2); }
.rank-2 .rank-num { color: #94a3b8; font-size: 16px; }
.rank-3 .rank-num { color: #b45309; font-size: 16px; }
/* åœ¨çº¿çŠ¶æ€å‘¼å¸ç¯æ•ˆæœ */
@keyframes onlinePulse {
    0%, 100% { 
        opacity: 1; 
        box-shadow: 0 0 5px #10b981, 0 0 10px #10b981;
    }
    50% { 
        opacity: 0.7; 
        box-shadow: 0 0 2px #10b981, 0 0 5px #10b981;
    }
}

.animate-pulse {
    animation: onlinePulse 2s ease-in-out infinite;
}

/* æ·»åŠ ç”¨æˆ·æ ‡ç­¾æ ·å¼ */
.text-\[8px\] {
    font-size: 8px;
}
.rank-avatar {
    width: 32px; height: 32px; border-radius: 50%; background: #e2e8f0; margin-right: 12px; display: flex; align-items: center; justify-content: center; font-size: 14px; position: relative;
}
.rank-name {
    flex: 1; font-size: 13px; font-weight: 600; color: #334155;
}
.rank-val {
    font-family: monospace; font-weight: 700; color: var(--primary); font-size: 14px;
}
.rank-row.is-me {
    background: var(--primary-light); position: relative;
}
.rank-row.is-me::after {
    content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; background: var(--primary);
}
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden {{BODY_CLASS}}">
    <canvas id="particleCanvas"></canvas>
<div id="bg-gradient" class="bg-mix-mode"></div>
    
    <header class="ios-card z-40 relative m-3 md:m-4 rounded-2xl flex-none">
    <div class="px-4 py-3 md:px-5 flex justify-between items-center">
        <div class="flex items-center gap-3 md:gap-4 overflow-hidden">
            <div id="headerIcon" onclick="openProfileModal()" class="flex-none w-11 h-11 rounded-xl flex flex-col items-center justify-center shadow-lg transition-transform duration-200 active:scale-90 cursor-pointer theme-transition relative" style="background: var(--primary)">
                
                <i data-lucide="trophy" class="w-5 h-5 text-white mb-0.5"></i>
                
                <span class="text-[8px] font-black text-white leading-none">XP</span>
            </div>
            
            <div class="flex flex-col justify-center min-w-0">
                <div class="flex items-center gap-2 group cursor-pointer" onclick="openRenameModal()">
                    <h1 id="planTitleText" class="text-lg font-black tracking-tight text-slate-800 truncate">{{PLAN_TITLE}}</h1>
                    <i data-lucide="edit-3" class="w-3.5 h-3.5 text-slate-300 group-hover:text-slate-500 flex-none"></i>
                </div>
                <div id="modeLabel" class="hidden sm:block text-[10px] font-bold text-slate-400 tracking-wide">DOPAMINE MIX</div>
            </div>
        </div>

        <div class="flex items-center gap-2 md:gap-4 flex-none">
            <div class="palette-btn reset-btn" onclick="openResetModal()" title="é‡ç½®è¿›åº¦">
                <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
            </div>
            
            <div class="palette-wrapper">
                <div style="position: relative; display: flex; gap: 8px;">
                    <div class="palette-btn visual-btn" onclick="toggleVisualMenu(event)" title="åˆ‡æ¢ç‰¹æ•ˆ" style="background: rgba(255,255,255,0.8); color: #333;">
                        <i data-lucide="wand-2" class="w-4 h-4"></i>
                    </div>
                    <div id="visualPopover" class="palette-popover" style="width: 140px; grid-template-columns: 1fr; right: 0; left: auto;">
                        <div class="visual-option" onclick="setVisualMode('off')">ğŸš« å…³é—­ç‰¹æ•ˆ</div>
                        <div class="visual-option" onclick="setVisualMode('sakura')">ğŸŒ¸ æµªæ¼«æ¨±èŠ±</div>
                        <div class="visual-option" onclick="setVisualMode('bubbles')">ğŸ«§ æ¢¦å¹»æ°”æ³¡</div>
                        <div class="visual-option" onclick="setVisualMode('meteor')">ğŸŒ  æé€Ÿæµæ˜Ÿ</div>
                        <div class="visual-option" onclick="setVisualMode('fireflies')">âœ¨ å¤å¤œè¤ç«</div>
                    </div>
                    
                    <div class="palette-btn theme-transition" onclick="togglePalette(event)" style="background: var(--primary)">
                        <i data-lucide="palette" class="w-4 h-4 text-white"></i>
                    </div>
                </div>

                <div id="palettePopover" class="palette-popover"></div>
                <input type="color" id="customPickerInput" onchange="switchToSingleColor(this.value)">
            </div>

            <div class="text-right hidden sm:block">
                <div class="text-[10px] text-slate-400 font-bold uppercase">æ€»ä½“å®Œæˆåº¦</div>
                <div class="font-black text-lg leading-none transition-colors theme-transition" style="color: var(--primary)" id="totalCompletionDisplay">0%</div>
            </div>
        </div>
    </div>
    <div class="h-1 w-full bg-slate-100 overflow-hidden rounded-b-2xl relative">
        <div id="overallProgressBar" class="absolute h-full transition-all duration-700 w-0 theme-transition" style="background: var(--primary)"></div>
    </div>
</header>
    
    <div class="flex flex-1 overflow-hidden max-w-7xl mx-auto w-full px-3 md:px-4 pb-4">
        <aside class="hidden md:flex w-64 flex-col ios-card mr-4 rounded-2xl overflow-hidden my-0 flex-none">
            <div class="p-4 border-b border-slate-100 font-bold text-slate-700 text-sm flex justify-between bg-white/50"><span>ğŸ—“ï¸ æ—¥ç¨‹è¡¨</span><span class="text-slate-400 font-mono text-xs" id="totalDaysLabel">--</span></div>
            <div class="flex-1 overflow-y-auto p-2 space-y-1 no-scrollbar" id="dateList"></div>
        </aside>
        
        <main class="flex-1 overflow-y-auto relative no-scrollbar rounded-2xl" id="mainScroll">
            <div class="max-w-3xl mx-auto py-2 md:py-4 min-h-[80vh]">
                <div class="md:hidden mb-4 px-1">
    <div class="md:hidden mb-4 px-1">
    <div class="flex items-center justify-between">
        <button onclick="handleMobileDaySwitch(-1)" class="p-2 w-10 h-10 flex items-center justify-center rounded-full text-slate-500 hover:bg-slate-100 active:bg-slate-200 transition"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
        
        <div class="mobile-select-wrapper flex-grow mx-2 relative">
            <select id="mobileDateSelect" 
                onchange="renderDay(parseInt(this.value))" 
                class="w-full appearance-none bg-white/80 backdrop-blur-xl border border-white/60 text-slate-800 font-bold text-sm py-3 px-10 rounded-2xl shadow-sm focus:outline-none focus:border-[var(--primary)] focus:ring-1 focus:ring-[var(--primary)] transition-all">
            </select>
            <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3 text-[var(--primary)]"><i data-lucide="calendar" class="w-4 h-4"></i></div>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3 text-slate-600"><i data-lucide="chevron-down" class="w-4 h-4"></i></div>
        </div>
        
        <button onclick="handleMobileDaySwitch(1)" class="p-2 w-10 h-10 flex items-center justify-center rounded-full text-slate-500 hover:bg-slate-100 active:bg-slate-200 transition"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
    </div>
</div>
</div>
                
                <div class="ios-card rounded-2xl p-6 md:p-8 mb-6 relative overflow-hidden group">
                    <div class="absolute -right-8 -top-8 w-40 h-40 opacity-15 rounded-full blur-3xl transition-colors duration-700 theme-transition" style="background: var(--primary)"></div> 
                    <div class="relative z-10 flex justify-between items-end">
                        <div>
                            <div class="flex items-center gap-2 mb-2"><span class="text-white text-[10px] font-bold px-2 py-0.5 rounded shadow-sm" style="background: #1d1d1f"> ç¬¬<span id="dayCountDisplay">1</span>å¤© </span></div>
                            <h2 class="text-3xl md:text-4xl font-black text-slate-800 tracking-tight" id="currentDateDisplay">--</h2>
                            <div class="mt-4 flex items-center gap-3"><div class="w-32 h-2 bg-slate-100 rounded-full overflow-hidden"><div id="dailyProgressBar" class="h-full transition-all duration-500 w-0 theme-transition" style="background: var(--primary)"></div></div><span class="text-xs font-mono font-bold text-slate-400" id="dailyProgressText">0/0</span></div>
                        </div>
                        <div id="trophyContainer" class="cursor-pointer hover:scale-105 transition-transform" onclick="confettiEffect()"></div>
                    </div>
                </div>
                
                <div id="contentLocker" class="transition-all duration-700 space-y-3"><div id="dynamicTasksContainer"></div></div>
            </div>
        </main>
    </div>
    
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 flex items-center gap-3 px-5 py-2.5 bg-slate-900/90 backdrop-blur text-white rounded-full shadow-2xl transition-all duration-300 opacity-0 translate-y-[-20px] pointer-events-none z-[100]"><i data-lucide="check-circle-2" class="w-4 h-4 text-emerald-400"></i><span id="toastMsg" class="font-bold text-xs tracking-wide">å·²å®Œæˆ</span></div>
    
    <div id="ritualOverlay" class="absolute inset-0 z-40 flex flex-col items-center justify-center transition-all duration-500" style="display: none;"><div class="ios-card p-10 rounded-3xl shadow-2xl max-w-sm w-full text-center border border-white"><div class="lock-icon-bg mb-6 inline-flex p-5 rounded-full shadow-sm theme-transition" style="background: var(--primary-light)"><i data-lucide="lock" class="w-8 h-8 theme-transition" style="color: var(--primary)"></i></div><h3 class="text-2xl font-black text-slate-800 mb-2">æ•´è£…å¾…å‘</h3><p class="text-slate-500 text-sm mb-8 px-2">ä»Šæ—¥è®¡åˆ’å·²é”å®šã€‚å¿ƒæ— æ—éª›ï¼Œæ–¹å¾—å§‹ç»ˆã€‚</p><button onclick="startDay()" class="w-full py-3.5 rounded-xl font-bold text-white shadow-lg transition-transform hover:-translate-y-0.5 active:scale-95 theme-transition" style="background: var(--primary)">å¼€å¯ä»Šæ—¥ä¸“æ³¨ä¹‹æ—…</button></div></div>

    <div id="proModalOverlay"><div class="deepflow-modal"><div class="df-modal-header"><div class="df-modal-title" id="proModalTitle">Title</div><div class="df-modal-desc" id="proModalDesc">Description</div><input type="text" id="proModalInput" class="df-modal-input" style="display: none;"></div><div class="df-modal-actions"><button class="df-modal-btn df-btn-cancel" onclick="closeProModal()">å–æ¶ˆ</button><button class="df-modal-btn df-btn-confirm" id="proModalConfirmBtn" onclick="">ç¡®å®š</button></div></div></div>
    <div id="profileModalOverlay" class="fixed inset-0 z-[10000] bg-black/40 backdrop-blur-sm flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300" onclick="if(event.target===this) closeProfileModal()">
    <div id="xpTipModalOverlay" class="fixed inset-0 z-[10001] bg-black/50 backdrop-blur-sm flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
    <div id="xpTipModal" class="bg-white/95 backdrop-blur-2xl w-80 rounded-2xl p-6 shadow-2xl transform scale-95 transition-all duration-300 text-center" onclick="event.stopPropagation();">
        <div class="inline-flex p-4 rounded-full mb-4" style="background: var(--primary-light)"><i data-lucide="trophy" class="w-6 h-6" style="color: var(--primary)"></i></div>
        <h3 class="text-xl font-black text-slate-800 mb-2">ğŸ‰ å¢ƒç•Œæå‡!</h3>
        <p class="text-sm text-slate-600 mb-6">ç»éªŒç­‰çº§æ’è¡Œæ¦œå·²è§£é”ã€‚ç‚¹å‡» **å·¦ä¸Šè§’å¥–æ¯å›¾æ ‡** å³å¯æŸ¥çœ‹ä½ çš„ä¿®è¡Œé˜…å†å’Œå…¨çƒæ’åã€‚</p>
        <div class="flex gap-3">
            <button onclick="disableXpTip()" class="flex-1 py-3 rounded-xl font-bold text-sm text-slate-500 hover:bg-slate-100 transition">ä¸å†æç¤º</button>
            <button onclick="showProfileModalAndCloseTip()" class="flex-1 py-3 rounded-xl font-bold text-white shadow-lg theme-transition active:scale-95" style="background: var(--primary)">ç«‹å³æŸ¥çœ‹</button>
        </div>
    </div>
</div>
    <div class="bg-white/95 backdrop-blur-2xl w-[95%] max-w-md rounded-[32px] p-6 shadow-2xl transform scale-95 transition-all duration-300 flex flex-col max-h-[85vh]" id="profileModalContent">
        
        <div class="flex justify-between items-center mb-4 flex-none">
            <div class="flex gap-2 bg-slate-100/80 p-1 rounded-xl">
                <button onclick="switchProfileTab('me')" id="tab-me" class="px-4 py-1.5 rounded-lg text-sm font-bold transition-all bg-white shadow-sm text-slate-800">æˆ‘çš„ä¿®ä¸š</button>
                <button onclick="switchProfileTab('rank')" id="tab-rank" class="px-4 py-1.5 rounded-lg text-sm font-bold transition-all text-slate-400 hover:text-slate-600">ç…çŠæ¦œ</button>
            </div>
            <button onclick="closeProfileModal()" class="p-2 bg-slate-100 rounded-full hover:bg-slate-200 transition"><i data-lucide="x" class="w-5 h-5 text-slate-500"></i></button>
        </div>
    
        <div class="overflow-y-auto flex-1 no-scrollbar pr-1">
            
            <div id="view-me">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white text-2xl shadow-lg shadow-blue-500/30 flex-none">
                        <i data-lucide="trophy"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-black text-slate-800" id="profileLevelTitle">Level 1 åˆçª¥é—¨å¾„</h2>
                        <div class="text-xs font-bold text-slate-400 uppercase tracking-wider">ä¿®è¡Œé˜…å†: <span id="xpCount" class="text-slate-600">0</span></div>
                    </div>
                </div>
    
                <div class="mb-8">
                    <div class="flex justify-between text-xs font-bold text-slate-400 mb-2">
                        <span>å½“å‰è¿›å¢ƒ</span>
                        <span class="text-indigo-600">è·ç¦»ä¸‹ä¸€å¢ƒç•Œ: <span id="nextLevelXp">100</span> XP</span>
                    </div>
                    <div class="xp-bar-container">
                        <div id="xpBarFill" class="xp-bar-fill"></div>
                    </div>
                </div>
    
                <div class="grid grid-cols-3 gap-3 mb-8">
                    <div class="bg-slate-50 p-3 rounded-2xl text-center border border-slate-100">
                        <div class="text-xl font-black text-orange-500 flex items-baseline justify-center gap-0.5"><span id="streakCount">0</span><small class="text-[10px] text-orange-300">å¤©</small></div>
                        <div class="text-[10px] font-bold text-slate-400">æ—¥ç§¯è·¬æ­¥</div>
                    </div>
                    <div class="bg-slate-50 p-3 rounded-2xl text-center border border-slate-100">
                        <div class="text-xl font-black text-blue-500 flex items-baseline justify-center gap-0.5"><span id="totalTasksCount">0</span><small class="text-[10px] text-blue-300">é¡¹</small></div>
                        <div class="text-[10px] font-bold text-slate-400">ç¡•æœç´¯ç´¯</div>
                    </div>
                    <div class="bg-slate-50 p-3 rounded-2xl text-center border border-slate-100">
                        <div class="text-xl font-black text-purple-500 flex items-baseline justify-center gap-0.5"><span id="focusCount">0</span><small class="text-[10px] text-purple-300">åˆ†</small></div>
                        <div class="text-[10px] font-bold text-slate-400">å¿ƒæµç¦…å®š</div>
                    </div>
                </div>
    
                <div>
                    <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2 text-sm"><i data-lucide="medal" class="w-4 h-4 text-yellow-500"></i> è£èª‰å‹‹ç«  <span class="text-xs font-normal text-slate-400 ml-auto">ç‚¹å‡»æŸ¥çœ‹æ¡ä»¶</span></h3>
                    <div class="badge-grid" id="badgesGrid"></div>
                </div>
            </div>
    
            <div id="view-rank" style="display: none;">
                <div class="flex gap-2 mb-4 overflow-x-auto no-scrollbar pb-1">
                    <button onclick="renderLeaderboard('xp')" class="rank-filter-btn active" data-type="xp">é˜…å†æ¦œ</button>
                    <button onclick="renderLeaderboard('focus')" class="rank-filter-btn" data-type="focus">ç¦…å®šæ¦œ</button>
                    <button onclick="renderLeaderboard('streak')" class="rank-filter-btn" data-type="streak">æ¯…åŠ›æ¦œ</button>
                </div>
                
                <div class="bg-slate-50 rounded-2xl border border-slate-100 overflow-hidden" id="leaderboardList">
                    </div>
                <div class="text-center mt-4 text-[10px] text-slate-300">æ’è¡Œæ¦œæ•°æ®æ¯å°æ—¶æ›´æ–° Â· ä¸å…¨çƒå­¦å‹å…±å‹‰</div>
            </div>
    
        </div>
    </div>
</div>
    <div id="focusDockWrapper"><div id="dockTooltip" class="show"><span>å¯åŠ¨å¿ƒæµè¿›ç¨‹</span> <i data-lucide="activity" class="w-4 h-4"></i></div><div id="dockOrb"><i data-lucide="activity" class="w-6 h-6 dock-icon theme-transition" style="color: var(--primary)"></i></div><div id="dockPanel"><div class="flex justify-between items-center mb-6"><span class="text-[10px] font-bold text-slate-400 tracking-widest uppercase">   ç•ª   èŒ„   é’Ÿ   ğŸ…</span><button onclick="toggleDock()" class="p-1 hover:bg-slate-100 rounded-full"><i data-lucide="x" class="w-4 h-4 text-slate-400"></i></button></div><div class="flex items-center justify-between mb-6 bg-slate-50 rounded-2xl p-2 relative overflow-hidden"><button onclick="adjustTime(-5)" class="w-12 h-12 flex items-center justify-center rounded-xl hover:bg-white text-slate-400 font-bold transition active:scale-95">-5</button><div id="dockTime" onclick="showTimeInput()" title="ç‚¹å‡»ä¿®æ”¹æ—¶é—´" class="text-4xl font-black text-slate-800 font-mono tracking-tight cursor-pointer hover:opacity-80 transition">25:00</div><button onclick="adjustTime(5)" class="w-12 h-12 flex items-center justify-center rounded-xl hover:bg-white text-slate-400 font-bold transition active:scale-95">+5</button><div id="customTimeOverlay"><input type="text" id="customTimeInput" class="pro-input" placeholder="25:00" onkeydown="if(event.key==='Enter') submitTime()"><div class="flex gap-2"><button onclick="submitTime()" class="text-xs bg-slate-900 text-white px-3 py-1 rounded-lg">ç¡®è®¤</button><button onclick="hideTimeInput()" class="text-xs text-slate-400 px-2 py-1">å–æ¶ˆ</button></div></div></div><button id="mainBtn" onclick="toggleTimer()" class="w-full py-4 rounded-xl font-bold text-white shadow-lg shadow-blue-500/20 active:scale-95 transition flex items-center justify-center gap-2 mb-2 theme-transition" style="background: var(--primary)"><i data-lucide="play" class="w-4 h-4"></i> <span>å¼€å§‹</span></button><button onclick="enterImmersive()" class="w-full py-3 rounded-xl font-bold text-slate-500 border border-slate-200 hover:bg-slate-50 active:scale-95 transition text-xs flex items-center justify-center gap-2"><i data-lucide="maximize" class="w-3 h-3"></i> æµå…‰æ¨¡å¼</button></div></div>
    
    <div id="immersiveLayer" class="im-mix"> 
    <div class="immersive-blob blob-1"></div>
    <div class="immersive-blob blob-2"></div>
    <div class="immersive-blob blob-3"></div>

    <div class="full-center-wrapper">
        <div class="flow-label">FLOW STATE</div>
        <div id="immTime" class="giant-time">25:00</div>
        
        <div class="flex items-center gap-10">
            <button onclick="exitImmersive()" class="btn-sub" title="é€€å‡º">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>

            <button onclick="toggleTimer()" class="btn-hero">
                <i id="immIcon" data-lucide="pause" class="w-10 h-10 fill-current"></i>
            </button>
            
            <button onclick="toggleSFX()" class="btn-sub" title="é™éŸ³">
                <i data-lucide="volume-2" class="w-5 h-5"></i>
            </button>
        </div>
    </div>
</div>
</div>
    <div id="noiseDockWrapper" style="position: fixed; bottom: 100px; left: 20px; z-index: 20000; touch-action: none;">
        <div id="noiseTooltip" style="position: absolute; left: 70px; top: 50%; transform: translateY(-50%); background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); color: #1d1d1f; padding: 8px 14px; border-radius: 10px; font-size: 12px; font-weight: 600; white-space: nowrap; pointer-events: none; opacity: 0; transition: opacity 0.5s; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05);">
            ç™½å™ªéŸ³ & éŸ³æ•ˆè®¾ç½®
            <div style="position: absolute; left: -5px; top: 50%; transform: translateY(-50%); width: 0; height: 0; border-top: 5px solid transparent; border-bottom: 5px solid transparent; border-right: 5px solid rgba(255,255,255,0.9);"></div>
        </div>
        <div id="noiseOrb" style="width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: grab; transition: transform 0.1s; position: relative; z-index: 20002;">
            <i data-lucide="headphones" class="w-6 h-6 pointer-events-none relative z-10"></i>
        </div>
        
        <div id="noisePanel" style="position: absolute; bottom: 0; width: 260px; padding: 24px; border-radius: 24px; display: none; opacity: 0; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 20001; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(30px); box-shadow: 0 20px 50px -12px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.8);">
    
    <div class="flex justify-between items-center mb-5">
        <div class="flex items-center gap-2">
            <span class="text-[10px] font-bold uppercase tracking-widest text-slate-400">ç™½ å™ª éŸ³ </span>
            <button id="sfxToggleBtn" onclick="toggleSFX()" class="text-[10px] bg-slate-100 px-2 py-1 rounded-md text-slate-500 font-bold hover:bg-slate-200 transition-colors flex items-center gap-1">
                <i data-lucide="volume-2" class="w-3 h-3"></i> äº¤äº’éŸ³
            </button>
        </div>
        <input type="range" min="0" max="1" step="0.1" value="0.6" oninput="changeNoiseVolume(this.value)" class="w-20 h-1.5 rounded-lg appearance-none bg-slate-200 cursor-pointer accent-slate-600">
    </div>
    
    <div class="grid grid-cols-4 gap-3 mb-5">
        <div class="noise-card relative" onclick="playNoise('rain')" title="ç©ºå±±æ–°é›¨"><i data-lucide="cloud-rain"></i></div>
        <div class="noise-card relative" onclick="playNoise('ocean')" title="æ²§æµ·å¬æ¶›"><i data-lucide="waves"></i></div>
        <div class="noise-card relative" onclick="playNoise('forest')" title="æ—é—´è‰é¸£"><i data-lucide="trees"></i></div>
        <div class="noise-card relative" onclick="playNoise('fire')" title="çº¢æ³¥ç«ç‚‰"><i data-lucide="flame"></i></div>
        <div class="noise-card relative" onclick="playNoise('cafe')" title="å¸‚äº•å–§åš£"><i data-lucide="coffee"></i></div>
        <div class="noise-card relative" onclick="playNoise('train')" title="è¿œè¡Œæ—…é€”"><i data-lucide="train"></i></div>
        <div class="noise-card relative" onclick="playNoise('night')" title="é™è°§å¤å¤œ"><i data-lucide="moon"></i></div>
        <div class="noise-card relative" onclick="playNoise('keyboard')" title="å¦™ç¬”ç”ŸèŠ±"><i data-lucide="keyboard"></i></div>
    </div>
    
    <button id="noiseStopBtn" onclick="stopAllNoise()" class="w-full text-xs py-2.5 rounded-xl font-bold text-slate-500 hover:text-slate-800 hover:bg-slate-100 transition border border-slate-200 flex items-center justify-center gap-2">
        <i data-lucide="square" class="w-3 h-3"></i> åœæ­¢æ’­æ”¾
    </button>
</div>

    <script>
        
        const script = document.createElement('script');
script.src = 'rules_db.js';
script.onerror = () => console.warn('rules_db.js not found, skipping.');
document.head.appendChild(script);

// ã€â­ æ ¸å¿ƒä¿®å¤ï¼šå®šä¹‰æ­£ç¡®çš„å®‰å…¨åˆå§‹åŒ–å‡½æ•° â­ã€‘
function initLucideSafe() {
    // æ£€æŸ¥ Lucide å¯¹è±¡æ˜¯å¦å­˜åœ¨ï¼Œå¹¶ç¡®ä¿ createIcons æ–¹æ³•å¯ç”¨
    if (window.lucide && typeof window.lucide.createIcons === 'function') {
        window.lucide.createIcons(); // æ­£ç¡®è°ƒç”¨ Lucide çš„æ¸²æŸ“æ–¹æ³•
    } else {
        // å¦‚æœåº“æœªåŠ è½½å®Œæˆï¼Œè®¾ç½®é‡è¯•æœºåˆ¶
        if (!window.lucideRetries) window.lucideRetries = 0;
        if (window.lucideRetries < 20) { 
            window.lucideRetries++;
            setTimeout(initLucideSafe, 50);
        }
    }
}

// ç»Ÿä¸€å…¥å£ï¼Œç¡®ä¿åœ¨ DOM å†…å®¹åŠ è½½å®Œæ¯•åæ‰§è¡Œå®‰å…¨åˆå§‹åŒ– (æ›¿æ¢åŸæœ‰ init() çš„è°ƒç”¨æ–¹å¼)
window.addEventListener('DOMContentLoaded', init);
window.addEventListener('DOMContentLoaded', initLucideSafe);
window.addEventListener('load', initLucideSafe);
        // --- å…¨å±€å˜é‡å®šä¹‰ ---
        const DOPAMINE_COLORS = ['#007AFF', '#FF3B30', '#FF9500', '#AF52DE', '#34C759', '#32ADE6', '#FF2D55', '#5856D6', '#FFCC00', '#00C7BE'];
        const RAW_DATA = '{{TASKS_DATA}}';
        const OSS_BASE = "https://deepflow-hellojyh-audio.oss-cn-hangzhou.aliyuncs.com";
        const NOISE_BASE = "https://deepflow-hellojyh-audio.oss-cn-hangzhou.aliyuncs.com/audio/ambience/";
       // --- â­ ç²’å­å¼•æ“ V4.0ï¼šæ——èˆ°æµæ˜Ÿ (æ‹’ç»æ•·è¡ç‰ˆ) + ç»ç¾æ¨±èŠ± â­ ---
const PARTICLE_ENGINE = {
    canvas: null, ctx: null, width: 0, height: 0, particles: [], animationId: null, mode: 'off',
    
    init: function() {
        this.canvas = document.getElementById('particleCanvas');
        if(!this.canvas) return;
        this.ctx = this.canvas.getContext('2d');
        this.resize();
        
        window.addEventListener('resize', () => this.resize());
        
        const savedMode = localStorage.getItem('pro_visual_mode') || 'sakura';
        this.setMode(savedMode);
    },

    resize: function() { 
        // å…³é”®ï¼šè·å–è®¾å¤‡åƒç´ æ¯”ï¼Œä¿è¯æ‰‹æœºç«¯æ¸…æ™°åº¦
        const dpr = window.devicePixelRatio || 1;
        this.width = window.innerWidth; 
        this.height = window.innerHeight; 
        
        this.canvas.width = this.width * dpr;
        this.canvas.height = this.height * dpr;
        
        this.canvas.style.width = this.width + 'px';
        this.canvas.style.height = this.height + 'px';
        
        this.ctx.scale(dpr, dpr);
    },

    setMode: function(mode) {
        this.mode = mode; 
        this.particles = [];
        if(this.animationId) cancelAnimationFrame(this.animationId);
        if(mode !== 'off') this.start(); 
        else this.ctx.clearRect(0,0,this.width+100,this.height+100);
    },

    start: function() { this.loop(); },

    createParticle: function() {
        const isMobile = this.width < 768;

        if(this.mode === 'meteor') {
            // ğŸŒ  æ——èˆ°çº§æµæ˜Ÿç”Ÿæˆé€»è¾‘
            // èŒƒå›´æ‰©å¤§åˆ° 2å€ å®½åº¦ï¼Œç¡®ä¿å…¨å±éƒ½æœ‰åˆ’è¿‡
            const startX = Math.random() * this.width * 2 - (this.width * 0.5); 
            const startY = -Math.random() * this.height * 0.5; // ä»ä¸Šæ–¹æ›´é«˜å¤„è½ä¸‹
            
            return {
                x: startX, 
                y: startY,
                angle: Math.PI / 4 + (Math.random() - 0.5) * 0.2, // è§’åº¦ç¨å¾®éšæœºä¸€ç‚¹
                
                // ğŸš€ æ ¸å¿ƒä¼˜åŒ– 1ï¼šé€Ÿåº¦
                // æ‰‹æœºä¸Šç¨å¾®æ…¢ä¸€ç‚¹ï¼Œå› ä¸ºå±å¹•å°ï¼Œå¤ªå¿«çœ‹ä¸æ¸…
                speed: (Math.random() * 10 + 8) * (isMobile ? 0.6 : 1), 
                
                // ğŸ“ æ ¸å¿ƒä¼˜åŒ– 2ï¼šé•¿åº¦
                // æ‰‹æœºä¸Šè¦æ›´é•¿çš„æ‹–å°¾ï¼Œè§†è§‰æ•ˆæœæ‰å¥½
                length: Math.random() * (isMobile ? 250 : 200) + 100, 
                
                // ğŸ–Œï¸ æ ¸å¿ƒä¼˜åŒ– 3ï¼šå®½åº¦ (ç²—ç»†)
                // æ‰‹æœºç«¯å¼ºåˆ¶åŠ ç²—ï¼æœ€å° 2pxï¼Œæœ€å¤§ 4px
                width: isMobile ? (Math.random() * 2 + 2) : (Math.random() * 1.5 + 0.5), 
                
                alpha: Math.random() * 0.5 + 0.5,
                type: 'meteor'
            };
        }

        if(this.mode === 'sakura') {
            return {
                x: Math.random() * this.width,
                y: -Math.random() * 50 - 20, 
                size: Math.random() * 12 + 8, 
                speedX: Math.random() * 1 - 0.5, 
                speedY: Math.random() * 1.5 + 1, 
                rotation: Math.random() * Math.PI * 2, 
                rotationSpeed: (Math.random() - 0.5) * 0.02, 
                flip: Math.random(), 
                flipSpeed: Math.random() * 0.03 + 0.005, 
                colorPhase: Math.random(), 
                type: 'sakura'
            };
        }

        if(this.mode === 'bubbles') return { x: Math.random() * this.width, y: this.height + 20, speed: Math.random() * 2 + 0.5, size: Math.random() * 20 + 5, color: `hsla(${Math.random()*360}, 80%, 70%, 0.6)`, wobble: Math.random() * Math.PI * 2, type: 'bubble' };
        
        if(this.mode === 'fireflies') return { x: Math.random() * this.width, y: Math.random() * this.height, vx: (Math.random() - 0.5) * 1, vy: (Math.random() - 0.5) * 1, size: Math.random() * 3 + 1, opacity: Math.random(), fadeDir: 1, type: 'firefly' };
    },

    drawSakuraPetal: function(ctx, p) {
        ctx.save();
        ctx.translate(p.x, p.y);
        const flipScale = Math.abs(Math.sin(p.flip)); 
        ctx.rotate(p.rotation);
        ctx.scale(1, flipScale); 
        const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, p.size);
        if (p.colorPhase > 0.7) {
            gradient.addColorStop(0, "rgba(255, 255, 255, 0.9)");
            gradient.addColorStop(1, "rgba(255, 220, 230, 0.8)");
        } else {
            gradient.addColorStop(0, "rgba(255, 240, 245, 0.9)");
            gradient.addColorStop(1, "rgba(255, 183, 197, 0.85)");
        }
        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.moveTo(0, p.size); 
        ctx.bezierCurveTo(p.size / 2, p.size / 2, p.size, -p.size / 2, 0, -p.size);
        ctx.bezierCurveTo(-p.size, -p.size / 2, -p.size / 2, p.size / 2, 0, p.size);
        ctx.fill();
        ctx.restore();
    },

    loop: function() {
        if(this.mode === 'off') return;
        
        this.ctx.clearRect(0, 0, this.width + 100, this.height + 100);
        
        const isMobile = this.width < 768;
        
        // ğŸ“Š æ•°é‡æ§åˆ¶
        let maxParticles = 100;
        // æ‰‹æœºç«¯æµæ˜Ÿæ•°é‡ï¼šä» 15 æå‡åˆ° 25ï¼Œè™½ç„¶ä¸å¤šï¼Œä½†é…åˆåŠ ç²—æ•ˆæœä¼šå¾ˆæ˜æ˜¾
        if (this.mode === 'meteor') maxParticles = isMobile ? 25 : 40; 
        if (this.mode === 'sakura') maxParticles = isMobile ? 40 : 80;

        // ğŸ² ç”Ÿæˆæ¦‚ç‡ (Chance)
        let chance = 0.05;
        // æ‰‹æœºç«¯æµæ˜Ÿç”Ÿæˆæ¦‚ç‡æå‡
        if(this.mode === 'meteor') chance = isMobile ? 0.15 : 0.3; 
        if(this.mode === 'sakura') chance = 0.04;
        
        if(Math.random() < chance && this.particles.length < maxParticles) {
            this.particles.push(this.createParticle());
        }

        for(let i=0; i<this.particles.length; i++) {
            let p = this.particles[i];
            
            if(p.type === 'meteor') {
                this.ctx.globalCompositeOperation = 'screen'; // å‘å…‰æ¨¡å¼
                
                p.x -= p.speed * Math.cos(p.angle); 
                p.y += p.speed * Math.sin(p.angle);

                const tailX = p.x + p.length * Math.cos(p.angle);
                const tailY = p.y - p.length * Math.sin(p.angle);

                const gradient = this.ctx.createLinearGradient(p.x, p.y, tailX, tailY);
                // å¤´éƒ¨ï¼šçº¯ç™½é«˜äº®
                gradient.addColorStop(0, `rgba(255, 255, 255, ${p.alpha})`);
                // ä¸­éƒ¨ï¼šå†°è“è‰²ï¼Œå¸¦ä¸€ç‚¹ç‚¹ç´«ï¼Œå¢åŠ é«˜çº§æ„Ÿ
                gradient.addColorStop(0.1, `rgba(160, 210, 255, ${p.alpha * 0.8})`);
                // å°¾éƒ¨ï¼šé€æ˜
                gradient.addColorStop(1, "rgba(100, 200, 255, 0)");

                this.ctx.strokeStyle = gradient;
                this.ctx.lineWidth = p.width; // ä½¿ç”¨åŠ ç²—åçš„å®½åº¦
                this.ctx.lineCap = 'round';
                
                this.ctx.beginPath();
                this.ctx.moveTo(p.x, p.y);
                this.ctx.lineTo(tailX, tailY);
                this.ctx.stroke();

                if(p.y > this.height + 200 || p.x < -300) { 
                    this.particles.splice(i, 1); i--; 
                }
            } 
            else if(p.type === 'sakura') {
                this.ctx.globalCompositeOperation = 'source-over';
                p.x += p.speedX + Math.sin(p.flip) * 0.5; 
                p.y += p.speedY;
                p.rotation += p.rotationSpeed;
                p.flip += p.flipSpeed;
                this.drawSakuraPetal(this.ctx, p);
                if(p.y > this.height + 30 || p.x < -50 || p.x > this.width + 50) { 
                    this.particles.splice(i, 1); i--; 
                }
            }
            else if (p.type === 'bubble') {
                this.ctx.globalCompositeOperation = 'screen';
                p.y -= p.speed; p.x += Math.sin(p.wobble); p.wobble += 0.03;
                this.ctx.beginPath(); this.ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); this.ctx.fillStyle = p.color; this.ctx.fill();
                this.ctx.beginPath(); this.ctx.arc(p.x - p.size*0.3, p.y - p.size*0.3, p.size*0.25, 0, Math.PI*2); this.ctx.fillStyle = "rgba(255,255,255,0.6)"; this.ctx.fill();
                if(p.y < -50) { this.particles.splice(i, 1); i--; }
            }
            else if (p.type === 'firefly') {
                this.ctx.globalCompositeOperation = 'screen';
                p.x += p.vx; p.y += p.vy; p.opacity += 0.02 * p.fadeDir;
                if(p.opacity > 1 || p.opacity < 0) p.fadeDir *= -1;
                const g = this.ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.size * 4);
                g.addColorStop(0, `rgba(255, 255, 200, ${Math.abs(p.opacity)})`);
                g.addColorStop(1, "rgba(255, 255, 200, 0)");
                this.ctx.fillStyle = g; this.ctx.beginPath(); this.ctx.arc(p.x, p.y, p.size*4, 0, Math.PI*2); this.ctx.fill();
                this.ctx.fillStyle = "#fff"; this.ctx.beginPath(); this.ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); this.ctx.fill();
                if(p.x < 0 || p.x > this.width || p.y < 0 || p.y > this.height) { this.particles.splice(i, 1); i--; }
            }
        }
        this.animationId = requestAnimationFrame(() => this.loop());
    }
};
// èœå•æ§åˆ¶å‡½æ•°
function toggleVisualMenu(e) { 
    if(e) e.stopPropagation(); 
    const p = document.getElementById('visualPopover'); 
    p.classList.toggle('active'); 
}
function setVisualMode(m) { 
    localStorage.setItem('pro_visual_mode', m); 
    PARTICLE_ENGINE.setMode(m); 
    document.getElementById('visualPopover').classList.remove('active');
    showToast("ç‰¹æ•ˆå·²åˆ‡æ¢"); 
}
// ç‚¹å‡»ç©ºç™½å¤„å…³é—­èœå•
document.addEventListener('click', (e) => { 
    if(!e.target.closest('.visual-btn')) {
        const p = document.getElementById('visualPopover');
        if(p) p.classList.remove('active');
    }
});
        
        let tasksData = []; let planId = 'pro_v4_demo';
        let userProgress = {}; let startedDays = []; 
        let currentMode = 'mix'; let currentSingleColor = DOPAMINE_COLORS[0]; let currentDayIdx = 0;
        let timer = null, timeLeft = 25 * 60, isRunning = false;
        let currentSessionMin = 25;
        // --- ğŸ® ä¿®å¤ç‰ˆï¼šXP æ¸¸æˆåŒ–å¼•æ“ (Gamification Engine v2) ---
const PROFILE_KEY = 'v4_profile_' + planId; // ç»‘å®šåˆ°å½“å‰è®¡åˆ’ID

// --- 1. [æ ¸å¿ƒå‡çº§] æ¸¸æˆåŒ–å¼•æ“ (å¢å¼ºç‰ˆï¼šæ›´å¤šæˆå°±+æ˜ç¡®æŒ‡å¼•) ---
const BADGES_CONFIG = [
    // --- åŸºç¡€ç¯‡ ---
    { id: 'first_step', icon: 'footprints', name: 'è·¬æ­¥åƒé‡Œ', desc: 'ã€æ¡ä»¶ã€‘å®Œæˆä½ çš„ç¬¬ 1 ä¸ªä»»åŠ¡', condition: (p) => p.totalTasks >= 1 },
    { id: 'streak_3', icon: 'flame', name: 'æ¸å…¥ä½³å¢ƒ', desc: 'ã€æ¡ä»¶ã€‘è¿ç»­æ‰“å¡ 3 å¤©', condition: (p) => p.streak >= 3 },
    { id: 'streak_7', icon: 'zap', name: 'æŒä¹‹ä»¥æ’', desc: 'ã€æ¡ä»¶ã€‘è¿ç»­æ‰“å¡ 7 å¤©', condition: (p) => p.streak >= 7 },
    { id: 'streak_21', icon: 'award', name: 'ä¹ æƒ¯å…»æˆ', desc: 'ã€æ¡ä»¶ã€‘è¿ç»­æ‰“å¡ 21 å¤©', condition: (p) => p.streak >= 21 },

    // --- ä¸“æ³¨ç¯‡ ---
    { id: 'focus_master', icon: 'brain', name: 'å¿ƒæ— æ—éª›', desc: 'ã€æ¡ä»¶ã€‘ç´¯è®¡ä¸“æ³¨æ—¶é•¿è¾¾åˆ° 100 åˆ†é’Ÿ', condition: (p) => (p.focusMinutes || 0) >= 100 },
    { id: 'deep_diver', icon: 'anchor', name: 'æ·±æµ·æ½œè¡Œ', desc: 'ã€æ¡ä»¶ã€‘ç´¯è®¡ä¸“æ³¨æ—¶é•¿è¾¾åˆ° 1000 åˆ†é’Ÿ', condition: (p) => (p.focusMinutes || 0) >= 1000 },
    { id: 'zen_mode', icon: 'lotus', name: 'å¤©äººåˆä¸€', desc: 'ã€æ¡ä»¶ã€‘å•æ¬¡ä¸“æ³¨æ—¶é•¿è®¾å®šè¶…è¿‡ 45 åˆ†é’Ÿå¹¶å®Œæˆ', condition: (p) => p.maxSession >= 45 },

    // --- ä»»åŠ¡ç¯‡ ---
    { id: 'half_way', icon: 'mountain', name: 'ä¸­æµå‡»æ°´', desc: 'ã€æ¡ä»¶ã€‘æ€»ä»»åŠ¡å®Œæˆç‡è¶…è¿‡ 50%', condition: (p) => p.completionRate >= 50 },
    { id: 'perfectionist', icon: 'crown', name: 'å°½å–„å°½ç¾', desc: 'ã€æ¡ä»¶ã€‘ç´¯è®¡ 3 å¤©å®Œæˆå½“æ—¥æ‰€æœ‰ä»»åŠ¡', condition: (p) => p.perfectDays >= 3 },
    { id: 'task_hunter', icon: 'target', name: 'èµé‡‘çŒäºº', desc: 'ã€æ¡ä»¶ã€‘ç´¯è®¡å®Œæˆ 50 ä¸ªä»»åŠ¡', condition: (p) => p.totalTasks >= 50 },

    // --- ä¹ æƒ¯ç¯‡ ---
    { id: 'early_bird', icon: 'sunrise', name: 'é—»é¸¡èµ·èˆ', desc: 'ã€æ¡ä»¶ã€‘åœ¨æ—©ä¸Š 9 ç‚¹å‰å®Œæˆä¸€æ¬¡æ‰“å¡', condition: (p) => p.hasEarlyTask },
    { id: 'night_owl', icon: 'moon', name: 'æŒ‘ç¯å¤œæˆ˜', desc: 'ã€æ¡ä»¶ã€‘åœ¨æ™šä¸Š 10 ç‚¹åå®Œæˆä¸€æ¬¡æ‰“å¡', condition: (p) => p.hasLateTask },
    { id: 'ai_user', icon: 'bot', name: 'å¦‚è™æ·»ç¿¼', desc: 'ã€æ¡ä»¶ã€‘ä½¿ç”¨è¿‡ AI è¾…åŠ©æˆ–ç”ŸæˆåŠŸèƒ½', condition: (p) => p.aiUsed },
    
    // --- ç»ˆæ ---
    { id: 'legend', icon: 'trophy', name: 'ç™»å³°é€ æ', desc: 'ã€æ¡ä»¶ã€‘è¾¾åˆ° Level 10 ä¸”å®Œæˆæ‰€æœ‰ä»»åŠ¡', condition: (p) => p.level >= 10 && p.completionRate >= 100 }
];

// é˜ˆå€¼ï¼š0çº§->1çº§éœ€è¦0XP(å‡ºç”Ÿ), 1->2éœ€è¦100XP...
const LEVEL_THRESHOLDS = [0, 100, 300, 600, 1000, 1500, 2200, 3000, 4000, 5500, 7500, 10000];

let userProfile = JSON.parse(localStorage.getItem(PROFILE_KEY) || JSON.stringify({
    xp: 0, level: 1, streak: 0, lastActive: null, badges: [], 
    totalTasks: 0, focusSessions: 0, focusMinutes: 0, maxSession: 0, // åŠ äº† maxSession
    hasEarlyTask: false, hasLateTask: false,
    perfectDays: 0, aiUsed: false, activeDays: 0, completionRate: 0
}));

function saveProfile() { localStorage.setItem(PROFILE_KEY, JSON.stringify(userProfile)); }

// ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šæ”¯æŒå¢å‡ XPï¼Œä¸”åŠ¨æ€è®¡ç®—ç­‰çº§ï¼Œé˜²æ­¢æ— é™åˆ·çº§
// ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šæ”¯æŒå¢å‡ XPï¼Œä¸”åŠ¨æ€è®¡ç®—ç­‰çº§ï¼Œé˜²æ­¢æ— é™åˆ·çº§
function gainXP(amount) {
    const oldLevel = userProfile.level;
    userProfile.xp += amount;
    if(userProfile.xp < 0) userProfile.xp = 0; // ä¸å…è®¸è´Ÿåˆ†

    // é‡æ–°è®¡ç®—ç­‰çº§
    let newLevel = 1;
    for (let i = 0; i < LEVEL_THRESHOLDS.length; i++) {
        if (userProfile.xp >= LEVEL_THRESHOLDS[i]) {
            newLevel = i + 1; // ç´¢å¼•0æ˜¯1çº§
        } else {
            break; 
        }
    }
    userProfile.level = newLevel;

    // å‡çº§åˆ¤å®š
    if (newLevel > oldLevel) {
        AUDIO_SYSTEM.play('finish'); // ä½¿ç”¨ finish éŸ³æ•ˆåº†ç¥å‡çº§
        showToast(`ğŸ‰ å‡çº§å•¦ï¼Level ${newLevel}`);
        confettiEffect();
        
        // â­ ã€æ–°å¢é€»è¾‘ã€‘: å»¶è¿Ÿå¼¹çª—åº†ç¥ï¼Œå¹¶åœ¨ Profile Modal å…³é—­åè§¦å‘ XP æç¤º
        setTimeout(() => openProfileModal(), 1500);
        
        // å…³é”®ï¼šæ£€æŸ¥æ˜¯å¦éœ€è¦æç¤º XP æŒ‰é’®ä½ç½®
        if (localStorage.getItem('pro_xp_tip_disabled') !== 'true') {
            // åœ¨ Profile Modal å…³é—­åæ‰§è¡Œæç¤º
            document.getElementById('profileModalOverlay').addEventListener('transitionend', function handler() {
                if (!document.getElementById('profileModalOverlay').classList.contains('show')) {
                    setTimeout(openXpTipModal, 500); // å»¶è¿Ÿæ‰“å¼€ XP æç¤º
                    this.removeEventListener('transitionend', handler);
                }
            });
        }
    }
    
    checkBadges();
    saveProfile();
}

function checkBadges() {
    // é‡æ–°è®¡ç®—æ€»è¿›åº¦
    let totalAll = 0; let doneAll = 0;
    tasksData.forEach(d => {
        totalAll += d.tasks.length;
        d.tasks.forEach((_, ti) => { if(userProgress[d.date+'_'+ti]) doneAll++; });
    });
    
    userProfile.totalTasks = doneAll;
    userProfile.completionRate = totalAll ? (doneAll / totalAll * 100) : 0;

    let newBadges = false;
    BADGES_CONFIG.forEach(badge => {
        if (!userProfile.badges.includes(badge.id) && badge.condition(userProfile)) {
            userProfile.badges.push(badge.id);
            showToast(`ğŸ† è§£é”æˆå°±: ${badge.name}`);
            newBadges = true;
        }
    });
    if (newBadges) { 
        AUDIO_SYSTEM.play('check'); // æˆå°±è§£é”éŸ³æ•ˆ
        saveProfile(); 
    }
}

// --- â­ ä¿®å¤ç‰ˆï¼šè¿èƒœè®¡ç®—é€»è¾‘ (ç²¾å‡†åˆ¤æ–­æ˜¨æ—¥) â­ ---
function updateStreak() {
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];

    // 1. å¦‚æœä»Šå¤©å·²ç»æ›´æ–°è¿‡ï¼Œç›´æ¥è¿”å›ï¼Œé¿å…é‡å¤å¢åŠ 
    if (userProfile.lastActive === todayStr) return;

    // 2. è®¡ç®—â€œæ˜¨å¤©â€çš„æ—¥æœŸå­—ç¬¦ä¸²
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayStr = yesterday.toISOString().split('T')[0];

    // 3. æ ¸å¿ƒåˆ¤å®š
    if (userProfile.lastActive === yesterdayStr) {
        // å¦‚æœä¸Šæ¬¡æ´»åŠ¨æ˜¯æ˜¨å¤© -> è¿èƒœ+1
        userProfile.streak++;
    } else {
        // å¦‚æœä¸Šæ¬¡æ´»åŠ¨ä¸æ˜¯æ˜¨å¤©ï¼ˆæ˜¯å‰å¤©ã€å¤§å‰å¤©ã€æˆ–è€…ä»æœªå¼€å§‹ï¼‰ -> é‡ç½®ä¸º 1
        userProfile.streak = 1;
    }

    // 4. ä¿å­˜çŠ¶æ€
    userProfile.lastActive = todayStr;
    userProfile.activeDays++; // ç´¯è®¡æ´»è·ƒæ€»å¤©æ•°
    saveProfile();
}

function getLevelTitle(lvl) {
    if(lvl < 3) return "åˆçª¥é—¨å¾„"; // åˆšå¼€å§‹æ¢ç´¢
    if(lvl < 5) return "ç•¥æœ‰å°æˆ"; // å–å¾—äº†ä¸€äº›æˆç»©
    if(lvl < 8) return "é©¾è½»å°±ç†Ÿ"; // å·²ç»éå¸¸ç†Ÿç»ƒ
    if(lvl < 10) return "ç‚‰ç«çº¯é’"; // è¾¾åˆ°å¾ˆé«˜çš„å¢ƒç•Œ
    return "å‡ºç¥å…¥åŒ–"; // é¡¶çº§ä¼ è¯´
}

// æ¸²æŸ“ Modal
// æ¸²æŸ“ Modal (ä¼˜åŒ–å¾½ç« ç‚¹å‡»ä½“éªŒç‰ˆ)
function renderProfileModal() {
    // åŸºç¡€ä¿¡æ¯
    document.getElementById('profileLevelTitle').innerText = `Level ${userProfile.level} ${getLevelTitle(userProfile.level)}`;
    
    // æ•°æ®æ›´æ–° (ä½¿ç”¨ innerText ä¿æŠ¤å•ä½)
    document.getElementById('streakCount').innerText = userProfile.streak;
    document.getElementById('totalTasksCount').innerText = userProfile.totalTasks;
    document.getElementById('focusCount').innerText = userProfile.focusMinutes || 0;
    document.getElementById('xpCount').innerText = Math.floor(userProfile.xp);

    // è¿›åº¦æ¡è®¡ç®—
    const currentLvlIdx = userProfile.level - 1;
    const prevXp = LEVEL_THRESHOLDS[currentLvlIdx];
    const nextXp = LEVEL_THRESHOLDS[currentLvlIdx + 1] || (prevXp + 5000); 
    
    let progress = 0;
    let nextNeed = 0;
    
    if (userProfile.level >= LEVEL_THRESHOLDS.length) {
        progress = 100;
        nextNeed = "MAX";
    } else {
        progress = ((userProfile.xp - prevXp) / (nextXp - prevXp)) * 100;
        nextNeed = nextXp - userProfile.xp;
    }
    
    document.getElementById('xpBarFill').style.width = `${Math.max(0, Math.min(100, progress))}%`;
    document.getElementById('nextLevelXp').innerText = typeof nextNeed === 'number' ? Math.floor(nextNeed) : nextNeed;

    // å¾½ç« æ¸²æŸ“
    const badgeContainer = document.getElementById('badgesGrid');
    badgeContainer.innerHTML = BADGES_CONFIG.map(b => {
        const unlocked = userProfile.badges.includes(b.id);
        const iconColor = unlocked ? 'text-yellow-500' : 'text-slate-300';
        
        // â­ ä¿®å¤ï¼šä¸å†ä½¿ç”¨ alertï¼Œæ”¹ä¸ºè°ƒç”¨ showBadgeTip â­
        // è¿™é‡ŒæŠŠå¾½ç« çš„åå­—å’Œæè¿°ä¼ è¿›å»
        return `
            <div class="badge-item ${unlocked ? 'unlocked' : ''}" onclick="showBadgeTip('${b.name}', '${b.desc}')">
                <i data-lucide="${b.icon}" class="${iconColor} w-5 h-5"></i>
                <span class="badge-name">${b.name}</span>
            </div>
        `;
    }).join('');

    if(window.lucide) initLucideSafe();
}

// â­ æ–°å¢ï¼šä¸“é—¨ç”¨äºæ˜¾ç¤ºå¾½ç« è¯¦æƒ…çš„ä¼˜é›…æç¤ºå‡½æ•° â­
function showBadgeTip(name, desc) {
    const t = document.getElementById('toast'); 
    const m = document.getElementById('toastMsg');
    const icon = t.querySelector('i');
    
    // è®¾ç½®æ–‡æ¡ˆï¼šæ ‡é¢˜ + æè¿°
    if(m) m.innerHTML = `<span class="font-black text-yellow-300">${name}</span> <span class="opacity-80 font-normal">| ${desc}</span>`;
    
    // è®¾ç½®å›¾æ ‡ä¸ºå¥–ç‰Œ
    if(icon) icon.setAttribute('data-lucide', 'medal');
    if(window.lucide) initLucideSafe();

    // æ˜¾ç¤º Toast
    t.style.opacity = '1'; 
    t.style.transform = 'translate(-50%, 0)'; 
    
    // è¿™é‡Œçš„å»¶æ—¶è®¾ä¸º 4000ms (4ç§’)ï¼Œè®©ç”¨æˆ·æœ‰è¶³å¤Ÿæ—¶é—´çœ‹æ¸…æ¡ä»¶
    if(window.toastTimer) clearTimeout(window.toastTimer);
    window.toastTimer = setTimeout(() => { 
        t.style.opacity = '0'; 
        t.style.transform = 'translate(-50%, -20px)'; 
    }, 4000); 
}

function openProfileModal() { renderProfileModal(); document.getElementById('profileModalOverlay').classList.add('show'); }
function closeProfileModal() { document.getElementById('profileModalOverlay').classList.remove('show'); }
        // --- 1. æ ¸å¿ƒå·¥å…·å‡½æ•° ---
        // ä¿®å¤çš„ showToastï¼šå®šä¹‰åœ¨å…¨å±€ä½œç”¨åŸŸï¼Œæ”¯æŒå›¾æ ‡å’Œé˜²æŠ–
        window.showToast = function(msg) { 
            const t = document.getElementById('toast'); 
            const m = document.getElementById('toastMsg');
            if(m) m.innerText = msg || "å·²å®Œæˆ"; 
            
            const icon = t.querySelector('i');
            if(icon) {
                if(msg && msg.includes('æ’­æ”¾')) icon.setAttribute('data-lucide', 'music'); 
                else if(msg && msg.includes('éŸ³æ•ˆ')) icon.setAttribute('data-lucide', 'volume-2');
                else icon.setAttribute('data-lucide', 'check-circle-2');
                if(window.lucide) initLucideSafe();
            }

            t.style.opacity = '1'; 
            t.style.transform = 'translate(-50%, 0)'; 
            
            if(window.toastTimer) clearTimeout(window.toastTimer);
            window.toastTimer = setTimeout(() => { 
                t.style.opacity = '0'; 
                t.style.transform = 'translate(-50%, -20px)'; 
            }, 2000); 
        };

        // --- 2. éŸ³é¢‘ç³»ç»Ÿ ---
        const AUDIO_SYSTEM = {
            sfxEnabled: localStorage.getItem('pro_sfx_enabled') !== 'false',
            pools: {
                check: [ OSS_BASE + "/audio/pro/check1.MP3", OSS_BASE + "/audio/pro/check2.MP3" ],
                start: [ OSS_BASE + "/audio/pro/start1.MP3" , OSS_BASE + "/audio/pro/start2.MP3" ],
                finish: [ OSS_BASE + "/audio/pro/finish.MP3" ]
            },
            cache: {},
            preload: function() { Object.keys(this.pools).forEach(key => { this.cache[key] = this.pools[key].map(src => { const audio = new Audio(); audio.src = src; audio.preload = 'auto'; audio.volume = 1.0; return audio; }); }); this.updateBtn(); },
            toggle: function() {
                this.sfxEnabled = !this.sfxEnabled;
                localStorage.setItem('pro_sfx_enabled', this.sfxEnabled);
                this.updateBtn();
                showToast(this.sfxEnabled ? "ç•Œé¢éŸ³æ•ˆ: å·²å¼€å¯" : "ç•Œé¢éŸ³æ•ˆ: å·²é™éŸ³");
            },
            updateBtn: function() {
                const btn = document.getElementById('sfxToggleBtn');
                if(!btn) return;
                const icon = btn.querySelector('i');
                if(this.sfxEnabled) {
                    btn.classList.remove('opacity-50', 'line-through');
                    btn.style.background = "#e2e8f0";
                    icon.setAttribute('data-lucide', 'volume-2');
                } else {
                    btn.classList.add('opacity-50');
                    btn.style.background = "transparent";
                    icon.setAttribute('data-lucide', 'volume-x');
                }
                if(window.lucide) initLucideSafe();
            },
            play: function(type) { 
                if (!this.sfxEnabled) return; 
                if (!this.cache[type]) return; 
                const audios = this.cache[type]; 
                const audio = audios[Math.floor(Math.random() * audios.length)]; 
                audio.volume = 1.0; audio.currentTime = 0; audio.play().catch(e=>{}); 
            }
        };
// --- 3. ç™½å™ªéŸ³ç³»ç»Ÿ (Web Audio API é‡æ„ç‰ˆ) ---
        const noiseConfig = {
            'rain': [ {n:'ç»µç»µç»†é›¨', f:'rain.mp3'}, {n:'é›·é›¨äº¤åŠ ', f:'rain_2.mp3'}, {n:'å±‹æªé›¨æ»´', f:'rain_3.mp3'} ],
            'ocean': [ {n:'è½»æŸ”æµ·æµª', f:'ocean.mp3'}, {n:'æ·±æµ·æ½œæµ', f:'ocean_2.mp3'} ],
            'forest': [ {n:'æ¸…æ™¨é¸Ÿé¸£', f:'forest.mp3'}, {n:'å¤å¤œè™«é¸£', f:'forest_2.mp3'}, {n:'æ—é—´é£å£°', f:'forest_3.mp3'} ],
            'fire': [ {n:'å£ç‚‰ç¯ç«', f:'fire.mp3'} ],
            'cafe': [ {n:'åˆåå’–å•¡', f:'cafe.mp3'} ],
            'train': [ {n:'è¿œè¡Œåˆ—è½¦', f:'train.mp3'} ],
            'night': [ {n:'é™è°§å¤å¤œ', f:'night.mp3'} ],
            'keyboard': [ {n:'æœºæ¢°é”®ç›˜', f:'keyboard.mp3'} ]
        };

        // Web Audio API æ ¸å¿ƒå˜é‡
        let noiseCtx = null;       // éŸ³é¢‘ä¸Šä¸‹æ–‡
        let noiseSource = null;    // å½“å‰æ’­æ”¾æº (Source Node)
        let noiseGain = null;      // éŸ³é‡æ§åˆ¶å™¨ (Gain Node)
        let audioCache = {};       // ç¼“å­˜å·²è§£ç çš„éŸ³é¢‘ï¼Œé¿å…é‡å¤ä¸‹è½½
        
        // çŠ¶æ€å˜é‡
        let currentCat = null; 
        let currentVarIdx = 0; 
        let masterVol = 0.6; 
        let isPaused = false; 
        let isNoiseLoading = false; // é˜²æ­¢é‡å¤ç‚¹å‡»

        // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡ (å¿…é¡»åœ¨ç”¨æˆ·äº¤äº’åè°ƒç”¨)
        function initAudioContext() {
            if (!noiseCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                noiseCtx = new AudioContext();
                
                // åˆ›å»ºå…¨å±€éŸ³é‡èŠ‚ç‚¹
                noiseGain = noiseCtx.createGain();
                noiseGain.gain.value = masterVol;
                noiseGain.connect(noiseCtx.destination);
            }
            // ç¡®ä¿ä¸Šä¸‹æ–‡æ˜¯è¿è¡ŒçŠ¶æ€
            if (noiseCtx.state === 'suspended') {
                noiseCtx.resume();
            }
        }

        // ä¸»å…¥å£ï¼šç‚¹å‡»å›¾æ ‡æ’­æ”¾
        function playNoise(cat) {
            initAudioContext(); // æ¿€æ´»éŸ³é¢‘å¼•æ“

            // å¦‚æœç‚¹å‡»å½“å‰æ­£åœ¨æ’­æ”¾çš„ç±»åˆ«
            if (currentCat === cat) {
                if (isPaused) {
                    togglePlayback(); // å¦‚æœæ˜¯æš‚åœçŠ¶æ€ï¼Œåˆ™ç»§ç»­
                } else {
                    // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œåˆ‡åˆ°ä¸‹ä¸€ä¸ªå˜ä½“
                    currentVarIdx = (currentVarIdx + 1) % noiseConfig[cat].length;
                    loadAndPlay();
                }
                return;
            }

            // ç‚¹å‡»æ–°ç±»åˆ«
            currentCat = cat;
            currentVarIdx = 0;
            loadAndPlay();
        }

        // æ ¸å¿ƒæ’­æ”¾é€»è¾‘
        async function loadAndPlay() {
            if (isNoiseLoading) return;
            
            // 1. åœæ­¢å½“å‰å£°éŸ³
            stopCurrentSource();
            isPaused = false; // é‡ç½®æš‚åœçŠ¶æ€
            updateNoiseUI();  // æ›´æ–° UI æ˜¾ç¤ºåŠ è½½çŠ¶æ€...

            const item = noiseConfig[currentCat][currentVarIdx];
            const url = NOISE_BASE + item.f;

            try {
                isNoiseLoading = true;
                let buffer;

                // 2. æ£€æŸ¥ç¼“å­˜ (å†…å­˜ä¸­æ˜¯å¦å·²æœ‰è§£ç å¥½çš„æ•°æ®)
                if (audioCache[url]) {
                    buffer = audioCache[url];
                } else {
                    // 3. æ²¡æœ‰ç¼“å­˜ï¼Œä¸‹è½½å¹¶è§£ç 
                    showToast("æ­£åœ¨åŠ è½½: " + item.n + "...");
                    const response = await fetch(url);
                    const arrayBuffer = await response.arrayBuffer();
                    // è§£ç éŸ³é¢‘æ•°æ® (è¿™æ˜¯æ¶ˆé™¤å¡é¡¿çš„å…³é”®æ­¥éª¤)
                    buffer = await noiseCtx.decodeAudioData(arrayBuffer);
                    audioCache[url] = buffer; // å­˜å…¥ç¼“å­˜
                }

                // 4. åˆ›å»ºæ’­æ”¾æºå¹¶è¿æ¥
                playBuffer(buffer);
                showToast("æ­£åœ¨æ’­æ”¾: " + item.n);

            } catch (error) {
                console.error("åŠ è½½ç™½å™ªéŸ³å¤±è´¥:", error);
                showToast("åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
            } finally {
                isNoiseLoading = false;
                updateNoiseUI();
            }
        }

        // æ’­æ”¾å…·ä½“çš„ Buffer æ•°æ®
        function playBuffer(buffer) {
            // åŒé‡ä¿é™©ï¼šåœæ­¢æ—§çš„
            if (noiseSource) { try{noiseSource.stop();}catch(e){} }

            // åˆ›å»ºæ–°çš„ Source Node
            noiseSource = noiseCtx.createBufferSource();
            noiseSource.buffer = buffer;
            
            // â­ å…³é”®ï¼šè®¾ç½®å†…å­˜çº§æ— ç¼å¾ªç¯ â­
            noiseSource.loop = true; 
            
            // è¿æ¥èŠ‚ç‚¹ï¼šSource -> Gain -> Speaker
            noiseSource.connect(noiseGain);
            
            // å¼€å§‹æ’­æ”¾
            noiseSource.start(0);
        }

        // åœæ­¢å½“å‰çš„ Source Node
        function stopCurrentSource() {
            if (noiseSource) {
                try {
                    // å¹³æ»‘åœæ­¢é˜²æ­¢çˆ†éŸ³ (å¯é€‰)
                    noiseSource.stop();
                    noiseSource.disconnect();
                } catch(e) {}
                noiseSource = null;
            }
        }

        // æš‚åœ/ç»§ç»­ (æ§åˆ¶æ•´ä¸ª Context)
        function togglePlayback() {
            if (!currentCat || !noiseCtx) return;

            if (noiseCtx.state === 'running') {
                noiseCtx.suspend().then(() => {
                    isPaused = true;
                    showToast("å·²æš‚åœ");
                    updateNoiseUI();
                });
            } else if (noiseCtx.state === 'suspended') {
                noiseCtx.resume().then(() => {
                    isPaused = false;
                    const item = noiseConfig[currentCat][currentVarIdx];
                    showToast("ç»§ç»­æ’­æ”¾: " + item.n);
                    updateNoiseUI();
                });
            }
        }

        // åœæ­¢æŒ‰é’®é€»è¾‘
        function stopAllNoise() {
            if (noiseCtx) {
                stopCurrentSource();
                // ä¹Ÿå¯ä»¥é€‰æ‹© suspendï¼Œä½†ä¸ºäº†å½»åº•é‡ç½®ï¼Œæˆ‘ä»¬åœæ­¢æº
                currentCat = null;
                isPaused = false;
                updateNoiseUI();
                showToast("å·²åœæ­¢æ’­æ”¾");
            }
        }

        // éŸ³é‡æ§åˆ¶
        function changeNoiseVolume(v) {
            masterVol = v;
            // å®æ—¶æ”¹å˜ Gain Node çš„å¢ç›Šå€¼
            if (noiseGain) {
                // ä½¿ç”¨ setTargetAtTime å®ç°å¹³æ»‘éŸ³é‡å˜åŒ–ï¼Œé˜²æ­¢æ»‹æ»‹å£°
                noiseGain.gain.setTargetAtTime(v, noiseCtx.currentTime, 0.1);
            }
        }

        // UI æ›´æ–°é€»è¾‘ (åŸºæœ¬ä¿æŒä¸å˜ï¼Œé€‚é…æ–°çŠ¶æ€)
        function updateNoiseUI() {
            const orb = document.getElementById('noiseOrb');
            const btn = document.getElementById('noiseStopBtn');
            
            // æ’­æ”¾çŠ¶æ€åˆ¤å®šï¼šæœ‰åˆ†ç±»ä¸” Context æ­£åœ¨è¿è¡Œ
            const isPlaying = currentCat && !isPaused && !isNoiseLoading;
            
            if(isPlaying) orb.classList.add('is-playing'); 
            else orb.classList.remove('is-playing');
            
            // åº•éƒ¨æŒ‰é’®çŠ¶æ€
            if (!currentCat) {
                // åˆå§‹çŠ¶æ€
                btn.className = "w-full text-xs py-2 rounded-lg font-bold opacity-60 hover:opacity-100 transition border border-current flex items-center justify-center gap-2";
                btn.innerHTML = `<i data-lucide="headphones" class="w-3 h-3"></i> é€‰æ‹©éŸ³æ•ˆ`;
                btn.style.background = ""; btn.style.color = ""; btn.style.borderColor = "";
            } else if (isPaused) {
                // æš‚åœçŠ¶æ€
                btn.classList.remove('stop-active');
                btn.style.background = "transparent"; btn.style.color = "inherit"; btn.style.borderColor = "currentColor"; btn.style.opacity = "0.7";
                btn.innerHTML = `<i data-lucide="play" class="w-3 h-3"></i> ç»§ç»­: ${noiseConfig[currentCat][currentVarIdx].n}`;
            } else {
                // æ’­æ”¾çŠ¶æ€
                btn.classList.add('stop-active'); 
                btn.style.background = ""; btn.style.color = ""; btn.style.borderColor = ""; btn.style.opacity = "1";
                // å¦‚æœæ­£åœ¨åŠ è½½ï¼Œæ˜¾ç¤ºåŠ è½½ä¸­
                if(isNoiseLoading) btn.innerHTML = `<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> åŠ è½½ä¸­...`;
                else btn.innerHTML = `<i data-lucide="pause" class="w-3 h-3"></i> æš‚åœ`;
            }

            // å¡ç‰‡é«˜äº®é€»è¾‘
            document.querySelectorAll('.noise-card').forEach(el => {
                el.classList.remove('active');
                const oldB = el.querySelector('.variant-badge'); if(oldB) oldB.remove();
                
                if(currentCat && el.getAttribute('onclick').includes(`'${currentCat}'`)) {
                    el.classList.add('active');
                    if(noiseConfig[currentCat].length > 1) {
                        el.insertAdjacentHTML('beforeend', `<span class="variant-badge">${currentVarIdx+1}</span>`);
                    }
                }
            });
            if(window.lucide) initLucideSafe();
        }

        function toggleSFX() { AUDIO_SYSTEM.toggle(); }

        // --- 4. ä»»åŠ¡ä¸æ¸²æŸ“é€»è¾‘ ---
        if (RAW_DATA.includes('{{')) { const today = new Date(); for(let i=0; i<7; i++) { let d = new Date(today); d.setDate(today.getDate() + i); tasksData.push({ date: d.toISOString().split('T')[0], dayNum: i+1, tasks: [{ title: 'Core Vocabulary', desc: 'Memorize 50 words', tag: 'Input' }, { title: 'Speaking Practice', desc: 'Record Part 2 topic', tag: 'Output' }] }); } } else { tasksData = JSON.parse(RAW_DATA); planId = '{{PLAN_ID}}'; }
        
        const STORAGE_KEY = 'v4_prog_' + planId; const START_KEY = 'v4_start_' + planId; const THEME_MODE_KEY = 'v4_mode_' + planId; const THEME_COLOR_KEY = 'v4_color_' + planId; const TITLE_KEY = 'v4_title_' + planId; const CURRENT_DAY_KEY = 'v4_current_day_' + planId; 
        
        // åŠ è½½æ•°æ®
        userProgress = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); 
        startedDays = JSON.parse(localStorage.getItem(START_KEY) || '[]'); 
        currentMode = localStorage.getItem(THEME_MODE_KEY) || 'mix'; 
        currentSingleColor = localStorage.getItem(THEME_COLOR_KEY) || DOPAMINE_COLORS[0]; 

        // --- ğŸ¨ å¤šå½©æ³¡æ³¡è°ƒè‰²ç›˜ç”Ÿæˆé€»è¾‘ ---
function initPalette() { 
    const container = document.getElementById('palettePopover'); 
    container.innerHTML = ''; 
    
    // 1. åˆ›å»ºâ€œæ··åˆæ¨¡å¼â€å½©è™¹çƒ
    const mixBtn = document.createElement('div'); 
    mixBtn.className = 'color-dot mix-dot'; // å¯¹åº” CSS é‡Œçš„å¤šå½©æ¸å˜
    mixBtn.innerHTML = '<div class="mix-icon"><i data-lucide="aperture" style="width:16px;height:16px"></i></div>'; // å¦‚æœæ²¡æœ‰ lucideï¼Œå¯ä»¥æ¢å› svg
    if(!mixBtn.querySelector('svg')) mixBtn.innerHTML = '<div class="mix-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg></div>';
    
    mixBtn.onclick = (e) => { e.stopPropagation(); switchToMixMode(); closePalette(); }; 
    if(currentMode === 'mix') mixBtn.classList.add('active-swatch'); 
    container.appendChild(mixBtn); 
    
    // 2. åˆ›å»ºæ™®é€šé¢œè‰²çƒ
    DOPAMINE_COLORS.forEach(color => { 
        const dot = document.createElement('div'); 
        dot.className = 'color-dot'; 
        dot.style.backgroundColor = color; 
        dot.onclick = (e) => { e.stopPropagation(); switchToSingleColor(color); closePalette(); }; 
        if(currentMode === 'single' && color.toUpperCase() === currentSingleColor.toUpperCase()) dot.classList.add('active-swatch'); 
        container.appendChild(dot); 
    }); 
    
    // 3. åˆ›å»ºè‡ªå®šä¹‰å–è‰²çƒ
    const custom = document.createElement('div'); 
    custom.className = 'color-dot picker-dot'; // å¯¹åº” CSS é‡Œçš„è‰²ç¯
    custom.innerHTML = '<div class="picker-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M2 12h20"/></svg></div>'; 
    custom.onclick = (e) => { e.stopPropagation(); document.getElementById('customPickerInput').click(); }; 
    container.appendChild(custom); 
    
    // åˆ·æ–°å›¾æ ‡
    if(window.lucide) window.lucide.createIcons();
}
        function getDayColor(dayIndex) { return currentMode === 'mix' ? DOPAMINE_COLORS[dayIndex % DOPAMINE_COLORS.length] : currentSingleColor; }
        function switchToMixMode() { 
    currentMode = 'mix'; 
    localStorage.setItem(THEME_MODE_KEY, 'mix'); 
    document.getElementById('modeLabel').innerText = "DOPAMINE MIX"; 
    
    // æ›´æ–°èƒŒæ™¯ç±»å
    const bg = document.getElementById('bg-gradient');
    if(bg) { bg.className = 'bg-mix-mode'; bg.style.background = ''; }
    
    // â­ æ–°å¢ï¼šè®©æ²‰æµ¸æ¨¡å¼å˜æˆå¤šå½©å…‰æ•ˆ
    document.getElementById('immersiveLayer').className = 'im-mix';
    
    renderDay(currentDayIdx); 
}

function switchToSingleColor(hex) { 
    currentMode = 'single'; 
    currentSingleColor = hex; 
    localStorage.setItem(THEME_MODE_KEY, 'single'); 
    localStorage.setItem(THEME_COLOR_KEY, hex); 
    document.getElementById('modeLabel').innerText = "PRO FOCUS"; 
    
    // æ›´æ–°èƒŒæ™¯ç±»å
    const bg = document.getElementById('bg-gradient');
    if(bg) bg.className = 'bg-single-mode';
    
    // â­ æ–°å¢ï¼šè®©æ²‰æµ¸æ¨¡å¼å˜æˆå•è‰²å…‰æ•ˆ (è·Ÿéš hex)
    document.getElementById('immersiveLayer').className = 'im-single';
    
    renderDay(currentDayIdx); 
}
        function applyThemeColor(hex) { const root = document.documentElement; const rgb = hexToRgb(hex); const brightness = (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000; root.style.setProperty('--primary', hex); root.style.setProperty('--primary-dark', adjustBrightness(hex, -20)); root.style.setProperty('--primary-light', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.1)`); root.style.setProperty('--text-on-primary', brightness < 128 ? '#ffffff' : '#1d1d1f'); initPalette(); }

        function autoDetectTag(text) {
            const map = {
                'æ ¸å¿ƒ': {color:'#007AFF', emoji:'ğŸ¯'}, 'Core': {color:'#007AFF', emoji:'ğŸ¯'},
                'æ•°å­¦': {color:'#5856D6', emoji:'â—'}, 'Math': {color:'#5856D6', emoji:'â—'},
                'è¿åŠ¨': {color:'#34C759', emoji:'ğŸƒ'}, 'Sport': {color:'#34C759', emoji:'ğŸ’ª'}, 'Fit': {color:'#34C759', emoji:'ğŸ§˜'},
                'è‹±è¯­': {color:'#FF9500', emoji:'ğŸ”¤'}, 'Eng': {color:'#FF9500', emoji:'ğŸ”¤'}, 'å•è¯': {color:'#FF9500', emoji:'ğŸ“™'},
                'ç¼–ç¨‹': {color:'#AF52DE', emoji:'ğŸ’»'}, 'Code': {color:'#AF52DE', emoji:'âŒ¨ï¸'}, 'ç®—æ³•': {color:'#AF52DE', emoji:'ğŸ§ '},
                'é˜…è¯»': {color:'#FF2D55', emoji:'ğŸ“–'}, 'Read': {color:'#FF2D55', emoji:'ğŸ“š'},
                'ç”Ÿæ´»': {color:'#32ADE6', emoji:'ğŸ¥—'}, 'Life': {color:'#32ADE6', emoji:'ğŸ '}, 'æ—©èµ·': {color:'#FFCC00', emoji:'â˜€ï¸'}, 'æ—©ç¡': {color:'#5856D6', emoji:'ğŸŒ™'},
                'å¤ç›˜': {color:'#8E8E93', emoji:'ğŸ“'}, 'Review': {color:'#8E8E93', emoji:'ğŸ”„'}
            };
            for(let key in map) { if(text.includes(key)) return { label: key, color: map[key].color, emoji: map[key].emoji, category: 'Specific' }; }
            return { label: 'Task', color: 'var(--primary)', emoji: 'âœ¨', category: 'æ—¥å¸¸' };
        }

        function getTaskWeight(task) { const time = task.time || ""; if(!time) return 9999; const hour = parseInt(time.split(':')[0]); return hour * 60; }

        // --- æ ¸å¿ƒæ¸²æŸ“é€»è¾‘ï¼šBento Grid é£æ ¼ ---
function renderDay(idx) {
    if (idx < 0 || idx >= tasksData.length) idx = 0;
    currentDayIdx = idx;
    const day = tasksData[idx];
    const todayColor = getDayColor(idx);
    applyThemeColor(todayColor);
    window.location.hash = `day=${idx}`;
    
    // æ›´æ–°é¡¶éƒ¨æ—¥æœŸé€‰æ‹©å™¨
    const mobSelect = document.getElementById('mobileDateSelect'); 
    if(mobSelect) mobSelect.value = idx;
    
    // æ›´æ–°ä¾§è¾¹æ é«˜äº®
    const dateList = document.getElementById('dateList'); 
    dateList.innerHTML = '';
    tasksData.forEach((d, i) => { 
        const isSelected = i === idx; 
        const itemColor = getDayColor(i); 
        const el = document.createElement('div'); 
        el.className = `p-3 rounded-lg flex justify-between items-center text-sm cursor-pointer transition-all mb-1 hover:bg-white/60`; 
        if(isSelected) { 
            el.className += ' bg-white shadow-sm font-bold border-l-4 text-slate-800'; 
            el.style.borderLeftColor = itemColor; 
        } else { 
            el.className += ' text-slate-600 border-l-4 border-transparent';
        } 
        const done = d.tasks.filter((_, ti) => userProgress[d.date+'_'+ti]).length; 
        const isAll = done === d.tasks.length && d.tasks.length > 0; 
        let iconHtml = isAll ? `<div class="w-2 h-2 rounded-full shadow-sm" style="background:${itemColor}; box-shadow: 0 0 4px ${itemColor}80;"></div>` : (!isSelected ? `<div class="w-1.5 h-1.5 rounded-full bg-slate-200"></div>` : ''); 
        el.innerHTML = `<span>${d.date.substring(5)}</span> ${iconHtml}`; 
        el.onclick = () => { window.location.hash = `day=${i}`; }; 
        dateList.appendChild(el); 
    });

    // æ›´æ–°æ ‡é¢˜æ•°æ®
    document.getElementById('currentDateDisplay').innerText = day.date; 
    document.getElementById('dayCountDisplay').innerText = day.dayNum; 
    updateStats(day);

    // --- ğŸ¯ ä»»åŠ¡åˆ—è¡¨æ¸²æŸ“æ ¸å¿ƒä¿®æ”¹å¼€å§‹ ---
    const container = document.getElementById('dynamicTasksContainer'); 
    container.innerHTML = '';
    
    // 1. è®¾ç½® Grid å¸ƒå±€å®¹å™¨ (æ‰‹æœº1åˆ—ï¼Œå¹³æ¿/ç”µè„‘2åˆ—)
    container.className = "grid grid-cols-1 md:grid-cols-2 gap-4 pb-24"; // å¢åŠ åº•éƒ¨paddingé˜²æ­¢è¢«Docké®æŒ¡
    
    // ç§»é™¤å¤–éƒ¨å®¹å™¨çš„ space-y-3ï¼Œé˜²æ­¢å¹²æ‰° Grid
    document.getElementById('contentLocker').classList.remove('space-y-3');

    if (day.tasks.length === 0) { 
        container.innerHTML = '<div class="col-span-full text-center p-12 text-slate-400 italic bg-white/50 rounded-3xl border border-dashed border-slate-200">ğŸµ ä»Šæ—¥æ— ä»»åŠ¡ï¼Œå°½æƒ…äº«å—æ—¶å…‰ã€‚</div>'; 
    } else {
        const sortedTasksWithIndex = day.tasks.map((t, i) => ({...t, originalIndex: i})).sort((a, b) => getTaskWeight(a) - getTaskWeight(b));
        
        sortedTasksWithIndex.forEach((t, i) => {
            const tid = day.date + '_' + t.originalIndex; 
            const checked = !!userProgress[tid];
            const autoInfo = autoDetectTag(t.title); 
            const displayTag = t.tag || (autoInfo.label !== 'Task' ? autoInfo.label : '');
            
            let displayColor = 'var(--primary)';
            if(t.tag && autoDetectTag(t.tag).category !== 'æ—¥å¸¸') displayColor = autoDetectTag(t.tag).color; 
            else if(autoInfo.category !== 'æ—¥å¸¸') displayColor = autoInfo.color;

            // å¾½ç«  HTML
            const badge = displayTag ? 
                `<span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold border" style="color:${displayColor}; background:${displayColor}10; border-color:${displayColor}30">${displayTag}</span>` : 
                '';

            // â° æ—¶é—´æ˜¾ç¤ºä¿®å¤ (Null æ£€æŸ¥)
            // å¦‚æœ t.time æ˜¯ "null" å­—ç¬¦ä¸²æˆ–è€… null/undefinedï¼Œå°±ä¸æ˜¾ç¤º
            const showTime = t.time && t.time !== 'null' ? t.time : null;
            const showDur = t.duration && t.duration !== 'null' ? t.duration : null;
            
            let timeInfoHtml = '';
            if (showTime || showDur) {
                timeInfoHtml = `
                    <div class="flex items-center gap-3 text-xs font-mono font-bold text-slate-400 bg-slate-50 px-2 py-1 rounded-lg">
                        ${showTime ? `<span class="flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> ${showTime}</span>` : ''}
                        ${showDur ? `<span class="flex items-center gap-1"><i data-lucide="hourglass" class="w-3 h-3"></i> ${showDur}m</span>` : ''}
                    </div>`;
            }

            const div = document.createElement('div');
            div.id = 'task-card-' + tid;
            
            // å¡ç‰‡æ ·å¼ï¼šBento é£æ ¼
            // flex-col ç¡®ä¿å†…å®¹å‚ç›´åˆ†å¸ƒï¼Œmin-h ç¡®ä¿å¡ç‰‡é«˜åº¦ç»Ÿä¸€ï¼Œjustify-between ç¡®ä¿åº•éƒ¨å¯¹é½
            div.className = `task-item group relative p-5 rounded-2xl bg-white/80 backdrop-blur-xl border border-white/60 shadow-sm hover:shadow-md hover:-translate-y-1 transition-all duration-300 cursor-pointer flex flex-col justify-between min-h-[120px] fade-in-up ${checked ? 'task-checked opacity-60 grayscale-[0.5]' : ''}`;
            
            // é€‰ä¸­æ—¶çš„è¾¹æ¡†è‰²
            if(checked) div.style.borderColor = 'var(--primary)';
            
            div.style.animationDelay = `${i * 0.05}s`;
            div.onclick = () => toggleTask(tid);

            div.innerHTML = `
                <div class="flex justify-between items-start gap-3 mb-2">
                    <h4 class="font-bold text-slate-800 text-[15px] leading-snug line-clamp-2 group-hover:text-[var(--primary)] transition-colors">
                        <span class="mr-1 inline-block transform group-hover:scale-110 transition-transform">${autoInfo.emoji}</span> ${t.title}
                    </h4>
                    <div class="checkbox-ios flex-shrink-0 ${checked ? 'bg-[var(--primary)] border-[var(--primary)]' : ''}">
                        <svg class="w-3.5 h-3.5 text-white ${checked ? 'opacity-100' : 'opacity-0'} transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="4"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
                    </div>
                </div>

                <p class="text-xs text-slate-500 font-medium leading-relaxed line-clamp-2 mb-4 h-8">
                    ${t.desc || ''}
                </p>

                <div class="flex items-center justify-between mt-auto pt-2 border-t border-slate-100/50">
                    <div class="flex gap-2">
                        ${badge}
                    </div>
                    ${timeInfoHtml}
                </div>
            `;
            container.appendChild(div);
        });
    }
    // --- ğŸ¯ ä»»åŠ¡åˆ—è¡¨æ¸²æŸ“æ ¸å¿ƒä¿®æ”¹ç»“æŸ ---

    checkLock(day.date); 
    if(window.lucide) initLucideSafe();
}
        // æ–°å¢ï¼šå¤„ç†ç§»åŠ¨ç«¯æ—¥æœŸåˆ‡æ¢å’Œæ»šåŠ¨é€»è¾‘
function handleMobileDaySwitch(delta) {
    let newIndex = currentDayIdx + delta;
    
    // ç¡®ä¿ç´¢å¼•åœ¨æœ‰æ•ˆèŒƒå›´å†…
    if (newIndex >= 0 && newIndex < tasksData.length) {
        renderDay(newIndex);
        
        // ä¼˜åŒ– UXï¼šè‡ªåŠ¨æ»šåŠ¨åˆ°é¡¶éƒ¨
        const mainScroll = document.getElementById('mainScroll');
        if (mainScroll) mainScroll.scrollTop = 0;
    } else {
        showToast("å·²åˆ°è¾¾è®¡åˆ’è¾¹ç¼˜");
    }
}
        async function toggleTask(tid) { 
    if(document.getElementById('contentLocker').style.filter.includes('blur')) return; 
    
    const isChecking = !userProgress[tid]; 
    
    // 1. æ›´æ–°æ•°æ®çŠ¶æ€
    if(userProgress[tid]) { delete userProgress[tid]; } else { userProgress[tid] = true; } 
    localStorage.setItem(STORAGE_KEY, JSON.stringify(userProgress)); 
    
    // 2. DOM æ›´æ–°
    const taskEl = document.getElementById('task-card-' + tid);
    if (taskEl) {
        const checkIcon = taskEl.querySelector('.checkbox-ios svg');
        if (isChecking) {
            taskEl.classList.add('task-checked');
            if(checkIcon) { checkIcon.classList.remove('opacity-0'); checkIcon.classList.add('opacity-100'); }
        } else {
            taskEl.classList.remove('task-checked');
            if(checkIcon) { checkIcon.classList.remove('opacity-100'); checkIcon.classList.add('opacity-0'); }
        }
    }

    // 3. è¿›åº¦è®¡ç®—
    const dayDate = tid.split('_')[0]; 
    const dayObj = tasksData.find(d => d.date === dayDate); 
    const total = dayObj.tasks.length; 
    const doneCount = dayObj.tasks.filter((_, i) => userProgress[dayDate+'_'+i]).length; 
    const isAllDone = (doneCount === total && total > 0); 
    
    // 4. â­ æ¸¸æˆåŒ– XP é€»è¾‘ (æ–°å¢éƒ¨åˆ†) â­
    if (isChecking) {
        gainXP(50); // å®Œæˆä»»åŠ¡ +50
        updateStreak();
        // æ—¶é—´ç›¸å…³æˆå°±åˆ¤å®š
        const h = new Date().getHours();
        if(h < 9) { userProfile.hasEarlyTask = true; checkBadges(); }
        if(h >= 22) { userProfile.hasLateTask = true; checkBadges(); }
        
        if (isAllDone) { 
            AUDIO_SYSTEM.play('finish'); confettiEffect(); 
            gainXP(100); // å…¨æ¸…å¥–åŠ± +100
            if(total >= 3) { userProfile.perfectDays++; checkBadges(); }
        } 
        else { AUDIO_SYSTEM.play('check'); showToast(); } 
        
        if(navigator.vibrate) navigator.vibrate(10); 
    } else {
        // å–æ¶ˆä»»åŠ¡ï¼Œæ‰£é™¤ XP (é˜²æ­¢åˆ·åˆ†)
        gainXP(-50); 
        // å¦‚æœå–æ¶ˆå¯¼è‡´ä¸å†æ˜¯å…¨æ¸…ï¼Œè¿™é‡Œä¸åšç‰¹æ®Šå¤„ç†ï¼Œå› ä¸ºå…¨æ¸…å¥–åŠ±å·²å‘æ”¾ã€‚
        // é€‰æ‹©æ¯”è¾ƒå®½æ¾çš„ç­–ç•¥ï¼šå·²å‘çš„å…¨æ¸…å¥–åŠ±ä¸æ”¶å›ï¼Œæˆ–è€…ç®€å•ç‚¹ä¸æ‰£å…¨æ¸…åˆ†ã€‚
        // è¿™é‡Œåªæ‰£é™¤åŸºç¡€ä»»åŠ¡åˆ†ã€‚
    }
    
    updateStats(tasksData[currentDayIdx]);
    
    // è‡ªåŠ¨å€’è®¡æ—¶é€»è¾‘
    const currentTask = tasksData[currentDayIdx].tasks[parseInt(tid.split('_')[1])]; 
    if (isChecking && currentTask && currentTask.duration) { setTime(parseInt(currentTask.duration)); } 
}        
        function updateStats(day) { const total = day.tasks.length; const done = day.tasks.filter((_, i) => userProgress[day.date+'_'+i]).length; const pct = total ? (done/total)*100 : 0; document.getElementById('dailyProgressBar').style.width = pct + '%'; document.getElementById('dailyProgressText').innerText = done + '/' + total; const trophy = document.getElementById('trophyContainer'); trophy.innerHTML = (done === total && total > 0) ? `<div class="p-3 rounded-full text-white shadow-lg animate-bounce theme-bg-target" style="background: var(--primary)"><i data-lucide="award" class="w-6 h-6"></i></div>` : `<div class="bg-slate-100 p-3 rounded-full text-slate-300"><i data-lucide="target" class="w-6 h-6"></i></div>`; let allT=0, allD=0; tasksData.forEach(d => { allT += d.tasks.length; allD += d.tasks.filter((_,i) => userProgress[d.date+'_'+i]).length; }); const gPct = allT ? Math.round((allD/allT)*100) : 0; document.getElementById('totalCompletionDisplay').innerText = gPct + '%'; document.getElementById('overallProgressBar').style.width = gPct + '%'; if(window.lucide) initLucideSafe(); }
        
        function startDay() { 
    const d = tasksData[currentDayIdx].date; 
    
    if(!startedDays.includes(d)) { 
        startedDays.push(d); 
        localStorage.setItem(START_KEY, JSON.stringify(startedDays)); 
    } 
    
    // â­ æ–°å¢ï¼šæ¯æ—¥å¯åŠ¨æ—¶æ›´æ–°è¿èƒœ â­
    updateStreak();

    AUDIO_SYSTEM.play('start'); 
    const overlay = document.getElementById('ritualOverlay');
    overlay.style.opacity = '0'; 
    if(window.proTimer) clearTimeout(window.proTimer);
    window.proTimer = setTimeout(() => { 
        overlay.style.display = 'none'; 
        unlockContent(); 
    }, 500); 
}        
        function checkLock(date) { 
    const locker = document.getElementById('contentLocker'); 
    const overlay = document.getElementById('ritualOverlay'); 
    const mainContent = document.querySelector('main'); // ç„å‡†ä¸»å†…å®¹åŒº

    const hasStarted = startedDays.includes(date) || Object.keys(userProgress).some(k => k.startsWith(date)); 
    
    // ç¡®ä¿åˆ‡æ¢å¤©æ•°æ—¶ï¼Œæ­£åœ¨è¿è¡Œçš„åŠ¨ç”»è¢«åœæ­¢
    if(window.proTimer) {
        clearTimeout(window.proTimer);
        window.proTimer = null;
    }

    if(hasStarted) { 
        // çŠ¶æ€ï¼šå·²å¼€å§‹ -> ç«‹å³æ¸…é™¤é”å®šæ•ˆæœ
        if(overlay) { 
             overlay.style.opacity = '0';
             overlay.style.display = 'none';
        }
        
        locker.style.filter = 'none'; 
        locker.style.pointerEvents = 'auto'; 
        locker.style.opacity = '1'; 
    } else { 
        // çŠ¶æ€ï¼šæœªå¼€å§‹ -> åº”ç”¨é”å®šæ•ˆæœ (å±€éƒ¨è¦†ç›–)
        if(overlay && mainContent) {
            // â­ æ ¸å¿ƒï¼šå°† overlay ç§»åŠ¨åˆ°ä»»åŠ¡å®¹å™¨ä¸Šæ–¹ï¼ˆå› ä¸ºå®ƒç°åœ¨æ˜¯ absolute inset-0ï¼‰
            // æˆ‘ä»¬åªéœ€è¦ç¡®ä¿å®ƒåœ¨ DOM ç»“æ„ä¸­ä½äºæ­£ç¡®çš„ä½ç½® (å³ main/locker é‡Œé¢)
            
            // ç¡®ä¿ overlay æŒ‚è½½åœ¨ main å…ƒç´ ä¸Šï¼Œå®ç°è¦†ç›–æ•ˆæœ
            if (!mainContent.contains(overlay)) {
                mainContent.appendChild(overlay);
            }
            
            // æ ·å¼è°ƒæ•´ï¼šç§»é™¤æ¨¡ç³Šï¼Œåªè®©å†…å®¹æ¨¡ç³Š
            overlay.classList.remove('bg-white/80', 'backdrop-blur-xl');
            
            overlay.style.position = 'absolute';
            overlay.style.inset = '0'; // è¦†ç›–æ•´ä¸ª main åŒºåŸŸ
            overlay.style.background = 'rgba(255, 255, 255, 0.7)'; // å¢åŠ åŠé€æ˜ç™½è‰²èƒŒæ™¯
            
            overlay.style.display = 'flex'; 
            overlay.style.opacity = '1'; 
            overlay.style.pointerEvents = 'auto'; 
        }

        // â­ å…³é”®ï¼šåªå¯¹ä»»åŠ¡åˆ—è¡¨åº”ç”¨æ¨¡ç³Šï¼Œè€Œä¸æ˜¯æ•´ä¸ªé¡µé¢
        locker.style.filter = 'blur(8px)'; 
        locker.style.pointerEvents = 'none'; 
        locker.style.opacity = '0.5'; 
    }
}
        function unlockContent() { const locker = document.getElementById('contentLocker'); locker.style.filter = 'none'; locker.style.pointerEvents = 'auto'; locker.style.opacity = '1'; }
        
        // --- Modal & Utils ---
        function openResetModal() { 
    const overlay = document.getElementById('proModalOverlay'); 
    document.getElementById('proModalTitle').innerText = "é‡ç½®æ•°æ®"; 
    document.getElementById('proModalDesc').innerText = "âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ‰“å¡è®°å½•å’Œä¿®è¡Œé˜…å†å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚"; 
    document.getElementById('proModalInput').style.display = 'none'; 
    const confirmBtn = document.getElementById('proModalConfirmBtn'); 
    confirmBtn.innerText = "æ¸…ç©ºæ•°æ®"; 
    
    // ç§»é™¤æ—§çš„ç±»ï¼Œæ·»åŠ æ–°çš„ç±»å
    confirmBtn.classList.add('destructive'); 
    confirmBtn.onclick = confirmReset; 
    
    overlay.classList.add('show'); 
}
        // --- ä¿®å¤ç‰ˆï¼šé‡ç½®åŠŸèƒ½ (åŒ…å«æ¸…é™¤ XP) ---
function confirmReset() { 
    // 1. æ¸…é™¤æ‰“å¡æ•°æ®
    userProgress = {}; 
    startedDays = []; 
    localStorage.removeItem(STORAGE_KEY); 
    localStorage.removeItem(START_KEY); 
    localStorage.removeItem(CURRENT_DAY_KEY); 
    
    // 2. â­ æ–°å¢ï¼šæ¸…é™¤ XPã€ç­‰çº§å’Œå¾½ç« æ•°æ® â­
    localStorage.removeItem(PROFILE_KEY);
    
    // 3. æ¢å¤é»˜è®¤ä¸»é¢˜å¹¶åˆ·æ–°
    switchToMixMode(); 
    location.reload(); 
}
        function openRenameModal() { 
    const overlay = document.getElementById('proModalOverlay'); 
    const titleEl = document.getElementById('planTitleText'); 
    document.getElementById('proModalTitle').innerText = "é‡å¡‘å¿ƒæµè½¨é“"; 
    document.getElementById('proModalDesc').innerText = "ä¸ºå½“å‰çš„ä¸“æ³¨è®¡åˆ’è¾“å…¥ä¸€ä¸ªæ›´å…·åŠ¨åŠ›çš„åç§°ã€‚"; 
    const input = document.getElementById('proModalInput'); 
    input.style.display = 'block'; 
    input.value = titleEl.innerText; 
    const confirmBtn = document.getElementById('proModalConfirmBtn'); 
    confirmBtn.innerText = "ç«‹å³é‡å‘½å"; 
    
    // ç¡®ä¿æ²¡æœ‰ destructive æ ·å¼
    confirmBtn.classList.remove('destructive'); 
    
    confirmBtn.onclick = confirmRename; 
    overlay.classList.add('show'); 
    setTimeout(() => input.focus(), 100); 
}
        function confirmRename() { const val = document.getElementById('proModalInput').value; if(val) { document.getElementById('planTitleText').innerText = val; localStorage.setItem(TITLE_KEY, val); closeProModal(); } }
        function closeProModal() { document.getElementById('proModalOverlay').classList.remove('show'); }
        /* --- æ›¿æ¢å¼€å§‹ï¼šé«˜çº§æ¨±èŠ±/ç¤¼èŠ±ç‰¹æ•ˆå‡½æ•° --- */
// --- ğŸŒ¸ æ¨±èŠ±/æ³¡æ³¡é£˜è½ç‰¹æ•ˆ (Sakura Mode) ---
function confettiEffect() {
    // è·å–å½“å‰ä¸»é¢˜è‰²
    const color = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
    
    // é…ç½®ï¼šåœ†å½¢ç²’å­(æ¨¡æ‹ŸèŠ±ç“£/æ³¡æ³¡) + æ…¢é€Ÿä¸‹è½
    const count = 200;
    const defaults = {
        origin: { y: 0.7 },
        zIndex: 9999,
        shapes: ['circle'], // ã€æ ¸å¿ƒã€‘æ”¹æˆåœ†å½¢ï¼Œçœ‹èµ·æ¥åƒæ¨±èŠ±ç“£æˆ–æ³¡æ³¡
        colors: [color, '#ffd700', '#ffffff'] // ä¸»é¢˜è‰² + é‡‘è‰² + ç™½è‰²
    };

    function fire(particleRatio, opts) {
        confetti(Object.assign({}, defaults, opts, {
            particleCount: Math.floor(count * particleRatio)
        }));
    }

    // 1. åƒèŠ±ç“£ä¸€æ ·æ•£å¼€
    fire(0.25, { spread: 26, startVelocity: 55, scalar: 0.8, drift: 0 });
    // 2. ä¹Ÿæ˜¯æ•£å¼€ï¼Œä½†å¤§ä¸€ç‚¹
    fire(0.2, { spread: 60, scalar: 1.2, drift: 0.1 }); // drift å¢åŠ é£˜é€¸æ„Ÿ
    // 3. ä¸­å¿ƒçš„å¼ºåŠ›å–·å°„
    fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
    // 4. å¿«é€Ÿå°„å‡ºçš„ç²’å­
    fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
    // 5. æ¼«å¤©é£èˆçš„ä½™éŸµ
    fire(0.1, { spread: 120, startVelocity: 45 });
}
/* --- æ›¿æ¢ç»“æŸ --- */
        function togglePalette(e) { if(e) e.stopPropagation(); const p = document.getElementById('palettePopover'); if(!p.classList.contains('active')) initPalette(); p.classList.toggle('active'); }
        function closePalette() { document.getElementById('palettePopover').classList.remove('active'); }
        function hexToRgb(hex) { let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : {r:0,g:0,b:0}; }
        function adjustBrightness(hex, percent) { let num = parseInt(hex.replace("#",""),16), amt = Math.round(2.55 * percent), R = (num >> 16) + amt, B = (num >> 8 & 0x00FF) + amt, G = (num & 0x0000FF) + amt; return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 + (B<255?B<1?0:B:255)*0x100 + (G<255?G<1?0:G:255)).toString(16).slice(1); }

        // --- 5. ç•ªèŒ„é’Ÿé€»è¾‘ ---
        const dockWrapper = document.getElementById('focusDockWrapper'); const orb = document.getElementById('dockOrb');
        let isDrag = false, startX, startY, initialLeft, initialTop;
        function handleDragStart(e) { if(e.target.closest('#dockPanel')) return; isDrag = false; const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX; const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY; startX = clientX; startY = clientY; let rect = dockWrapper.getBoundingClientRect(); initialLeft = rect.left; initialTop = rect.top; dockWrapper.style.transition = 'none'; document.addEventListener('mousemove', handleDragMove); document.addEventListener('touchmove', handleDragMove, {passive: false}); document.addEventListener('mouseup', handleDragEnd); document.addEventListener('touchend', handleDragEnd); }
        function handleDragMove(e) { const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX; const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY; if(Math.abs(clientX - startX) > 5 || Math.abs(clientY - startY) > 5) { isDrag = true; e.preventDefault(); dockWrapper.style.left = (initialLeft + clientX - startX) + 'px'; dockWrapper.style.top = (initialTop + clientY - startY) + 'px'; dockWrapper.style.right = 'auto'; dockWrapper.style.bottom = 'auto'; } }
        function handleDragEnd() { document.removeEventListener('mousemove', handleDragMove); document.removeEventListener('touchmove', handleDragMove); document.removeEventListener('mouseup', handleDragEnd); document.removeEventListener('touchend', handleDragEnd); dockWrapper.style.transition = 'all 0.4s cubic-bezier(0.25, 1, 0.5, 1)'; if(!isDrag) { toggleDock(); } else { snapDock(); } }
        orb.addEventListener('mousedown', handleDragStart); orb.addEventListener('touchstart', handleDragStart, {passive: false});
        function snapDock() { const rect = dockWrapper.getBoundingClientRect(); const winW = window.innerWidth; const winH = window.innerHeight; const SNAP_THRESHOLD = 100; const MARGIN = 32; let targetLeft = rect.left; let targetTop = rect.top; if (rect.left < SNAP_THRESHOLD) targetLeft = MARGIN; else if (winW - rect.right < SNAP_THRESHOLD) targetLeft = winW - rect.width - MARGIN; if (rect.top < SNAP_THRESHOLD) targetTop = MARGIN; else if (winH - rect.bottom < SNAP_THRESHOLD) targetTop = winH - rect.height - MARGIN; dockWrapper.style.left = `${Math.max(MARGIN, Math.min(winW - rect.width - MARGIN, targetLeft))}px`; dockWrapper.style.top = `${Math.max(MARGIN, Math.min(winH - rect.height - MARGIN, targetTop))}px`; }
        function updatePanelPosition() { const rect = dockWrapper.getBoundingClientRect(); const panel = document.getElementById('dockPanel'); const winH = window.innerHeight; const winW = window.innerWidth; panel.style.top = ''; panel.style.bottom = ''; panel.style.left = ''; panel.style.right = ''; panel.style.transformOrigin = ''; if (rect.top > winH / 2) { panel.style.bottom = '80px'; panel.style.transformOrigin = 'bottom '; } else { panel.style.top = '80px'; panel.style.transformOrigin = 'top '; } if (rect.left > winW / 2) { panel.style.right = '0'; panel.style.transformOrigin += 'right'; } else { panel.style.left = '0'; panel.style.transformOrigin += 'left'; } }
        function toggleDock() { const panel = document.getElementById('dockPanel'); if (!panel.classList.contains('open')) { updatePanelPosition(); } panel.classList.toggle('open'); }
        function showTimeInput() { if (isRunning) return; const overlay = document.getElementById('customTimeOverlay'); const input = document.getElementById('customTimeInput'); overlay.classList.add('show'); const m = Math.floor(timeLeft / 60); const s = timeLeft % 60; input.value = s > 0 ? `${m}:${String(s).padStart(2,'0')}` : m; input.focus(); input.select(); }
        function hideTimeInput() { document.getElementById('customTimeOverlay').classList.remove('show'); }

function submitTime() { 
    const input = document.getElementById('customTimeInput').value; 
    let m = 0, s = 0; 
    if (input.includes(':') || input.includes('ï¼š')) { 
        const parts = input.replace('ï¼š', ':').split(':'); 
        m = parseInt(parts[0]) || 0; 
        s = parseInt(parts[1]) || 0; 
    } else { 
        m = parseInt(input) || 0; 
    } 
    
    if (m > 120) m = 120; 
    if (m < 1 && s < 1) m = 1; // é˜²æ­¢è¾“å…¥ 0
    
    // â­ ä¿®å¤ï¼šåŒæ­¥æ›´æ–°ç»“ç®—æ—¶é•¿ (ç²¾ç¡®åˆ°å°æ•°ï¼Œä¾‹å¦‚ 1.5 åˆ†é’Ÿ)
    currentSessionMin = m + (s/60); 
    
    timeLeft = m * 60 + s; 
    updateUI(); 
    hideTimeInput(); 
}
function adjustTime(delta) { 
    if(isRunning) return; 
    let m = Math.floor(timeLeft/60) + delta; 
    if(m < 1) m = 1; 
    if(m > 120) m = 120; // é™åˆ¶æœ€å¤§ 120 åˆ†é’Ÿ
    
    // â­ ä¿®å¤ï¼šåŒæ­¥æ›´æ–°ç»“ç®—æ—¶é•¿
    currentSessionMin = m; 
    
    setTime(m); 
}
function setTime(m) { if(isRunning) return; timeLeft = m * 60; updateUI(); }
        function toggleTimer() { if(isRunning) { clearInterval(timer); isRunning = false; } else { isRunning = true; timer = setInterval(() => { if(timeLeft>0) { timeLeft--; updateUI(); } else { finish(); } }, 1000); } updateUI(); }
        function finish() { 
    clearInterval(timer); 
    isRunning = false; 
    AUDIO_SYSTEM.play('finish'); 
    
    // â­ é€»è¾‘ä¿®æ”¹ï¼šè®°å½•åˆ†é’Ÿæ•° â­
    userProfile.focusSessions++; // æ¬¡æ•°ç…§æ ·åŠ ï¼ˆç”¨äºç»Ÿè®¡æ¬¡æ•°ï¼‰
    
    // ç´¯åŠ åˆ†é’Ÿæ•° (å¦‚æœæ²¡æœ‰è®°å½•è¿‡ï¼Œå°±é»˜è®¤åŠ 25)
    let addedMins = Math.floor(currentSessionMin || 25);
    userProfile.focusMinutes = (userProfile.focusMinutes || 0) + addedMins;
    
    // ä¸“æ³¨å¥–åŠ±ï¼šæ¯åˆ†é’Ÿ 5 XP (ä¾‹å¦‚ 25åˆ†é’Ÿ = 125 XP)
    let xpGain = addedMins * 5;
    gainXP(xpGain); 
    
    alert(`ä¸“æ³¨å®Œæˆï¼æ²‰æµ¸ ${addedMins} åˆ†é’Ÿï¼Œè·å¾— +${xpGain} XP`); 
    confettiEffect(); 
    
    // é‡ç½®çŠ¶æ€
    timeLeft = 25 * 60; 
    currentSessionMin = 25; 
    
    exitImmersive(); 
    updateUI(); 
    saveProfile(); // åˆ«å¿˜äº†ä¿å­˜
}
        function updateUI() { const str = Math.floor(timeLeft/60).toString().padStart(2,'0') + ':' + (timeLeft%60).toString().padStart(2,'0'); document.getElementById('dockTime').innerText = str; document.getElementById('immTime').innerText = str; const btn = document.getElementById('mainBtn'); btn.innerHTML = isRunning ? `<i data-lucide="pause" class="w-4 h-4"></i> <span>æš‚åœ</span>` : `<i data-lucide="play" class="w-4 h-4"></i> <span>å¼€å§‹ä¸“æ³¨</span>`; document.getElementById('immIcon').setAttribute('data-lucide', isRunning ? 'pause' : 'play'); if(window.lucide) initLucideSafe(); }
        function enterImmersive() { document.getElementById('immersiveLayer').classList.add('active'); document.getElementById('dockPanel').classList.remove('open'); if(!isRunning) toggleTimer(); }
        function exitImmersive() { document.getElementById('immersiveLayer').classList.remove('active'); }

        // --- 6. ç™½å™ªéŸ³æ‹–æ‹½ä¸å¸é™„ (ä¿®å¤ç‰ˆ) ---
        const nWrapper = document.getElementById('noiseDockWrapper');
        const nOrb = document.getElementById('noiseOrb');
        const nPanel = document.getElementById('noisePanel');
        let noise_isDragging = false, noise_hasMoved = false, noise_startX, noise_startY, noise_initialLeft, noise_initialTop;

        nOrb.addEventListener('mousedown', noiseDragStart);
        nOrb.addEventListener('touchstart', noiseDragStart, {passive: false});

        function noiseDragStart(e) {
            if(e.target.closest('#noisePanel')) return;
            noise_isDragging = true; noise_hasMoved = false;
            const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
            const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
            noise_startX = clientX; noise_startY = clientY;
            const rect = nWrapper.getBoundingClientRect();
            noise_initialLeft = rect.left; noise_initialTop = rect.top;
            nWrapper.style.transition = 'none'; nOrb.style.cursor = 'grabbing'; nOrb.style.transform = 'scale(0.95)';
            document.addEventListener('mousemove', noiseDragMove); document.addEventListener('touchmove', noiseDragMove, {passive: false});
            document.addEventListener('mouseup', noiseDragEnd); document.addEventListener('touchend', noiseDragEnd);
        }

        function noiseDragMove(e) {
            if (!noise_isDragging) return; e.preventDefault();
            const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
            const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
            const dx = clientX - noise_startX; const dy = clientY - noise_startY;
            if (Math.abs(dx) > 3 || Math.abs(dy) > 3) {
                noise_hasMoved = true;
                if(nPanel.style.display !== 'none') { nPanel.style.opacity = '0'; nPanel.style.pointerEvents = 'none'; setTimeout(() => { nPanel.style.display = 'none'; }, 200); }
            }
            nWrapper.style.left = `${noise_initialLeft + dx}px`; nWrapper.style.top = `${noise_initialTop + dy}px`; nWrapper.style.bottom = 'auto';
        }

        function noiseDragEnd() {
            if (!noise_isDragging) return; noise_isDragging = false;
            nOrb.style.cursor = 'grab'; nOrb.style.transform = 'scale(1)';
            document.removeEventListener('mousemove', noiseDragMove); document.removeEventListener('touchmove', noiseDragMove);
            document.removeEventListener('mouseup', noiseDragEnd); document.removeEventListener('touchend', noiseDragEnd);
            if (noise_hasMoved) {
                const winW = window.innerWidth; const winH = window.innerHeight; const rect = nWrapper.getBoundingClientRect(); const centerX = rect.left + rect.width / 2;
                nWrapper.style.transition = 'all 0.4s cubic-bezier(0.25, 1, 0.5, 1)';
                let targetLeft = (centerX < winW / 2) ? 20 : winW - 70;
                let targetTop = Math.max(50, Math.min(winH - 100, rect.top));
                nWrapper.style.left = `${targetLeft}px`; nWrapper.style.top = `${targetTop}px`;
            } else { toggleNoisePanel(); }
        }

        function toggleNoisePanel() {
            const isOpen = nPanel.style.display === 'block' && nPanel.style.opacity !== '0';
            if (isOpen) {
                nPanel.style.opacity = '0'; nPanel.style.transform = 'scale(0.9)'; setTimeout(() => { nPanel.style.display = 'none'; }, 200);
            } else {
                nPanel.style.display = 'block'; nPanel.style.pointerEvents = 'auto';
                const wrapperRect = nWrapper.getBoundingClientRect(); const winW = window.innerWidth; const winH = window.innerHeight;
                nPanel.style.top = ''; nPanel.style.bottom = ''; nPanel.style.left = ''; nPanel.style.right = '';
                if (wrapperRect.left > winW / 2) { nPanel.style.right = '0px'; nPanel.style.transformOrigin = 'bottom right'; } else { nPanel.style.left = '0px'; nPanel.style.transformOrigin = 'bottom left'; }
                if (wrapperRect.top > winH / 2) { nPanel.style.bottom = '65px'; nPanel.style.transformOrigin = nPanel.style.transformOrigin.replace('top', 'bottom'); } else { nPanel.style.top = '65px'; nPanel.style.transformOrigin = nPanel.style.transformOrigin.replace('bottom', 'top'); }
                nPanel.offsetHeight; nPanel.style.opacity = '1'; nPanel.style.transform = 'scale(1)';
            }
        }
        // --- ğŸ† çœŸå®æ„Ÿæ’è¡Œæ¦œç³»ç»Ÿ (Pro Leaderboard Engine) ---
// ç‰¹æ€§ï¼šç¬¦åˆå›½äººå‘½åä¹ æƒ¯ + 3å°æ—¶æ•°æ®é”å®š + æ™ºèƒ½é”šå®šç®—æ³•

const RANK_CACHE_KEY = 'pro_rank_cache_' + planId;
const RANK_UPDATE_INTERVAL = 3 * 60 * 60 * 1000; // 3å°æ—¶æ›´æ–°ä¸€æ¬¡ (æ¯«ç§’)
let currentRankType = 'xp';

// 1. ä¸­å›½ç‰¹è‰²ç½‘ååº“ (çœŸå®æ„Ÿæ¥æº) - å¢å¼ºç‰ˆ
const REALISTIC_NAMES = [
    // å¥‹æ–—ç±»
    "è€ƒç ”å¿…ä¸Šå²¸", "å‡Œæ™¨å››ç‚¹çš„æ´›æ‰çŸ¶", "è‡ªå¾‹å³è‡ªç”±", "è¿™ç§æ„Ÿè§‰å¤ªæ£’äº†", "é—­å…³ä¿®ç‚¼ä¸­", "æ¯å¤©è¿›æ­¥ä¸€ç‚¹ç‚¹",
    "åŠªåŠ›ä¸Šå²¸", "å¥‹æ–—çš„å°èš‚èš", "æˆ‘è¦å˜ä¼˜ç§€", "è‡ªå¾‹æˆå°±æœªæ¥", "åšæŒå°±æ˜¯èƒœåˆ©", "è¿½æ¢¦äºº",
    
    // æ–‡è‰º/è‡ªç„¶ç±»
    "æ¸…é£å¾æ¥", "å±±å·æ¹–æµ·", "å¬é›¨", "äº‘æ·±ä¸çŸ¥å¤„", "æµ…ç¬‘å®‰ç„¶", "è¿™é‡Œçš„é»æ˜é™æ‚„æ‚„",
    "å²æœˆé™å¥½", "æ˜¥æš–èŠ±å¼€", "æ²§æµ·ä¸€å£°ç¬‘", "æ«å¶çº¢äº†", "é™å¾…èŠ±å¼€", "åŒ—å›½é£å…‰",
    
    // æŠ½è±¡/ç½‘ç»œçƒ­è¯ç±»
    "momo", "ç”¨æˆ·89757", "èŠå£«é›ªè±¹", "AAAå»ºæç‹æ€»", "çº¯çˆ±æˆ˜ç¥", "åªæ˜¯ä¸ªä¼ è¯´",
    "è„†è„†é²¨", "ç†¬å¤œå† å†›", "æ‘¸é±¼è¾¾äºº", "ä½›ç³»é’å¹´", "èººå¹³é€‰æ‰‹", "ç¤¾ææ‚£è€…",
    
    // è‹±æ–‡IDç±»
    "Focus_Man", "Echo", "Serendipity", "Joker", "Vicky", "Winner",
    "Dreamer", "Phoenix", "Shadow", "Luna", "Leo", "Alpha",
    
    // ä¸­æ–‡+æ•°å­—ç»„åˆï¼ˆåƒçœŸå®è´¦å·ï¼‰
    "å°æ˜åŒå­¦_2024", "å°ç‹çš„æ—¥å¸¸", "å°æçˆ±å­¦ä¹ ", "å¼ è€å¸ˆçš„ç¬”è®°", "ç‹æ•™ç»ƒ",
    "å°èŠ³è¦åŠ æ²¹", "é˜¿æ°çš„æˆé•¿æ—¥è®°", "å°ç¾å‘å‰å†²", "è€é™ˆçš„è¯»ä¹¦ç¬”è®°",
    
    // èŒä¸š/å…´è¶£ç±»
    "ç¨‹åºå‘˜å°ç‹", "è®¾è®¡å¸ˆLily", "è‹±è¯­è€å¸ˆLinda", "å¥èº«æ•™ç»ƒMike", "è€ƒç ”å…šå°å¼ ",
    "è¯»ä¹¦äººè€èµµ", "æ—…è¡Œæ‘„å½±å®¶", "ç¾é£Ÿæ¢ç´¢è€…", "ç”µå½±çˆ±å¥½è€…",
    
    // å¯çˆ±/èŒç³»
    "å–µæ˜Ÿäºº", "æ±ªæ˜Ÿäºº", "å°å…”å‡ ", "å°ç†Šè½¯ç³–", "è‰è“å¥¶æ˜”", "å¥¶èŒ¶ä¸åŠ ç³–",
    
    // ä¸ªæ€§åŒ–ç­¾åå¼
    "ä»Šå¤©ä¹Ÿè¦åŠ æ²¹é¸­", "å‘æ›´å¥½çš„è‡ªå·±å‡ºå‘", "è‡ªå¾‹ç»™æˆ‘è‡ªç”±", "æ…¢æ…¢æ¥æ¯”è¾ƒå¿«",
    "ä¸€åˆ‡éƒ½ä¼šå¥½çš„", "ä¿æŒçƒ­çˆ±å¥”èµ´å±±æµ·"
];
// å¢å¼ºç‰ˆåç§°ç”Ÿæˆå‡½æ•°ï¼Œé¿å…é‡å¤
// å¢å¼ºç‰ˆåç§°ç”Ÿæˆå‡½æ•°ï¼Œé¿å…é‡å¤
let usedGlobalNames = new Set();

function generateRealisticName(forceUnique = true) {
    let name;
    let attempts = 0;
    
    do {
        const baseName = REALISTIC_NAMES[Math.floor(Math.random() * REALISTIC_NAMES.length)];
        name = baseName;
        
        // éšæœºæ·»åŠ åç¼€ï¼ˆ40%æ¦‚ç‡ï¼‰
        if (Math.random() < 0.4) {
            const suffixes = [
                `_${Math.floor(Math.random() * 99) + 1}`, // _23
                `${Math.floor(Math.random() * 999)}`,     // 456
                "âœ¨", "ğŸŒŸ", "ğŸ”¥", "ğŸ’ª", "ğŸ¯", "ğŸ“š", "ğŸ“–", "ğŸ†"
            ];
            name = baseName + suffixes[Math.floor(Math.random() * suffixes.length)];
        }
        
        // éšæœºæ·»åŠ å‰ç¼€ï¼ˆ15%æ¦‚ç‡ï¼‰
        else if (Math.random() < 0.15) {
            const prefixes = ["æˆ‘æ˜¯", "è¶…çˆ±", "åŠªåŠ›", "åŠ æ²¹", "åšæŒ", "çƒ­çˆ±"];
            name = prefixes[Math.floor(Math.random() * prefixes.length)] + baseName;
        }
        
        // æ·»åŠ è¡¨æƒ…åç¼€ï¼ˆ15%æ¦‚ç‡ï¼‰
        else if (Math.random() < 0.15) {
            const emojis = [" ğŸ˜Š", " ğŸ˜", " ğŸ¥³", " ğŸ¤“", " ğŸ¥°", " ğŸ˜´", " ğŸ€", " ğŸƒ"];
            name = baseName + emojis[Math.floor(Math.random() * emojis.length)];
        }
        
        attempts++;
        
        // å¦‚æœå°è¯•å¤ªå¤šæ¬¡ï¼Œå¼ºåˆ¶æ·»åŠ å”¯ä¸€ID
        if (attempts > 5) {
            name = baseName + "_" + Date.now().toString().slice(-4) + Math.floor(Math.random() * 100);
            break;
        }
        
    } while (forceUnique && usedGlobalNames.has(name));
    
    if (forceUnique) usedGlobalNames.add(name);
    return name;
}
// 2. ç”Ÿæˆ/è¯»å–æ¦œå•æ•°æ® (æ ¸å¿ƒé€»è¾‘)
function getVirtualRankings(type) {
    // â­ å¼ºåˆ¶æ›´æ–°ç¼“å­˜ç‰ˆæœ¬ï¼ˆä¿®å¤åœ¨çº¿çŠ¶æ€é—®é¢˜ï¼‰
    const CACHE_VERSION = "3.0"; // æ¯æ¬¡ä¿®æ”¹å°±é€’å¢
    const VERSION_KEY = 'rank_cache_version_' + planId;
    
    if (localStorage.getItem(VERSION_KEY) !== CACHE_VERSION) {
        // æ¸…é™¤æ‰€æœ‰ç±»å‹çš„ç¼“å­˜
        localStorage.removeItem(RANK_CACHE_KEY);
        localStorage.setItem(VERSION_KEY, CACHE_VERSION);
        console.log('ğŸ¯ æ’è¡Œæ¦œç¼“å­˜å·²æ›´æ–°åˆ°ç‰ˆæœ¬', CACHE_VERSION);
    }
    
    let userVal = 0;
    if(type === 'xp') userVal = Math.floor(userProfile.xp);
    else if(type === 'focus') userVal = userProfile.focusMinutes || 0;
    else if(type === 'streak') userVal = userProfile.streak;

    const now = Date.now();
    let cache = JSON.parse(localStorage.getItem(RANK_CACHE_KEY) || '{}');
    
    // â­ å…³é”®ä¿®å¤ï¼šæ¯æ¬¡é‡æ–°ç”Ÿæˆå‰æ¸…ç©ºå…¨å±€è®°å½•
    usedGlobalNames.clear();
    
    if (!cache[type] || (now - cache[type].timestamp > RANK_UPDATE_INTERVAL)) {
        console.log(`[Leaderboard] Generating new ${type} opponents...`);
        
        const bots = [];
        const botCount = 15;
        
        // ä¸ºæ¯ä¸ªç±»å‹åˆ›å»ºç‹¬ç«‹çš„usedNames
        const usedNamesForThisType = new Set();
        
        for (let i = 0; i < botCount; i++) {
            // ç”Ÿæˆç»å¯¹ä¸é‡å¤çš„åå­—
            let name;
            let attempts = 0;
            
            do {
                name = generateRealisticName(false); // å…ˆä¸æ£€æŸ¥å…¨å±€é‡å¤
                
                // å¦‚æœåœ¨æœ¬ç±»å‹å†…é‡å¤ï¼ŒåŠ åç¼€
                if (usedNamesForThisType.has(name)) {
                    name = name + "_" + (Math.floor(Math.random() * 90) + 10);
                }
                
                attempts++;
                if (attempts > 8) {
                    // ç»ˆæé˜²é‡å¤ï¼šæ—¶é—´æˆ³+éšæœºæ•°
                    name = name.split('_')[0] + "_" + 
                           Date.now().toString().slice(-6) + 
                           Math.floor(Math.random() * 1000);
                    break;
                }
            } while (usedNamesForThisType.has(name));
            
            usedNamesForThisType.add(name);
            usedGlobalNames.add(name); // ä¹ŸåŠ å…¥å…¨å±€è®°å½•
            
            // æ™ºèƒ½å¤´åƒé€‰æ‹©ï¼ˆä¿®å¤ç‰ˆï¼‰
            const genderRand = Math.random();
            let avatar;
            if (genderRand < 0.2) {
                // 20%ç”·æ€§å¤´åƒ
                const maleAvatars = ["ğŸ‘¨â€ğŸ’»", "ğŸ‘¨â€ğŸ“", "ğŸ¦", "ğŸ¯", "ğŸš€", "ğŸ”¥", "âš½", "ğŸ®"];
                avatar = maleAvatars[Math.floor(Math.random() * maleAvatars.length)];
            } else if (genderRand < 0.4) {
                // 20%å¥³æ€§å¤´åƒ
                const femaleAvatars = ["ğŸ‘©â€ğŸ’»", "ğŸ‘©â€ğŸ“", "ğŸ±", "ğŸ°", "ğŸŒ¸", "ğŸŒŸ", "ğŸ’„", "ğŸ‘—"];
                avatar = femaleAvatars[Math.floor(Math.random() * femaleAvatars.length)];
            } else {
                // 60%ä¸­æ€§å¤´åƒ
                const neutralAvatars = ["ğŸ¶", "ğŸ¼", "ğŸ³", "ğŸ€", "ğŸ¯", "ğŸ“š", "ğŸ¨", "ğŸµ", "ğŸ", "âš¡"];
                avatar = neutralAvatars[Math.floor(Math.random() * neutralAvatars.length)];
            }
            
            // â­ ä¿®å¤ï¼šç”Ÿæˆå›ºå®šçš„åœ¨çº¿çŠ¶æ€å’Œæ´»è·ƒæ—¶é—´
            const userType = Math.random();
            let isOnline, lastActive;
            
            // æ ¹æ®ç”¨æˆ·ç±»å‹ç”Ÿæˆä¸åŒçš„åœ¨çº¿æ¨¡å¼
            if (userType < 0.2) {
                // 20%ï¼šé«˜æ´»è·ƒç”¨æˆ·ï¼ˆå­¦ç”Ÿã€è‡ªç”±èŒä¸šè€…ï¼‰
                // åœ¨çº¿æ—¶é—´ï¼š8:00-23:00 æ¦‚ç‡é«˜ï¼Œå…¶ä»–æ—¶é—´æ¦‚ç‡ä½
                const hour = new Date().getHours();
                isOnline = (hour >= 8 && hour <= 23) ? Math.random() > 0.4 : Math.random() > 0.8;
                lastActive = isOnline ? "åˆšåˆš" : "1å°æ—¶å‰";
            } else if (userType < 0.5) {
                // 30%ï¼šä¸Šç­æ—ç”¨æˆ·
                // åœ¨çº¿æ—¶é—´ï¼šåˆä¼‘12-14ç‚¹ï¼Œæ™šä¸Š19-23ç‚¹æ¦‚ç‡é«˜
                const hour = new Date().getHours();
                const isWorkTime = (hour >= 12 && hour <= 14) || (hour >= 19 && hour <= 23);
                isOnline = isWorkTime ? Math.random() > 0.6 : Math.random() > 0.85;
                lastActive = isOnline ? "åœ¨çº¿" : ["ä»Šå¤©", "æ˜¨å¤©", "å·¥ä½œæ—¥æ´»è·ƒ"][Math.floor(Math.random() * 3)];
            } else {
                // 50%ï¼šå¶å°”æ´»è·ƒç”¨æˆ·
                isOnline = Math.random() > 0.9; // åªæœ‰10%åœ¨çº¿
                lastActive = ["æ˜¨å¤©", "æœ¬å‘¨", "å¶å°”æ´»è·ƒ"][Math.floor(Math.random() * 3)];
            }
            
            // å¦‚æœå½“å‰æ—¶é—´å¾ˆæ™šï¼ˆå‡Œæ™¨0-6ç‚¹ï¼‰ï¼Œé™ä½åœ¨çº¿æ¦‚ç‡
            const currentHour = new Date().getHours();
            if (currentHour >= 0 && currentHour <= 6) {
                if (Math.random() > 0.1) isOnline = false; // å‡Œæ™¨åªæœ‰10%ç”¨æˆ·å¯èƒ½åœ¨çº¿
            }
            
            // â­ æ”¹è¿›çš„æ™ºèƒ½åˆ†æ•°ç®—æ³•
            let score = 0;
            
            if (userVal < 30) {
                // æ–°æ‰‹é˜¶æ®µï¼šæœºå™¨äººåˆ†æ•°åœ¨ 20-150 ä¹‹é—´
                score = Math.floor(Math.random() * 130) + 20;
            } else {
                // æ ¹æ®æ’åä½ç½®ç”Ÿæˆä¸åŒæ°´å¹³çš„åˆ†æ•°
                const positionFactor = i / botCount; // 0-1ä¹‹é—´
                
                if (positionFactor < 0.2) {
                    // å‰20%ï¼šå·ç‹ï¼Œæ¯”ç”¨æˆ·é«˜ 30-80%
                    score = Math.floor(userVal * (1.3 + Math.random() * 0.5));
                } else if (positionFactor < 0.6) {
                    // ä¸­é—´40%ï¼šç«äº‰è€…ï¼Œæ¯”ç”¨æˆ·é«˜ 5-30%
                    score = Math.floor(userVal * (1.05 + Math.random() * 0.25));
                } else {
                    // å40%ï¼šè¢«è¶…è¶Šè€…ï¼Œæ¯”ç”¨æˆ·ä½ 20-50%
                    score = Math.floor(userVal * (0.5 + Math.random() * 0.3));
                }
                
                // æ·»åŠ éšæœºæ³¢åŠ¨
                score = Math.floor(score * (0.9 + Math.random() * 0.2));
            }
            
            // é™åˆ¶èŒƒå›´
            if (type === 'streak') {
                score = Math.min(Math.max(score, 1), 365);
                if (score < 1) score = 1;
            }
            if (type === 'focus') {
                score = Math.max(score, 5);
                if (score > 10000) score = Math.floor(score / 10);
            }
            if (type === 'xp') {
                score = Math.max(score, 10);
                if (score > 50000) score = Math.floor(score / 5);
            }
            
            bots.push({ 
                name, 
                avatar, 
                val: score, 
                isMe: false,
                isOnline: isOnline, // â­ å›ºå®šå­˜å‚¨åœ¨çº¿çŠ¶æ€
                lastActive: lastActive, // â­ å›ºå®šå­˜å‚¨æ´»è·ƒæ—¶é—´
                userType: userType < 0.2 ? "é«˜æ´»è·ƒ" : userType < 0.5 ? "ä¸Šç­æ—" : "å¶å°”æ´»è·ƒ" // ç”¨æˆ·ç±»å‹æ ‡ç­¾
            });
        }
        
        // æŒ‰åˆ†æ•°æ’åº
        bots.sort((a, b) => b.val - a.val);
        
        // ç¡®ä¿æ’åºååˆ†æ•°ä¹Ÿæ˜¯é€’å‡çš„ï¼ˆçœ‹èµ·æ¥æ›´çœŸå®ï¼‰
        for (let i = 1; i < bots.length; i++) {
            if (bots[i].val >= bots[i-1].val) {
                bots[i].val = Math.floor(bots[i-1].val * (0.8 + Math.random() * 0.15));
            }
        }
        
        cache[type] = {
            timestamp: now,
            data: bots
        };
        localStorage.setItem(RANK_CACHE_KEY, JSON.stringify(cache));
    }
    
    // åˆå¹¶ç”¨æˆ·æ•°æ®
    let finalList = [...cache[type].data];
    finalList.push({ 
        name: "æˆ‘", 
        avatar: "ğŸ˜", 
        val: userVal, 
        isMe: true,
        isOnline: true, // ç”¨æˆ·è‡ªå·±é»˜è®¤åœ¨çº¿
        lastActive: "åˆšåˆš"
    });
    
    // é‡æ–°æ’åº
    finalList.sort((a, b) => b.val - a.val);
    
    // è°ƒè¯•ï¼šæ£€æŸ¥æ˜¯å¦æœ‰é‡å¤åå­—
    const debugNames = finalList.map(item => item.name);
    const uniqueNames = new Set(debugNames);
    if (debugNames.length !== uniqueNames.size) {
        console.warn('âš ï¸ æ£€æµ‹åˆ°é‡å¤åå­—:', {
            æ€»æ•°é‡: debugNames.length,
            å”¯ä¸€æ•°é‡: uniqueNames.size,
            é‡å¤åˆ—è¡¨: debugNames.filter((name, index) => debugNames.indexOf(name) !== index)
        });
    } else {
        console.log('âœ… åå­—å”¯ä¸€æ€§æ£€æŸ¥é€šè¿‡');
    }
    
    // è¿”å›å‰15å
    return finalList.slice(0, 15);
}

// 2. æ¸²æŸ“æ’è¡Œæ¦œ (æ±‰åŒ–å•ä½ + åŠ¨æ€é”å®šæç¤º)
function renderLeaderboard(type) {
    currentRankType = type;
    
    console.log(`ğŸ® æ¸²æŸ“æ’è¡Œæ¦œ: ${type}`);
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.rank-filter-btn').forEach(btn => {
        if(btn.dataset.type === type) btn.classList.add('active');
        else btn.classList.remove('active');
    });

    const list = getVirtualRankings(type);
    console.log('ç”¨æˆ·åˆ—è¡¨:', list.map(u => ({
        åå­—: u.name, 
        åœ¨çº¿: u.isOnline, 
        æ´»è·ƒ: u.lastActive,
        åˆ†æ•°: u.val,
        ç±»å‹: u.userType || 'æ™®é€šç”¨æˆ·'
    })));
    
    const container = document.getElementById('leaderboardList');
    if (!container) {
        console.error('æ’è¡Œæ¦œå®¹å™¨æœªæ‰¾åˆ°');
        return;
    }
    
    container.innerHTML = '';

    list.forEach((item, idx) => {
        const rank = idx + 1;
        const row = document.createElement('div');
        row.className = `rank-row rank-${rank} ${item.isMe ? 'is-me' : ''}`;
        
        // æ•°å€¼æ˜¾ç¤º
        let valDisplay = item.val;
        if(type === 'focus') valDisplay += ' åˆ†é’Ÿ';
        if(type === 'streak') valDisplay += ' å¤©';
        if(type === 'xp') valDisplay += ' é˜…å†';

        // â­ å…³é”®ä¿®å¤ï¼šä½¿ç”¨ç¼“å­˜ä¸­çš„åœ¨çº¿çŠ¶æ€ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éšæœº
        const isOnline = item.isOnline || false;
        const lastActive = item.lastActive || "æœ€è¿‘æ´»è·ƒ";
        
        // åå­—å¤ªé•¿æ—¶æˆªæ–­
        const displayName = item.name.length > 10 ? 
            item.name.substring(0, 8) + '...' : item.name;
        
        // ç”¨æˆ·æ ‡ç­¾ï¼ˆæ ¹æ®åˆ†æ•°æ˜¾ç¤ºä¸åŒæ ‡ç­¾ï¼‰
        let userTag = '';
        if (!item.isMe) {
            if (type === 'xp') {
                if (item.val > 10000) userTag = 'å¤§ç¥';
                else if (item.val > 5000) userTag = 'é«˜æ‰‹';
                else if (item.val > 2000) userTag = 'è¿›é˜¶';
            } else if (type === 'streak') {
                if (item.val > 100) userTag = 'æ¯…åŠ›å¸';
                else if (item.val > 30) userTag = 'åšæŒè€…';
            } else if (type === 'focus') {
                if (item.val > 5000) userTag = 'ä¸“æ³¨ç‹';
                else if (item.val > 1000) userTag = 'å¿ƒæµè€…';
            }
        }
        
        // ç”¨æˆ·ç±»å‹é¢œè‰²
        let nameColor = 'text-slate-800';
        if (item.userType === 'é«˜æ´»è·ƒ') nameColor = 'text-blue-700';
        else if (item.userType === 'ä¸Šç­æ—') nameColor = 'text-purple-700';
        
        row.innerHTML = `
            <div class="rank-num">${rank}</div>
            <div class="rank-avatar relative flex items-center justify-center">
                <span class="text-lg">${item.avatar}</span>
                ${isOnline ? '<div class="absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full border border-white animate-pulse"></div>' : ''}
            </div>
            <div class="rank-name flex flex-col flex-1 min-w-0">
                <div class="flex items-center gap-1">
                    <span class="font-semibold ${nameColor} truncate">${displayName}</span>
                    ${item.isMe ? 
                        '<span class="text-[8px] bg-blue-100 text-blue-600 px-1 rounded flex-shrink-0">æˆ‘</span>' : 
                        (userTag ? `<span class="text-[8px] bg-amber-100 text-amber-700 px-1 rounded flex-shrink-0">${userTag}</span>` : '')
                    }
                </div>
                <span class="text-[10px] ${isOnline ? 'text-green-600 font-bold' : 'text-slate-400'} mt-0.5 flex-shrink-0">
                    ${isOnline ? 'â— åœ¨çº¿' : lastActive + 'æ´»è·ƒ'}
                    ${item.userType && !item.isMe ? ` Â· ${item.userType}` : ''}
                </span>
            </div>
            <div class="rank-val font-mono font-bold" style="color: var(--primary)">${valDisplay}</div>
        `;
        container.appendChild(row);
    });
    
    // è®¡ç®—ä¸‹æ¬¡æ›´æ–°æ—¶é—´ï¼Œå¢åŠ çœŸå®æ„Ÿ
    const cache = JSON.parse(localStorage.getItem(RANK_CACHE_KEY) || '{}');
    let nextTimeStr = "å³å°†";
    if (cache[type]) {
        const nextTime = cache[type].timestamp + RANK_UPDATE_INTERVAL;
        const minLeft = Math.ceil((nextTime - Date.now()) / 60000);
        if (minLeft > 60) {
            const hours = Math.floor(minLeft / 60);
            const minutes = minLeft % 60;
            nextTimeStr = `çº¦ ${hours}å°æ—¶${minutes > 0 ? `${minutes}åˆ†é’Ÿ` : ''}å`;
        } else {
            nextTimeStr = `çº¦ ${minLeft} åˆ†é’Ÿå`;
        }
    }
    
    // æ›´æ–°åº•éƒ¨æç¤ºæ–‡æ¡ˆ
    const footer = document.querySelector('#view-rank .text-center');
    if(footer) {
        const totalUsers = list.length;
        const onlineUsers = list.filter(u => u.isOnline).length;
        footer.innerHTML = `æ¦œå• ${nextTimeStr} æ›´æ–° Â· ${onlineUsers}/${totalUsers} äººåœ¨çº¿ Â· ä¸å…¨ç½‘å­¦å‹å…±å‹‰`;
    }
}

// 3. Tab åˆ‡æ¢é€»è¾‘ (ä¿æŒä¸å˜ï¼Œä½†ä¸ºäº†å®Œæ•´æ€§è´´åœ¨è¿™é‡Œ)
function switchProfileTab(tab) {
    const viewMe = document.getElementById('view-me');
    const viewRank = document.getElementById('view-rank');
    const btnMe = document.getElementById('tab-me');
    const btnRank = document.getElementById('tab-rank');
    
    if (!viewMe || !viewRank || !btnMe || !btnRank) {
        console.error('Tabåˆ‡æ¢å…ƒç´ æœªæ‰¾åˆ°');
        return;
    }

    if (tab === 'me') {
        viewMe.style.display = 'block';
        viewRank.style.display = 'none';
        btnMe.className = "px-4 py-1.5 rounded-lg text-sm font-bold transition-all bg-white shadow-sm text-slate-800";
        btnRank.className = "px-4 py-1.5 rounded-lg text-sm font-bold transition-all text-slate-400 hover:text-slate-600 hover:bg-slate-50";
        
        // åˆ‡æ¢åˆ°æˆ‘çš„ä¿®ä¸šæ—¶ï¼Œåˆ·æ–°ä¸ªäººæ•°æ®
        renderProfileModal();
    } else {
        viewMe.style.display = 'none';
        viewRank.style.display = 'block';
        btnRank.className = "px-4 py-1.5 rounded-lg text-sm font-bold transition-all bg-white shadow-sm text-slate-800";
        btnMe.className = "px-4 py-1.5 rounded-lg text-sm font-bold transition-all text-slate-400 hover:text-slate-600 hover:bg-slate-50";
        
        // åˆ‡æ¢åˆ°æ’è¡Œæ¦œæ—¶ï¼Œæ¸²æŸ“å½“å‰æ¦œå•
        renderLeaderboard(currentRankType);
        
        // ç¡®ä¿å›¾æ ‡é‡æ–°æ¸²æŸ“
        setTimeout(() => {
            if(window.lucide) window.lucide.createIcons();
        }, 50);
    }
}
// --- â­ æ–°å¢ï¼šXP æç¤ºæ§åˆ¶é€»è¾‘ â­ ---
function openXpTipModal() {
    const modal = document.getElementById('xpTipModalOverlay');
    if (modal && localStorage.getItem('pro_xp_tip_disabled') !== 'true') {
        modal.classList.add('show');
        document.getElementById('xpTipModal').classList.add('scale-100');
    }
}

function closeXpTipModal() {
    const modal = document.getElementById('xpTipModalOverlay');
    if (modal) {
        modal.classList.remove('show');
        document.getElementById('xpTipModal').classList.remove('scale-100');
    }
}

function disableXpTip() {
    localStorage.setItem('pro_xp_tip_disabled', 'true');
    showToast("ä¸‹æ¬¡å‡çº§å°†ä¸å†æç¤º");
    closeXpTipModal();
}

function showProfileModalAndCloseTip() {
    closeXpTipModal();
    // å› ä¸º openProfileModal å·²ç»åŒ…å«åœ¨ gainXP çš„å»¶è¿Ÿé€»è¾‘ä¸­ï¼Œè¿™é‡Œå¯ä»¥ç›´æ¥æ‰“å¼€
    // ç¡®ä¿ç”¨æˆ·èƒ½çœ‹åˆ°æ’è¡Œæ¦œ
    openProfileModal(); 
}
        // --- 7. åˆå§‹åŒ– ---
        function init() { 
            if (!RAW_DATA.includes('{{')) { const st = localStorage.getItem(TITLE_KEY); if(st) document.getElementById('planTitleText').innerText = st; } 
            document.getElementById('totalDaysLabel').innerText = tasksData.length; 
            const mobSelect = document.getElementById('mobileDateSelect'); if(mobSelect) { tasksData.forEach((d, i) => { const opt = document.createElement('option'); opt.value = i; opt.text = `ğŸ“… ${d.date} - Day ${d.dayNum}`; mobSelect.appendChild(opt); }); } 
            if(mobSelect) mobSelect.onchange = (e) => renderDay(parseInt(e.target.value));
            let initialDayIdx = parseInt(localStorage.getItem(CURRENT_DAY_KEY) || '0'); 
            const hashMatch = window.location.hash.match(/day=(\d+)/); if (hashMatch) { initialDayIdx = parseInt(hashMatch[1]); } 
            const urlParams = new URLSearchParams(window.location.search); if (urlParams.has('day')) { const urlDayIdx = parseInt(urlParams.get('day')); if (!isNaN(urlDayIdx) && urlDayIdx >= 0 && urlDayIdx < tasksData.length) { initialDayIdx = urlDayIdx; } } 
            renderDay(initialDayIdx);
            // åˆå§‹åŒ–æ²‰æµ¸æ¨¡å¼èƒŒæ™¯
document.getElementById('immersiveLayer').className = currentMode === 'mix' ? 'im-mix' : 'im-single';
PARTICLE_ENGINE.init();

            document.getElementById('modeLabel').innerText = currentMode === 'mix' ? "DOPAMINE MIX" : "PRO FOCUS"; 
            document.addEventListener('click', (e) => { if(!e.target.closest('.palette-wrapper')) closePalette(); }); 
            window.addEventListener('hashchange', () => { const hashMatch = window.location.hash.match(/day=(\d+)/); if (hashMatch) { renderDay(parseInt(hashMatch[1])); } });
            
            // å¼•å¯¼åºåˆ—
            setTimeout(() => {
                const dockTip = document.getElementById('dockTooltip'); if(dockTip) dockTip.classList.add('show');
                setTimeout(() => { if(dockTip) dockTip.classList.remove('show'); const noiseTip = document.getElementById('noiseTooltip'); if(noiseTip) { noiseTip.style.opacity = '1'; setTimeout(() => { noiseTip.style.opacity = '0'; }, 4000); } }, 4000);
            }, 1500);
            
            AUDIO_SYSTEM.preload();
            if(window.lucide) initLucideSafe();
        }

        // ç»Ÿä¸€å…¥å£ï¼Œè§£å†³æ‰§è¡Œæ—¶æœºé—®é¢˜
        window.addEventListener('DOMContentLoaded', init);
    </script>
    <script>
    // å¼ºåˆ¶æ¯ 100ms æ£€æŸ¥ä¸€æ¬¡å›¾æ ‡æ˜¯å¦æ¸²æŸ“ï¼Œå°è¯• 10 æ¬¡
    // è¿™èƒ½è§£å†³æ‰‹æœºç«¯åŠ è½½æ…¢å¯¼è‡´å›¾æ ‡â€œä¸å‡ºæ¥â€çš„é—®é¢˜
    let checkCount = 0;
    const forceRender = setInterval(() => {
        if(window.lucide) {
            window.lucide.createIcons();
            checkCount++;
        }
        if(checkCount > 10) clearInterval(forceRender);
    }, 100);
</script>

</body>
</html>