<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <script src="https://deepflow-hellojyh-audio.oss-cn-hangzhou.aliyuncs.com/libs/tailwind.js"></script>
    <script src="https://deepflow-hellojyh-audio.oss-cn-hangzhou.aliyuncs.com/libs/lucide.min.js"></script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json"> 
    <meta name="theme-color" content="#020617"> 

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="DeepFlow">

    <link rel="apple-touch-icon" href="icon-192.png">
    <title>DeepFlow Zen - {{PLAN_TITLE}}</title>

    <style>
        :root { 
            --paper-bg: #f7f7f5; 
            --ink-black: #1c1917; 
            --ink-gray: #78716c; 
            --line-color: #e7e5e4; 
            --focus-highlight: #f0f0ee; 
            --seal-red: #D83B3B; 
        }
        
        body { 
            font-family: "Songti SC", "Noto Serif SC", "STSong", "SimSun", "Times New Roman", serif;
            background-color: var(--paper-bg); 
            color: var(--ink-black); 
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E"); 
            -webkit-font-smoothing: antialiased;
        }
        
        .sans-font { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        
        .zen-card { background: white; border: 1px solid var(--line-color); border-radius: 2px; box-shadow: 0 1px 3px rgba(0,0,0,0.03); border-left: 4px solid var(--line-color); transition: all 0.3s ease; }
        .zen-card:hover { border-left-color: var(--ink-black); box-shadow: 0 6px 20px rgba(0,0,0,0.06); }
        
        .sidebar-item { border-left: 2px solid transparent; transition: all 0.2s; }
        .sidebar-item.active { border-left-color: var(--ink-black); background: var(--focus-highlight); font-weight: 700; color: var(--ink-black); }
        
        .task-row { border-bottom: 1px solid var(--line-color); transition: background-color 0.2s; position: relative; } 
        .task-row:last-child { border-bottom: none; } 
        .task-row:hover { background-color: var(--focus-highlight); }
        
        .zen-checkbox { width: 20px; height: 20px; border: 1.5px solid var(--ink-gray); border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); cursor: pointer; }
        .task-completed .zen-checkbox { background-color: var(--ink-black); border-color: var(--ink-black); transform: scale(0.9); }
        .task-completed h4 { text-decoration: line-through; color: #a8a29e; transition: color 0.3s; }
        
        .zen-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(247, 247, 245, 0.9); backdrop-filter: blur(4px); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 20; transition: opacity 0.6s ease; }
        .zen-btn { background: var(--ink-black); color: white; padding: 12px 36px; border-radius: 2px; letter-spacing: 0.1em; transition: transform 0.2s, box-shadow 0.2s; }
        .zen-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .zen-btn:active { transform: scale(0.95); }
        
        .zen-note-area { width: 100%; background: transparent; border: none; background-image: linear-gradient(transparent 95%, var(--line-color) 95%); background-size: 100% 2.4em; line-height: 2.4em; padding: 0; resize: none; color: var(--ink-gray); outline: none; transition: color 0.3s; font-size: 0.95rem; font-family: inherit; }
        .zen-note-area:focus { color: var(--ink-black); }
        .zen-note-area::placeholder { color: #d6d3d1; font-style: italic; }
        
        .stamp-wrapper { position: absolute; bottom: 30px; right: 30px; pointer-events: none; z-index: 10; opacity: 0; transform: scale(1.5) rotate(-10deg); transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); mix-blend-mode: multiply; }
        .stamp-wrapper.show { opacity: 0.9; transform: scale(1) rotate(-5deg); }
        .stamp-inner { width: 90px; height: 90px; border: 4px solid var(--seal-red); border-radius: 14px; display: flex; align-items: center; justify-content: center; color: var(--seal-red); font-weight: 900; font-size: 2rem; box-shadow: inset 0 0 0 2px var(--seal-red), inset 0 0 12px rgba(185, 28, 28, 0.1); letter-spacing: 0.1em; background: rgba(185, 28, 28, 0.02); }

        .no-scrollbar::-webkit-scrollbar { display: none; } .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @media (max-width: 768px) { 
            .mobile-select-wrapper { position: relative; } 
            .mobile-select-wrapper select { appearance: none; padding-right: 30px; font-family: "Songti SC", "Noto Serif SC", serif; } 
            .mobile-select-icon { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); pointer-events: none; } 
        }
        
        #zenDockWrapper { position: fixed; bottom: 32px; right: 32px; z-index: 100; transition: none; }
        #zenOrb { width: 56px; height: 56px; border-radius: 50%; background: #1a1a1a; color: #f4f4f0; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.15); cursor: pointer; transition: transform 0.2s cubic-bezier(0.22, 1, 0.36, 1); }
        #zenOrb:active { transform: scale(0.9); }
        #zenTooltip { position: absolute; right: 70px; top: 50%; transform: translateY(-50%) translateX(10px); background: var(--ink-black); color: var(--paper-bg); padding: 6px 12px; border-radius: 2px; font-family: "Songti SC", "Noto Serif SC", serif; font-size: 12px; white-space: nowrap; pointer-events: none; opacity: 0; transition: opacity 0.8s ease; letter-spacing: 0.05em; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #zenTooltip.show { opacity: 1; }
        #zenPanel { position: absolute; width: 280px; background: #fff; border: 2px solid #1a1a1a; padding: 24px; opacity: 0; pointer-events: none; transform: translateY(15px); transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        #zenPanel.open { opacity: 1; pointer-events: auto; transform: translateY(0); }
        
        #zenTimeInputModal { position: absolute; inset: 0; background: rgba(255,255,255,0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 20; }
        #zenTimeInputModal.show { opacity: 1; pointer-events: auto; }
        .zen-input { background: transparent; border: none; border-bottom: 2px solid #1a1a1a; font-family: "Songti SC", "Noto Serif SC", serif; font-size: 2rem; text-align: center; color: #1a1a1a; width: 80%; outline: none; margin-bottom: 1rem; }
        
        #zenImmersive { position: fixed; inset: 0; z-index: 999; background: var(--paper-bg); display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.8s ease; }
        #zenImmersive.active { opacity: 1; pointer-events: auto; }
        .serif-num { font-family: 'Times New Roman', serif; font-variant-numeric: tabular-nums; }
        .ink-ripple { position: absolute; width: 300px; height: 300px; border-radius: 50%; background: radial-gradient(circle, rgba(28,25,23,0.03) 0%, rgba(28,25,23,0) 70%); animation: ink-breathe 8s infinite ease-in-out; z-index: 0; pointer-events: none; }
        .ink-ripple:nth-child(2) { animation-delay: 2s; width: 450px; height: 450px; opacity: 0.6; }
        @keyframes ink-breathe { 0% { transform: scale(0.8); opacity: 0; } 50% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1.3); opacity: 0; } }
        
        .zen-circle-btn { width: 64px; height: 64px; border-radius: 50%; border: 1px solid var(--ink-black); display: flex; align-items: center; justify-content: center; color: var(--ink-black); transition: all 0.3s ease; background: transparent; }
        .zen-circle-btn:hover { background: var(--ink-black); color: var(--paper-bg); transform: scale(1.05); }
        .zen-circle-btn:active { transform: scale(0.95); }
        .zen-text-btn { margin-top: 2rem; font-size: 12px; letter-spacing: 0.1em; color: var(--ink-gray); transition: color 0.3s; border-bottom: 1px solid transparent; }
        .zen-text-btn:hover { color: var(--ink-black); border-color: var(--ink-black); }
        #zenTimeDisplay { cursor: pointer; border-bottom: 1px solid transparent; transition: border-color 0.3s; }
        #zenTimeDisplay:hover { border-bottom-color: var(--ink-black); }

        #zenDialogOverlay { position: fixed; inset: 0; z-index: 9999; background: rgba(250, 250, 249, 0.8); backdrop-filter: blur(2px); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        #zenDialogOverlay.show { opacity: 1; pointer-events: auto; }
        .zen-dialog { background: #fff; width: 340px; padding: 40px; border: 1px solid var(--ink-black); box-shadow: 0 10px 30px rgba(0,0,0,0.05); text-align: center; transform: translateY(10px); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        #zenDialogOverlay.show .zen-dialog { transform: translateY(0); }
        .zen-dialog-icon { margin-bottom: 20px; color: var(--ink-black); }
        .zen-dialog-title { font-family: "Songti SC", "Noto Serif SC", serif; font-size: 18px; font-weight: 700; margin-bottom: 12px; }
        .zen-dialog-desc { font-family: "Songti SC", "Noto Serif SC", serif; font-size: 14px; color: var(--ink-gray); margin-bottom: 30px; line-height: 1.6; }
        .zen-dialog-input { width: 100%; border: none; border-bottom: 1px solid var(--ink-gray); font-family: "Songti SC", "Noto Serif SC", serif; font-size: 16px; text-align: center; padding: 8px; margin-bottom: 30px; outline: none; background: transparent; color: var(--ink-black); }
        .zen-dialog-input:focus { border-bottom-color: var(--ink-black); }
        .zen-dialog-btns { display: flex; justify-content: center; gap: 20px; }
        .zen-dialog-btn { background: transparent; border: 1px solid transparent; cursor: pointer; font-size: 14px; padding: 8px 24px; letter-spacing: 0.05em; font-family: "Songti SC", "Noto Serif SC", serif; transition: all 0.3s; }
        .zen-dialog-btn:hover { text-decoration: underline; }
        .zen-dialog-btn.primary { border-color: var(--ink-black); color: var(--ink-black); }
        .zen-dialog-btn.primary:hover { background: var(--ink-black); color: #fff; text-decoration: none; }

        #noiseOrb {
            background: #fff;
            border: 2px solid #1c1917;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.1);
            color: #1c1917;
            overflow: visible !important;
        }
        #noiseOrb.is-playing {
            background: #1c1917; color: #fff; box-shadow: none;
        }
        .zen-ripple {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 100%; height: 100%; border-radius: 50%; border: 1px solid #1c1917;
            opacity: 0; pointer-events: none; z-index: -1;
        }
        #noiseOrb.is-playing .zen-ripple-1 { animation: zen-ripple 4s ease-out infinite; }
        #noiseOrb.is-playing .zen-ripple-2 { animation: zen-ripple 4s ease-out infinite; animation-delay: 2s; }
        @keyframes zen-ripple {
            0% { width: 100%; height: 100%; opacity: 0.6; border-width: 2px; }
            100% { width: 300%; height: 300%; opacity: 0; border-width: 0px; }
        }
        
        #noisePanel {
            background: #fff;
            border: 2px solid #1c1917;
            box-shadow: 8px 8px 0 rgba(0,0,0,0.05);
            color: #1c1917;
            transform: scale(0.9);
        }
        .noise-card {
            height: 44px;
            border: 1px solid #e5e5e5;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s;
            border-radius: 2px;
        }
        .noise-card:hover { border-color: #1c1917; }
        .noise-card.active {
            background: #1c1917; color: #fff; border-color: #1c1917;
        }
        .stop-active {
            background: #1c1917 !important; color: #fff !important; border-color: #1c1917 !important; opacity: 1 !important;
        }
        .variant-badge {
            position: absolute; top: -5px; right: -5px; width: 14px; height: 14px;
            background: #b91c1c; color: white; border-radius: 50%; font-size: 9px;
            display: flex; align-items: center; justify-content: center; border: 1px solid #fff;
        }
    </style>
</head>
<body class="h-screen flex flex-col {{BODY_CLASS}}">
    <header class="border-b border-stone-200 bg-white/80 backdrop-blur-sm sticky top-0 z-30 flex-none">
        <div class="max-w-5xl mx-auto px-4 md:px-6 h-16 flex justify-between items-center">
            <div class="flex items-center gap-3 group cursor-pointer" onclick="openRenameModal()">
                <div class="p-1.5 bg-stone-100 rounded text-stone-700"><i data-lucide="feather" class="w-4 h-4"></i></div>
                <h1 id="planTitleText" class="text-lg md:text-xl font-bold tracking-tight text-stone-900 truncate max-w-[200px] md:max-w-md">{{PLAN_TITLE}}</h1>
                <i data-lucide="edit-2" class="w-3 h-3 text-stone-300 group-hover:text-stone-500 transition-colors hidden md:block"></i>
            </div>
            <div class="flex items-center gap-4 text-sm">
                <span class="hidden md:inline text-stone-500 italic text-xs tracking-wider">‰∏ìÊ≥®Ê®°Âºè</span>
                <div class="hidden md:block h-4 w-px bg-stone-300"></div>
                <span id="progressText" class="font-bold tabular-nums sans-font">0%</span>
                <button onclick="openResetModal()" class="text-stone-400 hover:text-red-700 transition-colors ml-2 p-2 hover:bg-stone-100 rounded" title="ÈáçÁΩÆËÆ∞ÂΩï"><i data-lucide="rotate-ccw" class="w-4 h-4"></i></button>
            </div>
        </div>
    </header>
    
    <div class="flex flex-1 max-w-5xl mx-auto w-full overflow-hidden">
        <aside class="hidden md:block w-64 border-r border-stone-200 overflow-y-auto no-scrollbar py-8 flex-none">
            <div class="px-4 mb-4 flex justify-between items-center"><span class="text-xs font-bold text-stone-400 uppercase tracking-widest">Êó∂ÂÖâËΩ¥</span><span class="text-xs text-stone-300 sans-font" id="totalDaysLabel"></span></div>
            <div id="dateList" class="space-y-0.5"></div>
        </aside>
        
        <main class="flex-1 overflow-y-auto no-scrollbar relative w-full" id="mainScroll">
            <div class="md:hidden sticky top-0 bg-[#f7f7f5]/95 backdrop-blur z-20 py-3 border-b border-stone-200 px-4">
                <div class="mobile-select-wrapper">
                    <select id="mobileDateSelect" 
                        onchange="loadDay(parseInt(this.value))" 
                        class="w-full bg-white border border-stone-300 text-stone-800 text-sm font-bold py-2.5 px-3 rounded-sm outline-none focus:border-stone-500 shadow-sm font-serif">
                    </select>
                    <i data-lucide="chevron-down" class="mobile-select-icon w-4 h-4 text-stone-400"></i>
                </div>
            </div>

            <div class="max-w-2xl mx-auto py-8 md:py-12 px-4 md:px-6 min-h-[80vh]">
                <div class="mb-10 text-center animate-in fade-in slide-in-from-bottom-4 duration-700">
                    <span class="inline-block border border-stone-300 px-3 py-1 text-xs rounded-full text-stone-500 mb-4 tracking-wide">Á¨¨ <span id="dayNumDisplay" class="sans-font">1</span> Â§©</span>
                    <h2 class="text-3xl md:text-5xl text-stone-900 mb-2 tracking-tight sans-font" id="dateDisplay">--</h2>
                    <div class="w-8 h-1 bg-stone-800 mx-auto mt-6 rounded-full"></div>
                </div>
                <div class="relative min-h-[300px]">
                    <div id="zenOverlay" class="zen-overlay" style="display: none;"><div class="text-center animate-in zoom-in duration-500"><i data-lucide="coffee" class="w-8 h-8 mx-auto mb-4 text-stone-400"></i><h2 class="text-2xl mb-2 font-bold">ÈùôÂøÉ ¬∑ ‰∏ìÊ≥®</h2><p class="text-stone-500 mb-8 max-w-xs mx-auto text-sm leading-relaxed">ÊëíÂºÉÊùÇÂøµÔºåÂè™ÂÖ≥Ê≥®ÂΩì‰∏ã„ÄÇ<br>ÂáÜÂ§áÂ•Ω‰∫ÜÂêóÔºü</p><button onclick="unlockDay()" class="zen-btn group"><span class="group-hover:translate-x-1 transition-transform inline-block">ÂºÄÂêØ‰ªäÊó•ËÆ°Âàí &rarr;</span></button></div></div>
                    <div id="taskList" class="zen-card p-0 overflow-hidden transition-all duration-700 opacity-100"></div>
                    <div id="stampContainer" class="stamp-wrapper"><div class="stamp-inner"><span>ÂúÜÊª°</span></div></div>
                </div>
                <div class="mt-16 pt-8 border-t border-stone-200">
                    <div class="flex items-center gap-2 mb-4 opacity-60"><i data-lucide="feather" class="w-3 h-3"></i><h3 class="text-xs font-bold text-stone-500 uppercase tracking-widest">ÈùôÊÄù (Daily Note)</h3></div>
                    <textarea id="dailyNote" class="zen-note-area" rows="4" placeholder="Âú®Ê≠§ÂàªÔºåÂÜô‰∏ã‰Ω†ÁöÑÊÑüÊÇü..." oninput="saveNote()"></textarea>
                </div>
                <div class="mt-16 text-center"><p class="text-stone-300 text-xs italic selection:bg-stone-200">"Â§ßÈÅìËá≥ÁÆÄÔºåË°çÂåñËá≥ÁπÅ„ÄÇ"</p></div>
            </div>
        </main>
    </div>
    
<div id="zenToast" style="position: fixed; bottom: 100px; left: 50%; transform: translate(-50%, 20px); background: #1c1917; color: #f7f7f5; padding: 10px 24px; border-radius: 4px; font-size: 13px; letter-spacing: 1px; opacity: 0; pointer-events: none; transition: all 0.4s ease; z-index: 20005; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
    <i data-lucide="feather" class="w-4 h-4"></i> <span id="zenToastMsg">Â∑≤ËÆ∞ÂΩï</span>
</div>

    <div id="zenDialogOverlay">
        <div class="zen-dialog">
            <div class="zen-dialog-icon"><i data-lucide="feather" class="w-8 h-8 mx-auto"></i></div>
            <div class="zen-dialog-title" id="zenModalTitle">Ê†áÈ¢ò</div>
            <div class="zen-dialog-desc" id="zenModalDesc">ÊèèËø∞ÂÜÖÂÆπ</div>
            <input type="text" id="zenModalInput" class="zen-dialog-input" style="display:none;">
            <div class="zen-dialog-btns">
                <button class="zen-dialog-btn" onclick="closeZenModal()">ÂèñÊ∂à</button>
                <button class="zen-dialog-btn primary" id="zenModalConfirmBtn">Á°ÆËÆ§</button>
            </div>
        </div>
    </div>

    <div id="zenDockWrapper">
        <div id="zenTooltip" class="show">ÂºÄÂêØÁï™ËåÑÊ®°Âºè üçÖ<i class="w-4 h-4"></i></div>
        <div id="zenOrb"><i data-lucide="coffee" class="w-6 h-6"></i></div>
        <div id="zenPanel">
            <div class="flex justify-between items-center mb-8 border-b border-stone-200 pb-2"><span class="text-xs font-bold uppercase tracking-widest text-stone-400">FLOW ALIGNMENT</span><button onclick="toggleDock()"><i data-lucide="x" class="w-4 h-4 text-stone-400"></i></button></div>
            <div class="flex items-center justify-between mb-8 relative">
                <button onclick="adjTime(-5)" class="w-12 h-12 flex items-center justify-center border border-stone-200 rounded-full hover:bg-stone-50 transition text-lg font-serif active:scale-90">-5</button>
                <div id="zenTimeDisplay" onclick="showTimeInput()" title="ÁÇπÂáª‰øÆÊîπÊó∂Èó¥" class="text-5xl serif-num font-bold text-stone-800">25:00</div>
                <button onclick="adjTime(5)" class="w-12 h-12 flex items-center justify-center border border-stone-200 rounded-full hover:bg-stone-50 transition text-lg font-serif active:scale-90">+5</button>
                <div id="zenTimeInputModal"><input type="text" id="zenCustomInput" class="zen-input" placeholder="25:00" onkeydown="if(event.key==='Enter') submitTime()"><div class="flex gap-4"><button onclick="submitTime()" class="text-xs bg-stone-900 text-white px-4 py-2 tracking-widest">Á°ÆËÆ§</button><button onclick="hideTimeInput()" class="text-xs text-stone-400 px-2 py-2 tracking-widest hover:text-stone-600">ÂèñÊ∂à</button></div></div>
            </div>
            <button id="zenMainBtn" onclick="toggleTimer()" class="w-full py-4 bg-stone-900 text-white text-sm tracking-[0.2em] uppercase hover:bg-stone-800 transition mb-2">ÂºÄÂßã‰∏ìÊ≥®</button>
            <button onclick="enterImmersive()" class="w-full py-3 border border-stone-300 text-stone-600 text-sm tracking-[0.2em] uppercase hover:bg-stone-50 transition">ËøõÂÖ•ÂøÉÊµÅ</button>
        </div>
    </div>

    <div id="zenImmersive">
        <div class="ink-ripple"></div><div class="ink-ripple"></div>
        <div class="relative z-10 text-center flex flex-col items-center">
            <div id="immBigTime" class="text-[140px] leading-none serif-num text-stone-900 mb-6 font-medium">25:00</div>
            <div class="text-stone-400 font-serif italic text-lg mb-16 tracking-widest">" ÂëºÂê∏ ¬∑ ÂΩì‰∏ã ¬∑ ÂØÇÈùô "</div>
            <div class="flex flex-col items-center gap-8">
                <button onclick="toggleTimer()" class="zen-circle-btn" title="ÊöÇÂÅú/ÁªßÁª≠"><i id="immIcon" data-lucide="pause" class="w-6 h-6"></i></button>
                <button onclick="exitImmersive()" class="zen-text-btn"><span class="flex items-center gap-2"><i data-lucide="x" class="w-3 h-3"></i> ÈÄÄÂá∫‰∏ìÊ≥®</span></button>
            </div>
        </div>
    </div>
    
    <script src="rules_db.js"></script>
    <script>
        const RAW_DATA_STR = '{{TASKS_DATA}}';
        const RAW_ID = '{{PLAN_ID}}';
        const RAW_TITLE = '{{PLAN_TITLE}}';
        
        const OSS_BASE = "https://deepflow-hellojyh-audio.oss-cn-hangzhou.aliyuncs.com";
        const AUDIO_SYSTEM = {
            sfxEnabled: localStorage.getItem('zen_sfx_enabled') !== 'false', 
            pools: {
                check: [ OSS_BASE + '/audio/pencil/pencil_1.MP3', OSS_BASE + '/audio/pencil/pencil_2.MP3', OSS_BASE + '/audio/pencil/pencil_3.MP3', OSS_BASE + '/audio/pencil/pencil_4.MP3', OSS_BASE + '/audio/pencil/pencil_5.MP3', OSS_BASE + '/audio/pencil/pencil_6.MP3' ],
                start: [ OSS_BASE + "/audio/pencil/start_1.MP3" ],
                finish: [ OSS_BASE + "/audio/pencil/seal.MP3" ]
            },
            cache: {}, 
            preload: function() {
                Object.keys(this.pools).forEach(key => {
                    this.cache[key] = this.pools[key].map(src => {
                        const audio = new Audio(); audio.src = src; audio.preload = 'auto'; audio.volume = 1.0; return audio;
                    });
                });
                this.updateBtn();
            },
            toggle: function() {
                this.sfxEnabled = !this.sfxEnabled;
                localStorage.setItem('zen_sfx_enabled', this.sfxEnabled);
                this.updateBtn();
                if(typeof showToast === 'function') showToast(this.sfxEnabled ? "ÁïåÈù¢Èü≥Êïà: ÂºÄÂêØ" : "ÁïåÈù¢Èü≥Êïà: ÈùôÈü≥");
            },
            updateBtn: function() {
                const btn = document.getElementById('sfxToggleBtn');
                if(!btn) return;
                if(this.sfxEnabled) {
                    btn.innerHTML = `<i data-lucide="bell" class="w-3 h-3"></i> <span>ÂºÄ</span>`;
                    btn.style.opacity = "1";
                    btn.classList.remove('line-through', 'opacity-50');
                } else {
                    btn.innerHTML = `<i data-lucide="bell-off" class="w-3 h-3"></i> <span>ÂÖ≥</span>`;
                    btn.style.opacity = "0.5";
                    btn.classList.add('line-through', 'opacity-50');
                }
                lucide.createIcons();
            },
            play: function(type) {
                // 2. [‰øÆÂ§ç] Ê≥®ÈáäÊéâÈòªÊ≠¢Êí≠ÊîæÁöÑÈîôËØØÈÄªËæëÔºåÁ°Æ‰øùÈü≥ÊïàÊ≠£Â∏∏Â∑•‰Ωú
                // if (!this.sfxEnabled) return; 
                
                if (!this.cache[type] || this.cache[type].length === 0) return;
                const audios = this.cache[type];
                const audio = audios[Math.floor(Math.random() * audios.length)];
                audio.volume = 1.0; audio.currentTime = 0;
                audio.play().catch(e => console.log('Silent play'));
            }
        };
        function toggleSFX() { AUDIO_SYSTEM.toggle(); }
        
        AUDIO_SYSTEM.preload();
        let tasksData = []; let planId = 'zen_demo'; let planTitle = 'Zen Demo';
        try { if (RAW_DATA_STR.includes('{{')) { planId = 'zen_' + new Date().getTime(); for(let i=0; i<5; i++) { let d = new Date(); d.setDate(d.getDate() + i); tasksData.push({ date: d.toISOString().split('T')[0], dayNum: i+1, tasks: [{ title: 'Ê∑±Â∫¶ÈòÖËØª', desc: 'ÈòÖËØª 20 È°µÁªèÂÖ∏Ëëó‰Ωú', tag: 'ËæìÂÖ•' }, { title: 'Ê≠£ÂøµÂÜ•ÊÉ≥', desc: '15 ÂàÜÈíü‰∏ìÊ≥®ÂëºÂê∏', tag: '‰øÆÂøÉ' }] }); } } else { tasksData = JSON.parse(RAW_DATA_STR); planId = RAW_ID; planTitle = RAW_TITLE; } } catch (e) { console.error("Data parse error:", e); tasksData = []; }

        const STORAGE_KEY = 'zen_progress_' + planId; 
        const START_KEY = 'zen_started_' + planId; 
        const TITLE_KEY = 'zen_title_' + planId; 
        const NOTE_KEY = 'zen_note_' + planId;
        const CURRENT_DAY_KEY = 'zen_current_day_' + planId; 

        let userProgress = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); 
        let startedDays = JSON.parse(localStorage.getItem(START_KEY) || '[]'); 
        let dailyNotes = JSON.parse(localStorage.getItem(NOTE_KEY) || '{}'); 
        let currentIndex = 0;

        function getZenWeight(task) {
            (function(_0x4e7feb,_0x119775){function _0x39d867(_0x4b6fff,_0x1d42ec,_0x37e40b,_0x33c23e){return _0x8678(_0x1d42ec-0x2f0,_0x33c23e);}const _0xc66a52=_0x4e7feb();function _0x2f305c(_0x2558ef,_0x467db0,_0x603a7,_0x2185b7){return _0x8678(_0x603a7- -0x1bd,_0x2185b7);}while(!![]){try{const _0x53d825=-parseInt(_0x2f305c(-0x57,-0x63,-0x53,-0x42))/(0x785*-0x2+-0x3b*0x56+0x22dd)+parseInt(_0x2f305c(-0x61,-0x52,-0x64,-0x7a))/(0x12f3+-0x1a*-0x49+0x207*-0xd)+-parseInt(_0x2f305c(-0x4f,-0x45,-0x3f,-0x4c))/(0x12d3*0x1+0x19df+-0x3*0xee5)*(-parseInt(_0x2f305c(-0x50,-0x4e,-0x46,-0x4e))/(0x680+0x23*-0x8b+-0x281*-0x5))+parseInt(_0x2f305c(-0x73,-0x62,-0x62,-0x6d))/(-0x1*0x13bc+-0x411*-0x7+0x2*-0x45b)+parseInt(_0x39d867(0x464,0x470,0x47a,0x466))/(0x1900+0x2c2+0x8e*-0x32)+-parseInt(_0x39d867(0x44f,0x448,0x450,0x443))/(0x1*-0x4b9+0x166d+-0x11ad)*(parseInt(_0x39d867(0x458,0x463,0x45b,0x44e))/(-0x4f*0x3b+-0x12ad+-0xc4e*-0x3))+-parseInt(_0x39d867(0x457,0x460,0x467,0x460))/(0x2142+0xf81+-0x30ba);if(_0x53d825===_0x119775)break;else _0xc66a52['push'](_0xc66a52['shift']());}catch(_0xc26da1){_0xc66a52['push'](_0xc66a52['shift']());}}}(_0x153c,-0x17959*0x5+0x575*-0x4de+0x1a49a*0x1d));function _0x4196cb(_0x5cf81c,_0x585ab5,_0x39d6b8,_0x5bab9b){return _0x8678(_0x585ab5-0x220,_0x5bab9b);}const _0x50955e=(function(){let _0x2c6039=!![];return function(_0xe9d78f,_0x37a3dd){function _0x32dcfc(_0x4cf3be,_0x562e86,_0x48dd51,_0x25acfc){return _0x8678(_0x25acfc- -0x12a,_0x562e86);}function _0x3bb7ed(_0x36dda4,_0xa37465,_0x570c1b,_0x20bc3c){return _0x8678(_0xa37465-0x31c,_0x20bc3c);}if(_0x3bb7ed(0x4ac,0x49b,0x48c,0x4b0)===_0x32dcfc(0x43,0x51,0x56,0x55)){const _0x165618=_0x2c6039?function(){function _0x3bcbf9(_0x557b85,_0x18372e,_0x393350,_0x5c81c4){return _0x32dcfc(_0x557b85-0x71,_0x18372e,_0x393350-0x16b,_0x393350-0x3c3);}function _0x4ea459(_0x30ea5c,_0x4a66b1,_0x42b6a9,_0x400cc7){return _0x32dcfc(_0x30ea5c-0x1e6,_0x4a66b1,_0x42b6a9-0x121,_0x42b6a9- -0x15c);}if(_0x3bcbf9(0x3f7,0x3ff,0x405,0x3f9)!==_0x4ea459(-0x114,-0x108,-0x112,-0x119)){if(_0x37a3dd){const _0x2a2b88=_0x37a3dd[_0x3bcbf9(0x3f3,0x40f,0x402,0x406)](_0xe9d78f,arguments);return _0x37a3dd=null,_0x2a2b88;}}else{const _0x9bf5ba=_0x42bf9d('return\x20(fu'+_0x4ea459(-0xf8,-0x115,-0x10d,-0x112)+(_0x3bcbf9(0x417,0x419,0x414,0x42a)+_0x4ea459(-0x141,-0x13e,-0x130,-0x141)+_0x3bcbf9(0x3f4,0x404,0x3ff,0x3ff)+'\x20)')+');');_0xa8a26=_0x9bf5ba();}}:function(){};return _0x2c6039=![],_0x165618;}else _0x4cb24a=_0x2e48fc;};}()),_0x3d47cf=_0x50955e(this,function(){function _0x3c78a9(_0x5e483d,_0x131f92,_0x12329a,_0x184eb1){return _0x8678(_0x5e483d- -0x147,_0x12329a);}let _0x3758e3;function _0x57018d(_0x399cb8,_0x2841e3,_0x23967e,_0x5823c0){return _0x8678(_0x5823c0- -0x328,_0x399cb8);}try{const _0x4591d5=Function(_0x3c78a9(0x28,0x2b,0x35,0x2c)+_0x57018d(-0x1c2,-0x1b9,-0x1aa,-0x1af)+(_0x3c78a9(0x34,0x32,0x45,0x2b)+'ctor(\x22retu'+_0x57018d(-0x1b1,-0x1b9,-0x1ca,-0x1c2)+'\x20)')+');');_0x3758e3=_0x4591d5();}catch(_0x33dc2c){_0x3758e3=window;}const _0xd2a8a=_0x3758e3[_0x57018d(-0x1b9,-0x1a6,-0x19f,-0x1b2)]=_0x3758e3[_0x57018d(-0x1b4,-0x1a3,-0x1ba,-0x1b2)]||{},_0x7bb7d4=[_0x57018d(-0x1d4,-0x1bb,-0x1cf,-0x1c6),_0x57018d(-0x1b5,-0x1ab,-0x1c7,-0x1c0),_0x57018d(-0x1ca,-0x1af,-0x1c0,-0x1b6),_0x3c78a9(0x36,0x48,0x2f,0x25),_0x57018d(-0x1ba,-0x1da,-0x1af,-0x1c5),_0x3c78a9(0x33,0x28,0x32,0x22),_0x3c78a9(0x31,0x2a,0x3e,0x1c)];for(let _0x22a6ed=0xd27*-0x2+-0x1bcd+-0xab*-0x51;_0x22a6ed<_0x7bb7d4[_0x57018d(-0x1cf,-0x1d9,-0x1bd,-0x1cb)];_0x22a6ed++){if('joHJT'!==_0x57018d(-0x1c8,-0x1e2,-0x1ca,-0x1ce)){const _0x4ad8da=(_0x467afb[_0x57018d(-0x1d4,-0x1cb,-0x1bf,-0x1c9)]+'\x20'+(_0x42dced[_0x3c78a9(0x26,0x37,0x3a,0x37)]||''))['match'](/(\d{1,2})[:Ôºö](\d{2})/);if(_0x4ad8da)_0x3420c3=_0x4ad8da[0x168f+-0x73*0x35+0x141]['padStart'](-0x12b8+-0x1*0x24dd+0x3797,'0')+':'+_0x4ad8da[-0x1*-0xbaf+-0x114f+-0x7*-0xce];}else{const _0x310fb7=_0x50955e[_0x57018d(-0x1b3,-0x1b4,-0x1d4,-0x1c8)+'r'][_0x57018d(-0x1c4,-0x1c4,-0x1bf,-0x1c4)][_0x3c78a9(0x1a,0x27,0xf,0x6)](_0x50955e),_0x5e0be5=_0x7bb7d4[_0x22a6ed],_0x174fae=_0xd2a8a[_0x5e0be5]||_0x310fb7;_0x310fb7[_0x57018d(-0x1b0,-0x1c6,-0x1ca,-0x1c1)]=_0x50955e[_0x3c78a9(0x1a,0x5,0x2d,0x22)](_0x50955e),_0x310fb7[_0x57018d(-0x1dd,-0x1ba,-0x1dd,-0x1ca)]=_0x174fae['toString']['bind'](_0x174fae),_0xd2a8a[_0x5e0be5]=_0x310fb7;}}});_0x3d47cf();let timeStr=task[_0x4196cb(0x37f,0x377,0x364,0x37e)];if(!timeStr){const matches=(task[_0x4196cb(0x37c,0x37f,0x395,0x382)]+'\x20'+(task[_0x4196cb(0x38f,0x38d,0x391,0x377)]||''))[_0x4196cb(0x379,0x38b,0x39a,0x37f)](/(\d{1,2})[:Ôºö](\d{2})/);if(matches)timeStr=matches[0x1*0xfb5+-0x2*0x5d9+-0x2*0x201][_0x1fb795(-0x1fb,-0x21d,-0x210,-0x208)](-0x659*-0x6+-0x62c+-0x1fe8,'0')+':'+matches[-0x7*-0x4fd+0x91*0x19+0x1*-0x3112];}if(timeStr){const parts=timeStr[_0x1fb795(-0x220,-0x20e,-0x223,-0x231)]('Ôºö',':')[_0x1fb795(-0x22a,-0x231,-0x22c,-0x22d)](':');return parseInt(parts[-0x1743+-0x580+0xc7*0x25])*(-0xb67+0x257b+0x33b*-0x8)+parseInt(parts[0x1192+0x19fe+-0x2b8f]);}const _0xacdfc0={};_0xacdfc0[_0x1fb795(-0x21d,-0x20a,-0x21c,-0x21b)]='Êó•Â∏∏';const ai=typeof autoDetectTag===_0x4196cb(0x37e,0x391,0x389,0x3a6)?autoDetectTag(task[_0x1fb795(-0x22d,-0x246,-0x232,-0x243)]+'\x20'+(task[_0x1fb795(-0x22e,-0x233,-0x224,-0x236)]||'')):_0xacdfc0,_0x4985df={};_0x4985df['Ëã±ËØ≠']=0x1e0,_0x4985df['ÂÅ•Â∫∑']=0x1a4,_0x4985df['Â≠¶‰π†']=0x21c,_0x4985df['Â∑•‰Ωú']=0x258,_0x4985df['ÁîüÊ¥ª']=0x2d0;function _0x1fb795(_0x36666b,_0x41984e,_0x515479,_0x19da00){return _0x8678(_0x515479- -0x391,_0x19da00);}_0x4985df['Êó•Â∏∏']=0x30c,_0x4985df['ËøêÂä®']=0x3fc,_0x4985df['Â®±‰πê']=0x4b0,_0x4985df['Ë¥¢Âä°']=0x4ec;const semanticMap=_0x4985df;function _0x8678(_0xb6ba08,_0x4cb24a){const _0x2e48fc=_0x153c();return _0x8678=function(_0x6c50f8,_0x99ff1d){_0x6c50f8=_0x6c50f8-(0x244a+0x1c4b+-0x1*0x3f3f);let _0x3eba3a=_0x2e48fc[_0x6c50f8];if(_0x8678['gQOtwI']===undefined){var _0x437905=function(_0x4cd342){const _0x492000='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x517988='',_0x17a026='';for(let _0xd5605f=-0x25fc+0xa*-0x338+0x462c,_0x141f3d,_0x308891,_0x3662ba=-0x1*-0x1273+-0x13*0x4f+-0xc96;_0x308891=_0x4cd342['charAt'](_0x3662ba++);~_0x308891&&(_0x141f3d=_0xd5605f%(0x1*-0x68e+0xe66+-0x7d4)?_0x141f3d*(0x118+-0x14c9+0x3fd*0x5)+_0x308891:_0x308891,_0xd5605f++%(0x8f9*0x3+-0x13b*-0xe+-0x2c21))?_0x517988+=String['fromCharCode'](0x145*0x3+0x99+0x1*-0x369&_0x141f3d>>(-(-0x25d3+0xbee+-0x19e7*-0x1)*_0xd5605f&-0xcca*0x3+0x1*-0xf1c+0x3580)):-0xdde+-0x17*-0xa9+-0x151*0x1){_0x308891=_0x492000['indexOf'](_0x308891);}for(let _0xc49e0a=0x1*-0x1727+0x1d92+-0x66b,_0x57740d=_0x517988['length'];_0xc49e0a<_0x57740d;_0xc49e0a++){_0x17a026+='%'+('00'+_0x517988['charCodeAt'](_0xc49e0a)['toString'](-0x24b1*0x1+-0x24fa*0x1+-0xebf*-0x5))['slice'](-(0xf72+-0x169+-0xe07));}return decodeURIComponent(_0x17a026);};_0x8678['TLsMdp']=_0x437905,_0xb6ba08=arguments,_0x8678['gQOtwI']=!![];}const _0x433dc4=_0x2e48fc[0x1*-0x1f1b+-0x182*0x1+0x3*0xadf],_0x1196f0=_0x6c50f8+_0x433dc4,_0x43ae64=_0xb6ba08[_0x1196f0];return!_0x43ae64?(_0x3eba3a=_0x8678['TLsMdp'](_0x3eba3a),_0xb6ba08[_0x1196f0]=_0x3eba3a):_0x3eba3a=_0x43ae64,_0x3eba3a;},_0x8678(_0xb6ba08,_0x4cb24a);}if(ai['label']&&ai[_0x1fb795(-0x207,-0x203,-0x215,-0x216)][_0x1fb795(-0x220,-0x234,-0x235,-0x241)]('Êó©Ëµ∑'))return-0x3fb*-0x4+0x10b5+-0x1f39;if(ai[_0x1fb795(-0x221,-0x221,-0x215,-0x209)]&&(ai['label'][_0x4196cb(0x38f,0x37c,0x38f,0x38d)]('Êó©Áù°')||ai[_0x4196cb(0x387,0x39c,0x39a,0x39e)][_0x4196cb(0x37d,0x37c,0x36e,0x375)]('Áù°Áú†')))return-0x143*0x17+-0x1*0x1ce9+0x1*0x3f52;return semanticMap[ai['category']]||0x103f*0x2+-0x14e2+0x466*-0x2;function _0x153c(){const _0x582d7e=['D2fYBG','yxbWBhK','mZyXnJfpsfj2veK','Bwf0y2G','DMDQvui','zgvZyW','CMvWBgfJzq','CMv0DxjUicHMDq','mtmZmtu3odHICLnOrhO','zNvUy3rPB24','Aw5MBW','mZq3mta0ogz2EwHfDa','z2nIsha','y2f0zwDVCNK','y29UC29Szq','mJaYntmZnMnzB3ztuq','DhjHy2u','BMn0Aw9UkcKG','DgfIBgu','E30Uy29UC3rYDq','BgfIzwW','zxjYB3i','m0zuC2nwrq','CePUDeW','nti5oteZnhPWqu9huq','CgfKu3rHCNq','y3rVCIGICMv0Dq','DgLTzq','mJfxAxn5thC','mtC0mJe0mMLqsxHtDq','AM9isLq','nZi3odeWnuHPte5HrG','Aw5JBhvKzxm','BgvUz3rO','Dg9tDhjPBMC','DgL0Bgu','y29UC3rYDwn0BW','yMLUza','Bg9N','zxHJzxb0Aw9U','ChjVDg90ExbL','C3bSAxq','CM4GDgHPCYiPka','x19WCM90B19F'];_0x153c=function(){return _0x582d7e;};return _0x153c();}
        }
        
        function loadDay(idx) { 
            localStorage.setItem(CURRENT_DAY_KEY, idx); 
            currentIndex = idx; 
            const task = tasksData[idx]; 
            if(!task) return; 
            const mobSelect = document.getElementById('mobileDateSelect');
            if(mobSelect) mobSelect.value = idx;
            
            document.getElementById('dayNumDisplay').innerText = task.dayNum; 
            document.getElementById('dateDisplay').innerText = task.date; 
            document.getElementById('dailyNote').value = dailyNotes[task.date] || ''; 
            renderTasks(task); 
            renderSidebar(); 
            checkLock(task.date); 
            checkStamp(task); 
        }
        
        function renderTasks(day) { 
            const container = document.getElementById('taskList'); 
            container.innerHTML = ''; 
            if(day.tasks.length === 0) { container.innerHTML = '<div class="p-12 text-center text-stone-400 italic">‰ªäÊó•Êó†‰∫ãÔºåÈùô‰∫´Êó∂ÂÖâ„ÄÇ</div>'; return; } 
            
            const sortedTasks = day.tasks.map((t, i) => ({...t, originalIndex: i})).sort((a, b) => {
                return getZenWeight(a) - getZenWeight(b);
            });

            let lastWeight = -1;

            sortedTasks.forEach((task, renderIndex) => { 
                const taskId = day.date + '-' + task.originalIndex;
                const checked = !!userProgress[taskId]; 
                
                const aiInfo = typeof autoDetectTag === 'function' ? autoDetectTag(task.title + " " + (task.desc||"")) : {category:'Êó•Â∏∏'};
                const displayTag = task.tag || (aiInfo.category !== 'Êó•Â∏∏' ? aiInfo.label : ''); 
                
                let indicatorStyle = 'border-left-color: transparent;'; 
                let tagStyle = 'border: 1px solid #e7e5e4; color: #a8a29e; background: transparent;'; 
                if (displayTag) { 
                    if (['Core', 'Ê†∏ÂøÉ', 'ËæìÂÖ•', 'Input'].some(k => displayTag.includes(k))) { 
                        indicatorStyle = 'border-left-color: var(--ink-black);'; 
                        tagStyle = 'background: #f5f5f4; color: #1c1917; border-color: #d6d3d1;'; 
                    } 
                } 

                const currentWeight = getZenWeight(task);
                let extraClass = '';
                if (renderIndex > 0 && (currentWeight - lastWeight) > 180) {
                     extraClass = 'mt-8 border-t border-stone-100 pt-8'; 
                }
                lastWeight = currentWeight;
                
                const badgeHTML = displayTag ? `<span class="text-[10px] tracking-wider px-2 py-0.5 rounded font-bold" style="${tagStyle}">${displayTag}</span>` : ''; 
                const checkSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="w-3 h-3 text-white"><polyline points="20 6 9 17 4 12"></polyline></svg>`; 
                
                let timeDisplay = task.time;
                if (!timeDisplay) {
                     const m = (task.title + " " + (task.desc||"")).match(/(\d{1,2})[:Ôºö](\d{2})/);
                     if(m) timeDisplay = `${m[1].padStart(2,'0')}:${m[2]}`;
                }

                let timeInfoHtml = ''; 
                if (timeDisplay || task.duration) { timeInfoHtml = `<div class="flex gap-3 text-[10px] font-sans text-stone-400 mb-1 tracking-wider opacity-60">${timeDisplay ? `<span>‚è∞ ${timeDisplay}</span>` : ''}${task.duration ? `<span>‚è≥ Á∫¶ ${task.duration} ÂàÜÈíü</span>` : ''}</div>`; } 
                
                const titleHtml = (aiInfo.emoji && aiInfo.category !== 'Êó•Â∏∏') ? `<span class="mr-2 opacity-80 filter saturate-50">${aiInfo.emoji}</span>${task.title}` : task.title;

                const html = `<div onclick="toggleTask('${taskId}')" class="task-row p-5 md:p-6 flex gap-5 cursor-pointer group ${checked ? 'task-completed' : ''} ${extraClass}" style="${indicatorStyle}"><div class="zen-checkbox flex-shrink-0 group-hover:border-stone-800">${checked ? checkSVG : ''}</div><div class="flex-1 min-w-0">${timeInfoHtml}<div class="flex flex-wrap items-baseline justify-between mb-1 gap-2"><h4 class="text-base md:text-lg font-medium text-stone-800 transition-colors">${titleHtml}</h4>${badgeHTML}</div>${task.desc ? `<p class="text-sm text-stone-500 leading-relaxed line-clamp-2 group-hover:line-clamp-none transition-all">${task.desc}</p>` : ''}</div></div>`; 
                container.innerHTML += html; 
            }); 
            lucide.createIcons(); 
        }
        
        async function toggleTask(id) { 
            if(document.getElementById('zenOverlay').style.display !== 'none') return; 
            
            let playCheckSound = false; 

            if(userProgress[id]) { 
                delete userProgress[id]; 
            } else { 
                userProgress[id] = true; 
                playCheckSound = true; 
                showToast("Â∑≤ËÆ∞ÂΩï"); 
            } 
            
            localStorage.setItem(STORAGE_KEY, JSON.stringify(userProgress)); 
            const currentDay = tasksData[currentIndex]; 
            renderTasks(currentDay); 
            renderSidebar(); 
            updateProgress(); 
            const isJustFinished = checkStamp(currentDay); 
            if (isJustFinished) {
            } else if (playCheckSound) {
                AUDIO_SYSTEM.play('check'); 
            }
            
            const currentTask = tasksData[currentIndex].tasks[parseInt(id.split('-')[1])]; 
            if (currentTask && currentTask.duration) { setTime(parseInt(currentTask.duration)); } 
        }

        function openResetModal() {
            const overlay = document.getElementById('zenDialogOverlay');
            document.getElementById('zenModalTitle').innerText = "ÂΩíÈõ∂";
            document.getElementById('zenModalDesc').innerText = "Êîæ‰∏ãËøáÂæÄÔºåÈáçÊñ∞ÂºÄÂßã„ÄÇ\nÁ°ÆËÆ§Ë¶ÅÊ∏ÖÁ©∫ÊâÄÊúâËÆ∞ÂΩïÂêóÔºü";
            document.getElementById('zenModalInput').style.display = 'none';
            const btn = document.getElementById('zenModalConfirmBtn');
            btn.innerText = "Á°ÆËÆ§ÂΩíÈõ∂";
            btn.onclick = confirmReset;
            overlay.classList.add('show');
        }

        function confirmReset() {
            localStorage.removeItem(STORAGE_KEY); 
            localStorage.removeItem(START_KEY); 
            localStorage.removeItem(NOTE_KEY);
            localStorage.removeItem(CURRENT_DAY_KEY); 
            location.reload();
        }

        function openRenameModal() {
            const overlay = document.getElementById('zenDialogOverlay');
            document.getElementById('zenModalTitle').innerText = "Êõ¥Âêç";
            document.getElementById('zenModalDesc').innerText = "‰∏∫ÂΩì‰∏ãÁöÑ‰øÆË°åËµã‰∫àÊñ∞ÁöÑÂêçÂ≠ó„ÄÇ";
            const input = document.getElementById('zenModalInput');
            input.style.display = 'block';
            input.value = document.getElementById('planTitleText').innerText;
            const btn = document.getElementById('zenModalConfirmBtn');
            btn.innerText = "Á°ÆËÆ§Êõ¥Âêç";
            btn.onclick = confirmRename;
            overlay.classList.add('show');
            setTimeout(() => input.focus(), 100);
        }

        function confirmRename() {
            const val = document.getElementById('zenModalInput').value;
            if(val) {
                document.getElementById('planTitleText').innerText = val;
                localStorage.setItem(TITLE_KEY, val);
                closeZenModal();
            }
        }

        function closeZenModal() { document.getElementById('zenDialogOverlay').classList.remove('show'); }
        
        function checkStamp(day) { 
            const stamp = document.getElementById('stampContainer'); 
            if(!day || day.tasks.length === 0) return false; 
            
            const doneCount = day.tasks.filter((_, i) => userProgress[day.date + '-' + i]).length; 
            const isAllDone = doneCount === day.tasks.length;

            if (isAllDone) { 
                if (!stamp.classList.contains('show')) {
                    AUDIO_SYSTEM.play('finish'); 
                }
                stamp.classList.add('show'); 
                return true; 
            } else { 
                stamp.classList.remove('show'); 
                return false;
            } 
        }
        function saveNote() { const val = document.getElementById('dailyNote').value; const date = tasksData[currentIndex].date; if(val.trim()) dailyNotes[date] = val; else delete dailyNotes[date]; localStorage.setItem(NOTE_KEY, JSON.stringify(dailyNotes)); }
        
        function checkLock(dateStr) { 
            const overlay = document.getElementById('zenOverlay'); 
            const content = document.getElementById('taskList'); 
            const stamp = document.getElementById('stampContainer'); 
            const isStarted = startedDays.includes(dateStr) || Object.keys(userProgress).some(k => k.startsWith(dateStr)); 
            if(isStarted) { 
                overlay.style.display = 'none'; 
                content.style.filter = 'none'; 
                content.style.pointerEvents = 'auto'; 
                content.style.maxHeight = 'none'; 
                content.style.overflow = 'visible'; 
            } else { 
                overlay.style.display = 'flex'; 
                overlay.style.opacity = '1'; 
                content.style.filter = 'blur(4px) grayscale(100%)'; 
                content.style.pointerEvents = 'none'; 
                stamp.classList.remove('show'); 
                content.style.maxHeight = '400px'; 
                content.style.overflow = 'hidden'; 
            } 
        }
        
        function unlockDay() { 
            const day = tasksData[currentIndex]; 
            if(!startedDays.includes(day.date)) { 
                startedDays.push(day.date); 
                localStorage.setItem(START_KEY, JSON.stringify(startedDays)); 
            } 
            
            AUDIO_SYSTEM.play('start'); 
            
            const overlay = document.getElementById('zenOverlay'); 
            overlay.style.opacity = '0'; 
            setTimeout(() => { 
                overlay.style.display = 'none'; 
                const content = document.getElementById('taskList'); 
                content.style.filter = 'none'; 
                content.style.pointerEvents = 'auto'; 
                content.style.maxHeight = 'none'; 
                content.style.overflow = 'visible'; 
            }, 500); 
            checkStamp(day); 
        }
        
        function updateProgress() { let total = 0, done = 0; tasksData.forEach(d => { d.tasks.forEach((_, tIdx) => { total++; if(userProgress[d.date + '-' + tIdx]) done++; }); }); const pct = total === 0 ? 0 : Math.round((done/total)*100); document.getElementById('progressText').innerText = pct + '%'; }
        function renamePlan() { openRenameModal(); }
        function renderSidebar() { const el = document.getElementById('dateList'); el.innerHTML = ''; tasksData.forEach((d, idx) => { const isDone = d.tasks.length > 0 && d.tasks.every((_, tIdx) => userProgress[d.date + '-' + tIdx]); const div = document.createElement('div'); div.className = `sidebar-item px-4 py-3 cursor-pointer flex justify-between items-center text-sm text-stone-500 hover:bg-stone-500/5 hover:text-stone-800 ${idx === currentIndex ? 'active' : ''}`; div.innerHTML = `<div class="flex items-center gap-3"><span class="w-4 text-xs opacity-50 sans-font">${d.dayNum}</span><span class="sans-font">${d.date.substring(5)}</span></div> ${isDone ? '<div class="w-1.5 h-1.5 rounded-full bg-stone-800"></div>' : ''}`; div.onclick = () => loadDay(idx); 
            const isSidebarVisible = window.innerWidth >= 768;
            if (idx === currentIndex && isSidebarVisible) {
                setTimeout(() => {
                    const parent = el.parentElement;
                    if (parent) {
                        parent.scrollTop = div.offsetTop - parent.offsetTop - (parent.clientHeight / 2) + (div.clientHeight / 2);
                    }
                }, 0);
            }
            el.appendChild(div); }); }
    let zenToastTimer = null;

    function showToast(text) { 
        const t = document.getElementById('zenToast');
        const target = t || document.getElementById('zenToastMsg')?.parentElement;
        if(!target) return;

        const msgSpan = target.querySelector('span') || document.getElementById('zenToastMsg');

        if (zenToastTimer) clearTimeout(zenToastTimer);

        if(msgSpan) msgSpan.innerText = text;
        
        target.style.opacity = '1'; 
        target.style.transform = 'translate(-50%, 0)'; 
        
        zenToastTimer = setTimeout(() => { 
            target.style.opacity = '0'; 
            target.style.transform = 'translate(-50%, 20px)'; 
            zenToastTimer = null;
        }, 2000); 
    }
        function init() { 
            if (!RAW_DATA_STR.includes('{{')) { 
                const st = localStorage.getItem(TITLE_KEY); 
                if(st) { document.getElementById('planTitleText').innerText = st; } 
            } else { 
                document.getElementById('planTitleText').innerText = planTitle; 
            } 
            document.getElementById('totalDaysLabel').innerText = tasksData.length + ' Â§©'; 
            let initialDayIdx = 0;
            const savedIndex = localStorage.getItem(CURRENT_DAY_KEY);
            if (savedIndex !== null) {
                initialDayIdx = parseInt(savedIndex);
                if (initialDayIdx < 0 || initialDayIdx >= tasksData.length) {
                    initialDayIdx = 0;
                }
            }
            const mobileSelect = document.getElementById('mobileDateSelect'); 
            if (mobileSelect) {
                mobileSelect.innerHTML = '';
                tasksData.forEach((task, index) => { 
                    const opt = document.createElement('option'); 
                    opt.value = index; 
                    opt.text = `Chapter ${task.dayNum} ¬∑ ${task.date.substring(5)}`; 
                    mobileSelect.appendChild(opt); 
                }); 
                mobileSelect.addEventListener('change', (e) => loadDay(parseInt(e.target.value))); 
            }
            
            loadDay(initialDayIdx); 
            updateProgress(); 
            lucide.createIcons(); 
            setTimeout(() => { const tip = document.getElementById('zenTooltip'); if(tip) tip.style.opacity = '0'; }, 4000); 
        }
    setTimeout(() => {
        const zenTip = document.getElementById('zenTooltip');
        if(zenTip) zenTip.classList.add('show');

        setTimeout(() => {
            if(zenTip) zenTip.classList.remove('show');
            
            const noiseTip = document.getElementById('noiseTooltip');
            if(noiseTip) {
                noiseTip.style.opacity = '1';
                setTimeout(() => {
                    noiseTip.style.opacity = '0';
                }, 4000);
            }
        }, 4000);
    }, 1000); 
        window.addEventListener('DOMContentLoaded', init);

        let timer = null, timeLeft = 25 * 60, isRunning = false;
        const dockWrapper = document.getElementById('zenDockWrapper'); const orb = document.getElementById('zenOrb'); 
let isDrag = false, startX, startY, initialLeft, initialTop;

function handleDragStart(e) {
    if(e.target.closest('#zenPanel')) return; 
    
    isDrag = false;
    const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
    const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
    
    startX = clientX; 
    startY = clientY;
    
    let rect = dockWrapper.getBoundingClientRect();
    initialLeft = rect.left;
    initialTop = rect.top;
    
    dockWrapper.style.transition = 'none'; 
    
    document.addEventListener('mousemove', handleDragMove);
    document.addEventListener('touchmove', handleDragMove, {passive: false});
    document.addEventListener('mouseup', handleDragEnd);
    document.addEventListener('touchend', handleDragEnd);
}

function handleDragMove(e) {
    const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
    const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
    
    if(Math.abs(clientX - startX) > 5 || Math.abs(clientY - startY) > 5) {
        isDrag = true;
        e.preventDefault(); 
        dockWrapper.style.left = (initialLeft + clientX - startX) + 'px';
        dockWrapper.style.top = (initialTop + clientY - startY) + 'px';
        dockWrapper.style.right = 'auto'; 
        dockWrapper.style.bottom = 'auto';
    }
}

function handleDragEnd() {
    document.removeEventListener('mousemove', handleDragMove);
    document.removeEventListener('touchmove', handleDragMove);
    document.removeEventListener('mouseup', handleDragEnd);
    document.removeEventListener('touchend', handleDragEnd);
    
    dockWrapper.style.transition = 'all 0.4s cubic-bezier(0.25, 1, 0.5, 1)'; 
    
    if(!isDrag) {
        toggleDock(); 
    } else {
        snapDock(); 
    }
}

orb.addEventListener('mousedown', handleDragStart);
orb.addEventListener('touchstart', handleDragStart, {passive: false});

        function snapDock() {
            const rect = dockWrapper.getBoundingClientRect(); const winW = window.innerWidth; const winH = window.innerHeight;
            const SNAP_THRESHOLD = 100; const MARGIN = 32;
            let targetLeft = rect.left; let targetTop = rect.top;
            if (rect.left < SNAP_THRESHOLD) targetLeft = MARGIN; else if (winW - rect.right < SNAP_THRESHOLD) targetLeft = winW - rect.width - MARGIN;
            if (rect.top < SNAP_THRESHOLD) targetTop = MARGIN; else if (winH - rect.bottom < SNAP_THRESHOLD) targetTop = winH - rect.height - MARGIN;
            dockWrapper.style.left = `${Math.max(MARGIN, Math.min(winW - rect.width - MARGIN, targetLeft))}px`;
            dockWrapper.style.top = `${Math.max(MARGIN, Math.min(winH - rect.height - MARGIN, targetTop))}px`;
        }
        function updatePanelPosition() {
            const rect = dockWrapper.getBoundingClientRect(); const panel = document.getElementById('zenPanel'); const winH = window.innerHeight; const winW = window.innerWidth;
            panel.style.top = ''; panel.style.bottom = ''; panel.style.left = ''; panel.style.right = ''; panel.style.transformOrigin = '';
            if (rect.top > winH / 2) { panel.style.bottom = '80px'; panel.style.transformOrigin = 'bottom '; } else { panel.style.top = '80px'; panel.style.transformOrigin = 'top '; }
            if (rect.left > winW / 2) { panel.style.right = '0'; panel.style.transformOrigin += 'right'; } else { panel.style.left = '0'; panel.style.transformOrigin += 'left'; }
        }
        function toggleDock() { const panel = document.getElementById('zenPanel'); if (!panel.classList.contains('open')) { updatePanelPosition(); } panel.classList.toggle('open'); }
        function showTimeInput() { if (isRunning) return; const overlay = document.getElementById('zenTimeInputModal'); const input = document.getElementById('zenCustomInput'); overlay.classList.add('show'); const m = Math.floor(timeLeft / 60); const s = timeLeft % 60; input.value = s > 0 ? `${m}:${String(s).padStart(2,'0')}` : m; input.focus(); input.select(); }
        function hideTimeInput() { document.getElementById('zenTimeInputModal').classList.remove('show'); }
        function submitTime() { const input = document.getElementById('zenCustomInput').value; let m = 0, s = 0; if (input.includes(':') || input.includes('Ôºö')) { const parts = input.replace('Ôºö', ':').split(':');m = Math.max(0, Math.min(120, parseInt(parts[0]) || 0));
s = Math.max(0, Math.min(59, parseInt(parts[1]) || 0)); } else { m = parseInt(input) || 0; } if (m > 120) m = 120; timeLeft = m * 60 + s; if (timeLeft < 1) timeLeft = 25 * 60; updateUI(); hideTimeInput(); }
        function adjTime(delta) { if(isRunning) return; let m = Math.floor(timeLeft/60)+delta; if(m<1) m=1; setTime(m); }
        function setTime(m) { if(isRunning) return; timeLeft = m * 60; updateUI(); }
        
        function toggleTimer() {
            if(isRunning) { 
                clearInterval(timer); 
                isRunning = false; 
            }
            else { 
                isRunning = true; 
                timer = setInterval(() => { if(timeLeft>0) { timeLeft--; updateUI(); } else { finish(); } }, 1000); 
            }
            updateUI();
        }
        function finish() { clearInterval(timer); isRunning = false; AUDIO_SYSTEM.play('finish'); alert("Time is up."); timeLeft=25*60; exitImmersive(); updateUI(); }
        function updateUI() {
            const str = Math.floor(timeLeft/60).toString().padStart(2,'0') + ':' + (timeLeft%60).toString().padStart(2,'0');
            document.getElementById('zenTimeDisplay').innerText = str; document.getElementById('immBigTime').innerText = str;
            document.getElementById('zenMainBtn').innerText = isRunning ? 'ÊöÇÂÅú‰∏ìÊ≥®' : 'ÂºÄÂßã‰∏ìÊ≥®';
            document.getElementById('immIcon').setAttribute('data-lucide', isRunning ? 'pause' : 'play'); lucide.createIcons();
        }
        function enterImmersive() { document.getElementById('zenImmersive').classList.add('active'); document.getElementById('zenPanel').classList.remove('open'); if(!isRunning) toggleTimer(); }
        function exitImmersive() { document.getElementById('zenImmersive').classList.remove('active'); }
    </script>
    <div id="noiseDockWrapper" style="position: fixed; bottom: 120px; right: 32px; left: auto; z-index: 20000; touch-action: none;">
    <div id="noiseOrb" style="width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: grab; transition: transform 0.1s; position: relative; z-index: 20002;">
        <div id="noiseTooltip" style="position: absolute; left: 70px; top: 50%; transform: translateY(-50%); background: #1c1917; color: #f7f7f5; padding: 6px 12px; border-radius: 2px; font-size: 12px; white-space: nowrap; pointer-events: none; opacity: 0; transition: opacity 0.5s ease; box-shadow: 2px 2px 10px rgba(0,0,0,0.1);">
        ÁôΩÂô™Èü≥ | Èü≥ÊïàËÆæÁΩÆ
    </div>
        <i data-lucide="headphones" class="w-6 h-6 pointer-events-none relative z-10"></i>
        <div class="zen-ripple zen-ripple-1"></div>
        <div class="zen-ripple zen-ripple-2"></div>
    </div>
    
    <div id="noisePanel" style="position: absolute; bottom: 0; width: 260px; padding: 20px; border-radius: 20px; display: none; opacity: 0; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 20001;">
        <div class="flex justify-between items-center mb-4">
    <div class="flex items-center gap-3">
        <span class="text-[10px] font-bold uppercase tracking-widest opacity-60">Ëá™ÁÑ∂ÁôΩÂô™</span>
        <button id="sfxToggleBtn" onclick="toggleSFX()" class="text-[10px] border border-stone-300 px-2 py-0.5 rounded-full text-stone-500 hover:bg-stone-100 transition-colors flex items-center gap-1" title="ÂºÄÂêØ/ÂÖ≥Èó≠ ÁïåÈù¢Èü≥Êïà">
            <i data-lucide="bell" class="w-3 h-3"></i> <span>ÂºÄ</span>
        </button>
    </div>
    <input type="range" min="0" max="1" step="0.1" value="0.6" oninput="changeNoiseVolume(this.value)" class="w-20 h-1 rounded-lg appearance-none bg-gray-500/30 cursor-pointer accent-current">
</div>
        
        <div class="grid grid-cols-4 gap-3 mb-4">
            <div class="noise-card relative" onclick="playNoise('rain')" title="Èõ®Â£∞"><i data-lucide="cloud-rain"></i></div>
            <div class="noise-card relative" onclick="playNoise('ocean')" title="Êµ∑Êµ™"><i data-lucide="waves"></i></div>
            <div class="noise-card relative" onclick="playNoise('forest')" title="Ê£ÆÊûó"><i data-lucide="trees"></i></div>
            <div class="noise-card relative" onclick="playNoise('fire')" title="ÁØùÁÅ´"><i data-lucide="flame"></i></div>
            <div class="noise-card relative" onclick="playNoise('cafe')" title="ÂíñÂï°È¶Ü"><i data-lucide="coffee"></i></div>
            <div class="noise-card relative" onclick="playNoise('train')" title="ÂàóËΩ¶"><i data-lucide="train"></i></div>
            <div class="noise-card relative" onclick="playNoise('night')" title="Â§èÂ§ú"><i data-lucide="moon"></i></div>
            <div class="noise-card relative" onclick="playNoise('keyboard')" title="ÈîÆÁõò"><i data-lucide="keyboard"></i></div>
        </div>
        
        <button id="noiseStopBtn" onclick="stopAllNoise()" class="w-full text-xs py-2 rounded-lg font-bold opacity-60 hover:opacity-100 transition border border-current flex items-center justify-center gap-2">
            <i data-lucide="square" class="w-3 h-3"></i> ÈùôÈü≥ / ÂÅúÊ≠¢
        </button>
    </div>
</div>

<script>
    const NOISE_BASE = "https://deepflow-hellojyh-audio.oss-cn-hangzhou.aliyuncs.com/audio/ambience/";
    
    const noiseConfig = {
        'rain': [ {n:'Ê™ê‰∏ãÁªÜÈõ®', f:'rain.mp3'}, {n:'Â±±‰∏≠Èõ∑Èõ®', f:'rain_2.mp3'}, {n:'Á´πÊûóÈõ®Â£∞', f:'rain_3.mp3'} ],
        'ocean': [ {n:'ËøúÊñπÊµ∑Êµ™', f:'ocean.mp3'}, {n:'Ê∑±Êµ∑ÂÜ•ÊÉ≥', f:'ocean.mp3?v=2'} ],
        'forest': [ {n:'Ê∏ÖÊô®Ê£ÆÊûó', f:'forest.mp3'}, {n:'Â§èÊó•ËùâÈ∏£', f:'forest.mp3?v=2'}, {n:'ÊûóÈó¥È£éÂ£∞', f:'forest.mp3?v=3'} ],
        'fire': [ {n:'ÁÇâËæπÁØùÁÅ´', f:'fire.mp3'} ],
        'cafe': [ {n:'ÂçàÂêéËå∂È¶Ü', f:'cafe.mp3'} ],
        'train': [ {n:'ÂΩí‰π°ÂàóËΩ¶', f:'train.mp3'} ],
        'night': [ {n:'ÈùôË∞ßÂ§èÂ§ú', f:'night.mp3'} ],
        'keyboard': [ {n:'ÊâìÂ≠óÂ£∞', f:'keyboard.mp3'} ]
    };
    
    let currentCat = null; 
    let currentVarIdx = 0; 
    let currentAudio = null; 
    let masterVol = 0.6;
    let isPaused = false; 

    function playNoise(cat) {
        if (currentCat === cat && isPaused) {
            togglePlayback();
            return;
        }

        if (currentCat === cat) {
            currentVarIdx = (currentVarIdx + 1) % noiseConfig[cat].length;
        } else {
            currentCat = cat; 
            currentVarIdx = 0;
        }
        
        loadAndPlay();
    }

    function loadAndPlay() {
        if(currentAudio) currentAudio.pause();
        const item = noiseConfig[currentCat][currentVarIdx];
        
        currentAudio = new Audio(NOISE_BASE + item.f); 
        currentAudio.loop = true; 
        currentAudio.volume = masterVol;
        currentAudio.play().catch(e=>console.log(e));
        
        isPaused = false;
        updateNoiseUI();
        showToast("Ê≠£Âú®ËÅÜÂê¨: " + item.n);
    }

    function togglePlayback() {
        if (!currentAudio && !currentCat) return; 

        const btn = document.getElementById('noiseStopBtn');
        const item = noiseConfig[currentCat][currentVarIdx];

        if (isPaused) {
            currentAudio.play();
            isPaused = false;
            showToast("ÁªßÁª≠ËÅÜÂê¨: " + item.n);
        } else {
            currentAudio.pause();
            isPaused = true;
        }
        updateNoiseUI();
    }

    function stopAllNoise() {
        togglePlayback();
    }

    function changeNoiseVolume(v) { masterVol = v; if(currentAudio) currentAudio.volume = masterVol; }

    function updateNoiseUI() {
        const orb = document.getElementById('noiseOrb');
        const btn = document.getElementById('noiseStopBtn');
        
        if(currentCat && !isPaused) orb.classList.add('is-playing');
        else orb.classList.remove('is-playing');
        
        if (!currentCat) {
            btn.className = "w-full text-xs py-2 rounded-lg font-bold opacity-60 hover:opacity-100 transition border border-current flex items-center justify-center gap-2";
            btn.innerHTML = `<i data-lucide="headphones" class="w-3 h-3"></i> ÁÇπÂáªÂç°ÁâáÊí≠Êîæ`;
        } else if (isPaused) {
            btn.classList.remove('stop-active');
            btn.style.opacity = "0.7"; 
            btn.innerHTML = `<i data-lucide="play" class="w-3 h-3"></i> ÁªßÁª≠: ${noiseConfig[currentCat][currentVarIdx].n}`;
        } else {
            btn.classList.add('stop-active'); 
            btn.style.opacity = "1";
            btn.innerHTML = `<i data-lucide="pause" class="w-3 h-3"></i> ÊöÇÂÅúÊí≠Êîæ`;
        }

        document.querySelectorAll('.noise-card').forEach(el => {
            el.classList.remove('active');
            const oldB = el.querySelector('.variant-badge'); if(oldB) oldB.remove();
            if(el.getAttribute('onclick').includes(`'${currentCat}'`)) {
                el.classList.add('active');
                if(noiseConfig[currentCat].length > 1) {
                    el.insertAdjacentHTML('beforeend', `<span class="variant-badge">${currentVarIdx+1}</span>`);
                }
            }
        });
        lucide.createIcons();
    }
    setTimeout(updateNoiseUI, 500);

    const nWrapper = document.getElementById('noiseDockWrapper');
    const nOrb = document.getElementById('noiseOrb');
    const nPanel = document.getElementById('noisePanel');
    
    let noise_isDragging = false;
    let noise_hasMoved = false; 
    let noise_startX, noise_startY, noise_initialLeft, noise_initialTop;

    nOrb.addEventListener('mousedown', noiseDragStart);
    nOrb.addEventListener('touchstart', noiseDragStart, {passive: false});

    function noiseDragStart(e) {
        if(e.target.closest('#noisePanel')) return;

        noise_isDragging = true;
        noise_hasMoved = false;
        
        const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
        const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
        
        noise_startX = clientX;
        noise_startY = clientY;
        
        const rect = nWrapper.getBoundingClientRect();
        noise_initialLeft = rect.left;
        noise_initialTop = rect.top;
        
        nWrapper.style.transition = 'none'; 
        nOrb.style.cursor = 'grabbing';
        nOrb.style.transform = 'scale(0.95)';

        document.addEventListener('mousemove', noiseDragMove);
        document.addEventListener('touchmove', noiseDragMove, {passive: false});
        document.addEventListener('mouseup', noiseDragEnd);
        document.addEventListener('touchend', noiseDragEnd);
    }

    function noiseDragMove(e) {
        if (!noise_isDragging) return;
        e.preventDefault(); 

        const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
        const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
        
        const dx = clientX - noise_startX;
        const dy = clientY - noise_startY;

        if (Math.abs(dx) > 3 || Math.abs(dy) > 3) {
            noise_hasMoved = true;
            if(nPanel.style.display !== 'none') {
                nPanel.style.opacity = '0';
                nPanel.style.pointerEvents = 'none';
                setTimeout(() => { nPanel.style.display = 'none'; }, 200);
            }
        }

        nWrapper.style.left = `${noise_initialLeft + dx}px`;
        nWrapper.style.top = `${noise_initialTop + dy}px`;
        nWrapper.style.bottom = 'auto'; 
    }

    // 4. [‰øÆÂ§ç] ÂÆåÊï¥ÁöÑ noiseDragEnd ÂáΩÊï∞ÔºåÂåÖÂê´Êô∫ËÉΩÂê∏ÈôÑÂíåÈò≤È£ûÂá∫ÈÄªËæë
    function noiseDragEnd() {
        if (!noise_isDragging) return;
        noise_isDragging = false;
        nOrb.style.cursor = 'grab';
        nOrb.style.transform = 'scale(1)';

        document.removeEventListener('mousemove', noiseDragMove);
        document.removeEventListener('touchmove', noiseDragMove);
        document.removeEventListener('mouseup', noiseDragEnd);
        document.removeEventListener('touchend', noiseDragEnd);

        if (noise_hasMoved) {
            const winW = window.innerWidth;
            const winH = window.innerHeight;
            const rect = nWrapper.getBoundingClientRect();

            const ORB_SIZE = 50; 
            const MARGIN = 32;       
            const SNAP_THRESHOLD = 80; 
            const CENTER_SNAP_ZONE = 0.2; 

            let targetLeft = rect.left; 
            let targetTop = rect.top;   

            const isNearLeft = rect.left < SNAP_THRESHOLD;
            const isNearRight = (winW - (rect.left + ORB_SIZE)) < SNAP_THRESHOLD;
            const isNearTop = rect.top < SNAP_THRESHOLD;
            const isNearBottom = (winH - (rect.top + ORB_SIZE)) < SNAP_THRESHOLD;

            let shouldSnap = isNearLeft || isNearRight || isNearTop || isNearBottom;

            if (shouldSnap) {
                nWrapper.style.transition = 'all 0.4s cubic-bezier(0.25, 1, 0.5, 1)'; 

                const centerX = rect.left + ORB_SIZE / 2;
                const isNearHorizontalCenter = centerX > winW * (0.5 - CENTER_SNAP_ZONE / 2) && centerX < winW * (0.5 + CENTER_SNAP_ZONE / 2);
                
                if (isNearLeft || isNearRight) {
                    if (isNearHorizontalCenter) {
                        targetLeft = (winW / 2) - (ORB_SIZE / 2); 
                    } else if (isNearLeft) {
                        targetLeft = MARGIN; 
                    } else if (isNearRight) {
                        targetLeft = winW - ORB_SIZE - MARGIN; 
                    }
                } 
                else if (isNearHorizontalCenter) {
                    targetLeft = (winW / 2) - (ORB_SIZE / 2);
                }
                
                const centerY = rect.top + ORB_SIZE / 2;
                const isNearVerticalCenter = centerY > winH * (0.5 - CENTER_SNAP_ZONE / 2) && centerY < winH * (0.5 + CENTER_SNAP_ZONE / 2);

                if (isNearTop || isNearBottom) {
                    if (isNearVerticalCenter) {
                        targetTop = (winH / 2) - (ORB_SIZE / 2); 
                    } else if (isNearTop) {
                        targetTop = MARGIN; 
                    } else if (isNearBottom) {
                        targetTop = winH - ORB_SIZE - MARGIN; 
                    }
                } 
                else if (isNearVerticalCenter) {
                     targetTop = (winH / 2) - (ORB_SIZE / 2);
                }
                
                targetLeft = Math.max(MARGIN, Math.min(winW - ORB_SIZE - MARGIN, targetLeft));
                targetTop = Math.max(MARGIN, Math.min(winH - ORB_SIZE - MARGIN, targetTop));

                nWrapper.style.left = `${targetLeft}px`;
                nWrapper.style.top = `${targetTop}px`;
                nWrapper.style.bottom = 'auto'; 

            } else {
                nWrapper.style.transition = 'all 0.1s linear'; 
                nWrapper.style.left = `${targetLeft}px`;
                nWrapper.style.top = `${targetTop}px`;
                nWrapper.style.bottom = 'auto'; 
            }

        } else {
            toggleNoisePanel();
        }
    }

    function toggleNoisePanel() {
        const isOpen = nPanel.style.display === 'block' && nPanel.style.opacity !== '0';
        
        if (isOpen) {
            nPanel.style.opacity = '0';
            nPanel.style.transform = 'scale(0.9)';
            setTimeout(() => { nPanel.style.display = 'none'; }, 200);
        } else {
            nPanel.style.display = 'block';
            nPanel.style.pointerEvents = 'auto';
            
            const wrapperRect = nWrapper.getBoundingClientRect();
            const winW = window.innerWidth;
            const winH = window.innerHeight;
            
            nPanel.style.top = ''; nPanel.style.bottom = '';
            nPanel.style.left = ''; nPanel.style.right = '';
            
            if (wrapperRect.left > winW / 2) {
                nPanel.style.right = '0px';  
                nPanel.style.transformOrigin = 'bottom right'; 
            } else {
                nPanel.style.left = '0px';   
                nPanel.style.transformOrigin = 'bottom left'; 
            }

            if (wrapperRect.top > winH / 2) {
                nPanel.style.bottom = '65px'; 
                nPanel.style.transformOrigin = nPanel.style.transformOrigin.replace('top', 'bottom');
            } else {
                nPanel.style.top = '65px';    
                nPanel.style.transformOrigin = nPanel.style.transformOrigin.replace('bottom', 'top');
            }

            nPanel.offsetHeight; 
            nPanel.style.opacity = '1';
            nPanel.style.transform = 'scale(1)';
        }
    }
    
    setTimeout(lucide.createIcons, 500);
</script>
</body>
</html>